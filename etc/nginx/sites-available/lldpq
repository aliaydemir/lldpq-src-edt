server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        index index.html index.htm;

        server_name _;

        location / {
            # Optional: Uncomment lines below to enable authentication
            # auth_basic "LLDPq Network Monitoring";
            # auth_basic_user_file /etc/nginx/.htpasswd;
            
            try_files $uri $uri/ =404;
            add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
            add_header Pragma "no-cache";
            add_header Expires "Thu, 01 Jan 1970 00:00:00 GMT";
        }
        location /configs/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        location /hstr/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        location /monitor-results/ {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        
        # Auto-trigger endpoint with fcgiwrap
        location = /trigger-lldp {
            # Execute trigger script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/trigger-lldp.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Monitor trigger endpoint with fcgiwrap
        location = /trigger-monitor {
            # Execute trigger script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/trigger-monitor.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Assets trigger endpoint with fcgiwrap
        location = /trigger-assets {
            # Execute trigger script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/trigger-assets.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Config collection trigger endpoint with fcgiwrap
        location = /trigger-configs {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/trigger-configs.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Edit topology.dot endpoint with fcgiwrap
        location = /edit-topology {
            # Execute edit script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/edit-topology.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Edit topology_config.yaml endpoint with fcgiwrap
        location = /edit-config {
            # Execute edit script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/edit-config.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Edit devices.yaml endpoint with fcgiwrap
        location = /edit-devices {
            # Execute edit script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/edit-devices.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
        }
        
        # Ansible API endpoint with fcgiwrap
        location = /ansible-api {
            # Execute ansible API script via fcgiwrap
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/ansible-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            
            # Longer timeout for ansible operations
            fastcgi_read_timeout 300;
        }
        
        # Authentication API endpoint with fcgiwrap
        location = /auth-api {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/auth-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            fastcgi_param HTTP_COOKIE $http_cookie;
        }
        
        # Ansible API endpoint with .sh extension (alias for compatibility)
        location = /ansible-api.sh {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/ansible-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            fastcgi_read_timeout 300;
        }
        
        # Fabric Configuration API endpoint with fcgiwrap
        location = /fabric-api.sh {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/fabric-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            
            # Longer timeout for parsing large configs
            fastcgi_read_timeout 60;
        }
        
        # Search API endpoint (MAC/ARP tables)
        location = /search-api.sh {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/search-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            
            # Longer timeout for parallel device queries
            fastcgi_read_timeout 120;
        }
        
        # SSH Setup API endpoint (send-key + sudo-fix)
        location = /setup-api.sh {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/setup-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            
            # Longer timeout for parallel SSH operations across all devices
            fastcgi_read_timeout 120;
        }
        
        # Provision API endpoint (ZTP + Base Config)
        location = /provision-api.sh {
            fastcgi_pass unix:/var/run/fcgiwrap.socket;
            fastcgi_param SCRIPT_FILENAME /var/www/html/provision-api.sh;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            
            # Longer timeout for parallel SCP/SSH deploy operations
            fastcgi_read_timeout 180;
            # Allow large OS image uploads (up to 2GB)
            client_max_body_size 2048m;
        }
}
