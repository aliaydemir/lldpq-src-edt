<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <title>..::LLDPQ::..</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="/css/select2.min.css">
    <link rel="stylesheet" type="text/css" href="/css/codemirror.min.css">
    <link rel="stylesheet" type="text/css" href="/css/codemirror-theme.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
        }
        
        .last-updated {
            font-size: 13px;
            color: #888;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Summary Cards Grid */
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .summary-card { 
            background: #252526; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 3px solid #76b900;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .summary-card:hover:not(.active-filter) {
            background: #2d2d2d;
            transform: translateY(-2px);
        }
        
        .card-excellent { border-left-color: #76b900; }
        .card-good { border-left-color: #8bc34a; }
        .card-warning { border-left-color: #ff9800; }
        .card-critical { border-left-color: #f44336; }
        .card-total { border-left-color: #4fc3f7; }
        .card-info { border-left-color: #9e9e9e; }
        
        .summary-card.active-filter {
            background: #37373d !important;
            border-left-width: 5px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }
        
        .card-value { 
            font-size: 28px; 
            font-weight: bold; 
            color: #fff; 
        }
        
        .card-excellent .card-value { color: #76b900; }
        .card-good .card-value { color: #8bc34a; }
        .card-warning .card-value { color: #ffb74d; }
        .card-critical .card-value { color: #ff6b6b; }
        .card-total .card-value { color: #fff; }
        .card-info .card-value { color: #9e9e9e; }
        
        .card-label { 
            font-size: 12px; 
            color: #888; 
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Dashboard Section */
        .dashboard-section {
            background: #2d2d2d;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 12px 16px;
            background: #333;
            font-weight: 600;
            font-size: 14px;
            color: #76b900;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .section-content {
            padding: 0;
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px 14px;
            background: #252526;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #404040;
        }
        
        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        
        .data-table tr:hover {
            background: #333;
        }
        
        /* Sortable Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
            transition: background 0.2s;
        }
        
        .sortable:hover {
            background: #2d2d2d;
        }
        
        .sort-arrow {
            font-size: 10px;
            color: #555;
            margin-left: 5px;
            opacity: 0.5;
        }
        
        .sortable.asc .sort-arrow::before {
            content: '▲';
            color: #76b900;
            opacity: 1;
        }
        
        .sortable.desc .sort-arrow::before {
            content: '▼';
            color: #76b900;
            opacity: 1;
        }
        
        .sortable.asc .sort-arrow,
        .sortable.desc .sort-arrow {
            opacity: 1;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .badge-green {
            background: rgba(118, 185, 0, 0.2);
            color: #76b900;
        }
        
        .badge-blue {
            background: rgba(0, 122, 204, 0.2);
            color: #4fc3f7;
        }
        
        .badge-orange {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }
        
        .badge-red {
            background: rgba(244, 67, 54, 0.2);
            color: #ff6b6b;
        }
        
        .badge-gray {
            background: rgba(158, 158, 158, 0.2);
            color: #999;
        }
        
        /* Status Badges */
        .status-success { 
            background: rgba(118, 185, 0, 0.2);
            color: #76b900;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-fail { 
            background: rgba(244, 67, 54, 0.2);
            color: #ff6b6b;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-ssh-failed { 
            background: rgba(233, 30, 99, 0.2);
            color: #f48fb1;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-unreachable { 
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-warning { 
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-no-info { 
            background: rgba(158, 158, 158, 0.2);
            color: #999;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Device Link */
        .device-link {
            color: #4fc3f7;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .device-link:hover {
            color: #76b900;
            text-decoration: underline;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(0deg, #8bd400 0%, #6ba000 100%);
        }
        
        .btn-secondary {
            background: #404040;
            color: #d4d4d4;
        }
        
        .btn-secondary:hover {
            background: #505050;
        }
        
        .btn-info {
            background: linear-gradient(0deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(0deg, #42a5f5 0%, #2196f3 100%);
        }
        
        /* Device Search Box */
        .device-search-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .device-search-container .select2-container {
            min-width: 200px;
        }
        
        .device-search-container .select2-container--default .select2-selection--single {
            height: 36px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            color: #d4d4d4;
            padding-left: 10px;
            font-size: 13px;
        }
        
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #888;
        }
        
        .clear-search-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: none;
            transition: all 0.2s;
        }
        
        .clear-search-btn:hover {
            background: #d32f2f;
        }
        
        /* Hidden elements */
        #metinAlani-1 {
            display: none;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Select2 Dark Theme Override */
        .select2-dropdown {
            background: #2d2d2d;
            border: 1px solid #404040;
        }
        
        .select2-search__field {
            background: #3c3c3c !important;
            color: #d4d4d4 !important;
            border: 1px solid #555 !important;
        }
        
        .select2-results__option {
            color: #d4d4d4;
            padding: 8px 10px;
        }
        
        .select2-results__option--highlighted {
            background: #37373d !important;
            color: #76b900 !important;
        }
        
        .select2-results__option--selected {
            background: #404040 !important;
        }
    </style>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" type="text/css" href="/css/codemirror.min.css">
    <link rel="stylesheet" type="text/css" href="/css/codemirror-theme.min.css">
    <link rel="stylesheet" type="text/css" href="/css/codemirror-dialog.min.css">
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <div class="page-title">Asset Analysis Results</div>
            <div class="last-updated">Last Updated: <span id="last-updated"></span></div>
        </div>
        <div class="action-buttons">
            <!-- Device Search Box -->
            <div class="device-search-container">
                <select id="deviceSearch" style="width: 200px;">
                    <option value="">Search Device...</option>
                </select>
                <button id="clearSearchBtn" class="clear-search-btn" onclick="clearDeviceSearch()">✕</button>
            </div>
            <button id="refresh-assets" onclick="refreshAssets()" class="btn btn-info">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                </svg>
                <span id="refresh-assets-text">Refresh Assets</span>
            </button>
            <button id="edit-devices" onclick="openDevicesEditor()" class="btn btn-gray" style="display: none; background: #555; color: #d4d4d4;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                </svg>
                Edit Devices
            </button>
            <button id="download-csv" onclick="downloadCSV()" class="btn btn-primary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Download CSV
            </button>
        </div>
    </div>
    
    <!-- Summary Section -->
    <div class="dashboard-section" style="margin-bottom: 25px;">
        <div class="section-header">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            Overview
        </div>
        <div class="section-content">
    
    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-devices">0</div>
            <div class="card-label">Total Devices</div>
        </div>
        <div class="summary-card card-excellent">
            <div class="card-value" id="success-count">0</div>
            <div class="card-label">Successful</div>
        </div>
        <div class="summary-card card-critical">
            <div class="card-value" id="fail-count">0</div>
            <div class="card-label">Failed</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="warning-count">0</div>
            <div class="card-label">Warnings</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="no-info-count">0</div>
            <div class="card-label">No Information</div>
        </div>
    </div>
        </div>
    </div>
    
    <!-- Device Table Section -->
    <div class="dashboard-section">
        <div class="section-header">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1M9 5h1V3H9v2m0 8h1v-2H9v2m0 8h1v-2H9v2M5 3v2h2V3H5m0 8v2h2v-2H5m0 8v2h2v-2H5z"/>
            </svg>
            Device Asset Status
        </div>
        <div class="section-content">
            <table class="data-table" id="assets-table">
                <thead>
                <tr>
                    <th class="sortable" data-column="0" data-type="string">
                        Device Name <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="1" data-type="ip">
                        IP Address <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="2" data-type="string">
                        MAC Address <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="3" data-type="string">
                        Serial Number <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="4" data-type="string">
                        Model <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="5" data-type="string">
                        Release <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="6" data-type="uptime">
                        Uptime <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="7" data-type="status">
                        Status <span class="sort-arrow">▲▼</span>
                    </th>
                    <th class="sortable" data-column="8" data-type="string">
                        Last Seen <span class="sort-arrow">▲▼</span>
                    </th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="metinAlani-1" style="display: none;"></div>

    <!-- jQuery and Select2 for device search -->
    <script src="/css/jquery-3.5.1.min.js"></script>
    <script src="/css/select2.min.js"></script>

<script>
    function fetchAndDisplayAssetResults() {
        fetch('assets.ini')
            .then(response => response.text())
            .then(data => {
                // Extract timestamp from data (first line: "Created on YYYY-MM-DD HH-MM")
                const firstLine = data.split('\n')[0];
                if (firstLine.startsWith('Created on ')) {
                    const timestampStr = firstLine.replace('Created on ', '');
                    setLastUpdated(timestampStr);
                } else {
                    setLastUpdated();
                }
                
                displayAssetResults(data);
                generateAssetTable(data);
            })
            .catch(error => {
                console.error('Error fetching Asset results:', error);
                document.getElementById('metinAlani-1').innerHTML = '<p style="color: red;">Error loading asset data: ' + error.message + '</p>';
                setLastUpdated(); // Fallback to current time on error
            });
    }
    
    function setLastUpdated(timestampFromFile) {
        let dateToUse;
        
        if (timestampFromFile) {
            // Parse "2025-08-05 04-22-30" format from assets.ini
            const parts = timestampFromFile.trim().split(' ');
            if (parts.length === 2) {
                const datePart = parts[0]; // "2025-08-05"
                const timePart = parts[1].replace(/-/g, ':'); // "04-22-30" -> "04:22:30"
                dateToUse = new Date(datePart + 'T' + timePart);
            } else {
                // Fallback if format doesn't match
                dateToUse = new Date();
            }
        } else {
            // Fallback to current time if no timestamp available
            dateToUse = new Date();
        }
        
        const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        const formattedDate = dateToUse.toLocaleString('en-US', options);
        document.getElementById('last-updated').textContent = formattedDate;
    }

    function displayAssetResults(results) {
        const element = document.getElementById('metinAlani-1');
        element.innerHTML = '';
        const lines = results.split('\n');
        lines.forEach(line => {
            let colorClass = 'green';
            if (line.startsWith('DEVICE')) {
                colorClass = 'steelBlue';
            } else if (line.toLowerCase().includes('ssh-failed')) {
                colorClass = 'yellow';
            } else if (line.toLowerCase().includes('fail')) {
                colorClass = 'tomato';
            } else if (line.toLowerCase().includes('reated')) {
                colorClass = 'tomato';
            } else if (line.toLowerCase().includes('no-info')) {
                colorClass = 'red';
            }

            const span = document.createElement('span');
            span.className = colorClass;
            span.textContent = line;

            element.appendChild(span);
            element.appendChild(document.createElement('br'));
        });
    }

    function generateAssetTable(results) {
        const lines = results.split('\n').filter(line => line.trim() !== '');
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        
        // Clear existing rows in tbody
        tbody.innerHTML = '';
        
        let totalDevices = 0;
        let successCount = 0;
        let failCount = 0;
        let warningCount = 0;
        let noInfoCount = 0;
        
        // Parse each line and create table rows
        // New format: DEVICE-NAME IP ETH0-MAC SERIAL MODEL RELEASE UPTIME STATUS LAST-SEEN
        lines.forEach(line => {
            if (line.startsWith('DEVICE-NAME') || line.trim() === '') return;
            if (line.startsWith('Created on')) return;
            
            // Parse the structured data - split by whitespace
            const parts = line.trim().split(/\s+/);
            if (parts.length < 7) return;
            
            const deviceName = parts[0];
            const ipAddress = parts[1];
            const macAddress = parts[2];
            const serialNumber = parts[3];
            const model = parts[4];
            const release = parts[5];
            const uptime = parts[6];
            // STATUS is now a dedicated column (index 7)
            const rawStatus = parts[7] || '';
            // LAST-SEEN is the last column (index 8)
            const lastSeen = parts[8] || '-';
            
            let displayStatus, healthClass, statusClass;
            
            // Map status from assets.ini to display status
            const statusUpper = rawStatus.toUpperCase();
            
            if (statusUpper === 'OK') {
                displayStatus = 'SUCCESS';
                healthClass = 'assets-excellent';
                statusClass = 'status-success';
                successCount++;
            } else if (statusUpper === 'UNREACHABLE') {
                displayStatus = 'UNREACHABLE';
                healthClass = 'assets-unreachable';
                statusClass = 'status-unreachable';
                warningCount++;
            } else if (statusUpper === 'SSH-FAILED') {
                displayStatus = 'SSH FAILED';
                healthClass = 'assets-critical';
                statusClass = 'status-ssh-failed';
                failCount++;
            } else if (statusUpper === 'NO-INFO') {
                displayStatus = 'NO INFO';
                healthClass = 'assets-unknown';
                statusClass = 'status-no-info';
                noInfoCount++;
            } else if (statusUpper.includes('FAIL') || statusUpper.includes('ERROR')) {
                displayStatus = 'FAILED';
                healthClass = 'assets-critical';
                statusClass = 'status-fail';
                failCount++;
            } else if (rawStatus && uptime && uptime.includes('up-')) {
                displayStatus = 'SUCCESS';
                healthClass = 'assets-excellent';
                statusClass = 'status-success';
                successCount++;
            } else {
                displayStatus = rawStatus || 'UNKNOWN';
                healthClass = 'assets-warning';
                statusClass = 'status-warning';
                warningCount++;
            }
            
            totalDevices++;
            
            // Format last seen for display
            const lastSeenDisplay = lastSeen.replace(/_/g, ' ');
            
            const row = document.createElement('tr');
            row.setAttribute('data-health', healthClass);
            row.innerHTML = `
                <td><a href="device.html?device=${deviceName}" target="_blank" rel="noopener noreferrer" class="device-link">${deviceName}</a></td>
                <td>${ipAddress || 'N/A'}</td>
                <td>${macAddress || 'N/A'}</td>
                <td>${serialNumber || 'N/A'}</td>
                <td>${model || 'N/A'}</td>
                <td>${release || 'N/A'}</td>
                <td>${uptime || 'N/A'}</td>
                <td><span class="${statusClass}">${displayStatus}</span></td>
                <td>${lastSeenDisplay}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Update summary cards
        document.getElementById('total-devices').textContent = totalDevices;
        document.getElementById('success-count').textContent = successCount;
        document.getElementById('fail-count').textContent = failCount;
        document.getElementById('warning-count').textContent = warningCount;
        document.getElementById('no-info-count').textContent = noInfoCount;
        
        // Add click handlers to cards for filtering
        addCardClickHandlers();
        
        // Sort table by health (problems first)
        sortTableByHealth();
        
        // Initialize device search after table is populated
        populateDeviceList();
        initDeviceSearch();
    }
    
    function sortTableByHealth() {
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        
        rows.sort((a, b) => {
            const aStatus = a.cells[7].textContent.trim(); // Status is column 7 (8th column)
            const bStatus = b.cells[7].textContent.trim();
            
            const priority = {
                'FAILED': 0,
                'SSH FAILED': 1,
                'WARNING': 2,
                'NO INFO': 3,
                'SUCCESS': 4
            };
            
            return (priority[aStatus] || 4) - (priority[bStatus] || 4);
        });
        
        // Clear tbody and add sorted rows back
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }

    // Generic table sorting functionality
    let currentSort = { column: -1, direction: 'asc' };
    
    function initTableSorting() {
        const headers = document.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.addEventListener('click', function() {
                const column = parseInt(this.dataset.column);
                const type = this.dataset.type;
                
                // Toggle sort direction
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.direction = 'asc';
                }
                currentSort.column = column;
                
                // Update header styling
                headers.forEach(h => h.classList.remove('asc', 'desc'));
                this.classList.add(currentSort.direction);
                
                // Sort table
                sortTable(column, currentSort.direction, type);
            });
        });
    }
    
    function sortTable(columnIndex, direction, type) {
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        
        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex].textContent.trim();
            let bVal = b.cells[columnIndex].textContent.trim();
            
            // Extract actual text for status column (remove HTML)
            if (type === 'status') {
                aVal = a.cells[columnIndex].querySelector('span')?.textContent || aVal;
                bVal = b.cells[columnIndex].querySelector('span')?.textContent || bVal;
            }
            
            let result = 0;
            
            switch(type) {
                case 'ip':
                    result = compareIP(aVal, bVal);
                    break;
                case 'uptime':
                    result = compareUptime(aVal, bVal);
                    break;
                case 'status':
                    result = compareStatus(aVal, bVal);
                    break;
                case 'string':
                default:
                    result = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
                    break;
            }
            
            return direction === 'desc' ? -result : result;
        });
        
        // Clear tbody and add sorted rows back
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function compareIP(a, b) {
        if (a === 'N/A') return 1;
        if (b === 'N/A') return -1;
        
        const aNum = a.split('.').map(num => parseInt(num, 10));
        const bNum = b.split('.').map(num => parseInt(num, 10));
        
        for (let i = 0; i < 4; i++) {
            if (aNum[i] !== bNum[i]) {
                return aNum[i] - bNum[i];
            }
        }
        return 0;
    }
    
    function compareUptime(a, b) {
        if (a === 'N/A') return 1;
        if (b === 'N/A') return -1;
        
        // Convert uptime to minutes for comparison
        const getUptimeMinutes = (uptime) => {
            let minutes = 0;
            const weekMatch = uptime.match(/(\d+).*week/);
            const dayMatch = uptime.match(/(\d+).*day/);
            const hourMatch = uptime.match(/(\d+).*hour/);
            const minuteMatch = uptime.match(/(\d+).*minute/);
            
            if (weekMatch) minutes += parseInt(weekMatch[1]) * 7 * 24 * 60;
            if (dayMatch) minutes += parseInt(dayMatch[1]) * 24 * 60;
            if (hourMatch) minutes += parseInt(hourMatch[1]) * 60;
            if (minuteMatch) minutes += parseInt(minuteMatch[1]);
            
            return minutes;
        };
        
        return getUptimeMinutes(a) - getUptimeMinutes(b);
    }
    
    function compareStatus(a, b) {
        const priority = {
            'FAILED': 0,
            'WARNING': 1,
            'NO INFO': 2,
            'SUCCESS': 3
        };
        
        return (priority[a] || 4) - (priority[b] || 4);
    }
    // Refresh Assets Function
    function refreshAssets() {
        const button = document.getElementById('refresh-assets');
        const buttonText = document.getElementById('refresh-assets-text');
        const originalText = buttonText.textContent;
        
        // Disable button and show loading
        button.disabled = true;
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
        buttonText.textContent = 'Refreshing...';
        
        // Make request to trigger assets refresh (same mechanism as trigger-lldp)
        fetch('/trigger-assets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log('✅ Refresh assets response:', data);
            
            // Show success
            buttonText.textContent = '✓ Refreshed';
            button.style.background = 'linear-gradient(0deg, #76b900 0%, #5a8c00 100%)';
            
            // Show instruction notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2d2d2d;
                color: #d4d4d4;
                padding: 15px 20px;
                border-radius: 8px;
                border-left: 4px solid #76b900;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                z-index: 1000;
                font-size: 13px;
                max-width: 350px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            notification.innerHTML = `
                <strong style="color: #76b900;">✅ Assets Refresh Started</strong><br>
                Collecting device information in the background.<br>
                <small style="color: #888;">Page will automatically refresh in 10 seconds.</small>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-refresh page after 10 seconds (assets collection takes longer)
            setTimeout(() => {
                location.reload();
            }, 10000);
            
            // Auto-remove notification after 9 seconds (before refresh)
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 6000);
            
            // Reset button after 5 seconds
            setTimeout(() => {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.style.background = 'linear-gradient(0deg, #2196f3 0%, #1976d2 100%)';
                buttonText.textContent = originalText;
            }, 5000);
        })
        .catch(error => {
            console.error('❌ Error refreshing assets:', error);
            
            // Show error state
            buttonText.textContent = '✗ Error';
            button.style.background = '#f44336';
            
            // Show error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2d2d2d;
                color: #d4d4d4;
                padding: 15px 20px;
                border-radius: 8px;
                border-left: 4px solid #f44336;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                z-index: 1000;
                font-size: 13px;
                max-width: 300px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            notification.innerHTML = `
                <strong style="color: #ff6b6b;">Error!</strong><br>
                Could not refresh assets. Please try again or contact administrator.
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.style.background = 'linear-gradient(0deg, #2196f3 0%, #1976d2 100%)';
                buttonText.textContent = originalText;
            }, 3000);
        });
    }

    // CSV Download Function
    function downloadCSV() {
        try {
            // Get current date for filename
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
            const timeStr = now.toTimeString().slice(0, 5).replace(':', '-'); // HH-MM
            const filename = `Asset_Analysis_Report_${dateStr}_${timeStr}.csv`;
            
            // Create CSV header
            const headers = [
                'Device Name',
                'IP Address', 
                'MAC Address',
                'Serial Number',
                'Model',
                'Release',
                'Uptime',
                'Status'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            // Get table data (only visible rows)
            const table = document.getElementById('assets-table');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            
            // Add summary stats as comments
            csvContent += `# Asset Analysis Summary Report\n`;
            csvContent += `# Generated: ${now.toLocaleString()}\n`;
            csvContent += `# Total Devices: ${document.getElementById('total-devices').textContent}\n`;
            csvContent += `# Successful: ${document.getElementById('success-count').textContent}\n`;
            csvContent += `# Failed: ${document.getElementById('fail-count').textContent}\n`;
            csvContent += `# Warnings: ${document.getElementById('warning-count').textContent}\n`;
            csvContent += `# No Information: ${document.getElementById('no-info-count').textContent}\n`;
            csvContent += `#\n`;
            
            // Process each visible row
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        const rowData = [
                            cells[0].textContent.trim(), // Device Name
                            cells[1].textContent.trim(), // IP Address
                            cells[2].textContent.trim(), // MAC Address
                            cells[3].textContent.trim(), // Serial Number
                            cells[4].textContent.trim(), // Model
                            cells[5].textContent.trim(), // Release
                            cells[6].textContent.trim(), // Uptime
                            cells[7].textContent.trim()  // Status
                        ];
                        
                        // Escape commas and quotes in data
                        const escapedData = rowData.map(field => {
                            if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                                return '"' + field.replace(/"/g, '""') + '"';
                            }
                            return field;
                        });
                        
                        csvContent += escapedData.join(',') + '\n';
                    }
                }
            });
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`✅ CSV downloaded: ${filename}`);
            
        } catch (error) {
            console.error('❌ Error generating CSV:', error);
            alert('Error generating CSV file. Please try again.');
        }
    }

    // Card filtering functionality
    let currentFilter = 'all';
    
    function addCardClickHandlers() {
        // Add click handlers to summary cards for filtering
        document.querySelector('.card-total').addEventListener('click', () => filterTable('all'));
        document.querySelector('.card-excellent').addEventListener('click', () => filterTable('success'));
        document.querySelector('.card-critical').addEventListener('click', () => filterTable('failed'));
        document.querySelector('.card-warning').addEventListener('click', () => filterTable('warning'));
        document.querySelector('.card-info').addEventListener('click', () => filterTable('no-info'));
    }
    
    function filterTable(filterType) {
        currentFilter = filterType;
        
        // Clear device search when using card filters
        if (deviceSearchActive) {
            selectedDevice = '';
            deviceSearchActive = false;
            $('#deviceSearch').val('').trigger('change');
            document.getElementById('clearSearchBtn').style.display = 'none';
        }
        
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        
        // Remove active class from all cards
        document.querySelectorAll('.summary-card').forEach(card => card.classList.remove('active-filter'));
        
        rows.forEach(row => {
            const statusCell = row.cells[7]; // Status is column 7
            const statusText = statusCell.querySelector('span')?.textContent || statusCell.textContent;
            let shouldShow = true;
            
            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    document.querySelector('.card-total').classList.add('active-filter');
                    break;
                case 'success':
                    shouldShow = statusText === 'SUCCESS';
                    document.querySelector('.card-excellent').classList.add('active-filter');
                    break;
                case 'failed':
                    shouldShow = statusText === 'FAILED' || statusText === 'SSH FAILED';
                    document.querySelector('.card-critical').classList.add('active-filter');
                    break;
                case 'warning':
                    shouldShow = statusText === 'WARNING';
                    document.querySelector('.card-warning').classList.add('active-filter');
                    break;
                case 'no-info':
                    shouldShow = statusText === 'NO INFO';
                    document.querySelector('.card-info').classList.add('active-filter');
                    break;
            }
            
            row.style.display = shouldShow ? '' : 'none';
        });
    }

    // ===== Device Search Functions =====
    let deviceSearchActive = false;
    let selectedDevice = '';
    let allDevices = [];
    
    function initDeviceSearch() {
        // Initialize Select2 with search capability
        $('#deviceSearch').select2({
            placeholder: 'Search Device...',
            allowClear: true,
            width: '250px',
            dropdownAutoWidth: true,
            matcher: function(params, data) {
                // Custom matcher for case-insensitive search
                if ($.trim(params.term) === '') {
                    return data;
                }
                if (typeof data.text === 'undefined') {
                    return null;
                }
                if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                    return data;
                }
                return null;
            }
        });
        
        // Handle device selection
        $('#deviceSearch').on('select2:select', function(e) {
            const device = e.params.data.id;
            if (device) {
                filterByDevice(device);
            }
        });
        
        // Handle clear selection
        $('#deviceSearch').on('select2:clear', function(e) {
            clearDeviceSearch();
        });
    }
    
    function populateDeviceList() {
        // Collect all unique device names from table
        const deviceSet = new Set();
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const deviceName = row.cells[0]?.textContent?.trim();
            if (deviceName) deviceSet.add(deviceName);
        });
        
        allDevices = Array.from(deviceSet);
        
        // Sort devices alphabetically
        const sortedDevices = allDevices.sort((a, b) => 
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );
        
        // Clear existing options and populate
        const select = document.getElementById('deviceSearch');
        select.innerHTML = '<option value="">Search Device...</option>';
        
        sortedDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device;
            option.textContent = device;
            select.appendChild(option);
        });
        
        // Reinitialize Select2 with new options
        $('#deviceSearch').trigger('change');
    }
    
    function filterByDevice(deviceName) {
        if (!deviceName) return;
        
        selectedDevice = deviceName;
        deviceSearchActive = true;
        
        // Clear card-based filter
        currentFilter = 'all';
        document.querySelectorAll('.summary-card').forEach(card => {
            card.classList.remove('active-filter');
        });
        
        // Filter table rows
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        let matchCount = 0;
        
        rows.forEach(row => {
            const rowDeviceName = row.cells[0]?.textContent?.trim();
            if (rowDeviceName === deviceName) {
                row.style.display = '';
                matchCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show clear button
        document.getElementById('clearSearchBtn').style.display = 'inline-block';
        
        console.log(`Device filter: ${deviceName}, found ${matchCount} rows`);
    }
    
    function clearDeviceSearch() {
        selectedDevice = '';
        deviceSearchActive = false;
        
        // Clear Select2 selection
        $('#deviceSearch').val('').trigger('change');
        
        // Hide clear button
        document.getElementById('clearSearchBtn').style.display = 'none';
        
        // Show all rows
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => row.style.display = '');
    }

    window.onload = function() {
        fetchAndDisplayAssetResults();
        initTableSorting();
    };

    // ===== Devices Editor Functions =====
    let devicesEditor = null;
    
    function openDevicesEditor() {
        document.getElementById('devicesEditorModal').style.display = 'flex';
        document.getElementById('devicesEditorStatus').textContent = 'Loading...';
        
        fetch('/edit-devices')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Initialize CodeMirror if not already done
                    if (!devicesEditor) {
                        devicesEditor = CodeMirror(document.getElementById('devicesEditorContainer'), {
                            value: data.content,
                            mode: 'yaml',
                            theme: 'material-darker',
                            lineNumbers: true,
                            lineWrapping: true,
                            tabSize: 2,
                            indentWithTabs: false,
                            autofocus: true
                        });
                        devicesEditor.setSize('100%', '100%');
                    } else {
                        devicesEditor.setValue(data.content);
                    }
                    document.getElementById('devicesEditorStatus').textContent = 'Loaded successfully. Edit and save.';
                } else {
                    document.getElementById('devicesEditorStatus').textContent = 'Error: ' + data.error;
                }
            })
            .catch(err => {
                document.getElementById('devicesEditorStatus').textContent = 'Error loading: ' + err.message;
            });
    }

    function closeDevicesEditorModal() {
        document.getElementById('devicesEditorModal').style.display = 'none';
    }

    function closeDevicesEditor(event) {
        if (event.target === event.currentTarget) {
            closeDevicesEditorModal();
        }
    }

    function saveDevices() {
        const content = devicesEditor ? devicesEditor.getValue() : '';
        document.getElementById('devicesEditorStatus').textContent = 'Saving...';
        
        fetch('/edit-devices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('devicesEditorStatus').textContent = '✓ Saved successfully!';
                document.getElementById('devicesEditorStatus').style.color = '#76b900';
                setTimeout(() => {
                    document.getElementById('devicesEditorStatus').style.color = '#888';
                }, 3000);
            } else {
                document.getElementById('devicesEditorStatus').textContent = 'Error: ' + data.error;
                document.getElementById('devicesEditorStatus').style.color = '#ff6b6b';
            }
        })
        .catch(err => {
            document.getElementById('devicesEditorStatus').textContent = 'Error: ' + err.message;
            document.getElementById('devicesEditorStatus').style.color = '#ff6b6b';
        });
    }

    function saveDevicesAndRun() {
        const content = devicesEditor ? devicesEditor.getValue() : '';
        document.getElementById('devicesEditorStatus').textContent = 'Saving...';
        
        fetch('/edit-devices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('devicesEditorStatus').textContent = '✓ Saved! Refreshing Assets...';
                closeDevicesEditorModal();
                refreshAssets();
            } else {
                document.getElementById('devicesEditorStatus').textContent = 'Error: ' + data.error;
                document.getElementById('devicesEditorStatus').style.color = '#ff6b6b';
            }
        })
        .catch(err => {
            document.getElementById('devicesEditorStatus').textContent = 'Error: ' + err.message;
        });
    }
</script>

<!-- CodeMirror for syntax highlighting -->
<script src="/css/codemirror.min.js"></script>
<script src="/css/codemirror-dialog.min.js"></script>
<script src="/css/codemirror-searchcursor.min.js"></script>
<script src="/css/codemirror-search.min.js"></script>
<script src="/css/codemirror-jump-to-line.min.js"></script>
<script src="/css/codemirror-yaml.min.js"></script>

<!-- Auth check for admin-only buttons -->
<script src="/css/auth.js"></script>
<script>
    (async function() {
        await LLDPqAuth.check();
        if (LLDPqAuth.isAdmin()) {
            document.getElementById('edit-devices').style.display = 'flex';
        }
    })();
</script>

<!-- Devices Editor Modal -->
<div id="devicesEditorModal" onclick="closeDevicesEditor(event)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
    <div onclick="event.stopPropagation()" style="background: #2d2d2d; border-radius: 8px; width: 85%; max-width: 1000px; max-height: 90vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
        <div style="padding: 15px 20px; background: #1a1a1a; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #76b900; font-size: 16px;">Edit Devices (devices.yaml)</h3>
            <button onclick="closeDevicesEditorModal()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
        <div style="padding: 0;">
            <div style="padding: 15px; background: #333; border-bottom: 1px solid #4a4a4a; font-size: 12px; color: #888;">
                Format: <code style="color: #76b900;">IP: Hostname @role</code> &nbsp;|&nbsp; 
                Example: <code style="color: #4fc3f7;">10.10.100.10: Spine1 @spine</code>
            </div>
            <div id="devicesEditorContainer" style="height: 55vh; border: none;"></div>
            <div style="padding: 15px; background: #333; border-top: 1px solid #4a4a4a; text-align: right; display: flex; justify-content: space-between; align-items: center;">
                <span id="devicesEditorStatus" style="color: #888; font-size: 12px;"></span>
                <div>
                    <button onclick="closeDevicesEditorModal()" style="background: #555; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                    <button onclick="saveDevices()" style="background: #607d8b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Save</button>
                    <button onclick="saveDevicesAndRun()" style="background: #76b900; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Save & Run LLDPq</button>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>