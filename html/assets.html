<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <title>..::LLDPQ::..</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="/css/styles2.css">
    <link rel="stylesheet" type="text/css" href="/css/select2.min.css">
    <style>
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .summary-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .card-excellent { border-left-color: #4caf50; }
        .card-good { border-left-color: #8bc34a; }
        .card-warning { border-left-color: #ff9800; }
        .card-critical { border-left-color: #f44336; }
        .card-total { border-left-color: #2196f3; }
        
        /* Active filter card styling */
        .summary-card.active-filter {
            background: #e3f2fd !important;
            border-left-width: 6px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
            transform: scale(1.02);
            cursor: default;
        }
        
        /* Make cards clickable */
        .summary-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover:not(.active-filter) {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .card-value { font-size: 24px; font-weight: bold; color: #333; }
        
        /* Colored card values */
        .card-excellent .card-value { color: #4caf50; }
        .card-good .card-value { color: #8bc34a; }
        .card-warning .card-value { color: #ff9800; }
        .card-critical .card-value { color: #f44336; }
        .card-total .card-value { color: #333; }
        .card-info .card-value { color: #2196f3; }
        .card-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .assets-excellent { color: #4caf50; font-weight: bold; }
        .assets-good { color: #8bc34a; font-weight: bold; }
        .assets-warning { color: #ff9800; font-weight: bold; }
        .assets-critical { color: #f44336; font-weight: bold; }
        .assets-unknown { color: gray; }
        
        .assets-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .assets-table th, .assets-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .assets-table th { background-color: #f2f2f2; }
        
        .steelBlue { color: steelblue; }
        .tomato { color: tomato; }
        .red { color: red; }
        .green { color: green; }
        .lime { color: lime; }
        
        #metinAlani-1 {
            white-space: pre;
            font-family: monospace;
            font-size: 15px;
        }
        
        .status-success { color: #4caf50; font-weight: bold; }
        .status-fail { color: #f44336; font-weight: bold; }
        .status-ssh-failed { color: #e91e63; font-weight: bold; }
        .status-warning { color: #ff9800; font-weight: bold; }
        .status-no-info { color: #f44336; font-weight: bold; }
        
        /* Device name link hover effect */
        .assets-table .device-link {
            color: inherit;
            text-decoration: underline;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .assets-table .device-link:hover {
            color: #b57614 !important;
            text-decoration: underline;
            text-shadow: 0 0 8px rgba(181, 118, 20, 0.6);
            transform: scale(1.05);
        }
        
        .assets-table .device-link:active {
            transform: scale(0.98);
        }
        
        /* Sortable table styling */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }
        
        .sortable:hover {
            background-color: #f5f5f5;
        }
        
        .sort-arrow {
            font-size: 10px;
            color: #999;
            margin-left: 5px;
            opacity: 0.5;
        }
        
        .sortable.asc .sort-arrow::before {
            content: '▲';
            color: #b57614;
            opacity: 1;
        }
        
        .sortable.desc .sort-arrow::before {
            content: '▼';
            color: #b57614;
            opacity: 1;
        }
        
        .sortable.asc .sort-arrow,
        .sortable.desc .sort-arrow {
            opacity: 1;
        }
        
        /* Device Search Box - Match Run button height (padding 8px + font 14px + border) */
        .device-search-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .device-search-container .select2-container {
            min-width: 250px;
        }
        .device-search-container .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ccc;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
            color: #333;
            padding-left: 8px;
            font-size: 14px;
        }
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #999;
        }
        .clear-search-btn {
            background: #ff5722;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: none;
            transition: all 0.3s ease;
        }
        .clear-search-btn:hover {
            background: #e64a19;
        }
    </style>
</head>
<body>
    <h1></h1>
    <h1><font color="#b57614">Asset Analysis Results</font></h1>
    <p><strong>Last Updated:</strong> <span id="last-updated"></span></p>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Asset Summary</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
        <!-- Device Search Box -->
        <div class="device-search-container">
            <select id="deviceSearch" style="width: 250px;">
                <option value="">Search Device...</option>
            </select>
            <button id="clearSearchBtn" class="clear-search-btn" onclick="clearDeviceSearch()">✕</button>
        </div>
        <button id="run-lldp" onclick="runLLDPCheck()" 
                style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                onmouseover="this.style.background='#1976d2'" 
                onmouseout="this.style.background='#2196f3'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
            </svg>
            <span id="run-lldp-text">Run LLDP Check</span>
        </button>
        <button id="download-csv" onclick="downloadCSV()" 
                style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                onmouseover="this.style.background='#45a049'" 
                onmouseout="this.style.background='#4caf50'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
            Download CSV
        </button>
        </div>
    </div>
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-devices">0</div>
            <div class="card-label">Total Devices</div>
        </div>
        <div class="summary-card card-excellent">
            <div class="card-value" id="success-count">0</div>
            <div class="card-label">Successful</div>
        </div>
        <div class="summary-card card-critical">
            <div class="card-value" id="fail-count">0</div>
            <div class="card-label">Failed</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="warning-count">0</div>
            <div class="card-label">Warnings</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="no-info-count">0</div>
            <div class="card-label">No Information</div>
        </div>
    </div>
    
    <h2>Device Asset Status</h2>
    <table class="assets-table" id="assets-table">
        <thead>
        <tr>
            <th class="sortable" data-column="0" data-type="string">
                Device Name <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="1" data-type="ip">
                IP Address <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="2" data-type="string">
                MAC Address <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="3" data-type="string">
                Serial Number <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="4" data-type="string">
                Model <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="5" data-type="string">
                Release <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="6" data-type="uptime">
                Uptime <span class="sort-arrow">▲▼</span>
            </th>
            <th class="sortable" data-column="7" data-type="status">
                Status <span class="sort-arrow">▲▼</span>
            </th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    
    <div id="metinAlani-1" style="display: none;"></div>

    <!-- jQuery and Select2 for device search -->
    <script src="/css/jquery-3.5.1.min.js"></script>
    <script src="/css/select2.min.js"></script>

<script>
    function fetchAndDisplayAssetResults() {
        fetch('assets.ini')
            .then(response => response.text())
            .then(data => {
                // Extract timestamp from data (first line: "Created on YYYY-MM-DD HH-MM")
                const firstLine = data.split('\n')[0];
                if (firstLine.startsWith('Created on ')) {
                    const timestampStr = firstLine.replace('Created on ', '');
                    setLastUpdated(timestampStr);
                } else {
                    setLastUpdated();
                }
                
                displayAssetResults(data);
                generateAssetTable(data);
            })
            .catch(error => {
                console.error('Error fetching Asset results:', error);
                document.getElementById('metinAlani-1').innerHTML = '<p style="color: red;">Error loading asset data: ' + error.message + '</p>';
                setLastUpdated(); // Fallback to current time on error
            });
    }
    
    function setLastUpdated(timestampFromFile) {
        let dateToUse;
        
        if (timestampFromFile) {
            // Parse "2025-08-05 04-22-30" format from assets.ini
            const parts = timestampFromFile.trim().split(' ');
            if (parts.length === 2) {
                const datePart = parts[0]; // "2025-08-05"
                const timePart = parts[1].replace(/-/g, ':'); // "04-22-30" -> "04:22:30"
                dateToUse = new Date(datePart + 'T' + timePart);
            } else {
                // Fallback if format doesn't match
                dateToUse = new Date();
            }
        } else {
            // Fallback to current time if no timestamp available
            dateToUse = new Date();
        }
        
        const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        const formattedDate = dateToUse.toLocaleString('en-US', options);
        document.getElementById('last-updated').textContent = formattedDate;
    }

    function displayAssetResults(results) {
        const element = document.getElementById('metinAlani-1');
        element.innerHTML = '';
        const lines = results.split('\n');
        lines.forEach(line => {
            let colorClass = 'green';
            if (line.startsWith('DEVICE')) {
                colorClass = 'steelBlue';
            } else if (line.toLowerCase().includes('ssh-failed')) {
                colorClass = 'yellow';
            } else if (line.toLowerCase().includes('fail')) {
                colorClass = 'tomato';
            } else if (line.toLowerCase().includes('reated')) {
                colorClass = 'tomato';
            } else if (line.toLowerCase().includes('no-info')) {
                colorClass = 'red';
            }

            const span = document.createElement('span');
            span.className = colorClass;
            span.textContent = line;

            element.appendChild(span);
            element.appendChild(document.createElement('br'));
        });
    }

    function generateAssetTable(results) {
        const lines = results.split('\n').filter(line => line.trim() !== '');
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        
        // Clear existing rows in tbody
        tbody.innerHTML = '';
        
        let totalDevices = 0;
        let successCount = 0;
        let failCount = 0;
        let warningCount = 0;
        let noInfoCount = 0;
        
        // Parse each line and create table rows
        lines.forEach(line => {
            if (line.startsWith('DEVICE-NAME') || line.trim() === '') return;
            
            // Parse the structured data - split by whitespace but handle columns properly
            const parts = line.trim().split(/\s+/);
            if (parts.length < 6) return;
            
            const deviceName = parts[0];
            const ipAddress = parts[1];
            const macAddress = parts[2];
            const serialNumber = parts[3];
            const model = parts[4];
            const release = parts[5];
            // Uptime might have multiple parts, join the rest
            const uptime = parts.slice(6).join(' ');
            
            let status, healthClass, statusClass;
            
            // Determine status based on asset collection results
            const lineText = line.toLowerCase();
            
            if (lineText.includes('ssh-failed') || (ipAddress && ipAddress !== 'No-Info' && macAddress === 'SSH-FAILED')) {
                status = 'SSH FAILED';
                healthClass = 'assets-critical';
                statusClass = 'status-ssh-failed';
                failCount++;
            } else if (lineText.includes('fail') || lineText.includes('error') || lineText.includes('timeout')) {
                status = 'FAILED';
                healthClass = 'assets-critical';
                statusClass = 'status-fail';
                failCount++;
            } else if (lineText.includes('no-info') || lineText.includes('no info') || 
                       (!ipAddress || ipAddress === 'N/A' || !macAddress || macAddress === 'N/A')) {
                status = 'NO INFO';
                healthClass = 'assets-unknown';
                statusClass = 'status-no-info';
                noInfoCount++;
            } else if (lineText.includes('reated') || lineText.includes('partial') || lineText.includes('warning')) {
                status = 'WARNING';
                healthClass = 'assets-warning';
                statusClass = 'status-warning';
                warningCount++;
            } else if (uptime && uptime.includes('up-') && ipAddress && macAddress && 
                       ipAddress !== 'N/A' && macAddress !== 'N/A') {
                // Device is up and all asset info collected successfully
                status = 'SUCCESS';
                healthClass = 'assets-excellent';
                statusClass = 'status-success';
                successCount++;
            } else {
                status = 'WARNING';
                healthClass = 'assets-warning';
                statusClass = 'status-warning';
                warningCount++;
            }
            
            totalDevices++;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><a href="monitor-results/${deviceName}.html" target="_blank" rel="noopener noreferrer" class="device-link">${deviceName}</a></td>
                <td>${ipAddress || 'N/A'}</td>
                <td>${macAddress || 'N/A'}</td>
                <td>${serialNumber || 'N/A'}</td>
                <td>${model || 'N/A'}</td>
                <td>${release || 'N/A'}</td>
                <td>${uptime || 'N/A'}</td>
                <td><span class="${statusClass}">${status}</span></td>
            `;
            tbody.appendChild(row);
        });
        
        // Update summary cards
        document.getElementById('total-devices').textContent = totalDevices;
        document.getElementById('success-count').textContent = successCount;
        document.getElementById('fail-count').textContent = failCount;
        document.getElementById('warning-count').textContent = warningCount;
        document.getElementById('no-info-count').textContent = noInfoCount;
        
        // Add click handlers to cards for filtering
        addCardClickHandlers();
        
        // Sort table by health (problems first)
        sortTableByHealth();
        
        // Initialize device search after table is populated
        populateDeviceList();
        initDeviceSearch();
    }
    
    function sortTableByHealth() {
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        
        rows.sort((a, b) => {
            const aStatus = a.cells[7].textContent.trim(); // Status is column 7 (8th column)
            const bStatus = b.cells[7].textContent.trim();
            
            const priority = {
                'FAILED': 0,
                'SSH FAILED': 1,
                'WARNING': 2,
                'NO INFO': 3,
                'SUCCESS': 4
            };
            
            return (priority[aStatus] || 4) - (priority[bStatus] || 4);
        });
        
        // Clear tbody and add sorted rows back
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }

    // Generic table sorting functionality
    let currentSort = { column: -1, direction: 'asc' };
    
    function initTableSorting() {
        const headers = document.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.addEventListener('click', function() {
                const column = parseInt(this.dataset.column);
                const type = this.dataset.type;
                
                // Toggle sort direction
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.direction = 'asc';
                }
                currentSort.column = column;
                
                // Update header styling
                headers.forEach(h => h.classList.remove('asc', 'desc'));
                this.classList.add(currentSort.direction);
                
                // Sort table
                sortTable(column, currentSort.direction, type);
            });
        });
    }
    
    function sortTable(columnIndex, direction, type) {
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        
        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex].textContent.trim();
            let bVal = b.cells[columnIndex].textContent.trim();
            
            // Extract actual text for status column (remove HTML)
            if (type === 'status') {
                aVal = a.cells[columnIndex].querySelector('span')?.textContent || aVal;
                bVal = b.cells[columnIndex].querySelector('span')?.textContent || bVal;
            }
            
            let result = 0;
            
            switch(type) {
                case 'ip':
                    result = compareIP(aVal, bVal);
                    break;
                case 'uptime':
                    result = compareUptime(aVal, bVal);
                    break;
                case 'status':
                    result = compareStatus(aVal, bVal);
                    break;
                case 'string':
                default:
                    result = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
                    break;
            }
            
            return direction === 'desc' ? -result : result;
        });
        
        // Clear tbody and add sorted rows back
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function compareIP(a, b) {
        if (a === 'N/A') return 1;
        if (b === 'N/A') return -1;
        
        const aNum = a.split('.').map(num => parseInt(num, 10));
        const bNum = b.split('.').map(num => parseInt(num, 10));
        
        for (let i = 0; i < 4; i++) {
            if (aNum[i] !== bNum[i]) {
                return aNum[i] - bNum[i];
            }
        }
        return 0;
    }
    
    function compareUptime(a, b) {
        if (a === 'N/A') return 1;
        if (b === 'N/A') return -1;
        
        // Convert uptime to minutes for comparison
        const getUptimeMinutes = (uptime) => {
            let minutes = 0;
            const weekMatch = uptime.match(/(\d+).*week/);
            const dayMatch = uptime.match(/(\d+).*day/);
            const hourMatch = uptime.match(/(\d+).*hour/);
            const minuteMatch = uptime.match(/(\d+).*minute/);
            
            if (weekMatch) minutes += parseInt(weekMatch[1]) * 7 * 24 * 60;
            if (dayMatch) minutes += parseInt(dayMatch[1]) * 24 * 60;
            if (hourMatch) minutes += parseInt(hourMatch[1]) * 60;
            if (minuteMatch) minutes += parseInt(minuteMatch[1]);
            
            return minutes;
        };
        
        return getUptimeMinutes(a) - getUptimeMinutes(b);
    }
    
    function compareStatus(a, b) {
        const priority = {
            'FAILED': 0,
            'WARNING': 1,
            'NO INFO': 2,
            'SUCCESS': 3
        };
        
        return (priority[a] || 4) - (priority[b] || 4);
    }
    // Run LLDP Check Function
    function runLLDPCheck() {
        const button = document.getElementById('run-lldp');
        const buttonText = document.getElementById('run-lldp-text');
        const originalText = buttonText.textContent;
        
        // Disable button and show loading
        button.disabled = true;
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
        buttonText.textContent = 'Running...';
        
        // Make request to trigger LLDP check via simple endpoint
        fetch('/trigger-lldp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log('✅ LLDP check response:', data);
            
            // Always show manual trigger instruction
            buttonText.textContent = '✓ Triggered';
            button.style.background = '#4caf50';
            
            // Show instruction notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2196f3;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 14px;
                max-width: 350px;
                font-family: monospace;
            `;
            notification.innerHTML = `
                <strong>✅ LLDP Check Started</strong><br>
                The topology analysis is running in the background.<br>
                <small>Page will automatically refresh in 5 seconds to show the latest results.</small>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-refresh page after 7 seconds
            setTimeout(() => {
                location.reload();
            }, 7000);
            
            // Auto-remove notification after 6 seconds (before refresh)
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 6000);
            
            // Reset button after 5 seconds
            setTimeout(() => {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.style.background = '#2196f3';
                buttonText.textContent = originalText;
            }, 5000);
        })
        .catch(error => {
            console.error('❌ Error running LLDP check:', error);
            
            // Show error state
            buttonText.textContent = '✗ Error';
            button.style.background = '#f44336';
            
            // Show error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 14px;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <strong>Error!</strong><br>
                Could not start LLDP check. Please try again or contact administrator.
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove notification after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.style.background = '#2196f3';
                buttonText.textContent = originalText;
            }, 3000);
        });
    }

    // CSV Download Function
    function downloadCSV() {
        try {
            // Get current date for filename
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
            const timeStr = now.toTimeString().slice(0, 5).replace(':', '-'); // HH-MM
            const filename = `Asset_Analysis_Report_${dateStr}_${timeStr}.csv`;
            
            // Create CSV header
            const headers = [
                'Device Name',
                'IP Address', 
                'MAC Address',
                'Serial Number',
                'Model',
                'Release',
                'Uptime',
                'Status'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            // Get table data (only visible rows)
            const table = document.getElementById('assets-table');
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            
            // Add summary stats as comments
            csvContent += `# Asset Analysis Summary Report\n`;
            csvContent += `# Generated: ${now.toLocaleString()}\n`;
            csvContent += `# Total Devices: ${document.getElementById('total-devices').textContent}\n`;
            csvContent += `# Successful: ${document.getElementById('success-count').textContent}\n`;
            csvContent += `# Failed: ${document.getElementById('fail-count').textContent}\n`;
            csvContent += `# Warnings: ${document.getElementById('warning-count').textContent}\n`;
            csvContent += `# No Information: ${document.getElementById('no-info-count').textContent}\n`;
            csvContent += `#\n`;
            
            // Process each visible row
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        const rowData = [
                            cells[0].textContent.trim(), // Device Name
                            cells[1].textContent.trim(), // IP Address
                            cells[2].textContent.trim(), // MAC Address
                            cells[3].textContent.trim(), // Serial Number
                            cells[4].textContent.trim(), // Model
                            cells[5].textContent.trim(), // Release
                            cells[6].textContent.trim(), // Uptime
                            cells[7].textContent.trim()  // Status
                        ];
                        
                        // Escape commas and quotes in data
                        const escapedData = rowData.map(field => {
                            if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                                return '"' + field.replace(/"/g, '""') + '"';
                            }
                            return field;
                        });
                        
                        csvContent += escapedData.join(',') + '\n';
                    }
                }
            });
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`✅ CSV downloaded: ${filename}`);
            
        } catch (error) {
            console.error('❌ Error generating CSV:', error);
            alert('Error generating CSV file. Please try again.');
        }
    }

    // Card filtering functionality
    let currentFilter = 'all';
    
    function addCardClickHandlers() {
        // Add click handlers to summary cards for filtering
        document.querySelector('.card-total').addEventListener('click', () => filterTable('all'));
        document.querySelector('.card-excellent').addEventListener('click', () => filterTable('success'));
        document.querySelector('.card-critical').addEventListener('click', () => filterTable('failed'));
        document.querySelector('.card-warning').addEventListener('click', () => filterTable('warning'));
        document.querySelector('.card-info').addEventListener('click', () => filterTable('no-info'));
    }
    
    function filterTable(filterType) {
        currentFilter = filterType;
        
        // Clear device search when using card filters
        if (deviceSearchActive) {
            selectedDevice = '';
            deviceSearchActive = false;
            $('#deviceSearch').val('').trigger('change');
            document.getElementById('clearSearchBtn').style.display = 'none';
        }
        
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        
        // Remove active class from all cards
        document.querySelectorAll('.summary-card').forEach(card => card.classList.remove('active-filter'));
        
        rows.forEach(row => {
            const statusCell = row.cells[7]; // Status is column 7
            const statusText = statusCell.querySelector('span')?.textContent || statusCell.textContent;
            let shouldShow = true;
            
            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    document.querySelector('.card-total').classList.add('active-filter');
                    break;
                case 'success':
                    shouldShow = statusText === 'SUCCESS';
                    document.querySelector('.card-excellent').classList.add('active-filter');
                    break;
                case 'failed':
                    shouldShow = statusText === 'FAILED' || statusText === 'SSH FAILED';
                    document.querySelector('.card-critical').classList.add('active-filter');
                    break;
                case 'warning':
                    shouldShow = statusText === 'WARNING';
                    document.querySelector('.card-warning').classList.add('active-filter');
                    break;
                case 'no-info':
                    shouldShow = statusText === 'NO INFO';
                    document.querySelector('.card-info').classList.add('active-filter');
                    break;
            }
            
            row.style.display = shouldShow ? '' : 'none';
        });
    }

    // ===== Device Search Functions =====
    let deviceSearchActive = false;
    let selectedDevice = '';
    let allDevices = [];
    
    function initDeviceSearch() {
        // Initialize Select2 with search capability
        $('#deviceSearch').select2({
            placeholder: 'Search Device...',
            allowClear: true,
            width: '250px',
            dropdownAutoWidth: true,
            matcher: function(params, data) {
                // Custom matcher for case-insensitive search
                if ($.trim(params.term) === '') {
                    return data;
                }
                if (typeof data.text === 'undefined') {
                    return null;
                }
                if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                    return data;
                }
                return null;
            }
        });
        
        // Handle device selection
        $('#deviceSearch').on('select2:select', function(e) {
            const device = e.params.data.id;
            if (device) {
                filterByDevice(device);
            }
        });
        
        // Handle clear selection
        $('#deviceSearch').on('select2:clear', function(e) {
            clearDeviceSearch();
        });
    }
    
    function populateDeviceList() {
        // Collect all unique device names from table
        const deviceSet = new Set();
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const deviceName = row.cells[0]?.textContent?.trim();
            if (deviceName) deviceSet.add(deviceName);
        });
        
        allDevices = Array.from(deviceSet);
        
        // Sort devices alphabetically
        const sortedDevices = allDevices.sort((a, b) => 
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );
        
        // Clear existing options and populate
        const select = document.getElementById('deviceSearch');
        select.innerHTML = '<option value="">Search Device...</option>';
        
        sortedDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device;
            option.textContent = device;
            select.appendChild(option);
        });
        
        // Reinitialize Select2 with new options
        $('#deviceSearch').trigger('change');
    }
    
    function filterByDevice(deviceName) {
        if (!deviceName) return;
        
        selectedDevice = deviceName;
        deviceSearchActive = true;
        
        // Clear card-based filter
        currentFilter = 'all';
        document.querySelectorAll('.summary-card').forEach(card => {
            card.classList.remove('active-filter');
        });
        
        // Filter table rows
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        let matchCount = 0;
        
        rows.forEach(row => {
            const rowDeviceName = row.cells[0]?.textContent?.trim();
            if (rowDeviceName === deviceName) {
                row.style.display = '';
                matchCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show clear button
        document.getElementById('clearSearchBtn').style.display = 'inline-block';
        
        console.log(`Device filter: ${deviceName}, found ${matchCount} rows`);
    }
    
    function clearDeviceSearch() {
        selectedDevice = '';
        deviceSearchActive = false;
        
        // Clear Select2 selection
        $('#deviceSearch').val('').trigger('change');
        
        // Hide clear button
        document.getElementById('clearSearchBtn').style.display = 'none';
        
        // Show all rows
        const table = document.getElementById('assets-table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => row.style.display = '');
    }

    window.onload = function() {
        fetchAndDisplayAssetResults();
        initTableSorting();
    };
</script>
</body>
</html>