<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provision - ZTP & Base Config</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <style>
        /* Prevent browser autofill from changing input background */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 1000px #1a1a1a inset !important;
            -webkit-text-fill-color: #fff !important;
            caret-color: #fff !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
        }

        .page-subtitle {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-status {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #555;
        }

        .status-dot.active { background: #4caf50; }
        .status-dot.inactive { background: #f44336; }
        .status-dot.unknown { background: #ff9800; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3c3c3c;
            padding-bottom: 0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #808080;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #d4d4d4;
            background: #2d2d2d;
        }

        .tab-btn.active {
            color: #76b900;
            border-bottom-color: #76b900;
        }

        .tab-btn .tab-badge {
            background: #76b900;
            color: #000;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn svg { width: 16px; height: 16px; fill: currentColor; }

        .btn-primary {
            background: #76b900;
            color: #000;
        }
        .btn-primary:hover { background: #8cd000; }
        .btn-primary:disabled { background: #3d5e00; color: #666; cursor: not-allowed; }

        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
        }
        .btn-secondary:hover { background: #4a4a4a; }

        .btn-danger {
            background: #c62828;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .btn-warning {
            background: #e65100;
            color: white;
        }
        .btn-warning:hover { background: #ff6d00; }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: #1e1e1e;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #3c3c3c;
            color: #808080;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .data-table tr:hover {
            background: #2d2d2d;
        }

        .data-table .row-actions {
            display: flex;
            gap: 5px;
        }

        /* Scrollable table wrapper */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar { width: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: #1e1e1e; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* Form Elements */
        .form-input {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #76b900;
        }

        .form-input.input-mac { width: 160px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-ip { width: 140px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-hostname { width: 200px; }

        select.form-input {
            cursor: pointer;
        }

        /* Search/Filter */
        .search-filter {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            width: 250px;
        }

        .search-filter:focus {
            outline: none;
            border-color: #76b900;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #1b5e20; color: #4caf50; }
        .badge-error { background: #4a1515; color: #f44336; }
        .badge-warning { background: #4a3000; color: #ff9800; }
        .badge-info { background: #0d3b66; color: #42a5f5; }
        .badge-mismatch { background: #4a1515; color: #ff6b6b; }
        .badge-match { background: #1b5e20; color: #66bb6a; }
        .badge-pending { background: #333; color: #999; }
        .badge-active { background: #1b5e20; color: #4caf50; }
        .badge-expired { background: #4a1515; color: #f44336; }

        /* Inline edit row */
        .edit-row td {
            background: #1a3000 !important;
        }

        .add-row {
            background: #1e2a1e;
            border-top: 2px solid #76b900;
        }

        .add-row td {
            padding: 10px 12px;
        }

        /* Section headers */
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #76b900;
            margin-bottom: 10px;
        }

        .section-desc {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #1e1e1e;
            padding: 12px 20px;
            border-radius: 6px;
            border-left: 3px solid #76b900;
            min-width: 120px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #76b900;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* ZTP Script Editor */
        .editor-container {
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            overflow: hidden;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3c3c3c;
        }

        .editor-filename {
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            color: #76b900;
        }

        .editor-textarea {
            width: 100%;
            min-height: 500px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            tab-size: 4;
        }

        .editor-textarea:focus {
            outline: none;
        }

        /* Key-Value config display */
        .config-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .config-label {
            color: #888;
            font-size: 13px;
            padding: 8px 0;
            text-align: right;
            padding-right: 15px;
        }

        .config-value {
            padding: 8px 12px;
        }

        /* DHCP Lease table colors */
        .lease-active { color: #4caf50; }
        .lease-expired { color: #f44336; }

        /* Base Config file list ‚Äî compact */
        .file-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .file-card {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
            cursor: pointer;
            font-size: 12px;
        }

        .file-card:hover {
            border-color: #555;
            background: #252526;
        }

        .file-card.selected {
            border-color: #76b900;
            background: #1a2e00;
        }

        .file-card input[type="checkbox"] {
            accent-color: #76b900;
            width: 14px;
            height: 14px;
            margin: 0;
        }

        .file-icon {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-icon svg { width: 14px; height: 14px; fill: #76b900; }
        .file-icon.binary svg { fill: #ff9800; }

        .file-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-name {
            font-size: 12px;
            font-weight: 600;
            color: #d4d4d4;
        }

        .file-dest {
            font-size: 10px;
            color: #666;
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        /* Deploy progress */
        .deploy-progress {
            max-height: 400px;
            overflow-y: auto;
        }

        .deploy-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .deploy-item .hostname {
            width: 200px;
            font-weight: 500;
        }

        .deploy-item .ip {
            width: 140px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 12px;
            color: #888;
        }

        .deploy-item .status {
            flex: 1;
        }

        .deploy-item .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: #1b5e20;
            color: #4caf50;
            border: 1px solid #2e7d32;
        }

        .toast-error {
            background: #4a1515;
            color: #f44336;
            border: 1px solid #c62828;
        }

        .toast-info {
            background: #0d3b66;
            color: #42a5f5;
            border: 1px solid #1565c0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            fill: #555;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            color: #888;
            margin-bottom: 8px;
        }

        /* Modal / Add Binding Form */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 25px;
            min-width: 450px;
            max-width: 600px;
        }

        .modal h3 {
            color: #76b900;
            margin-bottom: 20px;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .modal-field input, .modal-field select {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-field input:focus, .modal-field select:focus {
            outline: none;
            border-color: #76b900;
        }

        .modal-field input.mono {
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Device selector ‚Äî compact chips */
        .device-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
            max-height: 180px;
            overflow-y: auto;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
        }

        .device-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .device-chip:hover { border-color: #555; }

        .device-chip.selected {
            background: #1a2e00;
            border-color: #76b900;
            color: #76b900;
        }

        .device-chip input[type="checkbox"] {
            accent-color: #76b900;
            width: 12px;
            height: 12px;
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-btn { padding: 10px 16px; font-size: 12px; }
            .toolbar { flex-direction: column; }
            .config-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Page Header -->
<div class="page-header">
    <div>
        <div class="page-title">Provision</div>
        <div class="page-subtitle">ZTP Management & Base Config Deployment</div>
    </div>
    <div class="header-actions">
        <div class="header-status">
            <span class="status-dot unknown" id="dhcpStatusDot"></span>
            <span id="dhcpStatusText">DHCP: Checking...</span>
        </div>
        <div style="display: flex; gap: 6px; margin-left: 15px;">
            <button class="btn btn-primary btn-sm" onclick="dhcpServiceAction('start')" title="Start DHCP">Start</button>
            <button class="btn btn-secondary btn-sm" onclick="dhcpServiceAction('restart')" title="Restart DHCP">Restart</button>
            <button class="btn btn-danger btn-sm" onclick="dhcpServiceAction('stop')" title="Stop DHCP">Stop</button>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="tab-nav">
    <button class="tab-btn active" data-tab="dhcpd">DHCP Server</button>
    <button class="tab-btn" data-tab="bindings">Bindings</button>
    <button class="tab-btn" data-tab="ztp-script">ZTP Script</button>
    <button class="tab-btn" data-tab="base-config">Base Config</button>
</div>

<!-- ==================== TAB 0: DHCPd ==================== -->
<div class="tab-content active" id="tab-dhcpd">

    <!-- DHCP Server Configuration -->
    <div class="section-title">DHCP Server Configuration</div>
    <div class="section-desc">Subnet, IP range, gateway, DNS and ZTP settings. Changes require DHCP restart.</div>
    <div style="padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">SUBNET</label>
                <input type="text" class="form-input" id="dhcpSubnet" style="width: 100%;" placeholder="192.168.58.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">NETMASK</label>
                <input type="text" class="form-input" id="dhcpNetmask" style="width: 100%;" placeholder="255.255.255.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DYNAMIC RANGE START</label>
                <input type="text" class="form-input" id="dhcpRangeStart" style="width: 100%;" placeholder="192.168.58.210">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DYNAMIC RANGE END</label>
                <input type="text" class="form-input" id="dhcpRangeEnd" style="width: 100%;" placeholder="192.168.58.249">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">GATEWAY (ROUTER)</label>
                <input type="text" class="form-input" id="dhcpGateway" style="width: 100%;" placeholder="192.168.58.1">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DNS SERVER</label>
                <input type="text" class="form-input" id="dhcpDNS" style="width: 100%;" placeholder="192.168.58.1">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DOMAIN NAME</label>
                <input type="text" class="form-input" id="dhcpDomain" style="width: 100%;" placeholder="nvidia">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">ZTP PROVISION URL</label>
                <input type="text" class="form-input" id="dhcpProvisionURL" style="width: 100%;" placeholder="http://192.168.58.200/cumulus-ztp.sh">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">LISTEN INTERFACE</label>
                <select class="form-input" id="dhcpInterface" style="width: 100%;"><option value="">Loading...</option></select>
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT LEASE TIME (sec)</label>
                <input type="text" class="form-input" id="dhcpLeaseTime" style="width: 100%;" placeholder="172800">
            </div>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-primary btn-sm" onclick="saveDHCPConfig()">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save Config &amp; Restart DHCP
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadDHCPConfig()">Reload</button>
        </div>
    </div>

    <!-- Discovered Section (inside DHCP Server tab) -->
    <div class="section-title" style="margin-top: 10px;">Discovered Devices</div>
    <div class="section-desc">Cross-reference LLDP/ARP data with DHCP bindings. Click stats to filter.</div>
    <div class="stats-row" id="discoveredStats">
        <div class="stat-card" style="cursor:pointer;" onclick="setDiscoveredFilter('match')"><div class="stat-value" id="statMatched">-</div><div class="stat-label">Matched</div></div>
        <div class="stat-card" style="border-left-color:#ff9800; cursor:pointer;" onclick="setDiscoveredFilter('mismatch')"><div class="stat-value" id="statMismatch">-</div><div class="stat-label">Mismatch</div></div>
        <div class="stat-card" style="border-left-color:#42a5f5; cursor:pointer;" onclick="setDiscoveredFilter('unbound')"><div class="stat-value" id="statUnbound">-</div><div class="stat-label">No Binding</div></div>
        <div class="stat-card" style="border-left-color:#f44336; cursor:pointer;" onclick="setDiscoveredFilter('missing')"><div class="stat-value" id="statMissing">-</div><div class="stat-label">Not Discovered</div></div>
    </div>
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="discoveredSearch" placeholder="Filter..." oninput="filterDiscovered()">
            <select class="form-input" id="discoveredFilter" onchange="filterDiscovered()" style="width:180px;">
                <option value="all">All</option>
                <option value="match">Matched</option>
                <option value="mismatch">Mismatch Only</option>
                <option value="unbound">No Binding</option>
                <option value="missing">Not Discovered</option>
            </select>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadDiscovered()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="discoveredTable">
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>Binding MAC</th>
                    <th>Discovered MAC</th>
                    <th>Binding IP</th>
                    <th>Source</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="discoveredBody">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 1: BINDINGS ==================== -->
<div class="tab-content" id="tab-bindings">
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="bindingSearch" placeholder="Filter by hostname, MAC, or IP..." oninput="filterBindings()">
            <span id="bindingCount" style="font-size: 12px; color: #888;"></span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadBindings()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
            <button class="btn btn-primary" onclick="showAddBinding()">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Add Binding
            </button>
            <button class="btn btn-secondary" onclick="showBulkImport()">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11z"/></svg>
                Bulk Import
            </button>
            <button class="btn btn-warning" onclick="saveBindings()" id="btnSaveBindings" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save &amp; Restart DHCP
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="bindingsTable">
            <thead>
                <tr>
                    <th style="width:30px;"><input type="checkbox" id="selectAllBindings" onchange="toggleSelectAllBindings()"></th>
                    <th>Hostname</th>
                    <th>MAC Address</th>
                    <th>IP Address</th>
                    <th>Status</th>
                    <th style="width:120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="bindingsBody">
                <tr><td colspan="6" class="loading">Loading bindings...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 3: ZTP SCRIPT ==================== -->
<div class="tab-content" id="tab-ztp-script">
    <div class="section-desc">ZTP provisioning settings, SSH key management, OS image, and script editor.</div>

    <!-- SSH Key Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #76b900;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 5px;">SSH Key</div>
        <div class="section-desc" style="margin-bottom: 10px;">Single key pair used for ZTP provisioning and device management (Assets SSH Setup).</div>
        <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">PUBLIC KEY</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="ztpSSHKey" readonly style="flex:1; font-family:'Cascadia Code','Consolas',monospace; font-size:11px; background:#252526;" placeholder="No key generated yet...">
                    <button class="btn btn-secondary btn-sm" onclick="copySSHKey()" title="Copy public key">Copy</button>
                </div>
            </div>
            <div style="display: flex; gap: 8px; padding-top: 18px;">
                <button class="btn btn-primary btn-sm" onclick="generateSSHKey()">
                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h3v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    Generate New Key
                </button>
                <button class="btn btn-secondary btn-sm" onclick="loadSSHKey()">Refresh</button>
            </div>
        </div>
        <div id="sshKeyStatus" style="margin-top: 8px; font-size: 12px; color: #888;"></div>
    </div>

    <!-- Quick Settings Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 10px;">Quick Settings</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">TARGET OS VERSION</label>
                <input type="text" class="form-input" id="ztpTargetOS" style="width: 100%;" placeholder="e.g. 5.14.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT PASSWORD</label>
                <div style="position: relative;">
                    <input type="password" class="form-input" id="ztpPassword" style="width: 100%; padding-right: 36px;" placeholder="e.g. Nvidia01!" autocomplete="off">
                    <button onclick="togglePasswordVisibility()" style="position:absolute; right:4px; top:50%; transform:translateY(-50%); background:none; border:none; color:#888; cursor:pointer; padding:4px; font-size:16px;" title="Show/Hide" id="pwToggle">üëÅ</button>
                </div>
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">IMAGE SERVER IP</label>
                <input type="text" class="form-input input-ip" id="ztpImageServer" style="width: 100%;" placeholder="e.g. 192.168.58.200">
            </div>
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="applyQuickSettings()">Apply to Script</button>
    </div>

    <!-- OS Image Upload Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 5px;">OS Image</div>
        <div class="section-desc" style="margin-bottom: 10px;">Cumulus Linux image served via HTTP for ZTP OS upgrades.</div>
        <div id="imageList" style="margin-bottom: 10px;"><span style="color:#888;">Checking...</span></div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <label class="btn btn-secondary btn-sm" style="cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                Upload Image
                <input type="file" id="imageUpload" style="display: none;" accept=".bin,.img,.iso" onchange="uploadImage(this)">
            </label>
            <span id="uploadProgress" style="font-size: 12px; color: #888;"></span>
        </div>
    </div>

    <!-- Script Editor (collapsed by default) -->
    <div class="editor-container">
        <div class="editor-toolbar" style="cursor: pointer;" onclick="toggleScriptEditor()">
            <span class="editor-filename">
                <span id="editorToggle" style="margin-right: 6px;">&#9654;</span>
                cumulus-ztp.sh ‚Äî Click to edit
            </span>
            <div style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
                <button class="btn btn-secondary btn-sm" onclick="loadZTPScript()">Reload</button>
                <button class="btn btn-primary btn-sm" onclick="saveZTPScript()">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    Save
                </button>
            </div>
        </div>
        <textarea class="editor-textarea" id="ztpEditor" spellcheck="false" style="display: none;"></textarea>
    </div>
</div>

<!-- ==================== TAB 5: BASE CONFIG ==================== -->
<div class="tab-content" id="tab-base-config">

    <!-- Two-column layout: Files | Devices -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">

        <!-- Left: Files -->
        <div style="background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 6px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div class="section-title" style="margin: 0; font-size: 13px;">Files to Deploy</div>
                <label style="font-size: 11px; cursor: pointer; color: #888;">
                    <input type="checkbox" id="selectAllFiles" onchange="toggleSelectAllFiles()" checked style="accent-color: #76b900;">
                    All
                </label>
            </div>
            <div class="file-grid" id="fileGrid"></div>
        </div>

        <!-- Right: Devices -->
        <div style="background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 6px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div class="section-title" style="margin: 0; font-size: 13px;">Target Devices</div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" class="search-filter" id="deviceFilter" placeholder="Filter..." oninput="filterDeviceChips()" style="width: 140px; padding: 4px 8px; font-size: 11px;">
                    <label style="font-size: 11px; cursor: pointer; color: #888; white-space: nowrap;">
                        <input type="checkbox" id="selectAllDevices" onchange="toggleSelectAllDevices()" checked style="accent-color: #76b900;">
                        All
                    </label>
                </div>
            </div>
            <div class="device-selector" id="deviceSelector">
                <div class="loading">Loading devices...</div>
            </div>
        </div>
    </div>

    <!-- Deploy bar -->
    <div style="display: flex; gap: 12px; align-items: center; padding: 10px 15px; background: #252526; border: 1px solid #3c3c3c; border-radius: 6px; margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="deployBaseConfig()" id="btnDeploy">
            <svg viewBox="0 0 24 24"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
            Deploy
        </button>
        <label style="font-size: 12px; cursor: pointer; color: #888;">
            <input type="checkbox" id="disableZTPAfter" style="accent-color: #76b900;">
            Disable ZTP after deploy
        </label>
        <span id="deployStatusText" style="font-size: 12px; color: #888; margin-left: auto;"></span>
    </div>

    <!-- Deploy Progress -->
    <div id="deployProgress" style="display: none;">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>IP</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="deployBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Binding Modal -->
<div class="modal-overlay" id="bindingModal" style="display: none;" onclick="if(event.target===this)closeBindingModal()">
    <div class="modal">
        <h3 id="modalTitle">Add Binding</h3>
        <div class="modal-field">
            <label>Hostname</label>
            <input type="text" id="modalHostname" placeholder="e.g. leaf-01">
        </div>
        <div class="modal-field">
            <label>MAC Address</label>
            <input type="text" id="modalMAC" class="mono" placeholder="e.g. 54:9b:24:aa:68:16" oninput="formatMAC(this)">
        </div>
        <div class="modal-field">
            <label>IP Address</label>
            <input type="text" id="modalIP" class="mono" placeholder="e.g. 192.168.58.11">
        </div>
        <input type="hidden" id="modalOrigHostname">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBindingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBinding()" id="modalSaveBtn">Add</button>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal-overlay" id="bulkImportModal" style="display: none;" onclick="if(event.target===this)closeBulkImport()">
    <div class="modal" style="min-width: 600px;">
        <h3>Bulk Import Bindings</h3>
        <div class="section-desc" style="margin-bottom: 10px;">
            Paste one binding per line. Format: <code style="color:#76b900;">hostname  MAC  IP</code> (separated by space or tab)
        </div>
        <div style="margin-bottom: 10px; padding: 10px; background: #1e1e1e; border-radius: 4px; font-size: 12px; color: #888; font-family: 'Cascadia Code','Consolas',monospace;">
            Example:<br>
            leaf-01&nbsp;&nbsp;54:9b:24:aa:68:16&nbsp;&nbsp;192.168.58.11<br>
            leaf-02&nbsp;&nbsp;54:9b:24:8d:35:44&nbsp;&nbsp;192.168.58.12<br>
            spine-01&nbsp;8c:91:3a:b4:aa:60&nbsp;&nbsp;192.168.58.17
        </div>
        <textarea id="bulkImportText" style="width:100%; min-height:250px; padding:12px; background:#1a1a1a; color:#d4d4d4; border:1px solid #555; border-radius:4px; font-family:'Cascadia Code','Consolas',monospace; font-size:13px; line-height:1.6; resize:vertical;" spellcheck="false" placeholder="hostname  MAC  IP&#10;hostname  MAC  IP&#10;..."></textarea>
        <div id="bulkImportPreview" style="margin-top: 10px; font-size: 12px; color: #888;"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBulkImport()">Cancel</button>
            <button class="btn btn-primary" onclick="applyBulkImport()">Import</button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<script>
// ===================== GLOBAL STATE =====================
let allBindings = [];
let bindingsModified = false;
let allDiscovered = [];
let deviceList = [];

const BASE_CONFIG_FILES = [
    { name: 'bash.bashrc', dest: '/etc/bash.bashrc', destAlt: '/home/cumulus/.bashrc', type: 'config', desc: 'Shell aliases & VRF helpers' },
    { name: 'motd.sh', dest: '/etc/profile.d/motd.sh', type: 'config', desc: 'Login banner with BGP status' },
    { name: 'tmux.conf', dest: '/etc/tmux.conf', type: 'config', desc: 'tmux settings' },
    { name: 'nanorc', dest: '/etc/nanorc', type: 'config', desc: 'Editor settings' },
    { name: 'cmd', dest: '/usr/local/bin/cmd', type: 'script', desc: 'tmux session manager' },
    { name: 'nvc', dest: '/usr/local/bin/nvc', type: 'script', desc: 'NV config colorizer' },
    { name: 'nvt', dest: '/usr/local/bin/nvt', type: 'script', desc: 'Interface table tool' },
    { name: 'exa', dest: '/usr/bin/exa', type: 'binary', desc: 'Modern ls replacement' },
    { name: 'btop', dest: '/usr/bin/btop', type: 'binary', desc: 'System monitor' },
    { name: 'iftop', dest: '/usr/bin/iftop', type: 'binary', desc: 'Bandwidth monitor' }
];

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            onTabSwitch(btn.dataset.tab);
        });
    });

    // Load initial data
    loadDHCPConfig();
    loadDiscovered();
    loadDeviceList();
    renderBaseConfigFiles();
    checkDHCPStatus();
});

function onTabSwitch(tab) {
    if (tab === 'dhcpd') { loadDHCPConfig(); loadDiscovered(); }
    if (tab === 'bindings' && allBindings.length === 0) loadBindings();
    if (tab === 'ztp-script') loadZTPScript();
}

function setDiscoveredFilter(status) {
    document.getElementById('discoveredFilter').value = status;
    renderDiscovered();
    // Scroll to discovered table
    document.getElementById('discoveredTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===================== API HELPER =====================
async function apiCall(action, data = null) {
    try {
        const opts = {};
        if (data) {
            opts.method = 'POST';
            opts.headers = { 'Content-Type': 'application/json' };
            opts.body = JSON.stringify(data);
        }
        const resp = await fetch(`/provision-api.sh?action=${action}`, opts);
        return await resp.json();
    } catch (e) {
        return { success: false, error: e.message };
    }
}

// ===================== TOAST =====================
function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast toast-${type} show`;
    setTimeout(() => t.classList.remove('show'), 4000);
}

// ===================== DHCP STATUS CHECK =====================
async function checkDHCPStatus() {
    const data = await apiCall('dhcp-service-status');
    const dot = document.getElementById('dhcpStatusDot');
    const txt = document.getElementById('dhcpStatusText');
    if (data.success && data.running) {
        dot.className = 'status-dot active';
        txt.textContent = 'DHCP: Running';
    } else if (data.success && !data.running) {
        dot.className = 'status-dot inactive';
        txt.textContent = 'DHCP: Stopped';
    } else {
        dot.className = 'status-dot unknown';
        txt.textContent = 'DHCP: Unknown';
    }
}

// ===================== DHCP SERVICE CONTROL =====================
async function dhcpServiceAction(action) {
    if (action === 'stop' && !confirm('Stop DHCP server? New devices will not get IP addresses.')) return;
    showToast(`DHCP: ${action}...`, 'info');
    const data = await apiCall('dhcp-service-control', { action });
    if (data.success) {
        showToast(`DHCP ${action}: ${data.message || 'OK'}`, 'success');
    } else {
        showToast(`DHCP ${action} failed: ${data.error || 'Unknown error'}`, 'error');
    }
    checkDHCPStatus();
}

// ===================== DHCP CONFIG =====================
async function loadDHCPConfig() {
    const data = await apiCall('get-dhcp-config');
    if (data.success) {
        document.getElementById('dhcpSubnet').value = data.subnet || '';
        document.getElementById('dhcpNetmask').value = data.netmask || '';
        document.getElementById('dhcpRangeStart').value = data.range_start || '';
        document.getElementById('dhcpRangeEnd').value = data.range_end || '';
        document.getElementById('dhcpGateway').value = data.gateway || '';
        document.getElementById('dhcpDNS').value = data.dns || '';
        document.getElementById('dhcpDomain').value = data.domain || '';
        document.getElementById('dhcpProvisionURL').value = data.provision_url || '';
        document.getElementById('dhcpLeaseTime').value = data.lease_time || '';
        
        // Populate interface dropdown
        const sel = document.getElementById('dhcpInterface');
        const currentIface = data.interface || 'eth0';
        const ifaces = data.interfaces || [];
        if (ifaces.length > 0) {
            sel.innerHTML = ifaces.map(i => {
                const selected = i.name === currentIface ? ' selected' : '';
                const ipLabel = i.ip ? ` (${i.ip})` : ' (no IP)';
                return `<option value="${escHtml(i.name)}"${selected}>${escHtml(i.name)}${ipLabel}</option>`;
            }).join('');
        } else {
            sel.innerHTML = `<option value="${escHtml(currentIface)}" selected>${escHtml(currentIface)}</option>`;
        }
    }
}

async function saveDHCPConfig() {
    const config = {
        subnet: document.getElementById('dhcpSubnet').value.trim(),
        netmask: document.getElementById('dhcpNetmask').value.trim(),
        range_start: document.getElementById('dhcpRangeStart').value.trim(),
        range_end: document.getElementById('dhcpRangeEnd').value.trim(),
        gateway: document.getElementById('dhcpGateway').value.trim(),
        dns: document.getElementById('dhcpDNS').value.trim(),
        domain: document.getElementById('dhcpDomain').value.trim(),
        provision_url: document.getElementById('dhcpProvisionURL').value.trim(),
        interface: document.getElementById('dhcpInterface').value.trim(),
        lease_time: document.getElementById('dhcpLeaseTime').value.trim()
    };

    if (!config.subnet || !config.netmask || !config.gateway) {
        showToast('Subnet, Netmask and Gateway are required', 'error');
        return;
    }

    const data = await apiCall('save-dhcp-config', config);
    if (data.success) {
        showToast('DHCP config saved & server restarted', 'success');
        checkDHCPStatus();
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

// ===================== BULK IMPORT =====================
function showBulkImport() {
    document.getElementById('bulkImportText').value = '';
    document.getElementById('bulkImportPreview').textContent = '';
    document.getElementById('bulkImportModal').style.display = 'flex';
    document.getElementById('bulkImportText').focus();
}

function closeBulkImport() {
    document.getElementById('bulkImportModal').style.display = 'none';
}

function parseBulkText(text) {
    const lines = text.trim().split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
    const entries = [];
    const errors = [];

    lines.forEach((line, idx) => {
        // Split by whitespace (spaces or tabs)
        const parts = line.trim().split(/\s+/);
        if (parts.length < 3) {
            errors.push(`Line ${idx + 1}: Need 3 columns (hostname MAC IP), got ${parts.length}`);
            return;
        }
        const hostname = parts[0];
        const mac = parts[1].toLowerCase();
        const ip = parts[2];

        if (!/^([0-9a-f]{2}:){5}[0-9a-f]{2}$/.test(mac)) {
            errors.push(`Line ${idx + 1}: Invalid MAC "${parts[1]}"`);
            return;
        }
        if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
            errors.push(`Line ${idx + 1}: Invalid IP "${ip}"`);
            return;
        }
        entries.push({ hostname, mac, ip, commented: false });
    });

    return { entries, errors };
}

function applyBulkImport() {
    const text = document.getElementById('bulkImportText').value;
    if (!text.trim()) {
        showToast('Paste binding data first', 'error');
        return;
    }

    const { entries, errors } = parseBulkText(text);

    if (errors.length > 0) {
        document.getElementById('bulkImportPreview').innerHTML =
            `<span style="color:#f44336;">Errors:</span><br>` +
            errors.map(e => `‚Ä¢ ${escHtml(e)}`).join('<br>');
        return;
    }

    if (entries.length === 0) {
        showToast('No valid entries found', 'error');
        return;
    }

    // Merge with existing bindings
    let added = 0, updated = 0;
    entries.forEach(entry => {
        const existing = allBindings.findIndex(b => b.hostname === entry.hostname);
        if (existing >= 0) {
            allBindings[existing] = entry;
            updated++;
        } else {
            allBindings.push(entry);
            added++;
        }
    });

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    closeBulkImport();
    renderBindings();
    showToast(`Imported: ${added} added, ${updated} updated (unsaved)`, 'info');
}

// ===================== TAB 1: BINDINGS =====================
async function loadBindings() {
    document.getElementById('bindingsBody').innerHTML = '<tr><td colspan="6" class="loading">Loading bindings...</td></tr>';
    const data = await apiCall('list-bindings');
    if (data.success) {
        allBindings = data.bindings || [];
        bindingsModified = false;
        document.getElementById('btnSaveBindings').style.display = 'none';
        renderBindings();
    } else {
        document.getElementById('bindingsBody').innerHTML = `<tr><td colspan="6" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
}

function renderBindings() {
    const filter = document.getElementById('bindingSearch').value.toLowerCase();
    const filtered = allBindings.filter(b =>
        b.hostname.toLowerCase().includes(filter) ||
        b.mac.toLowerCase().includes(filter) ||
        b.ip.includes(filter)
    );

    document.getElementById('bindingCount').textContent = `${filtered.length} of ${allBindings.length} bindings`;

    if (filtered.length === 0) {
        document.getElementById('bindingsBody').innerHTML = `
            <tr><td colspan="6" style="text-align:center; padding:40px; color:#666;">
                ${allBindings.length === 0 ? 'No bindings configured. Click "Add Binding" to create one.' : 'No matches found.'}
            </td></tr>`;
        return;
    }

    document.getElementById('bindingsBody').innerHTML = filtered.map((b, i) => `
        <tr data-idx="${i}">
            <td><input type="checkbox" class="binding-cb" data-hostname="${b.hostname}"></td>
            <td><strong>${escHtml(b.hostname)}</strong></td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.mac)}</td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.ip)}</td>
            <td>${b.commented ? '<span class="badge badge-pending">Disabled</span>' : '<span class="badge badge-active">Active</span>'}</td>
            <td class="row-actions">
                <button class="btn btn-secondary btn-sm" onclick="editBinding('${escAttr(b.hostname)}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBinding('${escAttr(b.hostname)}')">Del</button>
            </td>
        </tr>
    `).join('');
}

function filterBindings() { renderBindings(); }

function showAddBinding() {
    document.getElementById('modalTitle').textContent = 'Add Binding';
    document.getElementById('modalHostname').value = '';
    document.getElementById('modalMAC').value = '';
    document.getElementById('modalIP').value = '';
    document.getElementById('modalOrigHostname').value = '';
    document.getElementById('modalSaveBtn').textContent = 'Add';
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function editBinding(hostname) {
    const b = allBindings.find(x => x.hostname === hostname);
    if (!b) return;
    document.getElementById('modalTitle').textContent = 'Edit Binding';
    document.getElementById('modalHostname').value = b.hostname;
    document.getElementById('modalMAC').value = b.mac;
    document.getElementById('modalIP').value = b.ip;
    document.getElementById('modalOrigHostname').value = b.hostname;
    document.getElementById('modalSaveBtn').textContent = 'Update';
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function closeBindingModal() {
    document.getElementById('bindingModal').style.display = 'none';
}

function saveBinding() {
    const hostname = document.getElementById('modalHostname').value.trim();
    const mac = document.getElementById('modalMAC').value.trim().toLowerCase();
    const ip = document.getElementById('modalIP').value.trim();
    const origHostname = document.getElementById('modalOrigHostname').value;

    if (!hostname || !mac || !ip) {
        showToast('All fields are required', 'error');
        return;
    }

    // MAC format validation
    if (!/^([0-9a-f]{2}:){5}[0-9a-f]{2}$/.test(mac)) {
        showToast('Invalid MAC format. Use xx:xx:xx:xx:xx:xx', 'error');
        return;
    }

    // IP format validation
    if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
        showToast('Invalid IP format', 'error');
        return;
    }

    if (origHostname) {
        // Edit existing
        const idx = allBindings.findIndex(x => x.hostname === origHostname);
        if (idx >= 0) {
            allBindings[idx] = { hostname, mac, ip, commented: false };
        }
    } else {
        // Check duplicate
        if (allBindings.find(x => x.hostname === hostname)) {
            showToast(`Hostname "${hostname}" already exists`, 'error');
            return;
        }
        allBindings.push({ hostname, mac, ip, commented: false });
    }

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    closeBindingModal();
    renderBindings();
    showToast(origHostname ? 'Binding updated (unsaved)' : 'Binding added (unsaved)', 'info');
}

function deleteBinding(hostname) {
    if (!confirm(`Delete binding for "${hostname}"?`)) return;
    allBindings = allBindings.filter(x => x.hostname !== hostname);
    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    renderBindings();
    showToast(`Binding "${hostname}" deleted (unsaved)`, 'info');
}

async function saveBindings() {
    const btn = document.getElementById('btnSaveBindings');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const data = await apiCall('save-bindings', { bindings: allBindings });
    if (data.success) {
        bindingsModified = false;
        btn.style.display = 'none';
        showToast('Bindings saved & DHCP restarted', 'success');
        checkDHCPStatus();
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Save &amp; Restart DHCP';
}

function toggleSelectAllBindings() {
    const checked = document.getElementById('selectAllBindings').checked;
    document.querySelectorAll('.binding-cb').forEach(cb => cb.checked = checked);
}

function formatMAC(input) {
    let v = input.value.replace(/[^0-9a-fA-F]/g, '').substring(0, 12);
    let parts = [];
    for (let i = 0; i < v.length; i += 2) {
        parts.push(v.substring(i, i + 2));
    }
    input.value = parts.join(':');
}

// ===================== TAB 2: DISCOVERED =====================
async function loadDiscovered() {
    document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';
    const data = await apiCall('discovered');
    if (data.success) {
        allDiscovered = data.entries || [];
        renderDiscoveredStats();
        renderDiscovered();
    } else {
        document.getElementById('discoveredBody').innerHTML = `<tr><td colspan="6" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
}

function renderDiscoveredStats() {
    const matched = allDiscovered.filter(d => d.status === 'match').length;
    const mismatch = allDiscovered.filter(d => d.status === 'mismatch').length;
    const unbound = allDiscovered.filter(d => d.status === 'unbound').length;
    const missing = allDiscovered.filter(d => d.status === 'missing').length;
    document.getElementById('statMatched').textContent = matched;
    document.getElementById('statMismatch').textContent = mismatch;
    document.getElementById('statUnbound').textContent = unbound;
    document.getElementById('statMissing').textContent = missing;
}

function renderDiscovered() {
    const filter = document.getElementById('discoveredSearch').value.toLowerCase();
    const typeFilter = document.getElementById('discoveredFilter').value;

    let filtered = allDiscovered;
    if (typeFilter !== 'all') {
        filtered = filtered.filter(d => d.status === typeFilter);
    }
    if (filter) {
        filtered = filtered.filter(d =>
            (d.hostname || '').toLowerCase().includes(filter) ||
            (d.binding_mac || '').toLowerCase().includes(filter) ||
            (d.discovered_mac || '').toLowerCase().includes(filter) ||
            (d.binding_ip || '').includes(filter)
        );
    }

    if (filtered.length === 0) {
        document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">No entries found.</td></tr>';
        return;
    }

    document.getElementById('discoveredBody').innerHTML = filtered.map(d => {
        const statusBadge = {
            'match': '<span class="badge badge-match">Match</span>',
            'mismatch': '<span class="badge badge-mismatch">Mismatch</span>',
            'unbound': '<span class="badge badge-info">No Binding</span>',
            'missing': '<span class="badge badge-warning">Not Discovered</span>'
        }[d.status] || '';

        return `<tr>
            <td><strong>${escHtml(d.hostname || '-')}</strong></td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.binding_mac || '-')}</td>
            <td style="font-family:monospace;font-size:12px;">${d.status === 'mismatch' ? `<span style="color:#ff6b6b;">${escHtml(d.discovered_mac)}</span>` : escHtml(d.discovered_mac || '-')}</td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.binding_ip || '-')}</td>
            <td>${escHtml(d.source || '-')}</td>
            <td>${statusBadge}</td>
        </tr>`;
    }).join('');
}

function filterDiscovered() { renderDiscovered(); }

// ===================== TAB 3: ZTP SCRIPT =====================
let ztpLoaded = false;
let scriptEditorVisible = false;

async function loadZTPScript() {
    const editor = document.getElementById('ztpEditor');
    editor.value = '# Loading...';
    const data = await apiCall('get-ztp-script');
    if (data.success) {
        editor.value = data.content || '';
        ztpLoaded = true;
        parseQuickSettings(data.content);
    } else {
        editor.value = `# Error loading: ${data.error}\n# You may need to create the file first.`;
    }
    loadSSHKey();
    loadOSImages();
}

// --- SSH Key ---
async function loadSSHKey() {
    const data = await apiCall('get-ssh-key');
    const keyInput = document.getElementById('ztpSSHKey');
    const status = document.getElementById('sshKeyStatus');
    if (data.success && data.public_key) {
        keyInput.value = data.public_key;
        status.innerHTML = `<span style="color:#4caf50;">Key found:</span> ${data.key_type || 'ssh'} (${data.key_file || ''})`;
    } else {
        keyInput.value = '';
        status.innerHTML = '<span style="color:#ff9800;">No SSH key found.</span> Click "Generate New Key" to create one.';
    }
}

async function generateSSHKey() {
    if (!confirm('Generate a new SSH key pair? This will be used for ZTP and device management.')) return;
    showToast('Generating SSH key...', 'info');
    const data = await apiCall('generate-ssh-key', {});
    if (data.success) {
        document.getElementById('ztpSSHKey').value = data.public_key || '';
        document.getElementById('sshKeyStatus').innerHTML = `<span style="color:#4caf50;">New key generated!</span> ${data.key_type || ''} (${data.key_file || ''})`;
        showToast('SSH key generated. Apply to ZTP script with "Apply to Script".', 'success');
    } else {
        showToast('Key generation failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

function copySSHKey() {
    const key = document.getElementById('ztpSSHKey').value;
    if (!key) { showToast('No key to copy', 'error'); return; }
    navigator.clipboard.writeText(key).then(() => showToast('Public key copied!', 'success'));
}

// --- Password Toggle ---
function togglePasswordVisibility() {
    const pw = document.getElementById('ztpPassword');
    const btn = document.getElementById('pwToggle');
    if (pw.type === 'password') { pw.type = 'text'; btn.textContent = 'üîí'; }
    else { pw.type = 'password'; btn.textContent = 'üëÅ'; }
}

// --- OS Image ---
async function loadOSImages() {
    const container = document.getElementById('imageList');
    const data = await apiCall('list-os-images');
    if (data.success && data.images && data.images.length > 0) {
        container.innerHTML = data.images.map(img => `
            <div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #2d2d2d;">
                <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:#76b900;flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                <span style="flex:1;font-family:monospace;font-size:13px;">${escHtml(img.name)}</span>
                <span style="color:#888;font-size:12px;">${escHtml(img.size)}</span>
                <button class="btn btn-danger btn-sm" onclick="deleteOSImage('${escAttr(img.name)}')" style="padding:2px 8px;font-size:11px;">Del</button>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<span style="color:#888;">No OS images found in web root. Upload a .bin image for ZTP.</span>';
    }
}

async function uploadImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    const progress = document.getElementById('uploadProgress');
    progress.textContent = `Uploading ${file.name} (${(file.size / 1048576).toFixed(0)} MB)...`;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const resp = await fetch('/provision-api.sh?action=upload-os-image', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        if (data.success) {
            showToast(`Image "${file.name}" uploaded successfully`, 'success');
            loadOSImages();
        } else {
            showToast('Upload failed: ' + (data.error || 'Unknown'), 'error');
        }
    } catch (e) {
        showToast('Upload failed: ' + e.message, 'error');
    }
    progress.textContent = '';
    input.value = '';
}

async function deleteOSImage(name) {
    if (!confirm(`Delete image "${name}"?`)) return;
    const data = await apiCall('delete-os-image', { name });
    if (data.success) { showToast('Image deleted', 'success'); loadOSImages(); }
    else { showToast('Delete failed: ' + (data.error || ''), 'error'); }
}

// --- Script Editor Toggle ---
function toggleScriptEditor() {
    const editor = document.getElementById('ztpEditor');
    const toggle = document.getElementById('editorToggle');
    scriptEditorVisible = !scriptEditorVisible;
    editor.style.display = scriptEditorVisible ? '' : 'none';
    toggle.innerHTML = scriptEditorVisible ? '&#9660;' : '&#9654;';
}

// --- Quick Settings ---
function parseQuickSettings(content) {
    const osMatch = content.match(/CUMULUS_TARGET_RELEASE=(\S+)/);
    const pwMatch = content.match(/echo\s+'cumulus:(.+?)'\s*\|\s*chpasswd/);
    const ipMatch = content.match(/IMAGE_SERVER_HOSTNAME=(\S+)/);
    // Don't overwrite SSH key from script ‚Äî loadSSHKey() handles that from actual key file

    if (osMatch) document.getElementById('ztpTargetOS').value = osMatch[1];
    if (pwMatch) document.getElementById('ztpPassword').value = pwMatch[1];
    if (ipMatch) document.getElementById('ztpImageServer').value = ipMatch[1];
}

function applyQuickSettings() {
    let content = document.getElementById('ztpEditor').value;
    const os = document.getElementById('ztpTargetOS').value.trim();
    const pw = document.getElementById('ztpPassword').value.trim();
    const ip = document.getElementById('ztpImageServer').value.trim();
    const key = document.getElementById('ztpSSHKey').value.trim();

    if (os) content = content.replace(/CUMULUS_TARGET_RELEASE=\S+/, `CUMULUS_TARGET_RELEASE=${os}`);
    if (pw) content = content.replace(/echo\s+'cumulus:.+?'\s*\|\s*chpasswd/, `echo 'cumulus:${pw}' | chpasswd`);
    if (ip) content = content.replace(/IMAGE_SERVER_HOSTNAME=\S+/, `IMAGE_SERVER_HOSTNAME=${ip}`);
    if (key) content = content.replace(/KEY="ssh-\S+\s+\S+"/, `KEY="${key}"`);

    // Show editor to see changes
    if (!scriptEditorVisible) toggleScriptEditor();
    document.getElementById('ztpEditor').value = content;
    showToast('Quick settings applied to script (unsaved)', 'info');
}

async function saveZTPScript() {
    const content = document.getElementById('ztpEditor').value;
    const data = await apiCall('save-ztp-script', { content });
    if (data.success) {
        showToast('ZTP script saved', 'success');
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

// ===================== TAB 5: BASE CONFIG =====================
function renderBaseConfigFiles() {
    const grid = document.getElementById('fileGrid');
    const typeColor = { 'config': '#76b900', 'script': '#42a5f5', 'binary': '#ff9800' };
    grid.innerHTML = BASE_CONFIG_FILES.map(f => {
        const color = typeColor[f.type] || '#76b900';
        return `<div class="file-card selected" data-file="${f.name}" onclick="toggleFileCard(this)">
            <input type="checkbox" checked class="file-cb" data-file="${f.name}" onclick="event.stopPropagation()">
            <div class="file-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="${color}"/></svg></div>
            <div class="file-info">
                <span class="file-name">${f.name}</span>
                <span class="file-dest">${f.dest}</span>
            </div>
        </div>`;
    }).join('');
}

function toggleFileCard(card) {
    const cb = card.querySelector('.file-cb');
    cb.checked = !cb.checked;
    card.classList.toggle('selected', cb.checked);
}

function toggleSelectAllFiles() {
    const checked = document.getElementById('selectAllFiles').checked;
    document.querySelectorAll('.file-cb').forEach(cb => {
        cb.checked = checked;
        cb.closest('.file-card').classList.toggle('selected', checked);
    });
}

async function loadDeviceList() {
    const data = await apiCall('list-devices');
    if (data.success) {
        deviceList = data.devices || [];
        renderDeviceChips();
    }
}

function renderDeviceChips() {
    const filter = document.getElementById('deviceFilter') ? document.getElementById('deviceFilter').value.toLowerCase() : '';
    const container = document.getElementById('deviceSelector');
    const filtered = deviceList.filter(d =>
        d.hostname.toLowerCase().includes(filter) || d.ip.includes(filter)
    );

    container.innerHTML = filtered.map(d => `
        <div class="device-chip selected" onclick="toggleDeviceChip(this)">
            <input type="checkbox" checked class="dev-cb" data-ip="${d.ip}" data-hostname="${d.hostname}" onclick="event.stopPropagation()">
            <span>${escHtml(d.hostname)}</span>
        </div>
    `).join('');
}

function toggleDeviceChip(chip) {
    const cb = chip.querySelector('.dev-cb');
    cb.checked = !cb.checked;
    chip.classList.toggle('selected', cb.checked);
}

function toggleSelectAllDevices() {
    const checked = document.getElementById('selectAllDevices').checked;
    document.querySelectorAll('.dev-cb').forEach(cb => {
        cb.checked = checked;
        cb.closest('.device-chip').classList.toggle('selected', checked);
    });
}

function filterDeviceChips() { renderDeviceChips(); }

async function deployBaseConfig() {
    const selectedFiles = Array.from(document.querySelectorAll('.file-cb:checked')).map(cb => cb.dataset.file);
    const selectedDevices = Array.from(document.querySelectorAll('.dev-cb:checked')).map(cb => ({
        ip: cb.dataset.ip,
        hostname: cb.dataset.hostname
    }));

    if (selectedFiles.length === 0) {
        showToast('Select at least one file to deploy', 'error');
        return;
    }
    if (selectedDevices.length === 0) {
        showToast('Select at least one device', 'error');
        return;
    }

    const disableZTP = document.getElementById('disableZTPAfter').checked;

    // Show progress
    document.getElementById('deployProgress').style.display = '';
    const btn = document.getElementById('btnDeploy');
    btn.disabled = true;

    // Init progress table
    document.getElementById('deployBody').innerHTML = selectedDevices.map(d => `
        <tr id="deploy-${d.ip.replace(/\./g, '-')}">
            <td><strong>${escHtml(d.hostname)}</strong></td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.ip)}</td>
            <td><div class="spinner"></div></td>
            <td style="color:#888;">Deploying...</td>
        </tr>
    `).join('');

    document.getElementById('deployStatusText').textContent = `Deploying to ${selectedDevices.length} devices...`;

    const data = await apiCall('deploy-base-config', {
        files: selectedFiles,
        devices: selectedDevices,
        disable_ztp: disableZTP
    });

    if (data.success && data.results) {
        let okCount = 0;
        let failCount = 0;
        data.results.forEach(r => {
            const rowId = `deploy-${r.ip.replace(/\./g, '-')}`;
            const row = document.getElementById(rowId);
            if (row) {
                if (r.success) {
                    okCount++;
                    row.innerHTML = `
                        <td><strong>${escHtml(r.hostname)}</strong></td>
                        <td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td>
                        <td><span class="badge badge-success">OK</span></td>
                        <td style="color:#4caf50;">${escHtml(r.message || 'Deployed successfully')}</td>`;
                } else {
                    failCount++;
                    row.innerHTML = `
                        <td><strong>${escHtml(r.hostname)}</strong></td>
                        <td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td>
                        <td><span class="badge badge-error">FAIL</span></td>
                        <td style="color:#f44336;">${escHtml(r.error || 'Unknown error')}</td>`;
                }
            }
        });
        document.getElementById('deployStatusText').textContent = `Done: ${okCount} OK, ${failCount} failed`;
        showToast(`Deployment complete: ${okCount} OK, ${failCount} failed`, failCount > 0 ? 'error' : 'success');
    } else {
        showToast('Deployment failed: ' + (data.error || 'Unknown error'), 'error');
        document.getElementById('deployStatusText').textContent = 'Deployment failed';
    }

    btn.disabled = false;
}

// ===================== UTILS =====================
function escHtml(s) { 
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}
function escAttr(s) {
    if (!s) return '';
    return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>
</body>
</html>
