<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provision - ZTP & Base Config</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <style>
        /* Prevent browser autofill from changing input background */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 1000px #1a1a1a inset !important;
            -webkit-text-fill-color: #fff !important;
            caret-color: #fff !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
        }

        .page-subtitle {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-status {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #555;
        }

        .status-dot.active { background: #4caf50; }
        .status-dot.inactive { background: #f44336; }
        .status-dot.unknown { background: #ff9800; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3c3c3c;
            padding-bottom: 0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #808080;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #d4d4d4;
            background: #2d2d2d;
        }

        .tab-btn.active {
            color: #76b900;
            border-bottom-color: #76b900;
        }

        .tab-btn .tab-badge {
            background: #76b900;
            color: #000;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn svg { width: 16px; height: 16px; fill: currentColor; }

        .btn-primary {
            background: #76b900;
            color: #000;
        }
        .btn-primary:hover { background: #8cd000; }
        .btn-primary:disabled { background: #3d5e00; color: #666; cursor: not-allowed; }

        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
        }
        .btn-secondary:hover { background: #4a4a4a; }

        .btn-danger {
            background: #c62828;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .btn-warning {
            background: #e65100;
            color: white;
        }
        .btn-warning:hover { background: #ff6d00; }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: #1e1e1e;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #3c3c3c;
            color: #808080;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .data-table tr:hover {
            background: #2d2d2d;
        }

        .data-table .row-actions {
            display: flex;
            gap: 5px;
        }

        /* Scrollable table wrapper */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar { width: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: #1e1e1e; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* Form Elements */
        .form-input {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #76b900;
        }

        .form-input.input-mac { width: 160px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-ip { width: 140px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-hostname { width: 200px; }

        select.form-input {
            cursor: pointer;
        }

        /* Search/Filter */
        .search-filter {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            width: 250px;
        }

        .search-filter:focus {
            outline: none;
            border-color: #76b900;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #1b5e20; color: #4caf50; }
        .badge-error { background: #4a1515; color: #f44336; }
        .badge-warning { background: #4a3000; color: #ff9800; }
        .badge-info { background: #0d3b66; color: #42a5f5; }
        .badge-mismatch { background: #4a1515; color: #ff6b6b; }
        .badge-match { background: #1b5e20; color: #66bb6a; }
        .badge-pending { background: #333; color: #999; }
        .badge-unreachable { background: #3d1515; color: #e57373; }
        .badge-active { background: #1b5e20; color: #4caf50; }
        .badge-expired { background: #4a1515; color: #f44336; }

        /* Inline edit row */
        .edit-row td {
            background: #1a3000 !important;
        }

        .add-row {
            background: #1e2a1e;
            border-top: 2px solid #76b900;
        }

        .add-row td {
            padding: 10px 12px;
        }

        /* Section headers */
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #76b900;
            margin-bottom: 10px;
        }

        .section-desc {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #1e1e1e;
            padding: 12px 20px;
            border-radius: 6px;
            border-left: 3px solid #76b900;
            min-width: 120px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #76b900;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* ZTP Script Editor */
        .editor-container {
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            overflow: hidden;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3c3c3c;
        }

        .editor-filename {
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            color: #76b900;
        }

        .editor-textarea {
            width: 100%;
            min-height: 500px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            tab-size: 4;
        }

        .editor-textarea:focus {
            outline: none;
        }

        /* Key-Value config display */
        .config-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .config-label {
            color: #888;
            font-size: 13px;
            padding: 8px 0;
            text-align: right;
            padding-right: 15px;
        }

        .config-value {
            padding: 8px 12px;
        }

        /* DHCP Lease table colors */
        .lease-active { color: #4caf50; }
        .lease-expired { color: #f44336; }

        /* Base Config file list — compact */
        .file-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .file-card {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
            cursor: pointer;
            font-size: 12px;
        }

        .file-card:hover {
            border-color: #555;
            background: #252526;
        }

        .file-card.selected {
            border-color: #76b900;
            background: #1a2e00;
        }

        .file-card input[type="checkbox"] {
            accent-color: #76b900;
            width: 14px;
            height: 14px;
            margin: 0;
        }

        .file-icon {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-icon svg { width: 14px; height: 14px; fill: #76b900; }
        .file-icon.binary svg { fill: #ff9800; }

        .file-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-name {
            font-size: 12px;
            font-weight: 600;
            color: #d4d4d4;
        }

        .file-dest {
            font-size: 10px;
            color: #666;
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        /* Deploy progress */
        .deploy-progress {
            max-height: 400px;
            overflow-y: auto;
        }

        .deploy-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .deploy-item .hostname {
            width: 200px;
            font-weight: 500;
        }

        .deploy-item .ip {
            width: 140px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 12px;
            color: #888;
        }

        .deploy-item .status {
            flex: 1;
        }

        .deploy-item .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: #1b5e20;
            color: #4caf50;
            border: 1px solid #2e7d32;
        }

        .toast-error {
            background: #4a1515;
            color: #f44336;
            border: 1px solid #c62828;
        }

        .toast-info {
            background: #0d3b66;
            color: #42a5f5;
            border: 1px solid #1565c0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            fill: #555;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            color: #888;
            margin-bottom: 8px;
        }

        /* Modal / Add Binding Form */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 25px;
            min-width: 450px;
            max-width: 600px;
        }

        .modal h3 {
            color: #76b900;
            margin-bottom: 20px;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .modal-field input, .modal-field select {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-field input:focus, .modal-field select:focus {
            outline: none;
            border-color: #76b900;
        }

        .modal-field input.mono {
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Device selector — compact chips */
        .device-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
            max-height: 180px;
            overflow-y: auto;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
        }

        .device-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .device-chip:hover { border-color: #555; }

        .device-chip.selected {
            background: #1a2e00;
            border-color: #76b900;
            color: #76b900;
        }

        .device-chip input[type="checkbox"] {
            accent-color: #76b900;
            width: 12px;
            height: 12px;
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-btn { padding: 10px 16px; font-size: 12px; }
            .toolbar { flex-direction: column; }
            .config-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Page Header -->
<div class="page-header">
    <div>
        <div class="page-title">Provision</div>
        <div class="page-subtitle">ZTP Management & Base Config Deployment</div>
    </div>
    <div class="header-actions">
        <div class="header-status">
            <span class="status-dot unknown" id="dhcpStatusDot"></span>
            <span id="dhcpStatusText">DHCP: Checking...</span>
        </div>
        <div style="display: flex; gap: 6px; margin-left: 15px;">
            <button class="btn btn-primary btn-sm" onclick="dhcpServiceAction('start')" title="Start DHCP">Start</button>
            <button class="btn btn-secondary btn-sm" onclick="dhcpServiceAction('restart')" title="Restart DHCP">Restart</button>
            <button class="btn btn-danger btn-sm" onclick="dhcpServiceAction('stop')" title="Stop DHCP">Stop</button>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="tab-nav">
    <button class="tab-btn active" data-tab="dhcpd">DHCP Server</button>
    <button class="tab-btn" data-tab="bindings">Bindings</button>
    <button class="tab-btn" data-tab="ztp-script">ZTP Script</button>
    <button class="tab-btn" data-tab="base-config">Base Config</button>
</div>

<!-- ==================== TAB 0: DHCPd ==================== -->
<div class="tab-content active" id="tab-dhcpd">

    <!-- DHCP Server Configuration -->
    <div class="section-title">DHCP Server Configuration</div>
    <div class="section-desc">Subnet, IP range, gateway, DNS and ZTP settings. Changes require DHCP restart.</div>
    <div style="padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">SUBNET</label>
                <input type="text" class="form-input" id="dhcpSubnet" style="width: 100%;" placeholder="192.168.58.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">NETMASK</label>
                <input type="text" class="form-input" id="dhcpNetmask" style="width: 100%;" placeholder="255.255.255.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DYNAMIC RANGE START</label>
                <input type="text" class="form-input" id="dhcpRangeStart" style="width: 100%;" placeholder="192.168.58.210">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DYNAMIC RANGE END</label>
                <input type="text" class="form-input" id="dhcpRangeEnd" style="width: 100%;" placeholder="192.168.58.249">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">GATEWAY (ROUTER)</label>
                <input type="text" class="form-input" id="dhcpGateway" style="width: 100%;" placeholder="192.168.58.1">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DNS SERVER</label>
                <input type="text" class="form-input" id="dhcpDNS" style="width: 100%;" placeholder="192.168.58.1">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DOMAIN NAME</label>
                <input type="text" class="form-input" id="dhcpDomain" style="width: 100%;" placeholder="nvidia">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">ZTP PROVISION URL</label>
                <input type="text" class="form-input" id="dhcpProvisionURL" style="width: 100%;" placeholder="http://192.168.58.200/cumulus-ztp.sh">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">LISTEN INTERFACE</label>
                <select class="form-input" id="dhcpInterface" style="width: 100%;"><option value="">Loading...</option></select>
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT LEASE TIME (sec)</label>
                <input type="text" class="form-input" id="dhcpLeaseTime" style="width: 100%;" placeholder="172800">
            </div>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-primary btn-sm" onclick="saveDHCPConfig()">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save Config &amp; Restart DHCP
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadDHCPConfig()">Reload</button>
        </div>
    </div>

    <!-- Discovery & Post-Provision Settings -->
    <div style="padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div class="section-title" style="font-size: 13px; margin-bottom: 8px;">Discovery Range</div>
                <div class="section-desc" style="margin-bottom: 8px; font-size: 11px;">IP range to scan for device discovery. Only IPs in this range will be pinged and probed.</div>
                <input type="text" class="form-input" id="discoveryRange" style="width: 100%; font-family: 'Cascadia Code','Consolas',monospace;" placeholder="192.168.58.10-192.168.58.249">
            </div>
            <div>
                <div class="section-title" style="font-size: 13px; margin-bottom: 8px;">Post-Provision Actions</div>
                <div class="section-desc" style="margin-bottom: 8px; font-size: 11px;">Automatically run on newly provisioned devices (SSH key auth OK + no marker).</div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #ccc;">
                        <input type="checkbox" id="autoBaseConfig" checked> Deploy Base Config (sw-base files)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #ccc;">
                        <input type="checkbox" id="autoZtpDisable" checked> Disable ZTP (sudo ztp -d)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #ccc;">
                        <input type="checkbox" id="autoSetHostname" checked> Set hostname from binding (nv set)
                    </label>
                </div>
            </div>
        </div>
        <div style="margin-top: 10px;">
            <button class="btn btn-secondary btn-sm" onclick="saveDiscoverySettings()">Save Discovery Settings</button>
        </div>
    </div>

    <!-- Discovered Section (inside DHCP Server tab) -->
    <div class="section-title" style="margin-top: 10px;">Discovered Devices</div>
    <div class="section-desc">Subnet-wide discovery with SSH classification. Provisioned devices get auto-configured.</div>
    <div class="stats-row" id="discoveredStats">
        <div class="stat-card" style="cursor:pointer;" onclick="setDiscoveredFilter('provisioned')"><div class="stat-value" id="statProvisioned">-</div><div class="stat-label">Provisioned</div></div>
        <div class="stat-card" style="border-left-color:#ff9800; cursor:pointer;" onclick="setDiscoveredFilter('not_provisioned')"><div class="stat-value" id="statNotProv">-</div><div class="stat-label">Not Provisioned</div></div>
        <div class="stat-card" style="border-left-color:#78909c; cursor:pointer;" onclick="setDiscoveredFilter('other')"><div class="stat-value" id="statOther">-</div><div class="stat-label">Other</div></div>
        <div class="stat-card" style="border-left-color:#f44336; cursor:pointer;" onclick="setDiscoveredFilter('unreachable')"><div class="stat-value" id="statUnreachable">-</div><div class="stat-label">Unreachable</div></div>
        <div class="stat-card" style="border-left-color:#e53935; cursor:pointer;" onclick="setDiscoveredFilter('mismatch')"><div class="stat-value" id="statMismatch">-</div><div class="stat-label">MAC Mismatch</div></div>
        <div class="stat-card" style="border-left-color:#42a5f5; cursor:pointer;" onclick="setDiscoveredFilter('no_binding')"><div class="stat-value" id="statNoBinding">-</div><div class="stat-label">No Binding</div></div>
        <div class="stat-card" style="border-left-color:#888; cursor:pointer;" onclick="setDiscoveredFilter('all')"><div class="stat-value" id="statAll">-</div><div class="stat-label">All</div></div>
    </div>
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="discoveredSearch" placeholder="Filter..." oninput="filterDiscovered()">
            <select class="form-input" id="discoveredFilter" onchange="filterDiscovered()" style="width:180px;">
                <option value="all">All</option>
                <option value="provisioned">Provisioned</option>
                <option value="not_provisioned">Not Provisioned</option>
                <option value="other">Other Device</option>
                <option value="unreachable">Unreachable</option>
                <option value="has_binding">Has Binding</option>
                <option value="no_binding">No Binding</option>
                <option value="mismatch">MAC Mismatch</option>
            </select>
            <span id="discoveredInfo" style="font-size: 11px; color: #666;"></span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-primary btn-sm" onclick="runSubnetScan()" id="btnScan">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                Scan
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="discoveredTable">
            <thead>
                <tr>
                    <th style="cursor:pointer;" onclick="sortDiscovered('hostname')">Hostname <span id="sort-hostname" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('ip')">IP <span id="sort-ip" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('binding_mac')">Binding MAC <span id="sort-binding_mac" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('discovered_mac')">Discovered MAC <span id="sort-discovered_mac" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('device_type')">Device Type <span id="sort-device_type" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('mac_status')">Status <span id="sort-mac_status" style="opacity:0.4;">&#9650;</span></th>
                </tr>
            </thead>
            <tbody id="discoveredBody">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 1: BINDINGS ==================== -->
<div class="tab-content" id="tab-bindings">
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="bindingSearch" placeholder="Filter by hostname, MAC, or IP..." oninput="filterBindings()">
            <span id="bindingCount" style="font-size: 12px; color: #888;"></span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadBindings()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
            <button class="btn btn-primary" onclick="showAddBinding()">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Add Binding
            </button>
            <button class="btn btn-secondary" onclick="showBulkImport()">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11z"/></svg>
                Bulk Import
            </button>
            <button class="btn btn-warning" onclick="saveBindings()" id="btnSaveBindings" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save &amp; Restart DHCP
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="bindingsTable">
            <thead>
                <tr>
                    <th style="width:30px;"><input type="checkbox" id="selectAllBindings" onchange="toggleSelectAllBindings()"></th>
                    <th style="cursor:pointer;" onclick="sortBindings('hostname')">Hostname <span id="bsort-hostname" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('mac')">MAC Address <span id="bsort-mac" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('ip')">IP Address <span id="bsort-ip" style="opacity:1;">&#9650;</span></th>
                    <th>Discovered MAC</th>
                    <th style="cursor:pointer;" onclick="sortBindings('status')">Status <span id="bsort-status" style="opacity:0.4;">&#9650;</span></th>
                    <th style="width:50px; text-align:center;">Live</th>
                    <th style="width:120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="bindingsBody">
                <tr><td colspan="8" class="loading">Loading bindings...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 3: ZTP SCRIPT ==================== -->
<div class="tab-content" id="tab-ztp-script">
    <div class="section-desc">ZTP provisioning settings, SSH key management, OS image, and script editor.</div>

    <!-- SSH Key Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #76b900;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 5px;">SSH Key</div>
        <div class="section-desc" style="margin-bottom: 10px;">Single key pair used for ZTP provisioning and device management (Assets SSH Setup).</div>
        <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">PUBLIC KEY</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="ztpSSHKey" readonly style="flex:1; font-family:'Cascadia Code','Consolas',monospace; font-size:11px; background:#252526;" placeholder="No key generated yet...">
                    <button class="btn btn-secondary btn-sm" onclick="copySSHKey()" title="Copy public key">Copy</button>
                </div>
            </div>
            <div style="display: flex; gap: 8px; padding-top: 18px;">
                <button class="btn btn-primary btn-sm" onclick="generateSSHKey()">
                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h3v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    Generate
                </button>
                <button class="btn btn-secondary btn-sm" onclick="toggleImportKey()">Import</button>
                <button class="btn btn-secondary btn-sm" onclick="loadSSHKey()">Refresh</button>
            </div>
        </div>
        <div id="sshKeyStatus" style="margin-top: 8px; font-size: 12px; color: #888;"></div>
        <!-- Import Key Area (hidden by default) -->
        <div id="importKeyArea" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #3c3c3c;">
            <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">PASTE PRIVATE KEY</label>
            <textarea id="importKeyText" spellcheck="false" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" style="width:100%; height:120px; padding:10px; background:#1a1a1a; color:#4fc3f7; border:1px solid #555; border-radius:4px; font-family:'Cascadia Code','Consolas',monospace; font-size:11px; resize:vertical; box-sizing:border-box;"></textarea>
            <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                <button class="btn btn-primary btn-sm" onclick="importSSHKey()">Save Key</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleImportKey()">Cancel</button>
                <span id="importKeyMsg" style="font-size: 12px; color: #888;"></span>
            </div>
        </div>
    </div>

    <!-- Quick Settings Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 10px;">Quick Settings</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">TARGET OS VERSION</label>
                <input type="text" class="form-input" id="ztpTargetOS" style="width: 100%;" placeholder="e.g. 5.14.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT PASSWORD</label>
                <div style="position: relative;">
                    <input type="password" class="form-input" id="ztpPassword" style="width: 100%; padding-right: 36px;" placeholder="Default password" autocomplete="off">
                    <button onclick="togglePasswordVisibility()" style="position:absolute; right:4px; top:50%; transform:translateY(-50%); background:none; border:none; color:#888; cursor:pointer; padding:4px;" title="Show/Hide" id="pwToggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                </div>
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">IMAGE SERVER IP</label>
                <input type="text" class="form-input input-ip" id="ztpImageServer" style="width: 100%;" placeholder="e.g. 192.168.58.200">
            </div>
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="applyQuickSettings()">Apply to Script</button>
    </div>

    <!-- OS Image Upload Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 5px;">OS Image</div>
        <div class="section-desc" style="margin-bottom: 10px;">Cumulus Linux image served via HTTP for ZTP OS upgrades.</div>
        <div id="imageList" style="margin-bottom: 10px;"><span style="color:#888;">Checking...</span></div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <label class="btn btn-secondary btn-sm" style="cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                Upload Image
                <input type="file" id="imageUpload" style="display: none;" accept=".bin,.img,.iso" onchange="uploadImage(this)">
            </label>
            <span id="uploadProgress" style="font-size: 12px; color: #888;"></span>
        </div>
    </div>

    <!-- Script Editor (collapsed by default) -->
    <div class="editor-container">
        <div class="editor-toolbar" style="cursor: pointer;" onclick="toggleScriptEditor()">
            <span class="editor-filename">
                <span id="editorToggle" style="margin-right: 6px;">&#9654;</span>
                cumulus-ztp.sh — Click to edit
            </span>
            <div style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
                <button class="btn btn-secondary btn-sm" onclick="loadZTPScript()">Reload</button>
                <button class="btn btn-primary btn-sm" onclick="saveZTPScript()">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    Save
                </button>
            </div>
        </div>
        <textarea class="editor-textarea" id="ztpEditor" spellcheck="false" style="display: none;"></textarea>
    </div>
</div>

<!-- ==================== TAB 5: BASE CONFIG ==================== -->
<div class="tab-content" id="tab-base-config">
    <div style="display: flex; gap: 15px; height: calc(100vh - 250px); min-height: 400px;">

        <!-- Left: Device Selection Panel (Device Details pattern) -->
        <div style="width: 300px; background: #252526; border: 1px solid #3c3c3c; border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;">
            <!-- Header -->
            <div style="padding: 10px 12px; background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%); color: white; font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: space-between;">
                <span>Select Devices</span>
                <span style="font-weight: normal; font-size: 12px;" id="bcSelectedCount">0 selected</span>
            </div>
            <!-- Quick actions -->
            <div style="padding: 6px 10px; border-bottom: 1px solid #404040; display: flex; gap: 8px; align-items: center; background: #2d2d2d;">
                <a href="#" onclick="bcSelectAll(true); return false;" style="font-size: 11px; color: #76b900; text-decoration: none;">All</a>
                <a href="#" onclick="bcSelectAll(false); return false;" style="font-size: 11px; color: #888; text-decoration: none;">None</a>
                <span style="flex:1;"></span>
                <span style="font-size: 11px; color: #666;" id="bcTotalDevices"></span>
            </div>
            <!-- Search -->
            <div style="padding: 8px 10px; border-bottom: 1px solid #404040;">
                <input type="text" id="bcDeviceSearch" placeholder="Search devices..." oninput="bcFilterDevices()" style="width: 100%; padding: 6px 10px; background: #3c3c3c; border: 1px solid #555; border-radius: 4px; color: #d4d4d4; font-size: 12px;">
            </div>
            <!-- Device list with role groups -->
            <div style="flex: 1; overflow-y: auto; padding: 5px 0;" id="bcDeviceList">
                <div class="loading" style="padding: 20px;">Loading devices...</div>
            </div>
        </div>

        <!-- Right: Deploy area -->
        <div style="flex: 1; display: flex; flex-direction: column;">
            <!-- Info bar -->
            <div style="padding: 12px 15px; background: #252526; border: 1px solid #3c3c3c; border-radius: 6px; margin-bottom: 10px; display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="deployBaseConfig()" id="btnDeploy">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    Deploy
                </button>
                <label style="font-size: 12px; cursor: pointer; color: #888;">
                    <input type="checkbox" id="disableZTPAfter" style="accent-color: #76b900;">
                    Disable ZTP after deploy
                </label>
                <span id="deployStatusText" style="font-size: 12px; color: #888; margin-left: auto;"></span>
            </div>
            <!-- Files info (compact) -->
            <div style="padding: 8px 12px; background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; margin-bottom: 10px; font-size: 12px; color: #888;">
                <span style="color: #76b900; font-weight: 600;">Files:</span>
                <span id="bcFileList"></span>
            </div>
            <!-- Deploy Progress -->
            <div style="flex: 1; overflow-y: auto;" id="deployProgress">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #555;">
                    <svg viewBox="0 0 24 24" style="width: 60px; height: 60px; fill: #555; margin-bottom: 15px;"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    <div style="font-size: 14px; color: #888;">Select devices and click Deploy</div>
                    <div style="font-size: 12px; margin-top: 5px;">All sw-base files will be deployed via parallel SSH/SCP</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Binding Modal -->
<div class="modal-overlay" id="bindingModal" style="display: none;" onclick="if(event.target===this)closeBindingModal()">
    <div class="modal">
        <h3 id="modalTitle">Add Binding</h3>
        <div class="modal-field">
            <label>Hostname</label>
            <input type="text" id="modalHostname" placeholder="e.g. leaf-01">
        </div>
        <div class="modal-field">
            <label>MAC Address</label>
            <input type="text" id="modalMAC" class="mono" placeholder="e.g. 54:9b:24:aa:68:16" oninput="formatMAC(this)">
        </div>
        <div class="modal-field">
            <label>IP Address</label>
            <input type="text" id="modalIP" class="mono" placeholder="e.g. 192.168.58.11">
        </div>
        <input type="hidden" id="modalOrigHostname">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBindingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBinding()" id="modalSaveBtn">Add</button>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal-overlay" id="bulkImportModal" style="display: none;" onclick="if(event.target===this)closeBulkImport()">
    <div class="modal" style="min-width: 600px;">
        <h3>Bulk Import Bindings</h3>
        <div class="section-desc" style="margin-bottom: 10px;">
            Paste one binding per line. Format: <code style="color:#76b900;">hostname  MAC  IP</code> (separated by space or tab)
        </div>
        <div style="margin-bottom: 10px; padding: 10px; background: #1e1e1e; border-radius: 4px; font-size: 12px; color: #888; font-family: 'Cascadia Code','Consolas',monospace;">
            Example:<br>
            leaf-01&nbsp;&nbsp;54:9b:24:aa:68:16&nbsp;&nbsp;192.168.58.11<br>
            leaf-02&nbsp;&nbsp;54:9b:24:8d:35:44&nbsp;&nbsp;192.168.58.12<br>
            spine-01&nbsp;8c:91:3a:b4:aa:60&nbsp;&nbsp;192.168.58.17
        </div>
        <textarea id="bulkImportText" style="width:100%; min-height:250px; padding:12px; background:#1a1a1a; color:#d4d4d4; border:1px solid #555; border-radius:4px; font-family:'Cascadia Code','Consolas',monospace; font-size:13px; line-height:1.6; resize:vertical;" spellcheck="false" placeholder="hostname  MAC  IP&#10;hostname  MAC  IP&#10;..."></textarea>
        <div id="bulkImportPreview" style="margin-top: 10px; font-size: 12px; color: #888;"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBulkImport()">Cancel</button>
            <button class="btn btn-primary" onclick="applyBulkImport()">Import</button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<script>
// ===================== GLOBAL STATE =====================
let allBindings = [];
let bindingsModified = false;
let allDiscovered = [];
let deviceList = [];

const BASE_CONFIG_FILES = [
    { name: 'bash.bashrc', dest: '/etc/bash.bashrc', destAlt: '/home/cumulus/.bashrc', type: 'config', desc: 'Shell aliases & VRF helpers' },
    { name: 'motd.sh', dest: '/etc/profile.d/motd.sh', type: 'config', desc: 'Login banner with BGP status' },
    { name: 'tmux.conf', dest: '/etc/tmux.conf', type: 'config', desc: 'tmux settings' },
    { name: 'nanorc', dest: '/etc/nanorc', type: 'config', desc: 'Editor settings' },
    { name: 'cmd', dest: '/usr/local/bin/cmd', type: 'script', desc: 'tmux session manager' },
    { name: 'nvc', dest: '/usr/local/bin/nvc', type: 'script', desc: 'NV config colorizer' },
    { name: 'nvt', dest: '/usr/local/bin/nvt', type: 'script', desc: 'Interface table tool' },
    { name: 'exa', dest: '/usr/bin/exa', type: 'binary', desc: 'Modern ls replacement' }
];

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            onTabSwitch(btn.dataset.tab);
        });
    });

    // Load initial data
    loadDHCPConfig();
    loadDiscoveryCache();
    loadDeviceList();
    checkDHCPStatus();
});

function onTabSwitch(tab) {
    if (tab === 'dhcpd') { loadDHCPConfig(); loadDiscoveryCache(); }
    if (tab === 'bindings' && allBindings.length === 0) loadBindings();
    if (tab === 'ztp-script') loadZTPScript();
}

function setDiscoveredFilter(status) {
    document.getElementById('discoveredFilter').value = status;
    renderDiscovered();
    // Scroll to discovered table
    document.getElementById('discoveredTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===================== API HELPER =====================
async function apiCall(action, data = null) {
    try {
        const opts = {};
        if (data) {
            opts.method = 'POST';
            opts.headers = { 'Content-Type': 'application/json' };
            opts.body = JSON.stringify(data);
        }
        const resp = await fetch(`/provision-api.sh?action=${action}`, opts);
        return await resp.json();
    } catch (e) {
        return { success: false, error: e.message };
    }
}

// ===================== TOAST =====================
function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast toast-${type} show`;
    setTimeout(() => t.classList.remove('show'), 4000);
}

// ===================== DHCP STATUS CHECK =====================
async function checkDHCPStatus() {
    const data = await apiCall('dhcp-service-status');
    const dot = document.getElementById('dhcpStatusDot');
    const txt = document.getElementById('dhcpStatusText');
    if (data.success && data.running) {
        dot.className = 'status-dot active';
        txt.textContent = 'DHCP: Running';
    } else if (data.success && !data.running) {
        dot.className = 'status-dot inactive';
        txt.textContent = 'DHCP: Stopped';
    } else {
        dot.className = 'status-dot unknown';
        txt.textContent = 'DHCP: Unknown';
    }
}

// ===================== DHCP SERVICE CONTROL =====================
async function dhcpServiceAction(action) {
    if (action === 'stop') {
        showConfirmModal('Stop DHCP Server', 'Stop DHCP server? New devices will not get IP addresses.', () => _dhcpServiceAction(action));
        return;
    }
    _dhcpServiceAction(action);
}
async function _dhcpServiceAction(action) {
    showToast(`DHCP: ${action}...`, 'info');
    const data = await apiCall('dhcp-service-control', { action });
    if (data.success) {
        showToast(`DHCP ${action}: ${data.message || 'OK'}`, 'success');
    } else {
        showToast(`DHCP ${action} failed: ${data.error || 'Unknown error'}`, 'error');
    }
    checkDHCPStatus();
}

// ===================== DHCP CONFIG =====================
async function loadDHCPConfig() {
    const data = await apiCall('get-dhcp-config');
    if (data.success) {
        document.getElementById('dhcpSubnet').value = data.subnet || '';
        document.getElementById('dhcpNetmask').value = data.netmask || '';
        document.getElementById('dhcpRangeStart').value = data.range_start || '';
        document.getElementById('dhcpRangeEnd').value = data.range_end || '';
        document.getElementById('dhcpGateway').value = data.gateway || '';
        document.getElementById('dhcpDNS').value = data.dns || '';
        document.getElementById('dhcpDomain').value = data.domain || '';
        document.getElementById('dhcpProvisionURL').value = data.provision_url || '';
        document.getElementById('dhcpLeaseTime').value = data.lease_time || '';
        
        // Discovery range and post-provision settings
        document.getElementById('discoveryRange').value = data.discovery_range || '';
        document.getElementById('autoBaseConfig').checked = data.auto_base_config !== false;
        document.getElementById('autoZtpDisable').checked = data.auto_ztp_disable !== false;
        document.getElementById('autoSetHostname').checked = data.auto_set_hostname !== false;
        
        // Populate interface dropdown
        const sel = document.getElementById('dhcpInterface');
        const currentIface = data.interface || 'eth0';
        const ifaces = data.interfaces || [];
        if (ifaces.length > 0) {
            sel.innerHTML = ifaces.map(i => {
                const selected = i.name === currentIface ? ' selected' : '';
                const ipLabel = i.ip ? ` (${i.ip})` : ' (no IP)';
                return `<option value="${escHtml(i.name)}"${selected}>${escHtml(i.name)}${ipLabel}</option>`;
            }).join('');
        } else {
            sel.innerHTML = `<option value="${escHtml(currentIface)}" selected>${escHtml(currentIface)}</option>`;
        }
    }
}

async function saveDHCPConfig() {
    const config = {
        subnet: document.getElementById('dhcpSubnet').value.trim(),
        netmask: document.getElementById('dhcpNetmask').value.trim(),
        range_start: document.getElementById('dhcpRangeStart').value.trim(),
        range_end: document.getElementById('dhcpRangeEnd').value.trim(),
        gateway: document.getElementById('dhcpGateway').value.trim(),
        dns: document.getElementById('dhcpDNS').value.trim(),
        domain: document.getElementById('dhcpDomain').value.trim(),
        provision_url: document.getElementById('dhcpProvisionURL').value.trim(),
        interface: document.getElementById('dhcpInterface').value.trim(),
        lease_time: document.getElementById('dhcpLeaseTime').value.trim(),
        discovery_range: document.getElementById('discoveryRange').value.trim(),
        auto_base_config: document.getElementById('autoBaseConfig').checked,
        auto_ztp_disable: document.getElementById('autoZtpDisable').checked,
        auto_set_hostname: document.getElementById('autoSetHostname').checked,
    };

    if (!config.subnet || !config.netmask || !config.gateway) {
        showToast('Subnet, Netmask and Gateway are required', 'error');
        return;
    }

    const data = await apiCall('save-dhcp-config', config);
    if (data.success) {
        showToast('DHCP config saved & server restarted', 'success');
        checkDHCPStatus();
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

async function saveDiscoverySettings() {
    const settings = {
        discovery_range: document.getElementById('discoveryRange').value.trim(),
        auto_base_config: document.getElementById('autoBaseConfig').checked,
        auto_ztp_disable: document.getElementById('autoZtpDisable').checked,
        auto_set_hostname: document.getElementById('autoSetHostname').checked,
    };
    const data = await apiCall('save-post-provision', settings);
    if (data.success) {
        showToast('Discovery settings saved', 'success');
    } else {
        showToast('Save failed: ' + (data.error || ''), 'error');
    }
}

// ===================== BULK IMPORT =====================
function showBulkImport() {
    document.getElementById('bulkImportText').value = '';
    document.getElementById('bulkImportPreview').textContent = '';
    document.getElementById('bulkImportModal').style.display = 'flex';
    document.getElementById('bulkImportText').focus();
}

function closeBulkImport() {
    document.getElementById('bulkImportModal').style.display = 'none';
}

function parseBulkText(text) {
    const lines = text.trim().split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
    const entries = [];
    const errors = [];

    lines.forEach((line, idx) => {
        // Split by whitespace (spaces or tabs)
        const parts = line.trim().split(/\s+/);
        if (parts.length < 3) {
            errors.push(`Line ${idx + 1}: Need 3 columns (hostname MAC IP), got ${parts.length}`);
            return;
        }
        const hostname = parts[0];
        const mac = parts[1].toLowerCase();
        const ip = parts[2];

        if (!/^([0-9a-fx]{2}:){5}[0-9a-fx]{2}$/.test(mac)) {
            errors.push(`Line ${idx + 1}: Invalid MAC "${parts[1]}"`);
            return;
        }
        if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
            errors.push(`Line ${idx + 1}: Invalid IP "${ip}"`);
            return;
        }
        entries.push({ hostname, mac, ip, commented: false });
    });

    return { entries, errors };
}

function applyBulkImport() {
    const text = document.getElementById('bulkImportText').value;
    if (!text.trim()) {
        showToast('Paste binding data first', 'error');
        return;
    }

    const { entries, errors } = parseBulkText(text);

    if (errors.length > 0) {
        document.getElementById('bulkImportPreview').innerHTML =
            `<span style="color:#f44336;">Errors:</span><br>` +
            errors.map(e => `• ${escHtml(e)}`).join('<br>');
        return;
    }

    if (entries.length === 0) {
        showToast('No valid entries found', 'error');
        return;
    }

    // Merge with existing bindings
    let added = 0, updated = 0;
    entries.forEach(entry => {
        const existing = allBindings.findIndex(b => b.hostname === entry.hostname);
        if (existing >= 0) {
            allBindings[existing] = entry;
            updated++;
        } else {
            allBindings.push(entry);
            added++;
        }
    });

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    closeBulkImport();
    renderBindings();
    showToast(`Imported: ${added} added, ${updated} updated (unsaved)`, 'info');
}

// ===================== TAB 1: BINDINGS =====================
async function loadBindings() {
    document.getElementById('bindingsBody').innerHTML = '<tr><td colspan="8" class="loading">Loading bindings...</td></tr>';
    const data = await apiCall('list-bindings');
    if (data.success) {
        allBindings = data.bindings || [];
        bindingsModified = false;
        document.getElementById('btnSaveBindings').style.display = 'none';
        renderBindings();
    } else {
        document.getElementById('bindingsBody').innerHTML = `<tr><td colspan="8" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
}

let bindSortCol = 'ip';
let bindSortAsc = true;

function sortBindings(col) {
    if (bindSortCol === col) { bindSortAsc = !bindSortAsc; }
    else { bindSortCol = col; bindSortAsc = true; }
    document.querySelectorAll('[id^="bsort-"]').forEach(el => { el.style.opacity = '0.4'; el.innerHTML = '&#9650;'; });
    const ind = document.getElementById('bsort-' + col);
    if (ind) { ind.style.opacity = '1'; ind.innerHTML = bindSortAsc ? '&#9650;' : '&#9660;'; }
    renderBindings();
}

function renderBindings() {
    const filter = document.getElementById('bindingSearch').value.toLowerCase();
    const filtered = allBindings.filter(b =>
        b.hostname.toLowerCase().includes(filter) ||
        b.mac.toLowerCase().includes(filter) ||
        b.ip.includes(filter)
    );

    // Sort
    filtered.sort((a, b) => {
        let va = a[bindSortCol] || '';
        let vb = b[bindSortCol] || '';
        if (bindSortCol === 'ip') {
            return bindSortAsc ? ipToNum(va) - ipToNum(vb) : ipToNum(vb) - ipToNum(va);
        }
        if (bindSortCol === 'status') {
            va = a.commented ? 'z' : 'a'; vb = b.commented ? 'z' : 'a';
        } else {
            va = va.toLowerCase(); vb = vb.toLowerCase();
        }
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return bindSortAsc ? cmp : -cmp;
    });

    document.getElementById('bindingCount').textContent = `${filtered.length} of ${allBindings.length} bindings`;

    if (filtered.length === 0) {
        document.getElementById('bindingsBody').innerHTML = `
            <tr><td colspan="8" style="text-align:center; padding:40px; color:#666;">
                ${allBindings.length === 0 ? 'No bindings configured. Click "Add Binding" to create one.' : 'No matches found.'}
            </td></tr>`;
        return;
    }

    // Build discovery lookup from cache (allDiscovered from subnet scan)
    const discByIp = {};
    (allDiscovered || []).forEach(d => { if (d.ip) discByIp[d.ip] = d; });

    document.getElementById('bindingsBody').innerHTML = filtered.map((b, i) => {
        const disc = discByIp[b.ip] || {};
        const dmac = disc.discovered_mac || '';
        const isAlive = disc.device_type && disc.device_type !== 'unreachable';
        const macMatch = dmac && b.mac && dmac === b.mac.toLowerCase();
        const macMismatch = dmac && b.mac && !b.mac.toLowerCase().includes('x') && dmac !== b.mac.toLowerCase();
        
        let dmacHtml = '-';
        if (dmac) {
            if (macMismatch) dmacHtml = `<span style="color:#ff6b6b;" title="Mismatch!">${escHtml(dmac)}</span>`;
            else if (macMatch) dmacHtml = `<span style="color:#4caf50;">${escHtml(dmac)}</span>`;
            else dmacHtml = escHtml(dmac);
        }
        
        let liveIcon;
        if (!disc.device_type) {
            liveIcon = '<span style="display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:4px;background:rgba(100,100,100,0.2);color:#555;font-size:13px;" title="Not scanned">-</span>';
        } else if (isAlive) {
            liveIcon = '<span style="display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:4px;background:rgba(76,175,80,0.2);color:#81c784;font-size:13px;" title="Reachable">&#10003;</span>';
        } else {
            liveIcon = '<span style="display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:4px;background:rgba(244,67,54,0.2);color:#e57373;font-size:13px;" title="Unreachable">&#10007;</span>';
        }

        return `<tr data-idx="${i}">
            <td><input type="checkbox" class="binding-cb" data-hostname="${b.hostname}"></td>
            <td><strong>${escHtml(b.hostname)}</strong></td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.mac)}</td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.ip)}</td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${dmacHtml}</td>
            <td>${b.mac.toLowerCase().includes('x') ? '<span class="badge badge-warning">Pending MAC</span>' : b.commented ? '<span class="badge badge-pending">Disabled</span>' : '<span class="badge badge-active">Active</span>'}</td>
            <td style="text-align:center;">${liveIcon}</td>
            <td class="row-actions">
                <button class="btn btn-secondary btn-sm" onclick="editBinding('${escAttr(b.hostname)}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBinding('${escAttr(b.hostname)}')">Del</button>
            </td>
        </tr>`;
    }).join('');
}

function filterBindings() { renderBindings(); }

function showAddBinding() {
    document.getElementById('modalTitle').textContent = 'Add Binding';
    document.getElementById('modalHostname').value = '';
    document.getElementById('modalMAC').value = 'xx:xx:xx:xx:xx:xx';
    document.getElementById('modalIP').value = '';
    document.getElementById('modalOrigHostname').value = '';
    document.getElementById('modalSaveBtn').textContent = 'Add';
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function editBinding(hostname) {
    const b = allBindings.find(x => x.hostname === hostname);
    if (!b) return;
    document.getElementById('modalTitle').textContent = 'Edit Binding';
    document.getElementById('modalHostname').value = b.hostname;
    document.getElementById('modalMAC').value = b.mac;
    document.getElementById('modalIP').value = b.ip;
    document.getElementById('modalOrigHostname').value = b.hostname;
    document.getElementById('modalSaveBtn').textContent = 'Update';
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function closeBindingModal() {
    document.getElementById('bindingModal').style.display = 'none';
}

function saveBinding() {
    const hostname = document.getElementById('modalHostname').value.trim();
    const mac = document.getElementById('modalMAC').value.trim().toLowerCase();
    const ip = document.getElementById('modalIP').value.trim();
    const origHostname = document.getElementById('modalOrigHostname').value;

    if (!hostname || !mac || !ip) {
        showToast('All fields are required', 'error');
        return;
    }

    // MAC format validation — allow placeholder like xx:xx:xx:xx:xx:xx
    if (!/^([0-9a-fx]{2}:){5}[0-9a-fx]{2}$/.test(mac)) {
        showToast('Invalid MAC format. Use xx:xx:xx:xx:xx:xx', 'error');
        return;
    }

    // IP format validation
    if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
        showToast('Invalid IP format', 'error');
        return;
    }

    if (origHostname) {
        // Edit existing
        const idx = allBindings.findIndex(x => x.hostname === origHostname);
        if (idx >= 0) {
            allBindings[idx] = { hostname, mac, ip, commented: false };
        }
    } else {
        // Check duplicate
        if (allBindings.find(x => x.hostname === hostname)) {
            showToast(`Hostname "${hostname}" already exists`, 'error');
            return;
        }
        allBindings.push({ hostname, mac, ip, commented: false });
    }

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    closeBindingModal();
    renderBindings();
    showToast(origHostname ? 'Binding updated (unsaved)' : 'Binding added (unsaved)', 'info');
}

function deleteBinding(hostname) {
    showConfirmModal('Delete Binding', `Delete binding for <strong>${hostname}</strong>?`, () => {
        allBindings = allBindings.filter(x => x.hostname !== hostname);
        bindingsModified = true;
        document.getElementById('btnSaveBindings').style.display = '';
        renderBindings();
        showToast(`Binding "${hostname}" deleted (unsaved)`, 'info');
    });
}

async function saveBindings() {
    const btn = document.getElementById('btnSaveBindings');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const data = await apiCall('save-bindings', { bindings: allBindings });
    if (data.success) {
        bindingsModified = false;
        btn.style.display = 'none';
        showToast('Bindings saved & DHCP restarted', 'success');
        checkDHCPStatus();
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Save &amp; Restart DHCP';
}

function toggleSelectAllBindings() {
    const checked = document.getElementById('selectAllBindings').checked;
    document.querySelectorAll('.binding-cb').forEach(cb => cb.checked = checked);
}

function formatMAC(input) {
    let v = input.value.replace(/[^0-9a-fA-F]/g, '').substring(0, 12);
    let parts = [];
    for (let i = 0; i < v.length; i += 2) {
        parts.push(v.substring(i, i + 2));
    }
    input.value = parts.join(':');
}

// ===================== TAB 2: DISCOVERED =====================
async function loadDiscoveryCache() {
    const data = await apiCall('discovery-cache');
    if (data.success && data.entries && data.entries.length > 0) {
        allDiscovered = data.entries;
        renderDiscoveredStats();
        renderDiscovered();
        updateDiscoveryInfo(data.age_seconds || 0);
        // If stale, silent background scan (no loading indicators)
        if (data.stale) silentSubnetScan();
    } else {
        // No cache — silent scan
        document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666;">No scan data yet. Click Scan or wait...</td></tr>';
        silentSubnetScan();
    }
}

function updateDiscoveryInfo(ageSec) {
    const info = document.getElementById('discoveredInfo');
    if (ageSec < 60) info.textContent = `${ageSec}s ago`;
    else if (ageSec < 3600) info.textContent = `${Math.round(ageSec/60)}m ago`;
    else info.textContent = `${Math.round(ageSec/3600)}h ago`;
}

// Silent background scan — no loading indicators, just updates data
async function silentSubnetScan() {
    const data = await apiCall('subnet-scan');
    if (data.success) {
        allDiscovered = data.entries || [];
        renderDiscoveredStats();
        renderDiscovered();
        updateDiscoveryInfo(0);
        // Refresh bindings table if loaded (uses discovery cache for MAC/Live columns)
        if (allBindings.length > 0) renderBindings();
    }
}

// Start periodic background scan (every 5 minutes)
setInterval(silentSubnetScan, 300000);

function renderDiscoveredStats() {
    const provisioned = allDiscovered.filter(d => d.device_type === 'provisioned').length;
    const notProv = allDiscovered.filter(d => d.device_type === 'not_provisioned').length;
    const other = allDiscovered.filter(d => d.device_type === 'other').length;
    // Unreachable: only count binding IPs (empty IPs in range are noise)
    const unreachable = allDiscovered.filter(d => d.device_type === 'unreachable' && d.has_binding).length;
    const mismatch = allDiscovered.filter(d => d.mac_status === 'mismatch').length;
    // No Binding: reachable IPs without binding (new unknown devices on network)
    const noBinding = allDiscovered.filter(d => !d.has_binding && d.device_type !== 'unreachable').length;
    // All: meaningful entries (exclude empty unreachable IPs)
    const meaningful = allDiscovered.filter(d => d.has_binding || d.device_type !== 'unreachable').length;
    document.getElementById('statProvisioned').textContent = provisioned;
    document.getElementById('statNotProv').textContent = notProv;
    document.getElementById('statOther').textContent = other;
    document.getElementById('statUnreachable').textContent = unreachable;
    document.getElementById('statMismatch').textContent = mismatch;
    document.getElementById('statNoBinding').textContent = noBinding;
    document.getElementById('statAll').textContent = meaningful;
}

async function runSubnetScan() {
    // Manual scan — shows loading indicator
    const btn = document.getElementById('btnScan');
    btn.disabled = true;
    btn.textContent = 'Scanning...';
    document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" class="loading">Scanning subnet: ping + SSH probe + post-provision...</td></tr>';
    
    const data = await apiCall('subnet-scan');
    if (data.success) {
        allDiscovered = data.entries || [];
        renderDiscoveredStats();
        renderDiscovered();
        const prov = allDiscovered.filter(d => d.device_type === 'provisioned').length;
        const unreach = allDiscovered.filter(d => d.device_type === 'unreachable').length;
        const deployed = Object.values(data.post_provision_results || {}).filter(s => s === 'deployed').length;
        let msg = `Scan: ${data.reachable || 0}/${data.total_ips || 0} reachable, ${prov} provisioned`;
        if (deployed > 0) msg += `, ${deployed} newly configured`;
        showToast(msg, 'success');
        updateDiscoveryInfo(0);
        if (allBindings.length > 0) renderBindings();
    } else {
        document.getElementById('discoveredBody').innerHTML = `<tr><td colspan="6" style="color:#f44336;padding:20px;">Scan failed: ${data.error}</td></tr>`;
        showToast('Scan failed: ' + (data.error || ''), 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Scan';
}

function renderDiscovered() {
    const filter = document.getElementById('discoveredSearch').value.toLowerCase();
    const typeFilter = document.getElementById('discoveredFilter').value;

    let filtered = allDiscovered;
    // Default: hide empty IPs (unreachable + no binding = unused IP in range)
    if (typeFilter === 'all') {
        filtered = filtered.filter(d => d.has_binding || d.device_type !== 'unreachable');
    } else if (typeFilter === 'has_binding') {
        filtered = filtered.filter(d => d.has_binding);
    } else if (typeFilter === 'no_binding') {
        filtered = filtered.filter(d => !d.has_binding && d.device_type !== 'unreachable');
    } else if (typeFilter === 'mismatch') {
        filtered = filtered.filter(d => d.mac_status === 'mismatch');
    } else if (typeFilter === 'unreachable') {
        // Unreachable filter: only show binding IPs that are unreachable (interesting ones)
        filtered = filtered.filter(d => d.device_type === 'unreachable' && d.has_binding);
    } else {
        filtered = filtered.filter(d => d.device_type === typeFilter);
    }
    if (filter) {
        filtered = filtered.filter(d =>
            (d.hostname || '').toLowerCase().includes(filter) ||
            (d.binding_mac || '').toLowerCase().includes(filter) ||
            (d.discovered_mac || '').toLowerCase().includes(filter) ||
            (d.ip || '').includes(filter)
        );
    }

    // Sort
    filtered.sort((a, b) => {
        let va = a[discSortCol] || '';
        let vb = b[discSortCol] || '';
        if (discSortCol === 'ip') {
            return discSortAsc ? ipToNum(va) - ipToNum(vb) : ipToNum(vb) - ipToNum(va);
        }
        va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return discSortAsc ? cmp : -cmp;
    });

    if (filtered.length === 0) {
        document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">No entries found.</td></tr>';
        return;
    }

    document.getElementById('discoveredBody').innerHTML = filtered.map(d => {
        // Device type badge
        const dtBadge = {
            'provisioned': '<span class="badge badge-match">Provisioned</span>',
            'not_provisioned': '<span class="badge badge-warning">Not Provisioned</span>',
            'other': '<span class="badge" style="background:rgba(120,144,156,0.15);color:#78909c;">Other</span>',
            'unreachable': '<span class="badge badge-unreachable">Unreachable</span>'
        }[d.device_type] || '';
        
        // Post-provision indicator
        let ppIcon = '';
        if (d.post_provision === 'deployed') ppIcon = ' <span title="Just configured" style="color:#4caf50;">&#10004;</span>';
        else if (d.post_provision === 'already') ppIcon = ' <span title="Already configured" style="color:#888;">&#10003;</span>';
        
        // MAC status badge
        let macBadge = '';
        if (d.mac_status === 'match') macBadge = '<span class="badge badge-match" style="font-size:10px;">Match</span>';
        else if (d.mac_status === 'mismatch') macBadge = '<span class="badge badge-mismatch" style="font-size:10px;">Mismatch</span>';
        else if (d.mac_status === 'no_binding') macBadge = '<span class="badge badge-info" style="font-size:10px;">No Binding</span>';
        else if (d.mac_status === 'unreachable' && d.has_binding) macBadge = '<span class="badge badge-unreachable" style="font-size:10px;">Unreachable</span>';

        // Discovered MAC color
        const dmac = d.discovered_mac || '-';
        const dmacHtml = d.mac_status === 'mismatch' ? `<span style="color:#ff6b6b;">${escHtml(dmac)}</span>` : escHtml(dmac);

        return `<tr>
            <td><strong>${escHtml(d.hostname || '-')}</strong></td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.ip || '-')}</td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.binding_mac || '-')}</td>
            <td style="font-family:monospace;font-size:12px;">${dmacHtml}</td>
            <td>${dtBadge}${ppIcon}</td>
            <td>${macBadge}</td>
        </tr>`;
    }).join('');
}

let discSortCol = 'ip';
let discSortAsc = true;

function sortDiscovered(col) {
    if (discSortCol === col) {
        discSortAsc = !discSortAsc;
    } else {
        discSortCol = col;
        discSortAsc = true;
    }
    document.querySelectorAll('[id^="sort-"]').forEach(el => { el.style.opacity = '0.4'; el.innerHTML = '&#9650;'; });
    const indicator = document.getElementById('sort-' + col);
    if (indicator) { indicator.style.opacity = '1'; indicator.innerHTML = discSortAsc ? '&#9650;' : '&#9660;'; }
    renderDiscovered();
}

function ipToNum(ip) {
    if (!ip) return 0;
    const parts = ip.split('.');
    return ((+parts[0]) << 24) + ((+parts[1]) << 16) + ((+parts[2]) << 8) + (+parts[3]);
}

function filterDiscovered() { renderDiscovered(); }

// ===================== TAB 3: ZTP SCRIPT =====================
let ztpLoaded = false;
let scriptEditorVisible = false;

async function loadZTPScript() {
    const editor = document.getElementById('ztpEditor');
    editor.value = '# Loading...';
    const data = await apiCall('get-ztp-script');
    if (data.success) {
        editor.value = data.content || '';
        ztpLoaded = true;
        parseQuickSettings(data.content);
    } else {
        editor.value = `# Error loading: ${data.error}\n# You may need to create the file first.`;
    }
    loadSSHKey();
    loadOSImages();
}

// --- SSH Key ---
async function loadSSHKey() {
    const data = await apiCall('get-ssh-key');
    const keyInput = document.getElementById('ztpSSHKey');
    const status = document.getElementById('sshKeyStatus');
    if (data.success && data.public_key) {
        keyInput.value = data.public_key;
        status.innerHTML = `<span style="color:#4caf50;">Key found:</span> ${data.key_type || 'ssh'} (${data.key_file || ''})`;
    } else {
        keyInput.value = '';
        status.innerHTML = '<span style="color:#ff9800;">No SSH key found.</span> Click "Generate New Key" to create one.';
    }
}

function generateSSHKey() {
    showConfirmModal('Generate SSH Key', 'Generate a new SSH key pair?<br>This will be used for ZTP and device management.', async () => {
        showToast('Generating SSH key...', 'info');
        const data = await apiCall('generate-ssh-key', {});
        if (data.success) {
            document.getElementById('ztpSSHKey').value = data.public_key || '';
            document.getElementById('sshKeyStatus').innerHTML = `<span style="color:#4caf50;">New key generated!</span> ${data.key_type || ''} (${data.key_file || ''})`;
            showToast('SSH key generated. Apply to ZTP script with "Apply to Script".', 'success');
        } else {
            showToast('Key generation failed: ' + (data.error || 'Unknown error'), 'error');
        }
    });
}

function copySSHKey() {
    const key = document.getElementById('ztpSSHKey').value;
    if (!key) { showToast('No key to copy', 'error'); return; }
    navigator.clipboard.writeText(key).then(() => showToast('Public key copied!', 'success'));
}

function toggleImportKey() {
    const area = document.getElementById('importKeyArea');
    area.style.display = area.style.display === 'none' ? '' : 'none';
    if (area.style.display !== 'none') document.getElementById('importKeyText').focus();
}

async function importSSHKey() {
    const key = document.getElementById('importKeyText').value.trim();
    if (!key || !key.includes('PRIVATE KEY')) {
        document.getElementById('importKeyMsg').innerHTML = '<span style="color:#f44336;">Paste a valid private key</span>';
        return;
    }
    document.getElementById('importKeyMsg').innerHTML = '<span style="color:#888;">Saving...</span>';
    const data = await apiCall('import-ssh-key', { private_key: key });
    if (data.success) {
        document.getElementById('importKeyMsg').innerHTML = '<span style="color:#4caf50;">Key imported!</span>';
        document.getElementById('importKeyText').value = '';
        toggleImportKey();
        loadSSHKey();
        showToast('SSH key imported successfully', 'success');
    } else {
        document.getElementById('importKeyMsg').innerHTML = `<span style="color:#f44336;">${data.error || 'Failed'}</span>`;
    }
}

// --- Password Toggle ---
function togglePasswordVisibility() {
    const pw = document.getElementById('ztpPassword');
    const btn = document.getElementById('pwToggle');
    if (pw.type === 'password') { pw.type = 'text'; btn.style.color = '#ff9800'; }
    else { pw.type = 'password'; btn.style.color = '#888'; }
}

// --- OS Image ---
async function loadOSImages() {
    const container = document.getElementById('imageList');
    const data = await apiCall('list-os-images');
    if (data.success && data.images && data.images.length > 0) {
        container.innerHTML = data.images.map(img => `
            <div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #2d2d2d;">
                <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:#76b900;flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                <span style="flex:1;font-family:monospace;font-size:13px;">${escHtml(img.name)}</span>
                <span style="color:#888;font-size:12px;">${escHtml(img.size)}</span>
                <button class="btn btn-danger btn-sm" onclick="deleteOSImage('${escAttr(img.name)}')" style="padding:2px 8px;font-size:11px;">Del</button>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<span style="color:#888;">No OS images found in web root. Upload a .bin image for ZTP.</span>';
    }
}

async function uploadImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    const progress = document.getElementById('uploadProgress');
    progress.textContent = `Uploading ${file.name} (${(file.size / 1048576).toFixed(0)} MB)...`;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const resp = await fetch('/provision-api.sh?action=upload-os-image', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        if (data.success) {
            showToast(`Image "${file.name}" uploaded successfully`, 'success');
            loadOSImages();
        } else {
            showToast('Upload failed: ' + (data.error || 'Unknown'), 'error');
        }
    } catch (e) {
        showToast('Upload failed: ' + e.message, 'error');
    }
    progress.textContent = '';
    input.value = '';
}

function deleteOSImage(name) {
    showConfirmModal('Delete OS Image', `Delete image <strong>${name}</strong>?`, async () => {
        const data = await apiCall('delete-os-image', { name });
        if (data.success) { showToast('Image deleted', 'success'); loadOSImages(); }
        else { showToast('Delete failed: ' + (data.error || ''), 'error'); }
    });
}

// --- Script Editor Toggle ---
function toggleScriptEditor() {
    const editor = document.getElementById('ztpEditor');
    const toggle = document.getElementById('editorToggle');
    scriptEditorVisible = !scriptEditorVisible;
    editor.style.display = scriptEditorVisible ? '' : 'none';
    toggle.innerHTML = scriptEditorVisible ? '&#9660;' : '&#9654;';
}

// --- Quick Settings ---
function parseQuickSettings(content) {
    const osMatch = content.match(/CUMULUS_TARGET_RELEASE=(\S+)/);
    const pwMatch = content.match(/echo\s+'cumulus:(.+?)'\s*\|\s*chpasswd/);
    const ipMatch = content.match(/IMAGE_SERVER_HOSTNAME=(\S+)/);
    // Don't overwrite SSH key from script — loadSSHKey() handles that from actual key file

    if (osMatch) document.getElementById('ztpTargetOS').value = osMatch[1];
    if (pwMatch) document.getElementById('ztpPassword').value = pwMatch[1];
    if (ipMatch) document.getElementById('ztpImageServer').value = ipMatch[1];
}

function applyQuickSettings() {
    let content = document.getElementById('ztpEditor').value;
    const os = document.getElementById('ztpTargetOS').value.trim() || '5.14.0';
    const pw = document.getElementById('ztpPassword').value.trim() || 'CumulusLinux!';
    const ip = document.getElementById('ztpImageServer').value.trim() || '192.168.58.200';
    const key = document.getElementById('ztpSSHKey').value.trim();

    // If script is placeholder/empty, generate full template
    if (!content.includes('CUMULUS_TARGET_RELEASE') && !content.includes('init_ztp')) {
        content = generateZTPTemplate(os, pw, ip, key);
    } else {
        // Update existing script via regex
        if (os) content = content.replace(/CUMULUS_TARGET_RELEASE=\S+/, `CUMULUS_TARGET_RELEASE=${os}`);
        if (pw) content = content.replace(/echo\s+'cumulus:.+?'\s*\|\s*chpasswd/, `echo 'cumulus:${pw}' | chpasswd`);
        if (ip) content = content.replace(/IMAGE_SERVER_HOSTNAME=\S+/, `IMAGE_SERVER_HOSTNAME=${ip}`);
        if (key) content = content.replace(/KEY="ssh-\S+\s+\S+"/, `KEY="${key}"`);
    }

    // Show editor to see changes
    if (!scriptEditorVisible) toggleScriptEditor();
    document.getElementById('ztpEditor').value = content;
    showToast('Quick settings applied to script (unsaved — click Save)', 'info');
}

function generateZTPTemplate(os, pw, ip, key) {
    const keyLine = key ? `\necho "$KEY" >> /root/.ssh/authorized_keys\necho "$KEY" >> /home/cumulus/.ssh/authorized_keys\nchown -R cumulus:cumulus /home/cumulus/.ssh` : '# No SSH key configured — generate one in Provision → ZTP Script';
    const keyVar = key ? `KEY="${key}"` : 'KEY=""';
    return `#!/bin/bash

#
# CUMULUS-AUTOPROVISIONING
# Generated by LLDPq Provision
#

function ping_until_reachable(){
    last_code=1
    max_tries=30
    tries=0
    while [ "0" != "$last_code" ] && [ "$tries" -lt "$max_tries" ]; do
        tries=$((tries+1))
        echo "$(date) INFO: ( Attempt $tries of $max_tries ) Pinging $1 Target Until Reachable."
        ping $1 -c2 --no-vrf-switch &> /dev/null
        last_code=$?
        sleep 1
    done
    if [ "$tries" -eq "$max_tries" ] && [ "$last_code" -ne "0" ]; then
        echo "$(date) ERROR: Reached maximum number of attempts to ping the target $1 ."
        exit 1
    fi
}

function set_password(){
    passwd -x 99999 cumulus
    echo 'cumulus:${pw}' | chpasswd
}

function init_ztp(){
    echo "Running ZTP..."

    # Change default password
    set_password

    # Make user cumulus passwordless sudo
    echo "cumulus ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/10_cumulus

    # Copy SSH keys
    ${keyVar}
    if [ -n "$KEY" ]; then
        mkdir -p /root/.ssh /home/cumulus/.ssh
        echo "$KEY" >> /root/.ssh/authorized_keys
        echo "$KEY" >> /home/cumulus/.ssh/authorized_keys
        chown -R cumulus:cumulus /home/cumulus/.ssh
        echo "SSH key installed"
    fi

    exit 0
}

# Check the Cumulus Linux Release
echo "Checking if the device is running the correct version..."
CUMULUS_TARGET_RELEASE=${os}
CUMULUS_CURRENT_RELEASE=$(cat /etc/lsb-release | grep RELEASE | cut -d "=" -f2)
IMAGE_SERVER_HOSTNAME=${ip}
IMAGE_SERVER=http://$IMAGE_SERVER_HOSTNAME/cumulus-linux-$CUMULUS_TARGET_RELEASE-mlx-amd64.bin
ZTP_URL=http://$IMAGE_SERVER_HOSTNAME/cumulus-ztp.sh

if [ "$CUMULUS_TARGET_RELEASE" != "$CUMULUS_CURRENT_RELEASE" ]; then
    echo "Version is incorrect: $CUMULUS_CURRENT_RELEASE, proceeding to download the correct version: $CUMULUS_TARGET_RELEASE"
    ping_until_reachable $IMAGE_SERVER_HOSTNAME
    /usr/cumulus/bin/onie-install -fa -i $IMAGE_SERVER -z $ZTP_URL && reboot
else
    echo "Version is correct: $CUMULUS_TARGET_RELEASE"
    init_ztp
fi
`;
}

async function saveZTPScript() {
    const content = document.getElementById('ztpEditor').value;
    const data = await apiCall('save-ztp-script', { content });
    if (data.success) {
        showToast('ZTP script saved', 'success');
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

// ===================== TAB 5: BASE CONFIG =====================
let bcDeviceGroups = {};

async function loadDeviceList() {
    const data = await apiCall('list-devices');
    if (data.success) {
        deviceList = data.devices || [];
        bcDeviceGroups = data.groups || {};
        renderBCDeviceList();
        renderBCFileList();
    }
}

function renderBCFileList() {
    document.getElementById('bcFileList').textContent = BASE_CONFIG_FILES.map(f => f.name).join(', ');
}

function renderBCDeviceList() {
    const container = document.getElementById('bcDeviceList');
    const filter = document.getElementById('bcDeviceSearch') ? document.getElementById('bcDeviceSearch').value.toLowerCase() : '';
    const groups = bcDeviceGroups;
    let html = '';
    let totalCount = 0;

    for (const [role, devices] of Object.entries(groups)) {
        const filtered = devices.filter(d =>
            d.hostname.toLowerCase().includes(filter) || d.ip.includes(filter)
        );
        if (filtered.length === 0) continue;
        totalCount += filtered.length;

        const groupId = role.replace(/[^a-zA-Z0-9]/g, '_');
        html += `
            <div style="margin-bottom: 2px;">
                <div style="display:flex; align-items:center; gap:8px; padding:6px 10px; background:#2d2d2d; cursor:pointer; user-select:none;" onclick="bcToggleGroup('${groupId}')">
                    <input type="checkbox" style="accent-color:#76b900; width:14px; height:14px;" id="bcg-${groupId}" onclick="event.stopPropagation(); bcToggleGroupDevices('${groupId}')">
                    <span style="color:#76b900; font-size:12px; font-weight:600; text-transform:uppercase;">${escHtml(role)}</span>
                    <span style="color:#888; font-size:11px; margin-left:auto;">${filtered.length}</span>
                </div>
                <div id="bcd-${groupId}" style="display:none;">
                    ${filtered.map(d => `
                        <label style="display:flex; align-items:center; gap:8px; padding:4px 10px 4px 28px; cursor:pointer; font-size:12px; transition:background 0.1s;" onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background=''">
                            <input type="checkbox" class="bc-dev-cb" data-ip="${d.ip}" data-hostname="${d.hostname}" data-username="${d.username || 'cumulus'}" data-group="${groupId}" style="accent-color:#76b900; width:13px; height:13px;" onchange="bcUpdateCounts()">
                            <span style="flex:1; color:#d4d4d4;">${escHtml(d.hostname)}</span>
                            <span style="color:#666; font-family:monospace; font-size:11px;">${escHtml(d.ip)}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    }

    container.innerHTML = html || '<div style="padding:20px; color:#666; text-align:center;">No devices</div>';
    document.getElementById('bcTotalDevices').textContent = `${totalCount} devices`;
    bcUpdateCounts();
}

function bcToggleGroup(groupId) {
    const div = document.getElementById('bcd-' + groupId);
    div.style.display = div.style.display === 'none' ? '' : 'none';
}

function bcToggleGroupDevices(groupId) {
    const groupCb = document.getElementById('bcg-' + groupId);
    document.querySelectorAll(`.bc-dev-cb[data-group="${groupId}"]`).forEach(cb => cb.checked = groupCb.checked);
    bcUpdateCounts();
}

function bcSelectAll(checked) {
    document.querySelectorAll('.bc-dev-cb').forEach(cb => cb.checked = checked);
    document.querySelectorAll('[id^="bcg-"]').forEach(cb => cb.checked = checked);
    bcUpdateCounts();
}

function bcUpdateCounts() {
    const total = document.querySelectorAll('.bc-dev-cb').length;
    const selected = document.querySelectorAll('.bc-dev-cb:checked').length;
    document.getElementById('bcSelectedCount').textContent = `${selected} selected`;

    // Update group checkboxes
    for (const role of Object.keys(bcDeviceGroups)) {
        const groupId = role.replace(/[^a-zA-Z0-9]/g, '_');
        const groupCbs = document.querySelectorAll(`.bc-dev-cb[data-group="${groupId}"]`);
        const groupChecked = document.querySelectorAll(`.bc-dev-cb[data-group="${groupId}"]:checked`);
        const gcb = document.getElementById('bcg-' + groupId);
        if (gcb) {
            gcb.checked = groupCbs.length > 0 && groupChecked.length === groupCbs.length;
            gcb.indeterminate = groupChecked.length > 0 && groupChecked.length < groupCbs.length;
        }
    }
}

function bcFilterDevices() { renderBCDeviceList(); }

async function deployBaseConfig() {
    const selectedDevices = Array.from(document.querySelectorAll('.bc-dev-cb:checked')).map(cb => ({
        ip: cb.dataset.ip,
        hostname: cb.dataset.hostname,
        username: cb.dataset.username
    }));

    if (selectedDevices.length === 0) {
        showToast('Select at least one device', 'error');
        return;
    }

    const disableZTP = document.getElementById('disableZTPAfter').checked;
    const btn = document.getElementById('btnDeploy');
    btn.disabled = true;

    // Show progress table
    const progress = document.getElementById('deployProgress');
    progress.innerHTML = `
        <div class="table-wrapper">
            <table class="data-table">
                <thead><tr><th>Hostname</th><th>IP</th><th>Status</th><th>Details</th></tr></thead>
                <tbody id="deployBody">
                    ${selectedDevices.map(d => `
                        <tr id="deploy-${d.ip.replace(/\./g, '-')}">
                            <td><strong>${escHtml(d.hostname)}</strong></td>
                            <td style="font-family:monospace;font-size:12px;">${escHtml(d.ip)}</td>
                            <td><div class="spinner"></div></td>
                            <td style="color:#888;">Deploying...</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;

    document.getElementById('deployStatusText').textContent = `Deploying to ${selectedDevices.length} devices...`;

    // No files param = deploy all available sw-base files
    const data = await apiCall('deploy-base-config', {
        devices: selectedDevices,
        disable_ztp: disableZTP
    });

    if (data.success && data.results) {
        let okCount = 0, failCount = 0;
        data.results.forEach(r => {
            const row = document.getElementById(`deploy-${r.ip.replace(/\./g, '-')}`);
            if (row) {
                if (r.success) {
                    okCount++;
                    row.innerHTML = `<td><strong>${escHtml(r.hostname)}</strong></td><td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td><td><span class="badge badge-success">OK</span></td><td style="color:#4caf50;">${escHtml(r.message || 'OK')}</td>`;
                } else {
                    failCount++;
                    row.innerHTML = `<td><strong>${escHtml(r.hostname)}</strong></td><td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td><td><span class="badge badge-error">FAIL</span></td><td style="color:#f44336;">${escHtml(r.error || 'Failed')}</td>`;
                }
            }
        });
        document.getElementById('deployStatusText').textContent = `Done: ${okCount} OK, ${failCount} failed`;
        showToast(`Deploy: ${okCount} OK, ${failCount} failed`, failCount > 0 ? 'error' : 'success');
    } else {
        showToast('Deploy failed: ' + (data.error || ''), 'error');
        document.getElementById('deployStatusText').textContent = 'Failed';
    }
    btn.disabled = false;
}

// ===================== UTILS =====================
function escHtml(s) { 
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}
function escAttr(s) {
    if (!s) return '';
    return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ===================== CUSTOM CONFIRM MODAL =====================
let _confirmCallback = null;
function showConfirmModal(title, message, callback, btnText) {
    document.getElementById('confirm-modal-title').textContent = title;
    document.getElementById('confirm-modal-message').innerHTML = message;
    // Set button text based on context
    const btn = document.querySelector('.btn-confirm-action');
    if (btnText) btn.textContent = btnText;
    else if (title.toLowerCase().includes('delete')) btn.textContent = 'Delete';
    else if (title.toLowerCase().includes('stop')) btn.textContent = 'Stop';
    else if (title.toLowerCase().includes('generate')) btn.textContent = 'Generate';
    else btn.textContent = 'Confirm';
    _confirmCallback = callback;
    document.getElementById('confirm-modal').classList.add('visible');
}
function closeConfirmModal() {
    document.getElementById('confirm-modal').classList.remove('visible');
    _confirmCallback = null;
}
function executeConfirmModal() {
    if (_confirmCallback) _confirmCallback();
    closeConfirmModal();
}
</script>

<!-- Confirm Modal -->
<div id="confirm-modal" class="confirm-modal" onclick="if(event.target===this)closeConfirmModal()">
    <div class="confirm-modal-content">
        <div class="confirm-modal-header">
            <h3 id="confirm-modal-title">Confirm</h3>
            <button class="confirm-modal-close" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="confirm-modal-body">
            <p id="confirm-modal-message"></p>
        </div>
        <div class="confirm-modal-footer">
            <button type="button" class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" class="btn-confirm-action" onclick="executeConfirmModal()">Confirm</button>
        </div>
    </div>
</div>

<style>
    .confirm-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center; }
    .confirm-modal.visible { display:flex; }
    .confirm-modal-content { background:#2d2d2d; border-radius:8px; width:420px; max-width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.5); overflow:hidden; }
    .confirm-modal-header { background:linear-gradient(135deg,#c53030 0%,#9b2c2c 100%); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    .confirm-modal-header h3 { margin:0; color:#fff; font-size:16px; }
    .confirm-modal-close { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; opacity:0.8; }
    .confirm-modal-close:hover { opacity:1; }
    .confirm-modal-body { padding:25px 20px; }
    .confirm-modal-body p { color:#ccc; line-height:1.6; margin:0; text-align:center; }
    .confirm-modal-footer { padding:15px 20px; display:flex; justify-content:flex-end; gap:10px; background:#252526; border-top:1px solid #3c3c3c; }
    .confirm-modal-footer .btn-cancel { background:#3c3c3c; color:#d4d4d4; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; }
    .confirm-modal-footer .btn-cancel:hover { background:#4a4a4a; }
    .confirm-modal-footer .btn-confirm-action { background:#c53030; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; }
    .confirm-modal-footer .btn-confirm-action:hover { background:#e53e3e; }
</style>
</body>
</html>
