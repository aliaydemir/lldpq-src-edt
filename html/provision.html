<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provision - ZTP & Base Config</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <style>
        /* Prevent browser autofill from changing input background */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 1000px #1a1a1a inset !important;
            -webkit-text-fill-color: #fff !important;
            caret-color: #fff !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
        }

        .page-subtitle {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-status {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #555;
        }

        .status-dot.active { background: #4caf50; }
        .status-dot.inactive { background: #f44336; }
        .status-dot.unknown { background: #ff9800; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3c3c3c;
            padding-bottom: 0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #808080;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #d4d4d4;
            background: #2d2d2d;
        }

        .tab-btn.active {
            color: #76b900;
            border-bottom-color: #76b900;
        }

        .tab-btn .tab-badge {
            background: #76b900;
            color: #000;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn svg { width: 16px; height: 16px; fill: currentColor; }

        .btn-primary {
            background: #76b900;
            color: #000;
        }
        .btn-primary:hover { background: #8cd000; }
        .btn-primary:disabled { background: #3d5e00; color: #666; cursor: not-allowed; }

        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
        }
        .btn-secondary:hover { background: #4a4a4a; }

        .btn-danger {
            background: #c62828;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .btn-warning {
            background: #e65100;
            color: white;
        }
        .btn-warning:hover { background: #ff6d00; }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: #1e1e1e;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #3c3c3c;
            color: #808080;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .data-table tr:hover {
            background: #2d2d2d;
        }

        .data-table .row-actions {
            display: flex;
            gap: 5px;
        }

        /* Scrollable table wrapper */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar { width: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: #1e1e1e; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* Form Elements */
        .form-input {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #76b900;
        }

        .form-input.input-mac { width: 160px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-ip { width: 140px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-hostname { width: 200px; }

        select.form-input {
            cursor: pointer;
        }

        /* Search/Filter */
        .search-filter {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            width: 250px;
        }

        .search-filter:focus {
            outline: none;
            border-color: #76b900;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #1b5e20; color: #4caf50; }
        .badge-error { background: #4a1515; color: #f44336; }
        .badge-warning { background: #4a3000; color: #ff9800; }
        .badge-info { background: #0d3b66; color: #42a5f5; }
        .badge-mismatch { background: #4a1515; color: #ff6b6b; }
        .badge-match { background: #1b5e20; color: #66bb6a; }
        .badge-pending { background: #333; color: #999; }
        .badge-active { background: #1b5e20; color: #4caf50; }
        .badge-expired { background: #4a1515; color: #f44336; }

        /* Inline edit row */
        .edit-row td {
            background: #1a3000 !important;
        }

        .add-row {
            background: #1e2a1e;
            border-top: 2px solid #76b900;
        }

        .add-row td {
            padding: 10px 12px;
        }

        /* Section headers */
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #76b900;
            margin-bottom: 10px;
        }

        .section-desc {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #1e1e1e;
            padding: 12px 20px;
            border-radius: 6px;
            border-left: 3px solid #76b900;
            min-width: 120px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #76b900;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* ZTP Script Editor */
        .editor-container {
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            overflow: hidden;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3c3c3c;
        }

        .editor-filename {
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            color: #76b900;
        }

        .editor-textarea {
            width: 100%;
            min-height: 500px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            tab-size: 4;
        }

        .editor-textarea:focus {
            outline: none;
        }

        /* Key-Value config display */
        .config-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .config-label {
            color: #888;
            font-size: 13px;
            padding: 8px 0;
            text-align: right;
            padding-right: 15px;
        }

        .config-value {
            padding: 8px 12px;
        }

        /* DHCP Lease table colors */
        .lease-active { color: #4caf50; }
        .lease-expired { color: #f44336; }

        /* Base Config file list */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .file-card {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: default;
        }

        .file-card:hover {
            border-color: #555;
        }

        .file-card.selected {
            border-color: #76b900;
            background: #1a2e00;
        }

        .file-card input[type="checkbox"] {
            accent-color: #76b900;
            width: 16px;
            height: 16px;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: #2d2d2d;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-icon svg { width: 18px; height: 18px; fill: #76b900; }
        .file-icon.binary svg { fill: #ff9800; }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 13px;
            font-weight: 600;
            color: #d4d4d4;
        }

        .file-dest {
            font-size: 11px;
            color: #888;
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        /* Deploy progress */
        .deploy-progress {
            max-height: 400px;
            overflow-y: auto;
        }

        .deploy-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .deploy-item .hostname {
            width: 200px;
            font-weight: 500;
        }

        .deploy-item .ip {
            width: 140px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 12px;
            color: #888;
        }

        .deploy-item .status {
            flex: 1;
        }

        .deploy-item .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: #1b5e20;
            color: #4caf50;
            border: 1px solid #2e7d32;
        }

        .toast-error {
            background: #4a1515;
            color: #f44336;
            border: 1px solid #c62828;
        }

        .toast-info {
            background: #0d3b66;
            color: #42a5f5;
            border: 1px solid #1565c0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            fill: #555;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            color: #888;
            margin-bottom: 8px;
        }

        /* Modal / Add Binding Form */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 25px;
            min-width: 450px;
            max-width: 600px;
        }

        .modal h3 {
            color: #76b900;
            margin-bottom: 20px;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .modal-field input, .modal-field select {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-field input:focus, .modal-field select:focus {
            outline: none;
            border-color: #76b900;
        }

        .modal-field input.mono {
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Device selector (for Base Config deploy) */
        .device-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
        }

        .device-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .device-chip:hover { border-color: #555; }

        .device-chip.selected {
            background: #1a2e00;
            border-color: #76b900;
            color: #76b900;
        }

        .device-chip input[type="checkbox"] {
            accent-color: #76b900;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-btn { padding: 10px 16px; font-size: 12px; }
            .toolbar { flex-direction: column; }
            .config-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Page Header -->
<div class="page-header">
    <div>
        <div class="page-title">Provision</div>
        <div class="page-subtitle">ZTP Management & Base Config Deployment</div>
    </div>
    <div class="header-actions">
        <div class="header-status">
            <span class="status-dot unknown" id="dhcpStatusDot"></span>
            <span id="dhcpStatusText">DHCP: Checking...</span>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="tab-nav">
    <button class="tab-btn active" data-tab="bindings">Bindings</button>
    <button class="tab-btn" data-tab="discovered">Discovered</button>
    <button class="tab-btn" data-tab="ztp-script">ZTP Script</button>
    <button class="tab-btn" data-tab="dhcp-status">DHCP Status</button>
    <button class="tab-btn" data-tab="base-config">Base Config</button>
</div>

<!-- ==================== TAB 1: BINDINGS ==================== -->
<div class="tab-content active" id="tab-bindings">
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="bindingSearch" placeholder="Filter by hostname, MAC, or IP..." oninput="filterBindings()">
            <span id="bindingCount" style="font-size: 12px; color: #888;"></span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadBindings()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
            <button class="btn btn-primary" onclick="showAddBinding()">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Add Binding
            </button>
            <button class="btn btn-warning" onclick="saveBindings()" id="btnSaveBindings" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save &amp; Restart DHCP
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="bindingsTable">
            <thead>
                <tr>
                    <th style="width:30px;"><input type="checkbox" id="selectAllBindings" onchange="toggleSelectAllBindings()"></th>
                    <th>Hostname</th>
                    <th>MAC Address</th>
                    <th>IP Address</th>
                    <th>Status</th>
                    <th style="width:120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="bindingsBody">
                <tr><td colspan="6" class="loading">Loading bindings...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 2: DISCOVERED ==================== -->
<div class="tab-content" id="tab-discovered">
    <div class="section-desc">Cross-reference LLDP/ARP data with DHCP bindings to detect MAC mismatches and undiscovered devices.</div>
    <div class="stats-row" id="discoveredStats">
        <div class="stat-card"><div class="stat-value" id="statMatched">-</div><div class="stat-label">Matched</div></div>
        <div class="stat-card" style="border-left-color:#ff9800;"><div class="stat-value" id="statMismatch">-</div><div class="stat-label">Mismatch</div></div>
        <div class="stat-card" style="border-left-color:#42a5f5;"><div class="stat-value" id="statUnbound">-</div><div class="stat-label">No Binding</div></div>
        <div class="stat-card" style="border-left-color:#f44336;"><div class="stat-value" id="statMissing">-</div><div class="stat-label">Not Discovered</div></div>
    </div>
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="discoveredSearch" placeholder="Filter..." oninput="filterDiscovered()">
            <select class="form-input" id="discoveredFilter" onchange="filterDiscovered()" style="width:180px;">
                <option value="all">All</option>
                <option value="match">Matched</option>
                <option value="mismatch">Mismatch Only</option>
                <option value="unbound">No Binding</option>
                <option value="missing">Not Discovered</option>
            </select>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadDiscovered()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="discoveredTable">
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>Binding MAC</th>
                    <th>Discovered MAC</th>
                    <th>Binding IP</th>
                    <th>Source</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="discoveredBody">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 3: ZTP SCRIPT ==================== -->
<div class="tab-content" id="tab-ztp-script">
    <div class="section-desc">Edit the ZTP (Zero Touch Provisioning) script that runs on switches during first boot.</div>

    <!-- Quick Config Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 10px;">Quick Settings</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">TARGET OS VERSION</label>
                <input type="text" class="form-input" id="ztpTargetOS" style="width: 100%;" placeholder="e.g. 5.14.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT PASSWORD</label>
                <input type="text" class="form-input" id="ztpPassword" style="width: 100%;" placeholder="e.g. Nvidia01!" autocomplete="off">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">IMAGE SERVER IP</label>
                <input type="text" class="form-input input-ip" id="ztpImageServer" style="width: 100%;" placeholder="e.g. 192.168.58.200">
            </div>
        </div>
        <div style="margin-top: 10px;">
            <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">SSH PUBLIC KEY</label>
            <input type="text" class="form-input" id="ztpSSHKey" style="width: 100%; font-family: 'Cascadia Code', 'Consolas', monospace; font-size: 11px;" placeholder="ssh-rsa AAAA...">
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="applyQuickSettings()">Apply to Script</button>
    </div>

    <!-- Script Editor -->
    <div class="editor-container">
        <div class="editor-toolbar">
            <span class="editor-filename">cumulus-ztp.sh</span>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary btn-sm" onclick="loadZTPScript()">Reload</button>
                <button class="btn btn-primary btn-sm" onclick="saveZTPScript()">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    Save
                </button>
            </div>
        </div>
        <textarea class="editor-textarea" id="ztpEditor" spellcheck="false"></textarea>
    </div>
</div>

<!-- ==================== TAB 4: DHCP STATUS ==================== -->
<div class="tab-content" id="tab-dhcp-status">
    <div class="section-desc">Active DHCP leases and server status.</div>
    <div class="stats-row" id="dhcpStats">
        <div class="stat-card"><div class="stat-value" id="statLeaseActive">-</div><div class="stat-label">Active Leases</div></div>
        <div class="stat-card" style="border-left-color:#f44336;"><div class="stat-value" id="statLeaseExpired">-</div><div class="stat-label">Expired</div></div>
        <div class="stat-card" style="border-left-color:#42a5f5;"><div class="stat-value" id="statLeaseReserved">-</div><div class="stat-label">Static Reservations</div></div>
    </div>
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="leaseSearch" placeholder="Search leases..." oninput="filterLeases()">
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadDHCPStatus()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="leaseTable">
            <thead>
                <tr>
                    <th>IP Address</th>
                    <th>MAC Address</th>
                    <th>Hostname</th>
                    <th>Lease Start</th>
                    <th>Lease End</th>
                    <th>State</th>
                </tr>
            </thead>
            <tbody id="leaseBody">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 5: BASE CONFIG ==================== -->
<div class="tab-content" id="tab-base-config">
    <div class="section-desc">Deploy standard tools and configs to switches via parallel SSH/SCP. No Ansible required.</div>

    <!-- Files to Deploy -->
    <div class="section-title">Files to Deploy</div>
    <div style="margin-bottom: 10px;">
        <label style="font-size: 12px; cursor: pointer; color: #888;">
            <input type="checkbox" id="selectAllFiles" onchange="toggleSelectAllFiles()" checked style="accent-color: #76b900;">
            Select All
        </label>
    </div>
    <div class="file-grid" id="fileGrid"></div>

    <!-- Target Devices -->
    <div class="section-title" style="margin-top: 20px;">Target Devices</div>
    <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
        <label style="font-size: 12px; cursor: pointer; color: #888;">
            <input type="checkbox" id="selectAllDevices" onchange="toggleSelectAllDevices()" checked style="accent-color: #76b900;">
            Select All
        </label>
        <input type="text" class="search-filter" id="deviceFilter" placeholder="Filter devices..." oninput="filterDeviceChips()" style="width: 200px; padding: 5px 10px; font-size: 12px;">
    </div>
    <div class="device-selector" id="deviceSelector">
        <div class="loading">Loading devices...</div>
    </div>

    <!-- Deploy Options -->
    <div style="margin: 15px 0; display: flex; gap: 20px; align-items: center;">
        <label style="font-size: 13px; cursor: pointer;">
            <input type="checkbox" id="disableZTPAfter" style="accent-color: #76b900;">
            Disable ZTP after deploy
        </label>
    </div>

    <!-- Deploy Button + Progress -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="deployBaseConfig()" id="btnDeploy">
            <svg viewBox="0 0 24 24"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
            Deploy to Selected Devices
        </button>
        <span id="deployStatusText" style="font-size: 13px; color: #888; line-height: 36px;"></span>
    </div>

    <div id="deployProgress" style="display: none;">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>IP</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="deployBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Binding Modal -->
<div class="modal-overlay" id="bindingModal" style="display: none;" onclick="if(event.target===this)closeBindingModal()">
    <div class="modal">
        <h3 id="modalTitle">Add Binding</h3>
        <div class="modal-field">
            <label>Hostname</label>
            <input type="text" id="modalHostname" placeholder="e.g. leaf-01">
        </div>
        <div class="modal-field">
            <label>MAC Address</label>
            <input type="text" id="modalMAC" class="mono" placeholder="e.g. 54:9b:24:aa:68:16" oninput="formatMAC(this)">
        </div>
        <div class="modal-field">
            <label>IP Address</label>
            <input type="text" id="modalIP" class="mono" placeholder="e.g. 192.168.58.11">
        </div>
        <input type="hidden" id="modalOrigHostname">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBindingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBinding()" id="modalSaveBtn">Add</button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<script>
// ===================== GLOBAL STATE =====================
let allBindings = [];
let bindingsModified = false;
let allDiscovered = [];
let allLeases = [];
let deviceList = [];

const BASE_CONFIG_FILES = [
    { name: 'bash.bashrc', dest: '/etc/bash.bashrc', destAlt: '/home/cumulus/.bashrc', type: 'config', desc: 'Shell aliases & VRF helpers' },
    { name: 'motd.sh', dest: '/etc/profile.d/motd.sh', type: 'config', desc: 'Login banner with BGP status' },
    { name: 'tmux.conf', dest: '/etc/tmux.conf', type: 'config', desc: 'tmux settings' },
    { name: 'nanorc', dest: '/etc/nanorc', type: 'config', desc: 'Editor settings' },
    { name: 'cmd', dest: '/usr/local/bin/cmd', type: 'script', desc: 'tmux session manager' },
    { name: 'nvc', dest: '/usr/local/bin/nvc', type: 'script', desc: 'NV config colorizer' },
    { name: 'nvt', dest: '/usr/local/bin/nvt', type: 'script', desc: 'Interface table tool' },
    { name: 'exa', dest: '/usr/bin/exa', type: 'binary', desc: 'Modern ls replacement' },
    { name: 'btop', dest: '/usr/bin/btop', type: 'binary', desc: 'System monitor' },
    { name: 'iftop', dest: '/usr/bin/iftop', type: 'binary', desc: 'Bandwidth monitor' }
];

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            onTabSwitch(btn.dataset.tab);
        });
    });

    // Load initial data
    loadBindings();
    loadDeviceList();
    renderBaseConfigFiles();
    checkDHCPStatus();
});

function onTabSwitch(tab) {
    if (tab === 'discovered') loadDiscovered();
    if (tab === 'ztp-script') loadZTPScript();
    if (tab === 'dhcp-status') loadDHCPStatus();
}

// ===================== API HELPER =====================
async function apiCall(action, data = null) {
    try {
        const opts = {};
        if (data) {
            opts.method = 'POST';
            opts.headers = { 'Content-Type': 'application/json' };
            opts.body = JSON.stringify(data);
        }
        const resp = await fetch(`/provision-api.sh?action=${action}`, opts);
        return await resp.json();
    } catch (e) {
        return { success: false, error: e.message };
    }
}

// ===================== TOAST =====================
function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast toast-${type} show`;
    setTimeout(() => t.classList.remove('show'), 4000);
}

// ===================== DHCP STATUS CHECK =====================
async function checkDHCPStatus() {
    const data = await apiCall('dhcp-service-status');
    const dot = document.getElementById('dhcpStatusDot');
    const txt = document.getElementById('dhcpStatusText');
    if (data.success && data.running) {
        dot.className = 'status-dot active';
        txt.textContent = 'DHCP: Running';
    } else if (data.success && !data.running) {
        dot.className = 'status-dot inactive';
        txt.textContent = 'DHCP: Stopped';
    } else {
        dot.className = 'status-dot unknown';
        txt.textContent = 'DHCP: Unknown';
    }
}

// ===================== TAB 1: BINDINGS =====================
async function loadBindings() {
    document.getElementById('bindingsBody').innerHTML = '<tr><td colspan="6" class="loading">Loading bindings...</td></tr>';
    const data = await apiCall('list-bindings');
    if (data.success) {
        allBindings = data.bindings || [];
        bindingsModified = false;
        document.getElementById('btnSaveBindings').style.display = 'none';
        renderBindings();
    } else {
        document.getElementById('bindingsBody').innerHTML = `<tr><td colspan="6" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
}

function renderBindings() {
    const filter = document.getElementById('bindingSearch').value.toLowerCase();
    const filtered = allBindings.filter(b =>
        b.hostname.toLowerCase().includes(filter) ||
        b.mac.toLowerCase().includes(filter) ||
        b.ip.includes(filter)
    );

    document.getElementById('bindingCount').textContent = `${filtered.length} of ${allBindings.length} bindings`;

    if (filtered.length === 0) {
        document.getElementById('bindingsBody').innerHTML = `
            <tr><td colspan="6" style="text-align:center; padding:40px; color:#666;">
                ${allBindings.length === 0 ? 'No bindings configured. Click "Add Binding" to create one.' : 'No matches found.'}
            </td></tr>`;
        return;
    }

    document.getElementById('bindingsBody').innerHTML = filtered.map((b, i) => `
        <tr data-idx="${i}">
            <td><input type="checkbox" class="binding-cb" data-hostname="${b.hostname}"></td>
            <td><strong>${escHtml(b.hostname)}</strong></td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.mac)}</td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.ip)}</td>
            <td>${b.commented ? '<span class="badge badge-pending">Disabled</span>' : '<span class="badge badge-active">Active</span>'}</td>
            <td class="row-actions">
                <button class="btn btn-secondary btn-sm" onclick="editBinding('${escAttr(b.hostname)}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBinding('${escAttr(b.hostname)}')">Del</button>
            </td>
        </tr>
    `).join('');
}

function filterBindings() { renderBindings(); }

function showAddBinding() {
    document.getElementById('modalTitle').textContent = 'Add Binding';
    document.getElementById('modalHostname').value = '';
    document.getElementById('modalMAC').value = '';
    document.getElementById('modalIP').value = '';
    document.getElementById('modalOrigHostname').value = '';
    document.getElementById('modalSaveBtn').textContent = 'Add';
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function editBinding(hostname) {
    const b = allBindings.find(x => x.hostname === hostname);
    if (!b) return;
    document.getElementById('modalTitle').textContent = 'Edit Binding';
    document.getElementById('modalHostname').value = b.hostname;
    document.getElementById('modalMAC').value = b.mac;
    document.getElementById('modalIP').value = b.ip;
    document.getElementById('modalOrigHostname').value = b.hostname;
    document.getElementById('modalSaveBtn').textContent = 'Update';
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function closeBindingModal() {
    document.getElementById('bindingModal').style.display = 'none';
}

function saveBinding() {
    const hostname = document.getElementById('modalHostname').value.trim();
    const mac = document.getElementById('modalMAC').value.trim().toLowerCase();
    const ip = document.getElementById('modalIP').value.trim();
    const origHostname = document.getElementById('modalOrigHostname').value;

    if (!hostname || !mac || !ip) {
        showToast('All fields are required', 'error');
        return;
    }

    // MAC format validation
    if (!/^([0-9a-f]{2}:){5}[0-9a-f]{2}$/.test(mac)) {
        showToast('Invalid MAC format. Use xx:xx:xx:xx:xx:xx', 'error');
        return;
    }

    // IP format validation
    if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
        showToast('Invalid IP format', 'error');
        return;
    }

    if (origHostname) {
        // Edit existing
        const idx = allBindings.findIndex(x => x.hostname === origHostname);
        if (idx >= 0) {
            allBindings[idx] = { hostname, mac, ip, commented: false };
        }
    } else {
        // Check duplicate
        if (allBindings.find(x => x.hostname === hostname)) {
            showToast(`Hostname "${hostname}" already exists`, 'error');
            return;
        }
        allBindings.push({ hostname, mac, ip, commented: false });
    }

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    closeBindingModal();
    renderBindings();
    showToast(origHostname ? 'Binding updated (unsaved)' : 'Binding added (unsaved)', 'info');
}

function deleteBinding(hostname) {
    if (!confirm(`Delete binding for "${hostname}"?`)) return;
    allBindings = allBindings.filter(x => x.hostname !== hostname);
    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    renderBindings();
    showToast(`Binding "${hostname}" deleted (unsaved)`, 'info');
}

async function saveBindings() {
    const btn = document.getElementById('btnSaveBindings');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const data = await apiCall('save-bindings', { bindings: allBindings });
    if (data.success) {
        bindingsModified = false;
        btn.style.display = 'none';
        showToast('Bindings saved & DHCP restarted', 'success');
        checkDHCPStatus();
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Save &amp; Restart DHCP';
}

function toggleSelectAllBindings() {
    const checked = document.getElementById('selectAllBindings').checked;
    document.querySelectorAll('.binding-cb').forEach(cb => cb.checked = checked);
}

function formatMAC(input) {
    let v = input.value.replace(/[^0-9a-fA-F]/g, '').substring(0, 12);
    let parts = [];
    for (let i = 0; i < v.length; i += 2) {
        parts.push(v.substring(i, i + 2));
    }
    input.value = parts.join(':');
}

// ===================== TAB 2: DISCOVERED =====================
async function loadDiscovered() {
    document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';
    const data = await apiCall('discovered');
    if (data.success) {
        allDiscovered = data.entries || [];
        renderDiscoveredStats();
        renderDiscovered();
    } else {
        document.getElementById('discoveredBody').innerHTML = `<tr><td colspan="6" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
}

function renderDiscoveredStats() {
    const matched = allDiscovered.filter(d => d.status === 'match').length;
    const mismatch = allDiscovered.filter(d => d.status === 'mismatch').length;
    const unbound = allDiscovered.filter(d => d.status === 'unbound').length;
    const missing = allDiscovered.filter(d => d.status === 'missing').length;
    document.getElementById('statMatched').textContent = matched;
    document.getElementById('statMismatch').textContent = mismatch;
    document.getElementById('statUnbound').textContent = unbound;
    document.getElementById('statMissing').textContent = missing;
}

function renderDiscovered() {
    const filter = document.getElementById('discoveredSearch').value.toLowerCase();
    const typeFilter = document.getElementById('discoveredFilter').value;

    let filtered = allDiscovered;
    if (typeFilter !== 'all') {
        filtered = filtered.filter(d => d.status === typeFilter);
    }
    if (filter) {
        filtered = filtered.filter(d =>
            (d.hostname || '').toLowerCase().includes(filter) ||
            (d.binding_mac || '').toLowerCase().includes(filter) ||
            (d.discovered_mac || '').toLowerCase().includes(filter) ||
            (d.binding_ip || '').includes(filter)
        );
    }

    if (filtered.length === 0) {
        document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">No entries found.</td></tr>';
        return;
    }

    document.getElementById('discoveredBody').innerHTML = filtered.map(d => {
        const statusBadge = {
            'match': '<span class="badge badge-match">Match</span>',
            'mismatch': '<span class="badge badge-mismatch">Mismatch</span>',
            'unbound': '<span class="badge badge-info">No Binding</span>',
            'missing': '<span class="badge badge-warning">Not Discovered</span>'
        }[d.status] || '';

        return `<tr>
            <td><strong>${escHtml(d.hostname || '-')}</strong></td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.binding_mac || '-')}</td>
            <td style="font-family:monospace;font-size:12px;">${d.status === 'mismatch' ? `<span style="color:#ff6b6b;">${escHtml(d.discovered_mac)}</span>` : escHtml(d.discovered_mac || '-')}</td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.binding_ip || '-')}</td>
            <td>${escHtml(d.source || '-')}</td>
            <td>${statusBadge}</td>
        </tr>`;
    }).join('');
}

function filterDiscovered() { renderDiscovered(); }

// ===================== TAB 3: ZTP SCRIPT =====================
let ztpLoaded = false;

async function loadZTPScript() {
    const editor = document.getElementById('ztpEditor');
    editor.value = '# Loading...';
    const data = await apiCall('get-ztp-script');
    if (data.success) {
        editor.value = data.content || '';
        ztpLoaded = true;
        parseQuickSettings(data.content);
    } else {
        editor.value = `# Error loading: ${data.error}\n# You may need to create the file first.`;
    }
}

function parseQuickSettings(content) {
    // Extract settings from script content
    const osMatch = content.match(/CUMULUS_TARGET_RELEASE=(\S+)/);
    const pwMatch = content.match(/echo\s+'cumulus:(.+?)'\s*\|\s*chpasswd/);
    const ipMatch = content.match(/IMAGE_SERVER_HOSTNAME=(\S+)/);
    const keyMatch = content.match(/KEY="(ssh-\S+\s+\S+)"/);

    if (osMatch) document.getElementById('ztpTargetOS').value = osMatch[1];
    if (pwMatch) document.getElementById('ztpPassword').value = pwMatch[1];
    if (ipMatch) document.getElementById('ztpImageServer').value = ipMatch[1];
    if (keyMatch) document.getElementById('ztpSSHKey').value = keyMatch[1];
}

function applyQuickSettings() {
    let content = document.getElementById('ztpEditor').value;
    const os = document.getElementById('ztpTargetOS').value.trim();
    const pw = document.getElementById('ztpPassword').value.trim();
    const ip = document.getElementById('ztpImageServer').value.trim();
    const key = document.getElementById('ztpSSHKey').value.trim();

    if (os) content = content.replace(/CUMULUS_TARGET_RELEASE=\S+/, `CUMULUS_TARGET_RELEASE=${os}`);
    if (pw) content = content.replace(/echo\s+'cumulus:.+?'\s*\|\s*chpasswd/, `echo 'cumulus:${pw}' | chpasswd`);
    if (ip) content = content.replace(/IMAGE_SERVER_HOSTNAME=\S+/, `IMAGE_SERVER_HOSTNAME=${ip}`);
    if (key) content = content.replace(/KEY="ssh-\S+\s+\S+"/, `KEY="${key}"`);

    document.getElementById('ztpEditor').value = content;
    showToast('Quick settings applied to script', 'info');
}

async function saveZTPScript() {
    const content = document.getElementById('ztpEditor').value;
    const data = await apiCall('save-ztp-script', { content });
    if (data.success) {
        showToast('ZTP script saved', 'success');
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

// ===================== TAB 4: DHCP STATUS =====================
async function loadDHCPStatus() {
    document.getElementById('leaseBody').innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';
    const data = await apiCall('dhcp-leases');
    if (data.success) {
        allLeases = data.leases || [];
        const active = allLeases.filter(l => l.state === 'active').length;
        const expired = allLeases.filter(l => l.state === 'expired' || l.state === 'free').length;
        document.getElementById('statLeaseActive').textContent = active;
        document.getElementById('statLeaseExpired').textContent = expired;
        document.getElementById('statLeaseReserved').textContent = data.reserved_count || allBindings.length;
        renderLeases();
    } else {
        document.getElementById('leaseBody').innerHTML = `<tr><td colspan="6" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
    checkDHCPStatus();
}

function renderLeases() {
    const filter = document.getElementById('leaseSearch').value.toLowerCase();
    let filtered = allLeases;
    if (filter) {
        filtered = filtered.filter(l =>
            (l.ip || '').includes(filter) ||
            (l.mac || '').toLowerCase().includes(filter) ||
            (l.hostname || '').toLowerCase().includes(filter)
        );
    }

    if (filtered.length === 0) {
        document.getElementById('leaseBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">No leases found.</td></tr>';
        return;
    }

    document.getElementById('leaseBody').innerHTML = filtered.map(l => `
        <tr>
            <td style="font-family:monospace;font-size:12px;">${escHtml(l.ip)}</td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(l.mac || '-')}</td>
            <td>${escHtml(l.hostname || '-')}</td>
            <td style="font-size:12px;">${escHtml(l.start || '-')}</td>
            <td style="font-size:12px;">${escHtml(l.end || '-')}</td>
            <td>${l.state === 'active' ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-expired">Expired</span>'}</td>
        </tr>
    `).join('');
}

function filterLeases() { renderLeases(); }

// ===================== TAB 5: BASE CONFIG =====================
function renderBaseConfigFiles() {
    const grid = document.getElementById('fileGrid');
    grid.innerHTML = BASE_CONFIG_FILES.map((f, i) => {
        const iconClass = f.type === 'binary' ? 'binary' : '';
        const icon = f.type === 'binary'
            ? '<svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>'
            : f.type === 'script'
            ? '<svg viewBox="0 0 24 24"><path d="M14.6,16.6L19.2,12L14.6,7.4L16,6L22,12L16,18L14.6,16.6M9.4,16.6L4.8,12L9.4,7.4L8,6L2,12L8,18L9.4,16.6Z"/></svg>'
            : '<svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>';

        return `<div class="file-card selected" data-file="${f.name}" onclick="toggleFileCard(this)">
            <input type="checkbox" checked class="file-cb" data-file="${f.name}" onclick="event.stopPropagation()">
            <div class="file-icon ${iconClass}">${icon}</div>
            <div class="file-info">
                <div class="file-name">${f.name}</div>
                <div class="file-dest">${f.dest}</div>
            </div>
        </div>`;
    }).join('');
}

function toggleFileCard(card) {
    const cb = card.querySelector('.file-cb');
    cb.checked = !cb.checked;
    card.classList.toggle('selected', cb.checked);
}

function toggleSelectAllFiles() {
    const checked = document.getElementById('selectAllFiles').checked;
    document.querySelectorAll('.file-cb').forEach(cb => {
        cb.checked = checked;
        cb.closest('.file-card').classList.toggle('selected', checked);
    });
}

async function loadDeviceList() {
    const data = await apiCall('list-devices');
    if (data.success) {
        deviceList = data.devices || [];
        renderDeviceChips();
    }
}

function renderDeviceChips() {
    const filter = document.getElementById('deviceFilter') ? document.getElementById('deviceFilter').value.toLowerCase() : '';
    const container = document.getElementById('deviceSelector');
    const filtered = deviceList.filter(d =>
        d.hostname.toLowerCase().includes(filter) || d.ip.includes(filter)
    );

    container.innerHTML = filtered.map(d => `
        <div class="device-chip selected" onclick="toggleDeviceChip(this)">
            <input type="checkbox" checked class="dev-cb" data-ip="${d.ip}" data-hostname="${d.hostname}" onclick="event.stopPropagation()">
            <span>${escHtml(d.hostname)}</span>
        </div>
    `).join('');
}

function toggleDeviceChip(chip) {
    const cb = chip.querySelector('.dev-cb');
    cb.checked = !cb.checked;
    chip.classList.toggle('selected', cb.checked);
}

function toggleSelectAllDevices() {
    const checked = document.getElementById('selectAllDevices').checked;
    document.querySelectorAll('.dev-cb').forEach(cb => {
        cb.checked = checked;
        cb.closest('.device-chip').classList.toggle('selected', checked);
    });
}

function filterDeviceChips() { renderDeviceChips(); }

async function deployBaseConfig() {
    const selectedFiles = Array.from(document.querySelectorAll('.file-cb:checked')).map(cb => cb.dataset.file);
    const selectedDevices = Array.from(document.querySelectorAll('.dev-cb:checked')).map(cb => ({
        ip: cb.dataset.ip,
        hostname: cb.dataset.hostname
    }));

    if (selectedFiles.length === 0) {
        showToast('Select at least one file to deploy', 'error');
        return;
    }
    if (selectedDevices.length === 0) {
        showToast('Select at least one device', 'error');
        return;
    }

    const disableZTP = document.getElementById('disableZTPAfter').checked;

    // Show progress
    document.getElementById('deployProgress').style.display = '';
    const btn = document.getElementById('btnDeploy');
    btn.disabled = true;

    // Init progress table
    document.getElementById('deployBody').innerHTML = selectedDevices.map(d => `
        <tr id="deploy-${d.ip.replace(/\./g, '-')}">
            <td><strong>${escHtml(d.hostname)}</strong></td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.ip)}</td>
            <td><div class="spinner"></div></td>
            <td style="color:#888;">Deploying...</td>
        </tr>
    `).join('');

    document.getElementById('deployStatusText').textContent = `Deploying to ${selectedDevices.length} devices...`;

    const data = await apiCall('deploy-base-config', {
        files: selectedFiles,
        devices: selectedDevices,
        disable_ztp: disableZTP
    });

    if (data.success && data.results) {
        let okCount = 0;
        let failCount = 0;
        data.results.forEach(r => {
            const rowId = `deploy-${r.ip.replace(/\./g, '-')}`;
            const row = document.getElementById(rowId);
            if (row) {
                if (r.success) {
                    okCount++;
                    row.innerHTML = `
                        <td><strong>${escHtml(r.hostname)}</strong></td>
                        <td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td>
                        <td><span class="badge badge-success">OK</span></td>
                        <td style="color:#4caf50;">${escHtml(r.message || 'Deployed successfully')}</td>`;
                } else {
                    failCount++;
                    row.innerHTML = `
                        <td><strong>${escHtml(r.hostname)}</strong></td>
                        <td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td>
                        <td><span class="badge badge-error">FAIL</span></td>
                        <td style="color:#f44336;">${escHtml(r.error || 'Unknown error')}</td>`;
                }
            }
        });
        document.getElementById('deployStatusText').textContent = `Done: ${okCount} OK, ${failCount} failed`;
        showToast(`Deployment complete: ${okCount} OK, ${failCount} failed`, failCount > 0 ? 'error' : 'success');
    } else {
        showToast('Deployment failed: ' + (data.error || 'Unknown error'), 'error');
        document.getElementById('deployStatusText').textContent = 'Deployment failed';
    }

    btn.disabled = false;
}

// ===================== UTILS =====================
function escHtml(s) { 
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}
function escAttr(s) {
    if (!s) return '';
    return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>
</body>
</html>
