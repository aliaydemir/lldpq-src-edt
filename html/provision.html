<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provision - ZTP & Base Config</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <style>
        /* Prevent browser autofill from changing input background */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 1000px #1a1a1a inset !important;
            -webkit-text-fill-color: #fff !important;
            caret-color: #fff !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
        }

        .page-subtitle {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-status {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #555;
        }

        .status-dot.active { background: #4caf50; }
        .status-dot.inactive { background: #f44336; }
        .status-dot.unknown { background: #ff9800; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3c3c3c;
            padding-bottom: 0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #808080;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #d4d4d4;
            background: #2d2d2d;
        }

        .tab-btn.active {
            color: #76b900;
            border-bottom-color: #76b900;
        }

        .tab-btn .tab-badge {
            background: #76b900;
            color: #000;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            min-height: calc(100vh - 160px);
        }

        .tab-content.active {
            display: block;
        }

        /* Discover and Inventory tabs use flex to fill viewport */
        #tab-discover.active,
        #tab-bindings.active {
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn svg { width: 16px; height: 16px; fill: currentColor; }

        .btn-primary {
            background: #76b900;
            color: #000;
        }
        .btn-primary:hover { background: #8cd000; }
        .btn-primary:disabled { background: #3d5e00; color: #666; cursor: not-allowed; }

        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
        }
        .btn-secondary:hover { background: #4a4a4a; }

        .btn-danger {
            background: #c62828;
            color: white;
        }
        .btn-danger:hover { background: #e53935; }

        .btn-warning {
            background: #e65100;
            color: white;
        }
        .btn-warning:hover { background: #ff6d00; }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: #1e1e1e;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #3c3c3c;
            color: #808080;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .data-table tr:hover {
            background: #2d2d2d;
        }

        .data-table .row-actions {
            display: flex;
            gap: 5px;
        }

        /* Scrollable table wrapper — fills remaining space in tab */
        .table-wrapper {
            flex: 1;
            min-height: 200px;
            overflow-y: auto;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
        }

        .table-wrapper::-webkit-scrollbar { width: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: #1e1e1e; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* Form Elements */
        .form-input {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #76b900;
        }

        .form-input.input-mac { width: 160px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-ip { width: 140px; font-family: 'Cascadia Code', 'Consolas', monospace; }
        .form-input.input-hostname { width: 200px; }

        select.form-input {
            cursor: pointer;
        }

        /* Search/Filter */
        .search-filter {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
            width: 250px;
        }

        .search-filter:focus {
            outline: none;
            border-color: #76b900;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #1b5e20; color: #4caf50; }
        .badge-error { background: #4a1515; color: #f44336; }
        .badge-warning { background: #4a3000; color: #ff9800; }
        .badge-info { background: #0d3b66; color: #42a5f5; }
        .badge-mismatch { background: #4a1515; color: #ff6b6b; }
        .badge-match { background: #1b5e20; color: #66bb6a; }
        .badge-pending { background: #333; color: #999; }
        .badge-unreachable { background: #3d1515; color: #e57373; }
        .badge-active { background: #1b5e20; color: #4caf50; }
        .badge-expired { background: #4a1515; color: #f44336; }

        /* Inline edit row */
        .edit-row td {
            background: #1a3000 !important;
        }

        .add-row {
            background: #1e2a1e;
            border-top: 2px solid #76b900;
        }

        .add-row td {
            padding: 10px 12px;
        }

        /* Section headers */
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #76b900;
            margin-bottom: 10px;
        }

        .section-desc {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #1e1e1e;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #76b900;
            flex: 1 1 0;
            min-width: 80px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #76b900;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* ZTP Script Editor */
        .editor-container {
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            overflow: hidden;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3c3c3c;
        }

        .editor-filename {
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            color: #76b900;
        }

        .editor-textarea {
            width: 100%;
            min-height: 500px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            tab-size: 4;
        }

        .editor-textarea:focus {
            outline: none;
        }

        /* Key-Value config display */
        .config-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .config-label {
            color: #888;
            font-size: 13px;
            padding: 8px 0;
            text-align: right;
            padding-right: 15px;
        }

        .config-value {
            padding: 8px 12px;
        }

        /* DHCP Lease table colors */
        .lease-active { color: #4caf50; }
        .lease-expired { color: #f44336; }

        /* Base Config file list — compact */
        .file-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .file-card {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
            cursor: pointer;
            font-size: 12px;
        }

        .file-card:hover {
            border-color: #555;
            background: #252526;
        }

        .file-card.selected {
            border-color: #76b900;
            background: #1a2e00;
        }

        .file-card input[type="checkbox"] {
            accent-color: #76b900;
            width: 14px;
            height: 14px;
            margin: 0;
        }

        .file-icon {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-icon svg { width: 14px; height: 14px; fill: #76b900; }
        .file-icon.binary svg { fill: #ff9800; }

        .file-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-name {
            font-size: 12px;
            font-weight: 600;
            color: #d4d4d4;
        }

        .file-dest {
            font-size: 10px;
            color: #666;
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        /* Deploy progress */
        .deploy-progress {
            max-height: 400px;
            overflow-y: auto;
        }

        .deploy-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #2d2d2d;
        }

        .deploy-item .hostname {
            width: 200px;
            font-weight: 500;
        }

        .deploy-item .ip {
            width: 140px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 12px;
            color: #888;
        }

        .deploy-item .status {
            flex: 1;
        }

        .deploy-item .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: #1b5e20;
            color: #4caf50;
            border: 1px solid #2e7d32;
        }

        .toast-error {
            background: #4a1515;
            color: #f44336;
            border: 1px solid #c62828;
        }

        .toast-info {
            background: #0d3b66;
            color: #42a5f5;
            border: 1px solid #1565c0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            fill: #555;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            color: #888;
            margin-bottom: 8px;
        }

        /* Modal / Add Binding Form */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 25px;
            min-width: 450px;
            max-width: 600px;
        }

        .modal h3 {
            color: #76b900;
            margin-bottom: 20px;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .modal-field input, .modal-field select {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-field input:focus, .modal-field select:focus {
            outline: none;
            border-color: #76b900;
        }

        .modal-field input.mono {
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Device selector — compact chips */
        .device-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
            max-height: 180px;
            overflow-y: auto;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
        }

        .device-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .device-chip:hover { border-color: #555; }

        .device-chip.selected {
            background: #1a2e00;
            border-color: #76b900;
            color: #76b900;
        }

        .device-chip input[type="checkbox"] {
            accent-color: #76b900;
            width: 12px;
            height: 12px;
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-btn { padding: 10px 16px; font-size: 12px; }
            .toolbar { flex-direction: column; }
            .config-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Page Header -->
<div class="page-header">
    <div>
        <div class="page-title">Provision</div>
        <div class="page-subtitle">Device discovery, inventory management, DHCP provisioning, ZTP and base config deployment</div>
    </div>
    <div class="header-actions">
        <div class="header-status">
            <span class="status-dot unknown" id="dhcpStatusDot"></span>
            <span id="dhcpStatusText">DHCP: Checking...</span>
        </div>
        <div style="display: flex; gap: 6px; margin-left: 15px;">
            <button class="btn btn-primary btn-sm" onclick="dhcpServiceAction('start')" title="Start DHCP">Start</button>
            <button class="btn btn-secondary btn-sm" onclick="dhcpServiceAction('restart')" title="Restart DHCP">Restart</button>
            <button class="btn btn-danger btn-sm" onclick="dhcpServiceAction('stop')" title="Stop DHCP">Stop</button>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="tab-nav">
    <button class="tab-btn active" data-tab="discover">Discover</button>
    <button class="tab-btn" data-tab="bindings">Inventory</button>
    <button class="tab-btn" data-tab="dhcpd">DHCP Server</button>
    <button class="tab-btn" data-tab="ztp-script">ZTP</button>
    <button class="tab-btn" data-tab="base-config">Base Config</button>
    <button class="tab-btn" data-tab="guide" style="margin-left:auto; color:#555;">Guide</button>
</div>

<!-- ==================== TAB 0: DISCOVER ==================== -->
<div class="tab-content active" id="tab-discover">

    <!-- Discovery & Post-Provision Settings -->
    <div style="padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div class="section-title" style="font-size: 13px; margin-bottom: 8px;">Discovery Range</div>
                <div class="section-desc" style="margin-bottom: 8px; font-size: 11px;">IP range to scan for device discovery. Only IPs in this range will be pinged and probed.</div>
                <input type="text" class="form-input" id="discoveryRange" style="width: 100%; font-family: 'Cascadia Code','Consolas',monospace;" placeholder="192.168.100.10-192.168.100.249">
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                    <label style="font-size: 11px; color: #888; white-space: nowrap;">Auto-scan every</label>
                    <select class="form-input" id="scanInterval" onchange="applyScanInterval()" style="width: 90px; padding: 3px 6px; font-size: 12px;">
                        <option value="0">Off</option>
                        <option value="180">3 min</option>
                        <option value="300" selected>5 min</option>
                        <option value="600">10 min</option>
                        <option value="900">15 min</option>
                    </select>
                    <span id="scanIntervalInfo" style="font-size: 11px; color: #555;"></span>
                </div>
            </div>
            <div>
                <div class="section-title" style="font-size: 13px; margin-bottom: 8px;">Post-Provision Actions</div>
                <div class="section-desc" style="margin-bottom: 8px; font-size: 11px;">Automatically run on newly provisioned devices (SSH key auth OK + no marker).</div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #ccc;">
                        <input type="checkbox" id="autoBaseConfig" checked> Deploy Base Config (sw-base files)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #ccc;">
                        <input type="checkbox" id="autoZtpDisable" checked> Disable ZTP (sudo ztp -d)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #ccc;">
                        <input type="checkbox" id="autoSetHostname" checked> Set hostname from binding (nv set)
                    </label>
                </div>
            </div>
        </div>
        <div style="margin-top: 10px;">
            <button class="btn btn-secondary btn-sm" onclick="saveDiscoverySettings()">Save Discovery Settings</button>
        </div>
    </div>

    <!-- Discovered Devices -->
    <div class="section-title" style="margin-top: 10px;">Discovered Devices</div>
    <div class="section-desc">Subnet-wide discovery with SSH classification. Provisioned devices get auto-configured.</div>
    <div class="stats-row" id="discoveredStats">
        <div class="stat-card" style="border-left-color:#4caf50; cursor:pointer;" onclick="setDiscoveredFilter('reachable')"><div class="stat-value" id="statReachable">-</div><div class="stat-label">Reachable</div></div>
        <div class="stat-card" style="cursor:pointer;" onclick="setDiscoveredFilter('provisioned')"><div class="stat-value" id="statProvisioned">-</div><div class="stat-label">Provisioned</div></div>
        <div class="stat-card" style="border-left-color:#42a5f5; cursor:pointer;" onclick="setDiscoveredFilter('no_binding')"><div class="stat-value" id="statNoBinding">-</div><div class="stat-label">Not in Inventory</div></div>
        <div class="stat-card" style="border-left-color:#78909c; cursor:pointer;" onclick="setDiscoveredFilter('other')"><div class="stat-value" id="statOther">-</div><div class="stat-label">Other Devices</div></div>
        <div class="stat-card" style="border-left-color:#e53935; cursor:pointer;" onclick="setDiscoveredFilter('mismatch')"><div class="stat-value" id="statMismatch">-</div><div class="stat-label">MAC Mismatch</div></div>
        <div class="stat-card" style="border-left-color:#ff9800; cursor:pointer;" onclick="setDiscoveredFilter('not_provisioned')"><div class="stat-value" id="statNotProv">-</div><div class="stat-label">No Key</div></div>
        <div class="stat-card" style="border-left-color:#f44336; cursor:pointer;" onclick="setDiscoveredFilter('unreachable')"><div class="stat-value" id="statUnreachable">-</div><div class="stat-label">Unreachable</div></div>
        <div class="stat-card" style="border-left-color:#888; cursor:pointer;" onclick="setDiscoveredFilter('all')"><div class="stat-value" id="statAll">-</div><div class="stat-label">All</div></div>
    </div>
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="discoveredSearch" placeholder="Filter..." oninput="filterDiscovered()">
            <select class="form-input" id="discoveredFilter" onchange="filterDiscovered()" style="width:180px;">
                <option value="reachable" selected>Reachable</option>
                <option value="provisioned">Provisioned</option>
                <option value="not_provisioned">No Key</option>
                <option value="other">Other Devices</option>
                <option value="has_binding">In Inventory</option>
                <option value="no_binding">Not in Inventory</option>
                <option value="mismatch">MAC Mismatch</option>
                <option value="all">All (incl. Unreachable)</option>
            </select>
            <span id="discoveredInfo" style="font-size: 11px; color: #666;"></span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary btn-sm" onclick="downloadDiscoveredCSV()">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                Download CSV
            </button>
            <button class="btn btn-secondary btn-sm" onclick="exportDiscoveredToDevicesYaml()" title="Add all provisioned devices to inventory and write devices.yaml">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm1 9h-2v2h-2v-2H9V9h2V7h2v2h2v2zm-3 7H6V4h7v5h5v9z"/></svg>
                Export to devices.yaml
            </button>
            <button class="btn btn-primary btn-sm" onclick="runSubnetScan()" id="btnScan">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                Scan
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="discoveredTable">
            <thead>
                <tr>
                    <th style="cursor:pointer;" onclick="sortDiscovered('hostname')">Hostname <span id="sort-hostname" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('discovered_mac')">MAC Address <span id="sort-discovered_mac" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('ip')">IP Address <span id="sort-ip" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('serial')">Serial <span id="sort-serial" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('role')">Role <span id="sort-role" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('device_type')">Access <span id="sort-device_type" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('post_provision')">Base Config <span id="sort-post_provision" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortDiscovered('mac_status')">Status <span id="sort-mac_status" style="opacity:0.4;">&#9650;</span></th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody id="discoveredBody">
                <tr><td colspan="8" class="loading">Click Scan to discover devices...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 1: INVENTORY (was Bindings) ==================== -->

<!-- ==================== TAB 2: DHCPd ==================== -->
<div class="tab-content" id="tab-dhcpd">
    <div class="section-title">DHCP Server Configuration</div>
    <div class="section-desc">Subnet, IP range, gateway, DNS and ZTP settings. Changes require DHCP restart.</div>
    <div style="padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">SUBNET</label>
                <input type="text" class="form-input" id="dhcpSubnet" style="width: 100%;" placeholder="192.168.100.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">NETMASK</label>
                <input type="text" class="form-input" id="dhcpNetmask" style="width: 100%;" placeholder="255.255.255.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DYNAMIC RANGE START</label>
                <input type="text" class="form-input" id="dhcpRangeStart" style="width: 100%;" placeholder="192.168.100.210">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DYNAMIC RANGE END</label>
                <input type="text" class="form-input" id="dhcpRangeEnd" style="width: 100%;" placeholder="192.168.100.249">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">GATEWAY (ROUTER)</label>
                <input type="text" class="form-input" id="dhcpGateway" style="width: 100%;" placeholder="192.168.100.1">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DNS SERVER</label>
                <input type="text" class="form-input" id="dhcpDNS" style="width: 100%;" placeholder="192.168.100.1">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DOMAIN NAME</label>
                <input type="text" class="form-input" id="dhcpDomain" style="width: 100%;" placeholder="example.com">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">ZTP PROVISION URL</label>
                <input type="text" class="form-input" id="dhcpProvisionURL" style="width: 100%;" placeholder="http://192.168.100.200/cumulus-ztp.sh">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">LISTEN INTERFACE</label>
                <select class="form-input" id="dhcpInterface" style="width: 100%;"><option value="">Loading...</option></select>
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT LEASE TIME (sec)</label>
                <input type="text" class="form-input" id="dhcpLeaseTime" style="width: 100%;" placeholder="172800">
            </div>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-primary btn-sm" onclick="saveDHCPConfig()">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save Config &amp; Restart DHCP
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadDHCPConfig()">Reload</button>
        </div>
    </div>
</div>

<!-- ==================== TAB 1: INVENTORY (was Bindings) ==================== -->
<div class="tab-content" id="tab-bindings">
    <div class="toolbar">
        <div class="toolbar-left">
            <input type="text" class="search-filter" id="bindingSearch" placeholder="Filter by hostname, MAC, IP, serial, or role..." oninput="filterBindings()">
            <span id="bindingCount" style="font-size: 12px; color: #888;"></span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="loadBindings()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                Refresh
            </button>
            <button class="btn btn-primary" onclick="showAddBinding()">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Add Binding
            </button>
            <button class="btn btn-secondary" onclick="showBulkImport()">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11z"/></svg>
                Bulk Import
            </button>
            <button class="btn btn-secondary" onclick="downloadBindingsCSV()">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM12 17l-4-4h2.5v-4h3v4H16l-4 4z"/></svg>
                Download CSV
            </button>
            <button class="btn btn-secondary" onclick="rebuildDevicesYaml()" title="Rebuild devices.yaml from inventory: groups by role, sorted by IP. Active entries are written normally, planned entries are commented out.">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V8l-6-6zm1 9h-2v2h-2v-2H9V9h2V7h2v2h2v2zm-3 7H6V4h7v5h5v9z"/></svg>
                Rebuild devices.yaml
            </button>
            <button class="btn btn-warning" onclick="saveBindings()" id="btnSaveBindings" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                Save
            </button>
            <button class="btn btn-primary" onclick="discardBindingChanges()" id="btnDiscardBindings" style="display:none;">Cancel</button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="data-table" id="bindingsTable">
            <thead>
                <tr>
                    <th style="cursor:pointer;" onclick="sortBindings('hostname')">Hostname <span id="bsort-hostname" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('mac')">MAC Address <span id="bsort-mac" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('ip')">IP Address <span id="bsort-ip" style="opacity:1;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('serial')">Serial <span id="bsort-serial" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('role')">Role <span id="bsort-role" style="opacity:0.4;">&#9650;</span></th>
                    <th style="cursor:pointer;" onclick="sortBindings('inv_status')">Status <span id="bsort-inv_status" style="opacity:0.4;">&#9650;</span></th>
                    <th style="width:50px; text-align:center;" title="DHCP binding required"><input type="checkbox" id="dhcpSelectAll" onchange="toggleAllDhcp(this.checked)" checked style="cursor:pointer;"> DHCP</th>
                    <th style="width:50px; text-align:center;">Live</th>
                    <th style="width:70px; text-align:center;" title="Base Config deployed">Base</th>
                    <th style="width:50px; text-align:center;" title="Generated config available in generated_config_folder/">Config</th>
                    <th style="width:120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="bindingsBody">
                <tr><td colspan="10" class="loading">Loading inventory...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 3: ZTP SCRIPT ==================== -->
<div class="tab-content" id="tab-ztp-script">
    <div class="section-desc">ZTP provisioning settings, SSH key management, OS image, and script editor.</div>

    <!-- SSH Key Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #76b900;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 5px;">SSH Key</div>
        <div class="section-desc" style="margin-bottom: 10px;">Single key pair used for ZTP provisioning and device management (Assets SSH Setup).</div>
        <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">PUBLIC KEY</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="ztpSSHKey" readonly style="flex:1; font-family:'Cascadia Code','Consolas',monospace; font-size:11px; background:#252526;" placeholder="No key generated yet...">
                    <button class="btn btn-secondary btn-sm" onclick="copySSHKey()" title="Copy public key">Copy</button>
                </div>
            </div>
            <div style="display: flex; gap: 8px; padding-top: 18px;">
                <button class="btn btn-primary btn-sm" onclick="generateSSHKey()">
                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h3v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    Generate
                </button>
                <button class="btn btn-secondary btn-sm" onclick="toggleImportKey()">Import</button>
                <button class="btn btn-secondary btn-sm" onclick="loadSSHKey()">Refresh</button>
            </div>
        </div>
        <div id="sshKeyStatus" style="margin-top: 8px; font-size: 12px; color: #888;"></div>
        <!-- Import Key Area (hidden by default) -->
        <div id="importKeyArea" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #3c3c3c;">
            <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">PASTE PRIVATE KEY</label>
            <textarea id="importKeyText" spellcheck="false" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" style="width:100%; height:120px; padding:10px; background:#1a1a1a; color:#4fc3f7; border:1px solid #555; border-radius:4px; font-family:'Cascadia Code','Consolas',monospace; font-size:11px; resize:vertical; box-sizing:border-box;"></textarea>
            <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                <button class="btn btn-primary btn-sm" onclick="importSSHKey()">Save Key</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleImportKey()">Cancel</button>
                <span id="importKeyMsg" style="font-size: 12px; color: #888;"></span>
            </div>
        </div>
    </div>

    <!-- Quick Settings Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 10px;">Quick Settings</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">TARGET OS VERSION</label>
                <input type="text" class="form-input" id="ztpTargetOS" style="width: 100%;" placeholder="e.g. 5.14.0">
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">DEFAULT PASSWORD</label>
                <div style="position: relative;">
                    <input type="password" class="form-input" id="ztpPassword" style="width: 100%; padding-right: 36px;" placeholder="Default password" autocomplete="off">
                    <button onclick="togglePasswordVisibility()" style="position:absolute; right:4px; top:50%; transform:translateY(-50%); background:none; border:none; color:#888; cursor:pointer; padding:4px;" title="Show/Hide" id="pwToggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                </div>
            </div>
            <div>
                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">IMAGE SERVER IP</label>
                <input type="text" class="form-input input-ip" id="ztpImageServer" style="width: 100%;" placeholder="e.g. 192.168.100.200">
            </div>
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="applyQuickSettings()">Apply to Script</button>
    </div>

    <!-- OS Image Upload Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div class="section-title" style="font-size: 14px; margin-bottom: 5px;">OS Image</div>
        <div class="section-desc" style="margin-bottom: 10px;">Cumulus Linux image served via HTTP for ZTP OS upgrades.</div>
        <div id="imageList" style="margin-bottom: 10px;"><span style="color:#888;">Checking...</span></div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <label class="btn btn-secondary btn-sm" style="cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                Upload Image
                <input type="file" id="imageUpload" style="display: none;" accept=".bin,.img,.iso" onchange="uploadImage(this)">
            </label>
            <span id="uploadProgress" style="font-size: 12px; color: #888;"></span>
        </div>
    </div>

    <!-- Serial Mapping Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <div class="section-title" style="font-size: 14px; margin-bottom: 2px;">Serial Mapping</div>
                <div class="section-desc">Map switch serial numbers to hostnames. ZTP script uses this to resolve which config to apply.</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary btn-sm" onclick="loadSerialMapping()">Reload</button>
                <button class="btn btn-primary btn-sm" onclick="saveSerialMapping()">
                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    Save
                </button>
            </div>
        </div>
        <div id="serialMappingTable" style="max-height: 300px; overflow-y: auto;">
            <table class="data-table" style="width: 100%; table-layout: fixed;">
                <thead><tr>
                    <th style="width: 40%;">Serial Number</th>
                    <th style="width: 40%;">Hostname</th>
                    <th style="width: 10%; text-align:center;" title="Green checkmark = generated config YAML exists in generated_config_folder/ for this hostname">Config</th>
                    <th style="width: 10%; text-align:center;">Del</th>
                </tr></thead>
                <tbody id="serialMappingBody"><tr><td colspan="4" style="color:#888; text-align:center;">Loading...</td></tr></tbody>
            </table>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-secondary btn-sm" onclick="addSerialMappingRow()">+ Add</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleBulkSerialMapping()">Bulk Import</button>
            <button class="btn btn-secondary btn-sm" onclick="autoFillFromInventory()" title="Fill serial/hostname pairs from Inventory bindings">Auto-fill from Inventory</button>
            <span style="font-size: 11px; color: #555; margin-left: 4px;" title="Cfg column: &#10004; = generated config YAML exists for this hostname">&#10004; = config ready</span>
            <span id="serialMappingStatus" style="font-size: 12px; color: #888; margin-left: auto;"></span>
        </div>
        <!-- Bulk Import Area (hidden) -->
        <div id="bulkSerialArea" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #3c3c3c;">
            <div style="margin-bottom: 8px; padding: 8px; background: #1a1a1a; border-radius: 4px; font-size: 12px; color: #888; font-family: 'Cascadia Code','Consolas',monospace; white-space: pre; line-height: 1.8;"><span style="color:#76b900;">Serial         Hostname</span>
<span style="color:#666;">ABC123XYZ001   leaf-01</span>
<span style="color:#666;">ABC123XYZ002   leaf-02</span>
<span style="color:#666;">ABC123XYZ003   spine-01</span></div>
            <div class="section-desc" style="margin-bottom: 8px;">Paste one mapping per line: <strong>SERIAL  HOSTNAME</strong> (space or tab separated). Header line and <code style="color:#76b900;">#</code> comments are skipped. Duplicates ignored.</div>
            <textarea id="bulkSerialText" spellcheck="false" placeholder="SERIAL  HOSTNAME&#10;SERIAL  HOSTNAME&#10;..." style="width:100%; height:120px; padding:10px; background:#1a1a1a; color:#76b900; border:1px solid #555; border-radius:4px; font-family:'Cascadia Code','Consolas',monospace; font-size:12px; resize:vertical; box-sizing:border-box;"></textarea>
            <div style="margin-top: 8px; display: flex; gap: 8px;">
                <button class="btn btn-primary btn-sm" onclick="importBulkSerialMapping()">Import</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleBulkSerialMapping()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Generated Configs Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 6px; border: 1px solid #3c3c3c;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <div class="section-title" style="font-size: 14px; margin-bottom: 2px;">Generated Configs</div>
                <div class="section-desc">NVUE YAML configs in <code style="background:#252526;padding:1px 4px;border-radius:3px;font-size:11px;">/var/www/html/generated_config_folder/</code> — served via HTTP for ZTP <code style="background:#252526;padding:1px 4px;border-radius:3px;font-size:11px;">-t</code> flag.</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <label class="btn btn-secondary btn-sm" style="cursor: pointer;" title="Upload YAML config files to generated_config_folder/">
                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                    Upload Configs
                    <input type="file" id="configUpload" style="display: none;" accept=".yaml,.yml" multiple onchange="uploadGeneratedConfigs(this)">
                </label>
                <button class="btn btn-secondary btn-sm" onclick="syncGeneratedConfigs()" title="Copy from Ansible generated_config_folder">Sync from Ansible</button>
                <button class="btn btn-secondary btn-sm" onclick="loadGeneratedConfigs()">Refresh</button>
            </div>
        </div>
        <div id="generatedConfigsList" style="max-height: 200px; overflow-y: auto;">
            <span style="color:#888;">Loading...</span>
        </div>
        <div id="generatedConfigsStatus" style="margin-top: 8px; font-size: 12px; color: #888;"></div>
    </div>

    <!-- Script Editor (collapsed by default) -->
    <div class="editor-container">
        <div class="editor-toolbar" style="cursor: pointer;" onclick="toggleScriptEditor()">
            <span class="editor-filename">
                <span id="editorToggle" style="margin-right: 6px;">&#9654;</span>
                cumulus-ztp.sh — Click to edit
            </span>
            <div style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
                <button class="btn btn-secondary btn-sm" onclick="loadZTPScript()">Reload</button>
                <button class="btn btn-primary btn-sm" onclick="saveZTPScript()">
                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    Save
                </button>
            </div>
        </div>
        <textarea class="editor-textarea" id="ztpEditor" spellcheck="false" style="display: none;"></textarea>
    </div>
</div>

<!-- ==================== TAB 5: BASE CONFIG ==================== -->
<div class="tab-content" id="tab-base-config">
    <div style="display: flex; gap: 15px; height: calc(100vh - 250px); min-height: 400px;">

        <!-- Left: Device Selection Panel (Device Details pattern) -->
        <div style="width: 300px; background: #252526; border: 1px solid #3c3c3c; border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;">
            <!-- Header -->
            <div style="padding: 10px 12px; background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%); color: white; font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: space-between;">
                <span>Select Devices</span>
                <span style="font-weight: normal; font-size: 12px;" id="bcSelectedCount">0 selected</span>
            </div>
            <!-- Quick actions -->
            <div style="padding: 6px 10px; border-bottom: 1px solid #404040; display: flex; gap: 8px; align-items: center; background: #2d2d2d;">
                <a href="#" onclick="bcSelectAll(true); return false;" style="font-size: 11px; color: #76b900; text-decoration: none;">All</a>
                <a href="#" onclick="bcSelectAll(false); return false;" style="font-size: 11px; color: #888; text-decoration: none;">None</a>
                <span style="flex:1;"></span>
                <span style="font-size: 11px; color: #666;" id="bcTotalDevices"></span>
            </div>
            <!-- Search -->
            <div style="padding: 8px 10px; border-bottom: 1px solid #404040;">
                <input type="text" id="bcDeviceSearch" placeholder="Search devices..." oninput="bcFilterDevices()" style="width: 100%; padding: 6px 10px; background: #3c3c3c; border: 1px solid #555; border-radius: 4px; color: #d4d4d4; font-size: 12px;">
            </div>
            <!-- Device list with role groups -->
            <div style="flex: 1; overflow-y: auto; padding: 5px 0;" id="bcDeviceList">
                <div class="loading" style="padding: 20px;">Loading devices...</div>
            </div>
        </div>

        <!-- Right: Deploy area -->
        <div style="flex: 1; display: flex; flex-direction: column;">
            <!-- Info bar -->
            <div style="padding: 12px 15px; background: #252526; border: 1px solid #3c3c3c; border-radius: 6px; margin-bottom: 10px; display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="deployBaseConfig()" id="btnDeploy">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    Deploy
                </button>
                <label style="font-size: 12px; cursor: pointer; color: #888;">
                    <input type="checkbox" id="disableZTPAfter" style="accent-color: #76b900;">
                    Disable ZTP after deploy
                </label>
                <span id="deployStatusText" style="font-size: 12px; color: #888; margin-left: auto;"></span>
            </div>
            <!-- Files info (compact) -->
            <div style="padding: 8px 12px; background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 4px; margin-bottom: 10px; font-size: 12px; color: #888;">
                <span style="color: #76b900; font-weight: 600;">Files:</span>
                <span id="bcFileList"></span>
            </div>
            <!-- Deploy Progress -->
            <div style="flex: 1; overflow-y: auto;" id="deployProgress">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #555;">
                    <svg viewBox="0 0 24 24" style="width: 60px; height: 60px; fill: #555; margin-bottom: 15px;"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    <div style="font-size: 14px; color: #888;">Select devices and click Deploy</div>
                    <div style="font-size: 12px; margin-top: 5px;">All sw-base files will be deployed via parallel SSH/SCP</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TAB 6: GUIDE ==================== -->
<div class="tab-content" id="tab-guide">
    <div style="overflow-y: auto; max-height: calc(100vh - 160px);">
    <iframe src="/lldpq-ztp-new-device-flow.html" style="width:100%; height: calc(100vh - 180px); border: none; border-radius: 6px;"></iframe>
    </div>
</div>

<!-- Add/Edit Binding Modal -->
<div class="modal-overlay" id="bindingModal" style="display: none;" onclick="if(event.target===this)closeBindingModal()">
    <div class="modal">
        <h3 id="modalTitle">Add Binding</h3>
        <div class="modal-field">
            <label>Hostname</label>
            <input type="text" id="modalHostname" placeholder="e.g. leaf-01">
        </div>
        <div class="modal-field">
            <label>MAC Address</label>
            <input type="text" id="modalMAC" class="mono" placeholder="Leave empty if unknown (Planned)" oninput="formatMAC(this)">
        </div>
        <div class="modal-field">
            <label>IP Address</label>
            <input type="text" id="modalIP" class="mono" placeholder="e.g. 192.168.100.11">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="modal-field" style="margin-bottom:0;">
                <label>Serial Number</label>
                <input type="text" id="modalSerial" class="mono" list="modalSerialList" placeholder="Select or type" oninput="onModalSerialSelect()" autocomplete="off">
                <datalist id="modalSerialList"></datalist>
            </div>
            <div class="modal-field" style="margin-bottom:0;">
                <label>Role</label>
                <input type="text" id="modalRole" list="modalRoleList" placeholder="Select or type" autocomplete="off">
                <datalist id="modalRoleList"></datalist>
            </div>
        </div>
        <input type="hidden" id="modalOrigHostname">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBindingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBinding()" id="modalSaveBtn">Add</button>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal-overlay" id="bulkImportModal" style="display: none;" onclick="if(event.target===this)closeBulkImport()">
    <div class="modal" style="min-width: 800px; max-width: 90vw;">
        <h3>Bulk Import Inventory</h3>
        <div class="section-desc" style="margin-bottom: 10px;">
            Paste one entry per line. Column order: <strong>Hostname  MAC  IP  Serial  Role</strong>. Use <code style="color:#76b900;">-</code> for unknown fields. DHCP is auto-enabled for entries with a MAC address; static IP devices (no MAC) get DHCP disabled.
        </div>
        <div style="margin-bottom: 10px; padding: 10px; background: #1e1e1e; border-radius: 4px; font-size: 12px; color: #888; font-family: 'Cascadia Code','Consolas',monospace; white-space: pre; overflow-x: auto; line-height: 1.8;">
<span style="color:#76b900;">Hostname  MAC                IP               Serial       Role</span>
<span style="color:#666;">leaf-01   54:9b:24:aa:68:16  192.168.100.11   MT253520027  oob_leaf</span>
<span style="color:#666;">leaf-02   -                  192.168.100.12   -            oob_leaf</span>
<span style="color:#666;">leaf-03   -                  192.168.100.13   -            -</span>
<span style="color:#666;">leaf-04   -                  -                -            -</span>
<span style="color:#666;">leaf-05   -                  -                -            oob_leaf</span>
<span style="color:#666;">leaf-06</span></div>
        <textarea id="bulkImportText" style="width:100%; min-height:250px; padding:12px; background:#1a1a1a; color:#d4d4d4; border:1px solid #555; border-radius:4px; font-family:'Cascadia Code','Consolas',monospace; font-size:13px; line-height:1.6; resize:vertical;" spellcheck="false" placeholder="hostname  MAC  IP  serial  role&#10;leaf-01  54:9b:24:aa:68:16  192.168.100.11  MT253520027  oob_leaf&#10;leaf-02  -  192.168.100.12  -  oob_leaf&#10;leaf-03  -  192.168.100.13"></textarea>
        <div id="bulkImportPreview" style="margin-top: 10px; font-size: 12px; color: #888;"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeBulkImport()">Cancel</button>
            <button class="btn btn-primary" onclick="applyBulkImport()">Import</button>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<script>
// ===================== GLOBAL STATE =====================
let allBindings = [];
let bindingsModified = false;
let allDiscovered = [];
let deviceList = [];
let knownRoles = []; // populated from devices.yaml via list-roles API
let pendingRemovals = []; // hostnames to remove from devices.yaml on save

const BASE_CONFIG_FILES = [
    { name: 'bash.bashrc', dest: '/etc/bash.bashrc', destAlt: '/home/cumulus/.bashrc', type: 'config', desc: 'Shell aliases & VRF helpers' },
    { name: 'motd.sh', dest: '/etc/profile.d/motd.sh', type: 'config', desc: 'Login banner with BGP status' },
    { name: 'tmux.conf', dest: '/etc/tmux.conf', type: 'config', desc: 'tmux settings' },
    { name: 'nanorc', dest: '/etc/nanorc', type: 'config', desc: 'Editor settings' },
    { name: 'cmd', dest: '/usr/local/bin/cmd', type: 'script', desc: 'tmux session manager' },
    { name: 'nvc', dest: '/usr/local/bin/nvc', type: 'script', desc: 'NV config colorizer' },
    { name: 'nvt', dest: '/usr/local/bin/nvt', type: 'script', desc: 'Interface table tool' },
    { name: 'exa', dest: '/usr/bin/exa', type: 'binary', desc: 'Modern ls replacement' }
];

// ===================== UNSAVED CHANGES WARNING =====================
window.addEventListener('beforeunload', (e) => {
    if (bindingsModified) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            onTabSwitch(btn.dataset.tab);
        });
    });

    // Load initial data
    loadDiscoverySettings();
    loadDiscoveryCache();
    loadDeviceList();
    loadKnownRoles();
    checkDHCPStatus();
    // Periodic DHCP status check (every 30s)
    setInterval(checkDHCPStatus, 30000);
});

function onTabSwitch(tab) {
    if (tab === 'discover') {
        loadDiscoveryCache();
        if (generatedConfigs.length === 0) apiCall('list-generated-configs').then(d => { if (d.success) generatedConfigs = d.configs || []; });
    }
    if (tab === 'dhcpd') { loadDHCPConfig(); }
    if (tab === 'bindings') {
        if (allBindings.length === 0) loadBindings();
        // Ensure discovery data is loaded for serial picker
        if (allDiscovered.length === 0) loadDiscoveryCache();
        // Load generated configs for Cfg column (if not loaded yet)
        if (generatedConfigs.length === 0) apiCall('list-generated-configs').then(d => { if (d.success) { generatedConfigs = d.configs || []; renderBindings(); } });
    }
    if (tab === 'ztp-script') loadZTPScript();
}

function setDiscoveredFilter(status) {
    document.getElementById('discoveredFilter').value = status;
    renderDiscovered();
    // Scroll to discovered table
    document.getElementById('discoveredTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===================== API HELPER =====================
async function apiCall(action, data = null) {
    try {
        const opts = {};
        if (data) {
            opts.method = 'POST';
            opts.headers = { 'Content-Type': 'application/json' };
            opts.body = JSON.stringify(data);
        }
        const resp = await fetch(`/provision-api.sh?action=${action}`, opts);
        return await resp.json();
    } catch (e) {
        return { success: false, error: e.message };
    }
}

// ===================== TOAST =====================
function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast toast-${type} show`;
    setTimeout(() => t.classList.remove('show'), 4000);
}

// ===================== DHCP STATUS CHECK =====================
async function checkDHCPStatus() {
    const data = await apiCall('dhcp-service-status');
    const dot = document.getElementById('dhcpStatusDot');
    const txt = document.getElementById('dhcpStatusText');
    if (data.success && data.running) {
        dot.className = 'status-dot active';
        txt.textContent = 'DHCP: Running';
    } else if (data.success && !data.running) {
        dot.className = 'status-dot inactive';
        txt.textContent = 'DHCP: Stopped';
    } else {
        dot.className = 'status-dot unknown';
        txt.textContent = 'DHCP: Unknown';
    }
}

// ===================== DHCP SERVICE CONTROL =====================
async function dhcpServiceAction(action) {
    if (action === 'stop') {
        showConfirmModal('Stop DHCP Server', 'Stop DHCP server? New devices will not get IP addresses.', () => _dhcpServiceAction(action));
        return;
    }
    _dhcpServiceAction(action);
}
async function _dhcpServiceAction(action) {
    showToast(`DHCP: ${action}...`, 'info');
    const data = await apiCall('dhcp-service-control', { action });
    if (data.success) {
        showToast(`DHCP ${action}: ${data.message || 'OK'}`, 'success');
    } else {
        showToast(`DHCP ${action} failed: ${data.error || 'Unknown error'}`, 'error');
    }
    checkDHCPStatus();
}

// ===================== DHCP CONFIG =====================
async function loadDHCPConfig() {
    // Use cached data from loadDiscoverySettings() if available, otherwise fetch
    const data = _cachedDhcpConfig || await apiCall('get-dhcp-config');
    _cachedDhcpConfig = null;  // clear cache after first use so Reload button works
    if (data.success) {
        document.getElementById('dhcpSubnet').value = data.subnet || '';
        document.getElementById('dhcpNetmask').value = data.netmask || '';
        document.getElementById('dhcpRangeStart').value = data.range_start || '';
        document.getElementById('dhcpRangeEnd').value = data.range_end || '';
        document.getElementById('dhcpGateway').value = data.gateway || '';
        document.getElementById('dhcpDNS').value = data.dns || '';
        document.getElementById('dhcpDomain').value = data.domain || '';
        document.getElementById('dhcpProvisionURL').value = data.provision_url || '';
        document.getElementById('dhcpLeaseTime').value = data.lease_time || '';
        
        // Discovery range and post-provision settings
        document.getElementById('discoveryRange').value = data.discovery_range || '';
        document.getElementById('autoBaseConfig').checked = data.auto_base_config !== false;
        document.getElementById('autoZtpDisable').checked = data.auto_ztp_disable !== false;
        document.getElementById('autoSetHostname').checked = data.auto_set_hostname !== false;
        
        // Populate interface dropdown
        const sel = document.getElementById('dhcpInterface');
        const currentIface = data.interface || 'eth0';
        const ifaces = data.interfaces || [];
        if (ifaces.length > 0) {
            sel.innerHTML = ifaces.map(i => {
                const selected = i.name === currentIface ? ' selected' : '';
                const ipLabel = i.ip ? ` (${i.ip})` : ' (no IP)';
                return `<option value="${escHtml(i.name)}"${selected}>${escHtml(i.name)}${ipLabel}</option>`;
            }).join('');
        } else {
            sel.innerHTML = `<option value="${escHtml(currentIface)}" selected>${escHtml(currentIface)}</option>`;
        }
    }
}

async function saveDHCPConfig() {
    const config = {
        subnet: document.getElementById('dhcpSubnet').value.trim(),
        netmask: document.getElementById('dhcpNetmask').value.trim(),
        range_start: document.getElementById('dhcpRangeStart').value.trim(),
        range_end: document.getElementById('dhcpRangeEnd').value.trim(),
        gateway: document.getElementById('dhcpGateway').value.trim(),
        dns: document.getElementById('dhcpDNS').value.trim(),
        domain: document.getElementById('dhcpDomain').value.trim(),
        provision_url: document.getElementById('dhcpProvisionURL').value.trim(),
        interface: document.getElementById('dhcpInterface').value.trim(),
        lease_time: document.getElementById('dhcpLeaseTime').value.trim(),
        discovery_range: document.getElementById('discoveryRange').value.trim(),
        auto_base_config: document.getElementById('autoBaseConfig').checked,
        auto_ztp_disable: document.getElementById('autoZtpDisable').checked,
        auto_set_hostname: document.getElementById('autoSetHostname').checked,
    };

    if (!config.subnet || !config.netmask || !config.gateway) {
        showToast('Subnet, Netmask and Gateway are required', 'error');
        return;
    }

    const data = await apiCall('save-dhcp-config', config);
    if (data.success) {
        showToast('DHCP config saved & server restarted', 'success');
        checkDHCPStatus();
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

function checkPrivateRange(rangeStr) {
    // Warn if range contains non-RFC1918 IPs (possible typo like 92.x instead of 192.x)
    if (!rangeStr) return '';
    const firstIp = rangeStr.split(/[-,]/)[0].trim();
    const parts = firstIp.split('.');
    if (parts.length !== 4) return '';
    const first = parseInt(parts[0]), second = parseInt(parts[1]);
    if (first === 10 || (first === 172 && second >= 16 && second <= 31) || (first === 192 && second === 168)) return '';
    return `Warning: "${firstIp}" is not a private IP (RFC1918). Did you mean 192.${parts.slice(1).join('.')}? Save anyway?`;
}

async function saveDiscoverySettings() {
    const rangeVal = document.getElementById('discoveryRange').value.trim();
    const rangeWarning = checkPrivateRange(rangeVal);
    if (rangeWarning) {
        showConfirmModal('Non-Private IP Range', rangeWarning, () => _doSaveDiscoverySettings(rangeVal));
        return;
    }
    _doSaveDiscoverySettings(rangeVal);
}

async function _doSaveDiscoverySettings(rangeVal) {
    const settings = {
        discovery_range: rangeVal,
        auto_base_config: document.getElementById('autoBaseConfig').checked,
        auto_ztp_disable: document.getElementById('autoZtpDisable').checked,
        auto_set_hostname: document.getElementById('autoSetHostname').checked,
        scan_interval: parseInt(document.getElementById('scanInterval').value) || 0,
    };
    const data = await apiCall('save-post-provision', settings);
    if (data.success) {
        showToast('Discovery settings saved', 'success');
    } else {
        showToast('Save failed: ' + (data.error || ''), 'error');
    }
}

async function loadDiscoverySettings() {
    // Uses same endpoint as loadDHCPConfig() but only sets discovery-specific fields.
    // On page load this runs first; loadDHCPConfig() runs when DHCP tab is opened.
    const data = await apiCall('get-dhcp-config');
    if (data.success) {
        document.getElementById('discoveryRange').value = data.discovery_range || '';
        document.getElementById('autoBaseConfig').checked = data.auto_base_config !== false;
        document.getElementById('autoZtpDisable').checked = data.auto_ztp_disable !== false;
        document.getElementById('autoSetHostname').checked = data.auto_set_hostname !== false;
        // Restore scan interval (default 300 = 5min)
        const interval = data.scan_interval !== undefined ? String(data.scan_interval) : '300';
        document.getElementById('scanInterval').value = interval;
        applyScanInterval();
        // Cache for DHCP tab so it doesn't need to re-fetch
        _cachedDhcpConfig = data;
    }
}

let _cachedDhcpConfig = null;

// ===================== DOWNLOAD CSV =====================
async function rebuildDevicesYaml() {
    // Count what will be written (must match server-side logic: inv_status == 'planned' is the sole criterion)
    const withRole = allBindings.filter(b => b.hostname && b.ip && b.role);
    const active = withRole.filter(b => b.inv_status !== 'planned');
    const planned = withRole.filter(b => b.inv_status === 'planned');
    const noRole = allBindings.filter(b => b.hostname && b.ip && !b.role);

    let msg = `Rebuild devices.yaml from inventory?<br><br>`;
    msg += `<strong>${active.length}</strong> active entries (written normally)<br>`;
    msg += `<strong>${planned.length}</strong> planned entries (commented with #)<br>`;
    if (noRole.length > 0) msg += `<span style="color:#ff9800;"><strong>${noRole.length}</strong> entries without role (skipped)</span><br>`;
    msg += `<br><span style="color:#888;font-size:12px;">Grouped by role, sorted by IP within each group.</span>`;

    showConfirmModal('Rebuild devices.yaml', msg, async () => {
        const data = await apiCall('rebuild-devices-yaml', { bindings: allBindings });
        if (data.success) {
            showToast(data.message || 'devices.yaml rebuilt', 'success');
        } else {
            showToast('Failed: ' + (data.error || ''), 'error');
        }
    }, 'Rebuild');
}

function downloadBindingsCSV() {
    if (allBindings.length === 0) {
        showToast('No bindings to download', 'error');
        return;
    }
    // Format: hostname  MAC  IP (same as Bulk Import expects)
    const lines = allBindings
        .filter(b => b.hostname && b.mac && b.ip)
        .sort((a, b) => {
            const pa = a.ip.split('.').map(n => n.padStart(3, '0')).join('.');
            const pb = b.ip.split('.').map(n => n.padStart(3, '0')).join('.');
            return pa.localeCompare(pb);
        })
        .map(b => `${b.hostname},${b.mac},${b.ip},${b.serial || ''},${b.role || ''}`);
    const header = 'Hostname,MAC,IP,Serial,Role';
    const content = header + '\n' + lines.join('\n') + '\n';
    const blob = new Blob([content], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventory-bindings.csv';
    a.click();
    URL.revokeObjectURL(url);
    showToast(`Downloaded ${lines.length} bindings`, 'success');
}

// ===================== BULK IMPORT =====================
function showBulkImport() {
    document.getElementById('bulkImportText').value = '';
    document.getElementById('bulkImportPreview').textContent = '';
    document.getElementById('bulkImportModal').style.display = 'flex';
    document.getElementById('bulkImportText').focus();
}

function closeBulkImport() {
    document.getElementById('bulkImportModal').style.display = 'none';
}

function parseBulkText(text) {
    const lines = text.trim().split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
    const entries = [];
    const errors = [];

    const clean = v => (!v || v === '-') ? '' : v.trim();
    const isMAC = v => /^([0-9a-fx]{2}:){5}[0-9a-fx]{2}$/.test(v);
    const isIP = v => /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(v);

    lines.forEach((line, idx) => {
        // Skip CSV header row
        if (idx === 0 && /^hostname/i.test(line.trim())) return;
        // Split by comma, tab, or whitespace
        const parts = line.trim().split(/[,\t]\s*|\s+/).filter(Boolean);
        if (parts.length < 1) return;

        // Fixed column order: Hostname  MAC  IP  Serial  Role
        // Use "-" for empty fields. Short lines OK (missing = empty).
        let hostname = parts[0];
        let mac = clean(parts[1]) || '';
        let ip = clean(parts[2]) || '';
        let serial = clean(parts[3]) || '';
        let role = clean(parts[4]) || '';

        // Smart fallback for 2-column lines: detect MAC vs IP
        if (parts.length === 2) {
            mac = ''; ip = ''; serial = ''; role = '';
            if (isIP(parts[1])) ip = parts[1];
            else if (isMAC(parts[1])) mac = parts[1].toLowerCase();
        }

        // Normalize MAC
        if (mac && isMAC(mac)) mac = mac.toLowerCase();
        else if (mac && !isMAC(mac)) mac = '';

        // Normalize: empty mac shows as '-'
        if (!mac) mac = '-';

        // Auto-detect DHCP: if MAC is provided, device needs DHCP; if no MAC (static IP), it doesn't
        const dhcp = (mac && mac !== '-');

        entries.push({ hostname, mac, ip, serial, role: role.toLowerCase(), commented: false, dhcp });
    });

    return { entries, errors };
}

function applyBulkImport() {
    const text = document.getElementById('bulkImportText').value;
    if (!text.trim()) {
        showToast('Paste binding data first', 'error');
        return;
    }

    const { entries, errors } = parseBulkText(text);

    if (errors.length > 0) {
        document.getElementById('bulkImportPreview').innerHTML =
            `<span style="color:#f44336;">Errors:</span><br>` +
            errors.map(e => `• ${escHtml(e)}`).join('<br>');
        return;
    }

    if (entries.length === 0) {
        showToast('No valid entries found', 'error');
        return;
    }

    // Merge with existing bindings (preserve existing fields not in import)
    let added = 0, updated = 0;
    entries.forEach(entry => {
        const existing = allBindings.findIndex(b => b.hostname === entry.hostname);
        if (existing >= 0) {
            // Merge: keep existing values for fields not provided in import
            const old = allBindings[existing];
            allBindings[existing] = {
                ...old,
                ...entry,
                mac: entry.mac !== '-' ? entry.mac : old.mac,
                serial: entry.serial || old.serial || '',
                role: entry.role || old.role || '',
            };
            updated++;
        } else {
            allBindings.push(entry);
            added++;
        }
    });

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = ''; document.getElementById('btnDiscardBindings').style.display = '';
    closeBulkImport();
    renderBindings();
    showToast(`Imported: ${added} added, ${updated} updated (unsaved)`, 'info');
}

// ===================== TAB 1: BINDINGS =====================
async function loadBindings() {
    document.getElementById('bindingsBody').innerHTML = '<tr><td colspan="10" class="loading">Loading inventory...</td></tr>';
    const data = await apiCall('list-bindings');
    if (data.success) {
        allBindings = data.bindings || [];
        bindingsModified = false;
        document.getElementById('btnSaveBindings').style.display = 'none'; document.getElementById('btnDiscardBindings').style.display = 'none';
        renderBindings();
    } else {
        document.getElementById('bindingsBody').innerHTML = `<tr><td colspan="9" style="color:#f44336;padding:20px;">Error: ${data.error}</td></tr>`;
    }
}

let bindSortCol = 'ip';
let bindSortAsc = true;

function sortBindings(col) {
    if (bindSortCol === col) { bindSortAsc = !bindSortAsc; }
    else { bindSortCol = col; bindSortAsc = true; }
    document.querySelectorAll('[id^="bsort-"]').forEach(el => { if (el) { el.style.opacity = '0.4'; el.innerHTML = '&#9650;'; } });
    const ind = document.getElementById('bsort-' + col);
    if (ind) { ind.style.opacity = '1'; ind.innerHTML = bindSortAsc ? '&#9650;' : '&#9660;'; }
    renderBindings();
}

function renderBindings() {
    const filter = document.getElementById('bindingSearch').value.toLowerCase();
    const filtered = allBindings.filter(b =>
        b.hostname.toLowerCase().includes(filter) ||
        b.mac.toLowerCase().includes(filter) ||
        b.ip.includes(filter) ||
        (b.serial || '').toLowerCase().includes(filter) ||
        (b.role || '').toLowerCase().includes(filter) ||
        (b.inv_status || '').toLowerCase().includes(filter)
    );

    // Sort
    filtered.sort((a, b) => {
        let va = a[bindSortCol] || '';
        let vb = b[bindSortCol] || '';
        if (bindSortCol === 'ip') {
            return bindSortAsc ? ipToNum(va) - ipToNum(vb) : ipToNum(vb) - ipToNum(va);
        }
        if (bindSortCol === 'inv_status') {
            const order = {planned: 0, discovered: 1, active: 2};
            va = order[a.inv_status] ?? 3; vb = order[b.inv_status] ?? 3;
            return bindSortAsc ? va - vb : vb - va;
        }
        va = va.toLowerCase(); vb = vb.toLowerCase();
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return bindSortAsc ? cmp : -cmp;
    });

    // Stats — use discovery cache to show reachability breakdown
    const discByIpStats = {};
    (allDiscovered || []).forEach(d => { if (d.ip) discByIpStats[d.ip] = d; });
    
    let statActive = 0, statUnreachable = 0, statPlanned = 0, statDiscovered = 0;
    allBindings.forEach(b => {
        const disc = discByIpStats[b.ip];
        if (disc && disc.device_type === 'provisioned') statActive++;
        else if (disc && disc.device_type === 'not_provisioned') statDiscovered++;
        else if (disc && disc.device_type === 'unreachable') statUnreachable++;
        else statPlanned++;  // not in discovery cache = not scanned
    });
    
    // Count devices in scan but NOT in inventory
    const invIps = new Set(allBindings.map(b => b.ip));
    const noBinding = (allDiscovered || []).filter(d => d.ip && !invIps.has(d.ip)).length;
    
    const parts = [`${filtered.length} of ${allBindings.length} entries`];
    if (statActive) parts.push(`Active: ${statActive}`);
    if (statDiscovered) parts.push(`Discovered: ${statDiscovered}`);
    if (statUnreachable) parts.push(`Unreachable: ${statUnreachable}`);
    if (statPlanned) parts.push(`Not Scanned: ${statPlanned}`);
    
    let statsHtml = parts.join('  |  ');
    if (noBinding > 0) {
        statsHtml += `  |  <a href="#" onclick="document.querySelector('[data-tab=discover]').click();setTimeout(()=>setDiscoveredFilter('no_binding'),100);return false;" style="color:#42a5f5;text-decoration:none;" title="Devices found in scan but not in inventory">${noBinding} not in inventory</a>`;
    }
    document.getElementById('bindingCount').innerHTML = statsHtml;

    if (filtered.length === 0) {
        document.getElementById('bindingsBody').innerHTML = `
            <tr><td colspan="11" style="text-align:center; padding:40px; color:#666;">
                ${allBindings.length === 0 ? 'No inventory entries. Click "Add Binding" to create one.' : 'No matches found.'}
            </td></tr>`;
        return;
    }

    // Build discovery lookup from cache (allDiscovered from subnet scan)
    const discByIp = {};
    (allDiscovered || []).forEach(d => { if (d.ip) discByIp[d.ip] = d; });

    document.getElementById('bindingsBody').innerHTML = filtered.map((b, i) => {
        const disc = discByIp[b.ip] || {};
        const isAlive = disc.device_type && disc.device_type !== 'unreachable';
        
        let liveIcon;
        if (!disc.device_type) {
            liveIcon = '<span style="display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:4px;background:rgba(100,100,100,0.2);color:#555;font-size:13px;" title="Not scanned">-</span>';
        } else if (isAlive) {
            liveIcon = '<span style="display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:4px;background:rgba(76,175,80,0.2);color:#81c784;font-size:13px;" title="Reachable">&#10003;</span>';
        } else {
            liveIcon = '<span style="display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:4px;background:rgba(244,67,54,0.2);color:#e57373;font-size:13px;" title="Unreachable">&#10007;</span>';
        }

        // Status badge
        let statusBadge;
        const st = b.inv_status || 'active';
        if (st === 'planned') statusBadge = '<span class="badge badge-pending">Planned</span>';
        else if (st === 'discovered') statusBadge = '<span class="badge badge-info">Discovered</span>';
        else statusBadge = '<span class="badge badge-active">Active</span>';

        // Role — if empty, show inline select directly; if set, show clickable badge
        let roleHtml;
        if (b.role) {
            roleHtml = `<span class="role-edit" onclick="editRole('${escAttr(b.hostname)}','${escAttr(b.ip)}',this)" style="cursor:pointer;padding:2px 8px;border-radius:3px;font-size:11px;background:#2d2d2d;color:#aaa;" title="Click to change role">${escHtml(b.role)}</span>`;
        } else {
            const roleOpts = knownRoles.map(r => `<option value="${escHtml(r)}">${escHtml(r)}</option>`).join('');
            roleHtml = `<select class="inline-select" onchange="inlineRoleSave('${escAttr(b.hostname)}','${escAttr(b.ip)}',this.value)" style="background:#1a1a1a;color:#888;border:1px solid #3c3c3c;border-radius:3px;padding:1px 4px;font-size:11px;outline:none;max-width:110px;cursor:pointer;"><option value="">—</option>${roleOpts}</select>`;
        }

        // Serial — if empty, check discovery for same IP first, then show dropdown of unbound
        let serialHtml;
        if (b.serial) {
            serialHtml = `<span class="serial-edit" onclick="editSerial('${escAttr(b.hostname)}','${escAttr(b.ip)}',this)" style="cursor:pointer;font-family:'Cascadia Code','Consolas',monospace; font-size:11px; color:#aaa;" title="Click to change serial">${escHtml(b.serial)}</span>`;
        } else {
            // Option 1: discovery has serial for same IP → quick-fill button
            const discForIp = disc;
            if (discForIp.serial) {
                serialHtml = `<span onclick="fillFromDiscovery('${escAttr(b.hostname)}','serial','${escAttr(discForIp.serial)}')" style="cursor:pointer;padding:2px 6px;border-radius:3px;font-size:10px;background:rgba(66,165,245,0.15);color:#42a5f5;font-family:'Cascadia Code','Consolas',monospace;" title="Fill from discovery">${escHtml(discForIp.serial)}</span>`;
            } else {
                // Option 2: dropdown of unbound serials from other discovered devices
                const boundSerials = new Set(allBindings.map(x => x.serial).filter(Boolean));
                const availSerials = (allDiscovered || []).filter(d => d.serial && !boundSerials.has(d.serial));
                if (availSerials.length > 0) {
                    const serialOpts = availSerials.map(d => `<option value="${escHtml(d.serial)}" data-mac="${escHtml(d.discovered_mac || '')}">${escHtml(d.serial)} (${escHtml(d.hostname || d.ip)})</option>`).join('');
                    serialHtml = `<select class="inline-select" onchange="inlineSerialSave('${escAttr(b.hostname)}','${escAttr(b.ip)}',this)" style="background:#1a1a1a;color:#888;border:1px solid #3c3c3c;border-radius:3px;padding:1px 4px;font-size:11px;outline:none;max-width:140px;cursor:pointer;font-family:'Cascadia Code','Consolas',monospace;"><option value="">—</option>${serialOpts}</select>`;
                } else {
                    serialHtml = '-';
                }
            }
        }

        // DHCP checkbox — disabled for entries without valid MAC (DHCP not applicable)
        const hasValidMac = b.mac && b.mac !== '-' && !b.mac.includes('x');
        const dhcpChecked = b.dhcp !== false ? 'checked' : '';
        const dhcpHtml = hasValidMac
            ? `<input type="checkbox" ${dhcpChecked} onchange="toggleDhcp('${escAttr(b.hostname)}', this.checked)" style="cursor:pointer;" title="DHCP binding">`
            : `<span style="color:#444;font-size:11px;" title="No MAC — DHCP not applicable">—</span>`;

        // Base Config badge
        let baseHtml;
        if (b.base_config) {
            baseHtml = '<span style="display:inline-block;padding:2px 6px;border-radius:3px;font-size:10px;background:rgba(76,175,80,0.15);color:#81c784;">Yes</span>';
        } else {
            baseHtml = '<span style="color:#555;font-size:11px;">-</span>';
        }

        // Generated Config status
        const gcSet = new Set((generatedConfigs || []).map(c => c.hostname));
        const hasCfg = gcSet.has(b.hostname);
        const cfgHtml = hasCfg
            ? '<span style="color:#76b900;" title="Generated config available">&#10004;</span>'
            : '<span style="color:#555;font-size:11px;" title="No generated config">-</span>';

        // MAC — if empty and discovery has MAC for same IP, show clickable auto-fill
        let macHtml;
        if (hasValidMac) {
            macHtml = escHtml(b.mac);
        } else if (disc.discovered_mac) {
            macHtml = `<span onclick="fillFromDiscovery('${escAttr(b.hostname)}','mac','${escAttr(disc.discovered_mac)}')" style="cursor:pointer;padding:2px 6px;border-radius:3px;font-size:11px;background:rgba(66,165,245,0.15);color:#42a5f5;font-family:'Cascadia Code','Consolas',monospace;" title="Fill MAC from discovery: ${escAttr(disc.discovered_mac)}">${escHtml(disc.discovered_mac)}</span>`;
        } else {
            macHtml = '<span style="color:#555;">-</span>';
        }

        return `<tr data-idx="${i}">
            <td><strong>${escHtml(b.hostname)}</strong></td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${macHtml}</td>
            <td style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">${escHtml(b.ip)}</td>
            <td>${serialHtml}</td>
            <td>${roleHtml}</td>
            <td>${statusBadge}</td>
            <td style="text-align:center;">${dhcpHtml}</td>
            <td style="text-align:center;">${liveIcon}</td>
            <td style="text-align:center;">${baseHtml}</td>
            <td style="text-align:center;">${cfgHtml}</td>
            <td class="row-actions">
                <button class="btn btn-secondary btn-sm" onclick="editBinding('${escAttr(b.hostname)}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteBinding('${escAttr(b.hostname)}')">Del</button>
            </td>
        </tr>`;
    }).join('');
}

function fillFromDiscovery(hostname, field, value) {
    const b = allBindings.find(x => x.hostname === hostname);
    if (!b) return;
    b[field] = value;
    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    document.getElementById('btnDiscardBindings').style.display = '';
    
    // If filling MAC, also fill serial from discovery if available
    if (field === 'mac') {
        const disc = (allDiscovered || []).find(d => d.ip === b.ip);
        if (disc && disc.serial && !b.serial) {
            b.serial = disc.serial;
            showToast(`MAC + Serial filled from discovery`, 'success');
        } else {
            showToast(`MAC filled: ${value}`, 'success');
        }
    } else if (field === 'serial') {
        // If filling serial, also fill MAC if available
        const disc = (allDiscovered || []).find(d => d.ip === b.ip);
        if (disc && disc.discovered_mac && (!b.mac || b.mac === '-')) {
            b.mac = disc.discovered_mac;
            showToast(`Serial + MAC filled from discovery`, 'success');
        } else {
            showToast(`Serial filled: ${value}`, 'success');
        }
    }
    renderBindings();
}

function toggleDhcp(hostname, checked) {
    const b = allBindings.find(x => x.hostname === hostname);
    if (b) {
        b.dhcp = checked;
        bindingsModified = true;
        document.getElementById('btnSaveBindings').style.display = '';
        document.getElementById('btnDiscardBindings').style.display = '';
    }
}

function toggleAllDhcp(checked) {
    allBindings.forEach(b => { b.dhcp = checked; });
    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    document.getElementById('btnDiscardBindings').style.display = '';
    renderBindings();
}

function filterBindings() { renderBindings(); }

async function loadKnownRoles() {
    const data = await apiCall('list-roles');
    if (data.success && data.roles) {
        knownRoles = data.roles;
    }
}

function inlineRoleSave(hostname, ip, newRole) {
    if (!newRole) return;
    // Update local state only — saved to devices.yaml when user clicks Save
    const b = allBindings.find(x => x.hostname === hostname);
    if (b) b.role = newRole;
    const d = (allDiscovered || []).find(x => x.hostname === hostname);
    if (d) d.role = newRole;
    if (!knownRoles.includes(newRole)) knownRoles.push(newRole);
    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = '';
    document.getElementById('btnDiscardBindings').style.display = '';
    showToast(`Role: ${hostname} → ${newRole} (unsaved)`, 'info');
    renderBindings();
}

function inlineSerialSave(hostname, ip, selectEl) {
    const newSerial = selectEl.value;
    if (!newSerial) return;
    const selectedOpt = selectEl.options[selectEl.selectedIndex];
    const discMac = selectedOpt.dataset.mac || '';
    const b = allBindings.find(x => x.hostname === hostname);
    if (b) {
        b.serial = newSerial;
        bindingsModified = true;
        document.getElementById('btnSaveBindings').style.display = ''; document.getElementById('btnDiscardBindings').style.display = '';
        if (discMac && (!b.mac || b.mac === '-' || b.mac.includes('x'))) {
            b.mac = discMac;
            showToast(`Serial assigned + MAC auto-filled: ${discMac}`, 'success');
        } else {
            showToast(`Serial assigned: ${newSerial}`, 'info');
        }
    }
    renderBindings();
}

function editRole(hostname, ip, el) {
    const currentRole = el.textContent.trim();
    // Build role options from devices.yaml only (no hardcoded defaults)
    const allRoles = ['', ...knownRoles];

    // Create combo box: wrapper with select + text input
    const wrapper = document.createElement('span');
    wrapper.style.cssText = 'display:inline-flex;align-items:center;gap:2px;';

    const select = document.createElement('select');
    select.style.cssText = 'background:#1a1a1a;color:#d4d4d4;border:1px solid #76b900;border-radius:3px 0 0 3px;padding:2px 4px;font-size:11px;outline:none;max-width:100px;';
    allRoles.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r || '(none)';
        if (r === currentRole || (r === '' && currentRole === '-')) opt.selected = true;
        select.appendChild(opt);
    });
    // Add "custom..." option at the end
    const customOpt = document.createElement('option');
    customOpt.value = '__custom__';
    customOpt.textContent = '✎ custom...';
    select.appendChild(customOpt);

    const textInput = document.createElement('input');
    textInput.type = 'text';
    textInput.style.cssText = 'display:none;background:#1a1a1a;color:#d4d4d4;border:1px solid #76b900;border-radius:0 3px 3px 0;padding:2px 4px;font-size:11px;outline:none;width:80px;';
    textInput.placeholder = 'type role';

    wrapper.appendChild(select);
    wrapper.appendChild(textInput);
    el.replaceWith(wrapper);
    select.focus();

    let saving = false;

    function saveRole(newRole) {
        if (saving) return;
        saving = true;
        // Update local state only — saved to devices.yaml when user clicks Save
        const b = allBindings.find(x => x.hostname === hostname);
        if (b) b.role = newRole;
        const d = (allDiscovered || []).find(x => x.hostname === hostname);
        if (d) d.role = newRole;
        if (newRole && !knownRoles.includes(newRole)) knownRoles.push(newRole);
        bindingsModified = true;
        document.getElementById('btnSaveBindings').style.display = '';
        document.getElementById('btnDiscardBindings').style.display = '';
        showToast(`Role: ${hostname} → ${newRole || '(none)'} (unsaved)`, 'info');
        renderBindings();
    }

    select.addEventListener('change', () => {
        if (select.value === '__custom__') {
            textInput.style.display = '';
            textInput.focus();
        } else {
            textInput.style.display = 'none';
            saveRole(select.value);
        }
    });

    textInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const val = textInput.value.trim().toLowerCase();
            saveRole(val);
        } else if (e.key === 'Escape') {
            renderBindings();
        }
    });

    textInput.addEventListener('blur', () => {
        if (!saving) {
            const val = textInput.value.trim().toLowerCase();
            if (val) saveRole(val);
            else renderBindings();
        }
    });

    select.addEventListener('blur', () => {
        // Only cancel if custom input is not shown (not switching to text input)
        setTimeout(() => {
            if (!saving && textInput.style.display === 'none' && document.activeElement !== textInput) {
                renderBindings();
            }
        }, 150);
    });
}

function editSerial(hostname, ip, el) {
    // Build dropdown from discovered devices that have serial but no binding, plus current serial
    const currentSerial = el.textContent.trim();
    const boundSerials = new Set(allBindings.map(b => b.serial).filter(Boolean));
    // Unbound serials from discovered data
    const available = (allDiscovered || [])
        .filter(d => d.serial && (!boundSerials.has(d.serial) || d.serial === currentSerial))
        .map(d => ({ serial: d.serial, hostname: d.hostname, ip: d.ip, mac: d.discovered_mac }));

    const select = document.createElement('select');
    select.style.cssText = 'background:#1a1a1a;color:#d4d4d4;border:1px solid #76b900;border-radius:3px;padding:2px 4px;font-size:11px;outline:none;max-width:180px;';

    // "(none)" option
    const noneOpt = document.createElement('option');
    noneOpt.value = '';
    noneOpt.textContent = '(none)';
    if (!currentSerial || currentSerial === '-') noneOpt.selected = true;
    select.appendChild(noneOpt);

    // Available serials
    available.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.serial;
        opt.textContent = `${d.serial} (${d.hostname || d.ip})`;
        opt.dataset.mac = d.mac || '';
        opt.dataset.discHostname = d.hostname || '';
        if (d.serial === currentSerial) opt.selected = true;
        select.appendChild(opt);
    });

    if (available.length === 0) {
        const noOpt = document.createElement('option');
        noOpt.value = '';
        noOpt.textContent = '— no discovered serials —';
        noOpt.disabled = true;
        select.appendChild(noOpt);
    }

    el.replaceWith(select);
    select.focus();

    let saving = false;

    select.addEventListener('change', () => {
        if (saving) return;
        saving = true;
        const selectedOpt = select.options[select.selectedIndex];
        const newSerial = select.value;
        const discMac = selectedOpt.dataset.mac || '';

        // Update local binding
        const b = allBindings.find(x => x.hostname === hostname);
        if (b) {
            b.serial = newSerial;
            bindingsModified = true;
            document.getElementById('btnSaveBindings').style.display = ''; document.getElementById('btnDiscardBindings').style.display = '';
            // Auto-fill MAC from discovered data if current MAC is empty/placeholder
            if (discMac && (!b.mac || b.mac === '-' || b.mac.includes('x'))) {
                b.mac = discMac;
                showToast(`Serial assigned + MAC auto-filled: ${discMac}`, 'success');
            } else {
                showToast(`Serial assigned: ${newSerial || '(none)'}`, 'info');
            }
        }
        renderBindings();
    });

    select.addEventListener('blur', () => {
        if (!saving) renderBindings();
    });
}

function showAddBinding() {
    document.getElementById('modalTitle').textContent = 'Add Binding';
    document.getElementById('modalHostname').value = '';
    document.getElementById('modalMAC').value = '';
    document.getElementById('modalIP').value = '';
    document.getElementById('modalSerial').value = '';
    document.getElementById('modalRole').value = '';
    document.getElementById('modalOrigHostname').value = '';
    document.getElementById('modalSaveBtn').textContent = 'Add';
    populateModalSerialDropdown('');
    populateModalRoleDropdown('');
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function editBinding(hostname) {
    const b = allBindings.find(x => x.hostname === hostname);
    if (!b) return;
    document.getElementById('modalTitle').textContent = 'Edit Binding';
    document.getElementById('modalHostname').value = b.hostname;
    document.getElementById('modalMAC').value = b.mac;
    document.getElementById('modalIP').value = b.ip;
    document.getElementById('modalSerial').value = b.serial || '';
    document.getElementById('modalRole').value = b.role || '';
    document.getElementById('modalOrigHostname').value = b.hostname;
    document.getElementById('modalSaveBtn').textContent = 'Update';
    populateModalSerialDropdown(b.serial || '');
    populateModalRoleDropdown(b.role || '');
    document.getElementById('bindingModal').style.display = 'flex';
    document.getElementById('modalHostname').focus();
}

function populateModalSerialDropdown(currentSerial) {
    const list = document.getElementById('modalSerialList');
    if (!list) return;
    list.innerHTML = '';
    const boundSerials = new Set(allBindings.map(b => b.serial).filter(Boolean));
    (allDiscovered || [])
        .filter(d => d.serial && (!boundSerials.has(d.serial) || d.serial === currentSerial))
        .forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.serial;
            opt.textContent = `${d.serial} (${d.hostname || d.ip})`;
            list.appendChild(opt);
        });
}

function populateModalRoleDropdown(currentRole) {
    const list = document.getElementById('modalRoleList');
    if (!list) return;
    list.innerHTML = '';
    knownRoles.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        list.appendChild(opt);
    });
}

function onModalSerialSelect() {
    const serial = document.getElementById('modalSerial').value;
    if (!serial) return;
    // Find discovered device with this serial and auto-fill MAC if empty
    const disc = (allDiscovered || []).find(d => d.serial === serial);
    if (disc && disc.discovered_mac) {
        const macInput = document.getElementById('modalMAC');
        if (!macInput.value || macInput.value === '-' || macInput.value.includes('x')) {
            macInput.value = disc.discovered_mac;
        }
    }
}

function closeBindingModal() {
    document.getElementById('bindingModal').style.display = 'none';
}

function saveBinding() {
    const hostname = document.getElementById('modalHostname').value.trim();
    let mac = document.getElementById('modalMAC').value.trim().toLowerCase();
    const ip = document.getElementById('modalIP').value.trim();
    const serial = document.getElementById('modalSerial').value.trim();
    const role = document.getElementById('modalRole').value.trim().toLowerCase();
    const origHostname = document.getElementById('modalOrigHostname').value;

    if (!hostname || !ip) {
        showToast('Hostname and IP are required', 'error');
        return;
    }

    // Empty MAC → placeholder dash (will be written as xx:xx:xx:xx:xx:xx in dhcpd.hosts)
    if (!mac || mac === '-') {
        mac = '-';
    } else {
        // MAC format validation — allow placeholder like xx:xx:xx:xx:xx:xx
        if (!/^([0-9a-fx]{2}:){5}[0-9a-fx]{2}$/.test(mac)) {
            showToast('Invalid MAC format. Use xx:xx:xx:xx:xx:xx', 'error');
            return;
        }
    }

    // IP format validation
    if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) {
        showToast('Invalid IP format', 'error');
        return;
    }

    if (origHostname) {
        // Edit existing
        const idx = allBindings.findIndex(x => x.hostname === origHostname);
        if (idx >= 0) {
            allBindings[idx] = { ...allBindings[idx], hostname, mac, ip, serial, role, commented: false };
        }
    } else {
        // Check duplicate
        if (allBindings.find(x => x.hostname === hostname)) {
            showToast(`Hostname "${hostname}" already exists`, 'error');
            return;
        }
        allBindings.push({ hostname, mac, ip, serial, role, commented: false });
    }

    // Role is saved to devices.yaml when user clicks Save (via sync_devices),
    // not immediately — avoids writing to disk for unsaved changes
    if (role && !knownRoles.includes(role)) knownRoles.push(role);

    bindingsModified = true;
    document.getElementById('btnSaveBindings').style.display = ''; document.getElementById('btnDiscardBindings').style.display = '';
    closeBindingModal();
    renderBindings();
    showToast(origHostname ? 'Binding updated (unsaved)' : 'Binding added (unsaved)', 'info');
}

function deleteBinding(hostname) {
    showConfirmModal('Delete Binding',
        `Delete binding for <strong>${escHtml(hostname)}</strong>?<br><br><span style="color:#ff9800;font-size:12px;">This will also remove the device from devices.yaml (inventory).</span>`,
        () => {
            allBindings = allBindings.filter(x => x.hostname !== hostname);
            pendingRemovals.push(hostname);
            bindingsModified = true;
            document.getElementById('btnSaveBindings').style.display = ''; document.getElementById('btnDiscardBindings').style.display = '';
            renderBindings();
            showToast(`Binding "${hostname}" deleted (unsaved)`, 'info');
        });
}

async function saveBindings() {
    const btn = document.getElementById('btnSaveBindings');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const data = await apiCall('save-bindings', {
        bindings: allBindings,
        sync_devices: true,
        remove_devices: pendingRemovals,
        restart_dhcp: false
    });
    if (data.success) {
        bindingsModified = false;
        pendingRemovals = [];
        btn.style.display = 'none';
        document.getElementById('btnDiscardBindings').style.display = 'none';
        showToast(data.message || 'Saved', 'success');
        loadKnownRoles();
        // Ask if user wants to restart DHCP
        showConfirmModal('Restart DHCP?',
            'Bindings saved successfully.<br><br>Restart DHCP server to apply changes?<br><span style="color:#888;font-size:12px;">Skip if DHCP is not running (e.g. Docker without DHCP).</span>',
            async () => {
                const r = await apiCall('dhcp-service-control', { action: 'restart' });
                if (r.success) {
                    showToast('DHCP restarted: ' + (r.message || 'OK'), 'success');
                } else {
                    showToast('DHCP restart failed: ' + (r.error || ''), 'error');
                }
                checkDHCPStatus();
            }, 'Restart', 'No');
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Save';
}


function discardBindingChanges() {
    showConfirmModal('Discard Changes', 'Discard all unsaved changes and reload bindings from server?', () => {
        pendingRemovals = [];
        bindingsModified = false;
        document.getElementById('btnSaveBindings').style.display = 'none'; document.getElementById('btnDiscardBindings').style.display = 'none';
        loadBindings();
        showToast('Changes discarded', 'info');
    });
}

function formatMAC(input) {
    let v = input.value.replace(/[^0-9a-fA-F]/g, '').substring(0, 12);
    let parts = [];
    for (let i = 0; i < v.length; i += 2) {
        parts.push(v.substring(i, i + 2));
    }
    input.value = parts.join(':');
}

// ===================== TAB 2: DISCOVERED =====================
async function loadDiscoveryCache() {
    const data = await apiCall('discovery-cache');
    if (data.success && data.entries && data.entries.length > 0) {
        allDiscovered = data.entries;
        renderDiscoveredStats();
        renderDiscovered();
        updateDiscoveryInfo(data.age_seconds || 0);
        // If stale, silent background scan (no loading indicators)
        if (data.stale) silentSubnetScan();
    } else {
        // No cache — silent scan
        document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">No scan data yet. Click Scan or wait...</td></tr>';
        silentSubnetScan();
    }
}

function updateDiscoveryInfo(ageSec) {
    const info = document.getElementById('discoveredInfo');
    if (ageSec < 60) info.textContent = `${ageSec}s ago`;
    else if (ageSec < 3600) info.textContent = `${Math.round(ageSec/60)}m ago`;
    else info.textContent = `${Math.round(ageSec/3600)}h ago`;
}

// Silent background scan — no loading indicators, just updates data
let _scanInProgress = false;
async function silentSubnetScan() {
    if (_scanInProgress) return;  // prevent concurrent scans
    _scanInProgress = true;
    const data = await apiCall('subnet-scan');
    if (data.success) {
        allDiscovered = data.entries || [];
        renderDiscoveredStats();
        renderDiscovered();
        updateDiscoveryInfo(0);
        // Refresh bindings table if loaded (uses discovery cache for MAC/Live columns)
        if (allBindings.length > 0) renderBindings();
    }
    _scanInProgress = false;
}

// Periodic background scan — interval controlled by dropdown
let scanIntervalId = null;

function applyScanInterval() {
    const sec = parseInt(document.getElementById('scanInterval').value) || 0;
    const info = document.getElementById('scanIntervalInfo');
    if (scanIntervalId) { clearInterval(scanIntervalId); scanIntervalId = null; }
    if (sec > 0) {
        scanIntervalId = setInterval(silentSubnetScan, sec * 1000);
        info.textContent = '';
    } else {
        info.textContent = '(manual only)';
    }
}

// Scan interval is initialized after loadDiscoverySettings() fetches the server value.
// Do not call applyScanInterval() here — it would start a timer with the wrong default.

function renderDiscoveredStats() {
    const provisioned = allDiscovered.filter(d => d.device_type === 'provisioned').length;
    const notProv = allDiscovered.filter(d => d.device_type === 'not_provisioned').length;
    const other = allDiscovered.filter(d => d.device_type === 'other').length;
    const unreachable = allDiscovered.filter(d => d.device_type === 'unreachable').length;
    const reachable = allDiscovered.filter(d => d.device_type && d.device_type !== 'unreachable').length;
    const mismatch = allDiscovered.filter(d => d.mac_status === 'mismatch').length;
    const noBinding = allDiscovered.filter(d => !d.has_binding).length;
    document.getElementById('statReachable').textContent = reachable;
    document.getElementById('statProvisioned').textContent = provisioned;
    document.getElementById('statNotProv').textContent = notProv;
    document.getElementById('statOther').textContent = other;
    document.getElementById('statUnreachable').textContent = unreachable;
    document.getElementById('statMismatch').textContent = mismatch;
    document.getElementById('statNoBinding').textContent = noBinding;
    document.getElementById('statAll').textContent = allDiscovered.length;
}

async function exportDiscoveredToDevicesYaml() {
    // Get provisioned devices from discovery
    const provisioned = (allDiscovered || []).filter(d => d.device_type === 'provisioned' && d.hostname);
    if (provisioned.length === 0) {
        showToast('No provisioned devices found. Run a scan first.', 'error');
        return;
    }

    const inInv = provisioned.filter(d => allBindings.some(b => b.ip === d.ip)).length;
    const notInInv = provisioned.length - inInv;

    let msg = `Export ${provisioned.length} provisioned devices to devices.yaml?<br><br>`;
    msg += `<strong>${inInv}</strong> already in inventory<br>`;
    if (notInInv > 0) msg += `<strong>${notInInv}</strong> will be added to inventory<br>`;
    msg += `<br><span style="color:#888;font-size:12px;">Adds missing devices to inventory, saves, then rebuilds devices.yaml (grouped by role, sorted by IP).</span>`;

    showConfirmModal('Export to devices.yaml', msg, async () => {
        // 1. Add missing provisioned devices to inventory
        let added = 0;
        for (const d of provisioned) {
            if (!allBindings.some(b => b.ip === d.ip)) {
                allBindings.push({
                    hostname: d.hostname,
                    mac: d.discovered_mac || '-',
                    ip: d.ip,
                    serial: d.serial || '',
                    role: d.role || '',
                    inv_status: 'active',
                    dhcp: !!(d.discovered_mac),
                });
                added++;
            }
        }

        // 2. Save inventory
        const saveData = await apiCall('save-bindings', {
            bindings: allBindings,
            sync_devices: false,
            remove_devices: [],
            restart_dhcp: false
        });
        if (!saveData.success) {
            showToast('Save failed: ' + (saveData.error || ''), 'error');
            return;
        }

        // 3. Rebuild devices.yaml
        const rebuildData = await apiCall('rebuild-devices-yaml', { bindings: allBindings });
        if (rebuildData.success) {
            showToast(`Exported: ${rebuildData.active || 0} active, ${rebuildData.planned || 0} planned. ${added} new devices added.`, 'success');
        } else {
            showToast('Rebuild failed: ' + (rebuildData.error || ''), 'error');
        }

        // Refresh bindings if on inventory tab
        if (allBindings.length > 0) renderBindings();
    }, 'Export');
}

async function runSubnetScan() {
    if (_scanInProgress) { showToast('Scan already in progress...', 'info'); return; }
    _scanInProgress = true;
    const btn = document.getElementById('btnScan');
    btn.disabled = true;
    btn.textContent = 'Scanning...';
    document.getElementById('discoveredBody').innerHTML = '<tr><td colspan="8" class="loading">Scanning subnet: ping + SSH probe + post-provision...</td></tr>';
    
    const data = await apiCall('subnet-scan');
    if (data.success) {
        allDiscovered = data.entries || [];
        renderDiscoveredStats();
        renderDiscovered();
        const prov = allDiscovered.filter(d => d.device_type === 'provisioned').length;
        const unreach = allDiscovered.filter(d => d.device_type === 'unreachable').length;
        const deployed = Object.values(data.post_provision_results || {}).filter(s => s === 'deployed').length;
        let msg = `Scan: ${data.reachable || 0}/${data.total_ips || 0} reachable, ${prov} provisioned`;
        if (deployed > 0) msg += `, ${deployed} newly configured`;
        if (data.warning) {
            showToast(data.warning, 'error');
            setTimeout(() => showToast(msg, 'success'), 4500);
        } else {
            showToast(msg, 'success');
        }
        updateDiscoveryInfo(0);
        if (allBindings.length > 0) renderBindings();
    } else {
        document.getElementById('discoveredBody').innerHTML = `<tr><td colspan="8" style="color:#f44336;padding:20px;">Scan failed: ${data.error}</td></tr>`;
        showToast('Scan failed: ' + (data.error || ''), 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:14px;height:14px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Scan';
    _scanInProgress = false;
}

function renderDiscovered() {
    const filter = document.getElementById('discoveredSearch').value.toLowerCase();
    const typeFilter = document.getElementById('discoveredFilter').value;

    let filtered = allDiscovered;
    if (typeFilter !== 'all') {
        if (typeFilter === 'reachable') filtered = filtered.filter(d => d.device_type && d.device_type !== 'unreachable');
        else if (typeFilter === 'has_binding') filtered = filtered.filter(d => d.has_binding);
        else if (typeFilter === 'no_binding') filtered = filtered.filter(d => !d.has_binding);
        else if (typeFilter === 'mismatch') filtered = filtered.filter(d => d.mac_status === 'mismatch');
        else filtered = filtered.filter(d => d.device_type === typeFilter);
    }
    if (filter) {
        filtered = filtered.filter(d =>
            (d.hostname || '').toLowerCase().includes(filter) ||
            (d.discovered_mac || '').toLowerCase().includes(filter) ||
            (d.serial || '').toLowerCase().includes(filter) ||
            (d.role || '').toLowerCase().includes(filter) ||
            (d.ip || '').includes(filter)
        );
    }

    // Sort
    filtered.sort((a, b) => {
        let va = a[discSortCol] || '';
        let vb = b[discSortCol] || '';
        if (discSortCol === 'ip') {
            return discSortAsc ? ipToNum(va) - ipToNum(vb) : ipToNum(vb) - ipToNum(va);
        }
        va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return discSortAsc ? cmp : -cmp;
    });

    if (filtered.length === 0) {
        // Show helpful hint when filter hides everything (e.g., all unreachable + reachable filter)
        const totalEntries = allDiscovered.length;
        const unreachCount = allDiscovered.filter(d => d.device_type === 'unreachable').length;
        let hint = 'No entries found.';
        if (totalEntries > 0 && filtered.length === 0 && typeFilter === 'reachable') {
            hint = `No reachable devices found. ${unreachCount} device(s) are unreachable. <a href="#" onclick="setDiscoveredFilter('all');return false;" style="color:#42a5f5;">Show All</a>`;
        }
        document.getElementById('discoveredBody').innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:#666;">${hint}</td></tr>`;
        return;
    }

    document.getElementById('discoveredBody').innerHTML = filtered.map(d => {
        // Device type badge
        const dtBadge = {
            'provisioned': '<span class="badge badge-match">Provisioned</span>',
            'not_provisioned': '<span class="badge badge-warning">No Key</span>',
            'other': '<span class="badge" style="background:rgba(120,144,156,0.15);color:#78909c;">Other</span>',
            'unreachable': '<span class="badge badge-unreachable">Unreachable</span>'
        }[d.device_type] || '-';
        
        // Post-provision badge (separate column)
        let ppBadge = '-';
        if (d.post_provision === 'deployed') ppBadge = '<span class="badge badge-match" style="font-size:10px;">Just Now</span>';
        else if (d.post_provision === 'already') ppBadge = '<span class="badge" style="font-size:10px;background:rgba(100,100,100,0.2);color:#aaa;">Yes</span>';
        else if (d.post_provision === 'failed') ppBadge = '<span class="badge badge-error" style="font-size:10px;">Failed</span>';
        else if (d.device_type === 'provisioned') ppBadge = '<span class="badge" style="font-size:10px;background:rgba(255,152,0,0.15);color:#ff9800;">Pending</span>';
        else if (d.device_type === 'not_provisioned') ppBadge = 'No SSH';
        else if (d.device_type === 'unreachable') ppBadge = '-';
        
        // MAC status badge
        let macBadge = '-';
        if (d.mac_status === 'match') macBadge = '<span class="badge badge-match" style="font-size:10px;">Match</span>';
        else if (d.mac_status === 'mismatch') macBadge = '<span class="badge badge-mismatch" style="font-size:10px;">Mismatch</span>';
        else if (d.mac_status === 'no_binding') macBadge = '<span class="badge badge-info" style="font-size:10px;">Not in Inventory</span>';
        else if (d.mac_status === 'unreachable' && d.has_binding) macBadge = '<span class="badge badge-unreachable" style="font-size:10px;">Unreachable</span>';

        // Discovered MAC color
        const dmac = d.discovered_mac || '-';
        const dmacHtml = d.mac_status === 'mismatch' ? `<span style="color:#ff6b6b;">${escHtml(dmac)}</span>` : escHtml(dmac);

        // Role badge
        const roleHtml = d.role ? `<span style="padding:2px 8px;border-radius:3px;font-size:11px;background:#2d2d2d;color:#aaa;">${escHtml(d.role)}</span>` : '-';

        // Deploy Config button: show only for provisioned devices with a generated config
        const gcSet = new Set((generatedConfigs || []).map(c => c.hostname));
        const canDeploy = d.device_type === 'provisioned' && d.hostname && gcSet.has(d.hostname);
        const deployHtml = canDeploy
            ? `<button class="btn btn-primary btn-sm" onclick="deployGeneratedConfig('${escAttr(d.hostname)}','${escAttr(d.ip)}')" style="font-size:11px;padding:2px 8px;">Deploy</button>`
            : '';

        return `<tr>
            <td><strong>${escHtml(d.hostname || '-')}</strong></td>
            <td style="font-family:monospace;font-size:12px;">${dmacHtml}</td>
            <td style="font-family:monospace;font-size:12px;">${escHtml(d.ip || '-')}</td>
            <td style="font-family:monospace;font-size:11px;color:#aaa;">${escHtml(d.serial || '-')}</td>
            <td>${roleHtml}</td>
            <td>${dtBadge}</td>
            <td>${ppBadge}</td>
            <td>${macBadge}</td>
            <td class="row-actions">${deployHtml}</td>
        </tr>`;
    }).join('');
}

let discSortCol = 'ip';
let discSortAsc = true;

function sortDiscovered(col) {
    if (discSortCol === col) {
        discSortAsc = !discSortAsc;
    } else {
        discSortCol = col;
        discSortAsc = true;
    }
    document.querySelectorAll('[id^="sort-"]').forEach(el => { el.style.opacity = '0.4'; el.innerHTML = '&#9650;'; });
    const indicator = document.getElementById('sort-' + col);
    if (indicator) { indicator.style.opacity = '1'; indicator.innerHTML = discSortAsc ? '&#9650;' : '&#9660;'; }
    renderDiscovered();
}

function downloadDiscoveredCSV() {
    if (allDiscovered.length === 0) {
        showToast('No discovered data. Run a Scan first.', 'error');
        return;
    }
    // Apply current filter (same as table view)
    const searchFilter = document.getElementById('discoveredSearch').value.toLowerCase();
    const typeFilter = document.getElementById('discoveredFilter').value;

    let filtered = allDiscovered;
    if (typeFilter !== 'all') {
        if (typeFilter === 'reachable') filtered = filtered.filter(d => d.device_type && d.device_type !== 'unreachable');
        else if (typeFilter === 'has_binding') filtered = filtered.filter(d => d.has_binding);
        else if (typeFilter === 'no_binding') filtered = filtered.filter(d => !d.has_binding);
        else if (typeFilter === 'mismatch') filtered = filtered.filter(d => d.mac_status === 'mismatch');
        else filtered = filtered.filter(d => d.device_type === typeFilter);
    }
    if (searchFilter) {
        filtered = filtered.filter(d =>
            (d.hostname || '').toLowerCase().includes(searchFilter) ||
            (d.discovered_mac || '').toLowerCase().includes(searchFilter) ||
            (d.serial || '').toLowerCase().includes(searchFilter) ||
            (d.role || '').toLowerCase().includes(searchFilter) ||
            (d.ip || '').includes(searchFilter)
        );
    }

    if (filtered.length === 0) {
        showToast('No devices match current filter', 'error');
        return;
    }

    // Same column order as Bulk Import: Hostname, MAC, IP, Serial, Role
    const lines = filtered
        .sort((a, b) => ipToNum(a.ip) - ipToNum(b.ip))
        .map(d => [
            d.hostname || '-',
            d.discovered_mac || '-',
            d.ip || '-',
            d.serial || '-',
            d.role || '-'
        ].join(','));
    const header = 'Hostname,MAC,IP,Serial,Role';
    const content = header + '\n' + lines.join('\n') + '\n';
    const blob = new Blob([content], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'discovered-devices.csv';
    a.click();
    URL.revokeObjectURL(url);
    showToast(`Downloaded ${filtered.length} devices (filter: ${typeFilter})`, 'success');
}

function ipToNum(ip) {
    if (!ip) return 0;
    const parts = ip.split('.');
    // Use multiplication instead of bit shift to avoid signed 32-bit overflow for octets >= 128
    return (+parts[0]) * 16777216 + (+parts[1]) * 65536 + (+parts[2]) * 256 + (+parts[3]);
}

function filterDiscovered() { renderDiscovered(); }

async function deployGeneratedConfig(hostname, ip) {
    showConfirmModal('Deploy Generated Config',
        `Deploy NVUE config to <strong>${escHtml(hostname)}</strong> (${escHtml(ip)})?<br><br>` +
        `This will run:<br>` +
        `<code style="font-size:11px;color:#76b900;">nv config replace + apply + save</code><br><br>` +
        `<span style="color:#ff9800;">The switch configuration will be fully replaced.</span>`,
        async () => {
            showToast(`Deploying config to ${hostname}...`, 'info');
            const data = await apiCall('deploy-generated-config', { hostname, ip });
            if (data.success && data.results) {
                const r = data.results[0];
                if (r && r.success) {
                    showToast(`Config deployed to ${hostname}`, 'success');
                } else {
                    showToast(`Deploy failed: ${r ? r.error : 'Unknown'}`, 'error');
                }
            } else {
                showToast(`Deploy failed: ${data.error || 'Unknown error'}`, 'error');
            }
        }
    );
}

// ===================== TAB 3: ZTP SCRIPT =====================
let ztpLoaded = false;
let scriptEditorVisible = false;
let serialMappings = [];
let generatedConfigs = [];

// ---- Serial Mapping ----

async function loadSerialMapping() {
    const data = await apiCall('get-serial-mapping');
    if (data.success) {
        serialMappings = data.mappings || [];
        renderSerialMapping();
        renderGeneratedConfigsBadges();
    }
}

function renderSerialMapping() {
    const tbody = document.getElementById('serialMappingBody');
    if (serialMappings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color:#888; text-align:center;">No mappings yet. Click "+ Add Mapping" to start.</td></tr>';
        return;
    }
    const configSet = new Set(generatedConfigs.map(c => c.hostname));
    tbody.innerHTML = serialMappings.map((m, i) => {
        const hasConfig = configSet.has(m.hostname);
        return `<tr>
            <td><input type="text" class="form-input" value="${escHtml(m.serial)}" onchange="serialMappings[${i}].serial=this.value;document.getElementById('serialMappingStatus').textContent='Unsaved changes — click Save';document.getElementById('serialMappingStatus').style.color='#ff8c00';" style="width:100%;font-family:'Cascadia Code','Consolas',monospace;font-size:12px;" placeholder="Serial number"></td>
            <td><input type="text" class="form-input" value="${escHtml(m.hostname)}" onchange="serialMappings[${i}].hostname=this.value;document.getElementById('serialMappingStatus').textContent='Unsaved changes — click Save';document.getElementById('serialMappingStatus').style.color='#ff8c00';" style="width:100%;font-size:12px;" placeholder="Hostname"></td>
            <td style="text-align:center;">${hasConfig ? '<span style="color:#76b900;" title="Config available">&#10004;</span>' : '<span style="color:#666;" title="No config file">&#8212;</span>'}</td>
            <td style="text-align:center;"><button class="btn btn-sm" onclick="serialMappings.splice(${i},1);renderSerialMapping();document.getElementById('serialMappingStatus').textContent='Unsaved changes — click Save';document.getElementById('serialMappingStatus').style.color='#ff8c00';" style="color:#ff4444;background:none;border:none;cursor:pointer;font-size:16px;" title="Remove">&times;</button></td>
        </tr>`;
    }).join('');
}

function addSerialMappingRow() {
    serialMappings.push({ serial: '', hostname: '' });
    renderSerialMapping();
    const tbody = document.getElementById('serialMappingBody');
    const inputs = tbody.querySelectorAll('input');
    if (inputs.length >= 2) inputs[inputs.length - 2].focus();
}

async function saveSerialMapping() {
    const valid = serialMappings.filter(m => m.serial.trim() && m.hostname.trim());
    const data = await apiCall('save-serial-mapping', { mappings: valid });
    if (data.success) {
        showToast(data.message, 'success');
        serialMappings = valid;
        renderSerialMapping();
        document.getElementById('serialMappingStatus').textContent = '';
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

function toggleBulkSerialMapping() {
    const area = document.getElementById('bulkSerialArea');
    area.style.display = area.style.display === 'none' ? '' : 'none';
    if (area.style.display !== 'none') document.getElementById('bulkSerialText').focus();
}

function importBulkSerialMapping() {
    const text = document.getElementById('bulkSerialText').value.trim();
    if (!text) { showToast('Nothing to import', 'error'); return; }

    const existing = new Set(serialMappings.map(m => m.serial.toUpperCase()));
    let added = 0, skipped = 0;

    text.split('\n').forEach(line => {
        line = line.trim();
        if (!line || line.startsWith('#')) return;
        // Split by whitespace (space or tab)
        const parts = line.split(/\s+/);
        if (parts.length >= 2) {
            const serial = parts[0].trim();
            const hostname = parts[1].trim();
            if (serial && hostname && !existing.has(serial.toUpperCase())) {
                serialMappings.push({ serial, hostname });
                existing.add(serial.toUpperCase());
                added++;
            } else {
                skipped++;
            }
        }
    });

    renderSerialMapping();
    document.getElementById('bulkSerialText').value = '';
    toggleBulkSerialMapping();

    if (added > 0) {
        document.getElementById('serialMappingStatus').textContent = 'Unsaved changes — click Save';
        document.getElementById('serialMappingStatus').style.color = '#ff8c00';
        showToast(`Imported ${added} mapping(s)${skipped ? `, ${skipped} skipped (duplicate)` : ''}`, 'success');
    } else {
        showToast('No new mappings to import (all duplicates or empty)', 'info');
    }
}

async function autoFillFromInventory() {
    // Load bindings if not already loaded
    if (allBindings.length === 0) {
        const data = await apiCall('list-bindings');
        if (data.success) allBindings = data.bindings || [];
    }
    const existing = new Set(serialMappings.map(m => m.serial.toUpperCase()));
    let added = 0;
    allBindings.forEach(b => {
        if (b.serial && b.hostname && !existing.has(b.serial.toUpperCase())) {
            serialMappings.push({ serial: b.serial, hostname: b.hostname });
            existing.add(b.serial.toUpperCase());
            added++;
        }
    });
    renderSerialMapping();
    if (added > 0) {
        showToast(`Added ${added} mapping(s) from Inventory`, 'success');
        document.getElementById('serialMappingStatus').textContent = 'Unsaved changes — click Save';
        document.getElementById('serialMappingStatus').style.color = '#ff8c00';
    } else {
        showToast('No new serial+hostname pairs found in Inventory', 'info');
    }
}

// ---- Generated Configs ----

async function loadGeneratedConfigs() {
    const data = await apiCall('list-generated-configs');
    if (data.success) {
        generatedConfigs = data.configs || [];
        renderGeneratedConfigsBadges();
        renderSerialMapping();
    } else {
        document.getElementById('generatedConfigsList').innerHTML = `<span style="color:#ff4444;">${data.error || 'Failed to load'}</span>`;
    }
}

function renderGeneratedConfigsBadges() {
    const container = document.getElementById('generatedConfigsList');
    if (!container) return;
    if (generatedConfigs.length === 0) {
        container.innerHTML = '<span style="color:#888;">No configs found in generated_config_folder/. Use "Sync from Ansible" or copy YAML files manually.</span>';
        document.getElementById('generatedConfigsStatus').textContent = '';
        return;
    }
    const mappedSet = new Set(serialMappings.map(m => m.hostname));
    container.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:6px;">` +
        generatedConfigs.map(c => {
            const mapped = mappedSet.has(c.hostname);
            const size = c.size > 1024 ? (c.size / 1024).toFixed(0) + 'K' : c.size + 'B';
            const date = new Date(c.mtime * 1000).toLocaleDateString();
            const style = mapped
                ? 'background:#1a2e00;border:1px solid #76b900;color:#76b900;'
                : 'background:#252526;border:1px solid #404040;color:#999;';
            return `<span style="${style}padding:3px 8px;border-radius:4px;font-size:11px;cursor:default;" title="${c.filename} (${size}, ${date})${mapped ? ' — serial mapped' : ' — no serial mapping'}">${c.hostname} ${mapped ? '&#10004;' : ''}</span>`;
        }).join('') +
        `</div>`;
    document.getElementById('generatedConfigsStatus').textContent =
        `${generatedConfigs.length} config(s) — ${generatedConfigs.filter(c => mappedSet.has(c.hostname)).length} with serial mapping`;
}

async function uploadGeneratedConfigs(input) {
    const files = input.files;
    if (!files || files.length === 0) return;

    const yamlFiles = Array.from(files).filter(f => f.name.endsWith('.yaml') || f.name.endsWith('.yml'));
    if (yamlFiles.length === 0) { showToast('No YAML files selected', 'error'); return; }

    showToast(`Uploading ${yamlFiles.length} config(s)...`, 'info');
    let ok = 0, fail = 0;

    for (const file of yamlFiles) {
        try {
            const content = await file.text();
            const resp = await fetch('/provision-api.sh?action=upload-generated-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, content })
            });
            const data = await resp.json();
            if (data.success) ok++;
            else fail++;
        } catch (e) {
            fail++;
        }
    }

    input.value = '';
    loadGeneratedConfigs().then(() => renderSerialMapping());
    showToast(`Uploaded ${ok} config(s)${fail ? `, ${fail} failed` : ''}`, ok > 0 ? 'success' : 'error');
}

async function syncGeneratedConfigs() {
    showToast('Syncing configs from Ansible...', 'info');
    const data = await apiCall('sync-generated-configs');
    if (data.success) {
        showToast(data.message, 'success');
        loadGeneratedConfigs();
    } else {
        showToast('Sync failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

async function loadZTPScript() {
    const editor = document.getElementById('ztpEditor');
    editor.value = '# Loading...';

    // Single API call loads everything for ZTP tab
    const data = await apiCall('load-ztp-tab');
    if (!data.success) {
        editor.value = '# Error loading ZTP data';
        return;
    }

    // ZTP script
    if (data.ztp_script && data.ztp_script.success) {
        editor.value = data.ztp_script.content || '';
        ztpLoaded = true;
        parseQuickSettings(data.ztp_script.content);
    }

    // SSH key
    if (data.ssh_key) {
        const keyInput = document.getElementById('ztpSSHKey');
        const status = document.getElementById('sshKeyStatus');
        if (data.ssh_key.success && data.ssh_key.public_key) {
            keyInput.value = data.ssh_key.public_key;
            status.innerHTML = `<span style="color:#76b900;">Key found:</span> ${data.ssh_key.key_type || 'ssh'} (${data.ssh_key.key_file || ''})`;
        } else {
            keyInput.value = '';
            status.innerHTML = '<span style="color:#ff9800;">No SSH key found.</span> Click Generate to create one.';
        }
    }

    // OS images
    if (data.os_images && data.os_images.success) {
        const images = data.os_images.images || [];
        const container = document.getElementById('imageList');
        if (images.length > 0) {
            container.innerHTML = images.map(img => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:#252526; border-radius:4px; margin-bottom:4px;">
                    <span style="font-family:'Cascadia Code','Consolas',monospace; font-size:12px;">&#128196; ${escHtml(img.name)}</span>
                    <span style="color:#888; font-size:11px; display:flex; align-items:center; gap:10px;">
                        ${(img.size / 1048576).toFixed(0)} MB
                        <button class="btn btn-danger btn-sm" onclick="deleteOSImage('${escAttr(img.name)}')" style="padding:2px 8px;font-size:11px;">Del</button>
                    </span>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<span style="color:#888;">No OS images found in web root. Upload a .bin image for ZTP.</span>';
        }
    }

    // Serial mapping + generated configs (cross-dependent)
    if (data.generated_configs && data.generated_configs.success) {
        generatedConfigs = data.generated_configs.configs || [];
    }
    if (data.serial_mapping && data.serial_mapping.success) {
        serialMappings = data.serial_mapping.mappings || [];
    }
    renderGeneratedConfigsBadges();
    renderSerialMapping();
}

// --- SSH Key ---
async function loadSSHKey() {
    const data = await apiCall('get-ssh-key');
    const keyInput = document.getElementById('ztpSSHKey');
    const status = document.getElementById('sshKeyStatus');
    if (data.success && data.public_key) {
        keyInput.value = data.public_key;
        status.innerHTML = `<span style="color:#4caf50;">Key found:</span> ${data.key_type || 'ssh'} (${data.key_file || ''})`;
    } else {
        keyInput.value = '';
        status.innerHTML = '<span style="color:#ff9800;">No SSH key found.</span> Click "Generate New Key" to create one.';
    }
}

function generateSSHKey() {
    showConfirmModal('Generate SSH Key', 'Generate a new SSH key pair?<br>This will be used for ZTP and device management.', async () => {
        showToast('Generating SSH key...', 'info');
        const data = await apiCall('generate-ssh-key', {});
        if (data.success) {
            document.getElementById('ztpSSHKey').value = data.public_key || '';
            document.getElementById('sshKeyStatus').innerHTML = `<span style="color:#4caf50;">New key generated!</span> ${data.key_type || ''} (${data.key_file || ''})`;
            showToast('SSH key generated. Apply to ZTP script with "Apply to Script".', 'success');
        } else {
            showToast('Key generation failed: ' + (data.error || 'Unknown error'), 'error');
        }
    });
}

function copySSHKey() {
    const key = document.getElementById('ztpSSHKey').value;
    if (!key) { showToast('No key to copy', 'error'); return; }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(key)
            .then(() => showToast('Public key copied!', 'success'))
            .catch(() => fallbackCopy(key));
    } else {
        fallbackCopy(key);
    }
}
function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;left:-9999px;';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); showToast('Public key copied!', 'success'); }
    catch(e) { showToast('Copy failed — select and copy manually', 'error'); }
    document.body.removeChild(ta);
}

function toggleImportKey() {
    const area = document.getElementById('importKeyArea');
    area.style.display = area.style.display === 'none' ? '' : 'none';
    if (area.style.display !== 'none') document.getElementById('importKeyText').focus();
}

async function importSSHKey() {
    const key = document.getElementById('importKeyText').value.trim();
    if (!key || !key.includes('PRIVATE KEY')) {
        document.getElementById('importKeyMsg').innerHTML = '<span style="color:#f44336;">Paste a valid private key</span>';
        return;
    }
    document.getElementById('importKeyMsg').innerHTML = '<span style="color:#888;">Saving...</span>';
    const data = await apiCall('import-ssh-key', { private_key: key });
    if (data.success) {
        document.getElementById('importKeyMsg').innerHTML = '<span style="color:#4caf50;">Key imported!</span>';
        document.getElementById('importKeyText').value = '';
        toggleImportKey();
        loadSSHKey();
        showToast('SSH key imported successfully', 'success');
    } else {
        document.getElementById('importKeyMsg').innerHTML = `<span style="color:#f44336;">${data.error || 'Failed'}</span>`;
    }
}

// --- Password Toggle ---
function togglePasswordVisibility() {
    const pw = document.getElementById('ztpPassword');
    const btn = document.getElementById('pwToggle');
    if (pw.type === 'password') { pw.type = 'text'; btn.style.color = '#ff9800'; }
    else { pw.type = 'password'; btn.style.color = '#888'; }
}

// --- OS Image ---
async function loadOSImages() {
    const container = document.getElementById('imageList');
    const data = await apiCall('list-os-images');
    if (data.success && data.images && data.images.length > 0) {
        container.innerHTML = data.images.map(img => `
            <div style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #2d2d2d;">
                <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:#76b900;flex-shrink:0;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                <span style="flex:1;font-family:monospace;font-size:13px;">${escHtml(img.name)}</span>
                <span style="color:#888;font-size:12px;">${escHtml(img.size)}</span>
                <button class="btn btn-danger btn-sm" onclick="deleteOSImage('${escAttr(img.name)}')" style="padding:2px 8px;font-size:11px;">Del</button>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<span style="color:#888;">No OS images found in web root. Upload a .bin image for ZTP.</span>';
    }
}

async function uploadImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    const progress = document.getElementById('uploadProgress');
    progress.textContent = `Uploading ${file.name} (${(file.size / 1048576).toFixed(0)} MB)...`;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const resp = await fetch('/provision-api.sh?action=upload-os-image', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        if (data.success) {
            showToast(`Image "${file.name}" uploaded successfully`, 'success');
            loadOSImages();
        } else {
            showToast('Upload failed: ' + (data.error || 'Unknown'), 'error');
        }
    } catch (e) {
        showToast('Upload failed: ' + e.message, 'error');
    }
    progress.textContent = '';
    input.value = '';
}

function deleteOSImage(name) {
    showConfirmModal('Delete OS Image', `Delete image <strong>${escHtml(name)}</strong>?`, async () => {
        const data = await apiCall('delete-os-image', { name });
        if (data.success) { showToast('Image deleted', 'success'); loadOSImages(); }
        else { showToast('Delete failed: ' + (data.error || ''), 'error'); }
    });
}

// --- Script Editor Toggle ---
function toggleScriptEditor() {
    const editor = document.getElementById('ztpEditor');
    const toggle = document.getElementById('editorToggle');
    scriptEditorVisible = !scriptEditorVisible;
    editor.style.display = scriptEditorVisible ? '' : 'none';
    toggle.innerHTML = scriptEditorVisible ? '&#9660;' : '&#9654;';
}

// --- Quick Settings ---
function parseQuickSettings(content) {
    const osMatch = content.match(/CUMULUS_TARGET_RELEASE=(\S+)/);
    const pwMatch = content.match(/echo\s+'cumulus:(.+?)'\s*\|\s*chpasswd/);
    const ipMatch = content.match(/IMAGE_SERVER_HOSTNAME=(\S+)/);
    // Don't overwrite SSH key from script — loadSSHKey() handles that from actual key file

    if (osMatch) document.getElementById('ztpTargetOS').value = osMatch[1];
    if (pwMatch) document.getElementById('ztpPassword').value = pwMatch[1];
    if (ipMatch) document.getElementById('ztpImageServer').value = ipMatch[1];
}

function escapeBashSingleQuote(s) {
    // In bash single-quoted strings, single quotes can't be escaped.
    // Use the pattern: end quote, escaped quote, start quote: 'it'\''s' → it's
    return s.replace(/'/g, "'\\''");
}

function applyQuickSettings() {
    let content = document.getElementById('ztpEditor').value;
    const os = document.getElementById('ztpTargetOS').value.trim() || '5.14.0';
    const pwRaw = document.getElementById('ztpPassword').value.trim() || 'CumulusLinux!';
    const pw = escapeBashSingleQuote(pwRaw);
    const ip = document.getElementById('ztpImageServer').value.trim() || '192.168.100.200';
    const key = document.getElementById('ztpSSHKey').value.trim();

    const hasSerialLogic = content.includes('resolve_hostname') || content.includes('serial-mapping');
    const isOldTemplate = content.includes('CUMULUS_TARGET_RELEASE') && !hasSerialLogic;

    // If script is placeholder/empty, generate full template
    if (!content.includes('CUMULUS_TARGET_RELEASE') && !content.includes('init_ztp')) {
        content = generateZTPTemplate(os, pw, ip, key);
    } else if (isOldTemplate) {
        // Old template without serial config resolution — offer upgrade
        showConfirmModal('Upgrade ZTP Script',
            'Current script uses the old template without serial-based config resolution.<br><br>' +
            'Upgrade to the new template with:<br>' +
            '&bull; Serial number detection (<code>decode-syseeprom</code>)<br>' +
            '&bull; Hostname resolution via <code>serial-mapping.txt</code><br>' +
            '&bull; Auto config download via <code>onie-install -t</code><br>' +
            '&bull; Direct config apply via <code>nv config replace</code><br><br>' +
            'Quick Settings (OS version, password, IP, SSH key) will be preserved.',
            () => {
                const newContent = generateZTPTemplate(os, pw, ip, key);
                document.getElementById('ztpEditor').value = newContent;
                if (!scriptEditorVisible) toggleScriptEditor();
                showToast('Script upgraded to serial-based template (unsaved — click Save)', 'success');
            }
        );
        return;
    } else {
        // Update existing script via regex (already has serial logic or custom)
        if (os) content = content.replace(/CUMULUS_TARGET_RELEASE=\S+/, `CUMULUS_TARGET_RELEASE=${os}`);
        if (pw) content = content.replace(/echo\s+'cumulus:.+?'\s*\|\s*chpasswd/, `echo 'cumulus:${pw}' | chpasswd`);
        if (ip) content = content.replace(/IMAGE_SERVER_HOSTNAME=\S+/, `IMAGE_SERVER_HOSTNAME=${ip}`);
        if (key) content = content.replace(/KEY="ssh-\S+\s+\S+"/, `KEY="${key}"`);
    }

    // Show editor to see changes
    if (!scriptEditorVisible) toggleScriptEditor();
    document.getElementById('ztpEditor').value = content;
    showToast('Quick settings applied to script (unsaved — click Save)', 'info');
}

function generateZTPTemplate(os, pw, ip, key) {
    const keyVar = key ? `KEY="${key}"` : 'KEY=""';
    return `#!/bin/bash

#
# CUMULUS-AUTOPROVISIONING
# Generated by LLDPq Provision
#

function ping_until_reachable(){
    last_code=1
    max_tries=30
    tries=0
    while [ "0" != "$last_code" ] && [ "$tries" -lt "$max_tries" ]; do
        tries=$((tries+1))
        echo "$(date) INFO: ( Attempt $tries of $max_tries ) Pinging $1 Target Until Reachable."
        ping $1 -c2 --no-vrf-switch &> /dev/null
        last_code=$?
        sleep 1
    done
    if [ "$tries" -eq "$max_tries" ] && [ "$last_code" -ne "0" ]; then
        echo "$(date) ERROR: Reached maximum number of attempts to ping the target $1 ."
        exit 1
    fi
}

function set_password(){
    passwd -x 99999 cumulus
    echo 'cumulus:${pw}' | chpasswd
}

# Resolve hostname from serial number via mapping file on HTTP server
function resolve_hostname(){
    local serial="$1"
    local mapping_url="http://$IMAGE_SERVER_HOSTNAME/serial-mapping.txt"
    local hostname=""
    local mapping=$(curl -sf "$mapping_url" 2>/dev/null)
    if [ -n "$mapping" ]; then
        hostname=$(echo "$mapping" | grep -v '^#' | grep -i "$serial" | awk '{print $2}' | head -1)
    fi
    echo "$hostname"
}

function init_ztp(){
    echo "Running ZTP..."

    # Change default password
    set_password

    # Make user cumulus passwordless sudo
    echo "cumulus ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/10_cumulus

    # Copy SSH keys
    ${keyVar}
    if [ -n "$KEY" ]; then
        mkdir -p /root/.ssh /home/cumulus/.ssh
        echo "$KEY" >> /root/.ssh/authorized_keys
        echo "$KEY" >> /home/cumulus/.ssh/authorized_keys
        chown -R cumulus:cumulus /home/cumulus/.ssh
        echo "SSH key installed"
    fi

    # Apply generated config if version was already correct
    if [ -n "$CONFIG_URL" ]; then
        echo "Applying generated config for $MY_HOSTNAME..."
        curl -sf "$CONFIG_URL" -o /tmp/startup.yaml
        if [ -s /tmp/startup.yaml ]; then
            nv config replace /tmp/startup.yaml
            nv config apply -y
            nv config save
            echo "Config applied and saved for $MY_HOSTNAME"
        fi
    fi

    exit 0
}

# ---- Main ----

IMAGE_SERVER_HOSTNAME=${ip}
CUMULUS_TARGET_RELEASE=${os}
CUMULUS_CURRENT_RELEASE=$(cat /etc/lsb-release | grep RELEASE | cut -d "=" -f2)
IMAGE_SERVER=http://$IMAGE_SERVER_HOSTNAME/cumulus-linux-$CUMULUS_TARGET_RELEASE-mlx-amd64.bin
ZTP_URL=http://$IMAGE_SERVER_HOSTNAME/cumulus-ztp.sh

# Get this switch's serial number and resolve hostname
MY_SERIAL=$(decode-syseeprom 2>/dev/null | grep "Serial Number" | awk '{print $NF}')
[ -z "$MY_SERIAL" ] && MY_SERIAL=$(onie-syseeprom -g 0x23 2>/dev/null | tr -d ' ')
echo "Serial: $MY_SERIAL"

MY_HOSTNAME=$(resolve_hostname "$MY_SERIAL")
echo "Resolved hostname: $MY_HOSTNAME"

# Check if a generated config exists for this switch
CONFIG_URL=""
if [ -n "$MY_HOSTNAME" ]; then
    URL="http://$IMAGE_SERVER_HOSTNAME/generated_config_folder/\${MY_HOSTNAME}.yaml"
    if curl -sf --head "$URL" 2>/dev/null | head -1 | grep -q "200"; then
        CONFIG_URL="$URL"
        echo "Config available: $CONFIG_URL"
    else
        echo "No generated config found for $MY_HOSTNAME"
    fi
else
    echo "Serial $MY_SERIAL not found in mapping — no config will be applied"
fi

echo "Checking if the device is running the correct version..."
if [ "$CUMULUS_TARGET_RELEASE" != "$CUMULUS_CURRENT_RELEASE" ]; then
    echo "Version mismatch: $CUMULUS_CURRENT_RELEASE -> $CUMULUS_TARGET_RELEASE"
    ping_until_reachable $IMAGE_SERVER_HOSTNAME
    if [ -n "$CONFIG_URL" ]; then
        echo "Installing OS + config for $MY_HOSTNAME..."
        /usr/cumulus/bin/onie-install -fa -i $IMAGE_SERVER -z $ZTP_URL -t $CONFIG_URL && reboot
    else
        echo "Installing OS only (no config)..."
        /usr/cumulus/bin/onie-install -fa -i $IMAGE_SERVER -z $ZTP_URL && reboot
    fi
else
    echo "Version is correct: $CUMULUS_TARGET_RELEASE"
    init_ztp
fi
`;
}

async function saveZTPScript() {
    const content = document.getElementById('ztpEditor').value;
    const data = await apiCall('save-ztp-script', { content });
    if (data.success) {
        showToast('ZTP script saved', 'success');
    } else {
        showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
    }
}

// ===================== TAB 5: BASE CONFIG =====================
let bcDeviceGroups = {};

async function loadDeviceList() {
    const data = await apiCall('list-devices');
    if (data.success) {
        deviceList = data.devices || [];
        bcDeviceGroups = data.groups || {};
        renderBCDeviceList();
        renderBCFileList();
    }
}

function renderBCFileList() {
    document.getElementById('bcFileList').textContent = BASE_CONFIG_FILES.map(f => f.name).join(', ');
}

function renderBCDeviceList() {
    const container = document.getElementById('bcDeviceList');
    const filter = document.getElementById('bcDeviceSearch') ? document.getElementById('bcDeviceSearch').value.toLowerCase() : '';
    const groups = bcDeviceGroups;
    let html = '';
    let totalCount = 0;

    for (const [role, devices] of Object.entries(groups)) {
        const filtered = devices.filter(d =>
            d.hostname.toLowerCase().includes(filter) || d.ip.includes(filter)
        );
        if (filtered.length === 0) continue;
        totalCount += filtered.length;

        const groupId = role.replace(/[^a-zA-Z0-9]/g, '_');
        html += `
            <div style="margin-bottom: 2px;">
                <div style="display:flex; align-items:center; gap:8px; padding:6px 10px; background:#2d2d2d; cursor:pointer; user-select:none;" onclick="bcToggleGroup('${groupId}')">
                    <input type="checkbox" style="accent-color:#76b900; width:14px; height:14px;" id="bcg-${groupId}" onclick="event.stopPropagation(); bcToggleGroupDevices('${groupId}')">
                    <span style="color:#76b900; font-size:12px; font-weight:600; text-transform:uppercase;">${escHtml(role)}</span>
                    <span style="color:#888; font-size:11px; margin-left:auto;">${filtered.length}</span>
                </div>
                <div id="bcd-${groupId}" style="display:none;">
                    ${filtered.map(d => `
                        <label style="display:flex; align-items:center; gap:8px; padding:4px 10px 4px 28px; cursor:pointer; font-size:12px; transition:background 0.1s;" onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background=''">
                            <input type="checkbox" class="bc-dev-cb" data-ip="${d.ip}" data-hostname="${d.hostname}" data-username="${d.username || 'cumulus'}" data-group="${groupId}" style="accent-color:#76b900; width:13px; height:13px;" onchange="bcUpdateCounts()">
                            <span style="flex:1; color:#d4d4d4;">${escHtml(d.hostname)}</span>
                            <span style="color:#666; font-family:monospace; font-size:11px;">${escHtml(d.ip)}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    }

    container.innerHTML = html || '<div style="padding:20px; color:#666; text-align:center;">No devices</div>';
    document.getElementById('bcTotalDevices').textContent = `${totalCount} devices`;
    bcUpdateCounts();
}

function bcToggleGroup(groupId) {
    const div = document.getElementById('bcd-' + groupId);
    div.style.display = div.style.display === 'none' ? '' : 'none';
}

function bcToggleGroupDevices(groupId) {
    const groupCb = document.getElementById('bcg-' + groupId);
    document.querySelectorAll(`.bc-dev-cb[data-group="${groupId}"]`).forEach(cb => cb.checked = groupCb.checked);
    bcUpdateCounts();
}

function bcSelectAll(checked) {
    document.querySelectorAll('.bc-dev-cb').forEach(cb => cb.checked = checked);
    document.querySelectorAll('[id^="bcg-"]').forEach(cb => cb.checked = checked);
    bcUpdateCounts();
}

function bcUpdateCounts() {
    const total = document.querySelectorAll('.bc-dev-cb').length;
    const selected = document.querySelectorAll('.bc-dev-cb:checked').length;
    document.getElementById('bcSelectedCount').textContent = `${selected} selected`;

    // Update group checkboxes
    for (const role of Object.keys(bcDeviceGroups)) {
        const groupId = role.replace(/[^a-zA-Z0-9]/g, '_');
        const groupCbs = document.querySelectorAll(`.bc-dev-cb[data-group="${groupId}"]`);
        const groupChecked = document.querySelectorAll(`.bc-dev-cb[data-group="${groupId}"]:checked`);
        const gcb = document.getElementById('bcg-' + groupId);
        if (gcb) {
            gcb.checked = groupCbs.length > 0 && groupChecked.length === groupCbs.length;
            gcb.indeterminate = groupChecked.length > 0 && groupChecked.length < groupCbs.length;
        }
    }
}

function bcFilterDevices() { renderBCDeviceList(); }

async function deployBaseConfig() {
    const selectedDevices = Array.from(document.querySelectorAll('.bc-dev-cb:checked')).map(cb => ({
        ip: cb.dataset.ip,
        hostname: cb.dataset.hostname,
        username: cb.dataset.username
    }));

    if (selectedDevices.length === 0) {
        showToast('Select at least one device', 'error');
        return;
    }

    const disableZTP = document.getElementById('disableZTPAfter').checked;
    const btn = document.getElementById('btnDeploy');
    btn.disabled = true;

    // Show progress table
    const progress = document.getElementById('deployProgress');
    progress.innerHTML = `
        <div class="table-wrapper">
            <table class="data-table">
                <thead><tr><th>Hostname</th><th>IP</th><th>Status</th><th>Details</th></tr></thead>
                <tbody id="deployBody">
                    ${selectedDevices.map(d => `
                        <tr id="deploy-${d.ip.replace(/\./g, '-')}">
                            <td><strong>${escHtml(d.hostname)}</strong></td>
                            <td style="font-family:monospace;font-size:12px;">${escHtml(d.ip)}</td>
                            <td><div class="spinner"></div></td>
                            <td style="color:#888;">Deploying...</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;

    document.getElementById('deployStatusText').textContent = `Deploying to ${selectedDevices.length} devices...`;

    // No files param = deploy all available sw-base files
    const data = await apiCall('deploy-base-config', {
        devices: selectedDevices,
        disable_ztp: disableZTP
    });

    if (data.success && data.results) {
        let okCount = 0, failCount = 0;
        data.results.forEach(r => {
            const row = document.getElementById(`deploy-${r.ip.replace(/\./g, '-')}`);
            if (row) {
                if (r.success) {
                    okCount++;
                    row.innerHTML = `<td><strong>${escHtml(r.hostname)}</strong></td><td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td><td><span class="badge badge-success">OK</span></td><td style="color:#4caf50;">${escHtml(r.message || 'OK')}</td>`;
                } else {
                    failCount++;
                    row.innerHTML = `<td><strong>${escHtml(r.hostname)}</strong></td><td style="font-family:monospace;font-size:12px;">${escHtml(r.ip)}</td><td><span class="badge badge-error">FAIL</span></td><td style="color:#f44336;">${escHtml(r.error || 'Failed')}</td>`;
                }
            }
        });
        document.getElementById('deployStatusText').textContent = `Done: ${okCount} OK, ${failCount} failed`;
        showToast(`Deploy: ${okCount} OK, ${failCount} failed`, failCount > 0 ? 'error' : 'success');
    } else {
        showToast('Deploy failed: ' + (data.error || ''), 'error');
        document.getElementById('deployStatusText').textContent = 'Failed';
    }
    btn.disabled = false;
}

// ===================== UTILS =====================
function escHtml(s) { 
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}
function escAttr(s) {
    if (!s) return '';
    return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/`/g, '\\`').replace(/\n/g, '').replace(/\r/g, '');
}

// ===================== CUSTOM CONFIRM MODAL =====================
let _confirmCallback = null;
function showConfirmModal(title, message, callback, btnText, cancelText) {
    document.getElementById('confirm-modal-title').textContent = title;
    document.getElementById('confirm-modal-message').innerHTML = message;
    // Set action button text
    const btn = document.querySelector('.btn-confirm-action');
    if (btnText) btn.textContent = btnText;
    else if (title.toLowerCase().includes('delete')) btn.textContent = 'Delete';
    else if (title.toLowerCase().includes('stop')) btn.textContent = 'Stop';
    else if (title.toLowerCase().includes('generate')) btn.textContent = 'Generate';
    else btn.textContent = 'Confirm';
    // Set cancel button text (default: Cancel)
    document.querySelector('.confirm-modal-footer .btn-cancel').textContent = cancelText || 'Cancel';
    _confirmCallback = callback;
    document.getElementById('confirm-modal').classList.add('visible');
}
function closeConfirmModal() {
    document.getElementById('confirm-modal').classList.remove('visible');
    _confirmCallback = null;
    // Reset cancel button text to default
    document.querySelector('.confirm-modal-footer .btn-cancel').textContent = 'Cancel';
}
function executeConfirmModal() {
    if (_confirmCallback) _confirmCallback();
    closeConfirmModal();
}
</script>

<!-- Confirm Modal -->
<div id="confirm-modal" class="confirm-modal" onclick="if(event.target===this)closeConfirmModal()">
    <div class="confirm-modal-content">
        <div class="confirm-modal-header">
            <h3 id="confirm-modal-title">Confirm</h3>
            <button class="confirm-modal-close" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="confirm-modal-body">
            <p id="confirm-modal-message"></p>
        </div>
        <div class="confirm-modal-footer">
            <button type="button" class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" class="btn-confirm-action" onclick="executeConfirmModal()">Confirm</button>
        </div>
    </div>
</div>

<style>
    .confirm-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center; }
    .confirm-modal.visible { display:flex; }
    .confirm-modal-content { background:#2d2d2d; border-radius:8px; width:420px; max-width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.5); overflow:hidden; }
    .confirm-modal-header { background:linear-gradient(135deg,#c53030 0%,#9b2c2c 100%); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    .confirm-modal-header h3 { margin:0; color:#fff; font-size:16px; }
    .confirm-modal-close { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; opacity:0.8; }
    .confirm-modal-close:hover { opacity:1; }
    .confirm-modal-body { padding:25px 20px; }
    .confirm-modal-body p { color:#ccc; line-height:1.6; margin:0; text-align:center; }
    .confirm-modal-footer { padding:15px 20px; display:flex; justify-content:flex-end; gap:10px; background:#252526; border-top:1px solid #3c3c3c; }
    .confirm-modal-footer .btn-cancel { background:#3c3c3c; color:#d4d4d4; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; }
    .confirm-modal-footer .btn-cancel:hover { background:#4a4a4a; }
    .confirm-modal-footer .btn-confirm-action { background:#c53030; color:#fff; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; }
    .confirm-modal-footer .btn-confirm-action:hover { background:#e53e3e; }
</style>
</body>
</html>
