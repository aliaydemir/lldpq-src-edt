<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <title>..::LLDPQ::..</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="css/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-title svg {
            width: 28px;
            height: 28px;
            fill: #76b900;
        }
        
        .last-updated {
            font-size: 13px;
            color: #888;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Summary Cards */
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .summary-card { 
            background: #252526; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 3px solid #76b900;
        }
        
        .card-total { border-left-color: #76b900; }
        .card-info { border-left-color: #4fc3f7; }
        .card-warning { border-left-color: #ff9800; }
        .card-success { border-left-color: #4caf50; }
        
        .card-value { 
            font-size: 28px; 
            font-weight: bold; 
        }
        
        .card-total .card-value { color: #76b900; }
        .card-info .card-value { color: #4fc3f7; }
        .card-warning .card-value { color: #ffb74d; }
        .card-success .card-value { color: #81c784; }
        
        .card-label { 
            font-size: 12px; 
            color: #888; 
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(0deg, #76b900 0%, #8bc34a 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(0deg, #8bc34a 0%, #9ccc65 100%);
        }
        
        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #555;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #4a4a4a;
            border-color: #76b900;
        }
        
        .btn-warning {
            background: linear-gradient(0deg, #e65100 0%, #ff9800 100%);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(0deg, #ff9800 0%, #ffb74d 100%);
        }
        
        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        /* Device Selection Panel */
        .device-panel {
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #2d2d2d;
            padding: 12px 15px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #76b900;
        }
        
        .select-actions {
            display: flex;
            gap: 8px;
        }
        
        .select-actions a {
            color: #4fc3f7;
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .select-actions a:hover {
            text-decoration: underline;
        }
        
        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .device-group {
            margin-bottom: 15px;
        }
        
        .group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #1e1e1e;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .group-header:hover {
            background: #2a2a2a;
        }
        
        .group-header input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #76b900;
        }
        
        .group-name {
            color: #76b900;
            font-size: 13px;
            font-weight: 600;
        }
        
        .group-count {
            color: #888;
            font-size: 11px;
            margin-left: auto;
        }
        
        .device-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 30px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s;
        }
        
        .device-item:hover {
            background: #2a2a2a;
        }
        
        .device-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #76b900;
        }
        
        .device-name {
            font-size: 13px;
            color: #d4d4d4;
        }
        
        .device-ip {
            font-size: 11px;
            color: #888;
            margin-left: auto;
        }
        
        /* Deploy Actions Panel */
        .deploy-panel {
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .deploy-actions {
            padding: 15px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .selected-count {
            margin-left: auto;
            font-size: 13px;
            color: #888;
        }
        
        .selected-count strong {
            color: #76b900;
        }
        
        /* Output Area */
        .output-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #1a1a1a;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .output-area .success { color: #4caf50; }
        .output-area .error { color: #f44336; }
        .output-area .warning { color: #ff9800; }
        .output-area .info { color: #4fc3f7; }
        .output-area .changed { color: #ffb74d; }
        
        .output-placeholder {
            color: #666;
            text-align: center;
            padding: 40px;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .output-placeholder svg {
            width: 48px;
            height: 48px;
            fill: #444;
            margin-bottom: 15px;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }
        
        .loading-overlay.visible {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 15px;
            color: #888;
            font-size: 14px;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-synced {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }
        
        .status-pending {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }
        
        /* Modified Badge */
        .modified-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            background: rgba(255, 152, 0, 0.25);
            color: #ffb74d;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .device-item.modified {
            background: rgba(255, 152, 0, 0.08);
            border-left: 2px solid #ff9800;
            padding-left: 28px;
        }
        
        .device-item.modified:hover {
            background: rgba(255, 152, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="page-title">
            <svg viewBox="0 0 24 24">
                <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>
            Fabric Deploy
        </div>
        <div class="action-buttons">
            <span class="last-updated" id="last-updated"></span>
            <button class="btn btn-secondary" onclick="loadDevices()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-devices">-</div>
            <div class="card-label">Total Devices</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="selected-devices">0</div>
            <div class="card-label">Selected</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="pending-changes">-</div>
            <div class="card-label">Pending Changes</div>
        </div>
        <div class="summary-card card-success">
            <div class="card-value" id="synced-devices">-</div>
            <div class="card-label">Synchronized</div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Device Selection Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <span class="panel-title">Select Devices</span>
                <div class="select-actions">
                    <a onclick="selectAll(true)">All</a>
                    <a onclick="selectAll(false)">None</a>
                    <a onclick="selectModified()" style="color: #ffb74d;">Modified</a>
                </div>
            </div>
            <div class="device-list" id="device-list">
                <div class="output-placeholder">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1"/>
                    </svg>
                    <div>Loading devices...</div>
                </div>
            </div>
        </div>
        
        <!-- Deploy Actions Panel -->
        <div class="deploy-panel">
            <div class="deploy-actions">
                <button class="btn btn-primary" onclick="runGenerate()" id="btn-generate">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Generate
                </button>
                <button class="btn btn-secondary" onclick="runDiff()" id="btn-diff">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    Diff
                </button>
                <button class="btn btn-warning" onclick="runDeploy()" id="btn-deploy">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    Deploy
                </button>
                <span class="selected-count">
                    <strong id="action-selected-count">0</strong> devices selected
                </span>
            </div>
            <div class="output-area" id="output-area">
                <div class="output-placeholder">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <div style="margin-top: 10px;">Select devices and run Generate, Diff, or Deploy</div>
                    <div style="color: #555; font-size: 11px; margin-top: 8px;">
                        Generate: Create configs from Ansible templates<br>
                        Diff: Compare generated vs running config<br>
                        Deploy: Apply configuration to devices
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-text" class="loading-text">Loading...</div>
    </div>
    
    <script>
        let devices = {};
        let totalDeviceCount = 0;
        let modifiedDevices = new Set();
        
        // Load devices on page load
        document.addEventListener('DOMContentLoaded', loadDevices);
        
        async function loadDevices() {
            try {
                // Fetch devices and modified status in parallel
                const [devicesResp, modifiedResp] = await Promise.all([
                    fetch('/fabric-api.sh?action=list-devices'),
                    fetch('/ansible-api?action=get-modified-devices')
                ]);
                
                const devicesData = await devicesResp.json();
                const modifiedData = await modifiedResp.json();
                
                if (devicesData.success && devicesData.devices) {
                    devices = devicesData.devices;
                }
                
                // Update modified devices set
                modifiedDevices = new Set();
                if (modifiedData.success && modifiedData.modified_devices) {
                    modifiedData.modified_devices.forEach(d => modifiedDevices.add(d));
                }
                
                renderDeviceList();
                updateLastUpdated();
                updateSummaryCards();
            } catch (e) {
                document.getElementById('device-list').innerHTML = 
                    `<div class="output-placeholder" style="color: #f44336;">Error loading devices: ${e.message}</div>`;
            }
        }
        
        function updateSummaryCards() {
            const pendingCount = modifiedDevices.size;
            const syncedCount = totalDeviceCount - pendingCount;
            
            document.getElementById('pending-changes').textContent = pendingCount;
            document.getElementById('synced-devices').textContent = syncedCount;
        }
        
        function renderDeviceList() {
            const container = document.getElementById('device-list');
            let html = '';
            
            // Count unique devices (same device may be in multiple groups)
            const uniqueDevices = new Set();
            for (const [group, groupDevices] of Object.entries(devices)) {
                for (const device of groupDevices) {
                    uniqueDevices.add(device.hostname || device);
                }
            }
            totalDeviceCount = uniqueDevices.size;
            
            for (const [group, groupDevices] of Object.entries(devices)) {
                const groupId = group.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Count modified in this group
                const modifiedInGroup = groupDevices.filter(d => modifiedDevices.has(d.hostname || d)).length;
                const modifiedBadge = modifiedInGroup > 0 ? `<span class="modified-badge">${modifiedInGroup} modified</span>` : '';
                
                html += `
                    <div class="device-group">
                        <div class="group-header" onclick="toggleGroup('${groupId}')">
                            <input type="checkbox" id="group-${groupId}" onclick="event.stopPropagation(); toggleGroupDevices('${groupId}')" onchange="updateCounts()">
                            <span class="group-name">${group}</span>
                            ${modifiedBadge}
                            <span class="group-count">${groupDevices.length}</span>
                        </div>
                        <div id="devices-${groupId}">
                `;
                
                for (const device of groupDevices) {
                    const hostname = device.hostname || device;
                    const ip = device.ansible_host || device.ip || '';
                    const isModified = modifiedDevices.has(hostname);
                    const modifiedClass = isModified ? ' modified' : '';
                    const badge = isModified ? '<span class="modified-badge">modified</span>' : '';
                    
                    html += `
                        <label class="device-item${modifiedClass}">
                            <input type="checkbox" name="device" value="${hostname}" data-group="${groupId}" onchange="syncDeviceCheckboxes('${hostname}', this.checked); updateCounts()">
                            <span class="device-name">${hostname}${badge}</span>
                            <span class="device-ip">${ip}</span>
                        </label>
                    `;
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            document.getElementById('total-devices').textContent = totalDeviceCount;
            updateCounts();
        }
        
        function selectModified() {
            // First uncheck all
            document.querySelectorAll('input[name="device"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[id^="group-"]').forEach(cb => cb.checked = false);
            
            // Then check only modified devices
            modifiedDevices.forEach(hostname => {
                const cb = document.querySelector(`input[name="device"][value="${hostname}"]`);
                if (cb) {
                    cb.checked = true;
                    // Update group checkbox
                    const groupId = cb.dataset.group;
                    if (groupId) updateGroupCheckbox(groupId);
                }
            });
            
            updateCounts();
        }
        
        function toggleGroup(groupId) {
            const devicesDiv = document.getElementById('devices-' + groupId);
            devicesDiv.style.display = devicesDiv.style.display === 'none' ? 'block' : 'block';
        }
        
        function toggleGroupDevices(groupId) {
            const groupCb = document.getElementById('group-' + groupId);
            const deviceCbs = document.querySelectorAll(`input[name="device"][data-group="${groupId}"]`);
            deviceCbs.forEach(cb => cb.checked = groupCb.checked);
            updateCounts();
        }
        
        function updateGroupCheckbox(groupId) {
            const deviceCbs = document.querySelectorAll(`input[name="device"][data-group="${groupId}"]`);
            const allChecked = Array.from(deviceCbs).every(cb => cb.checked);
            const groupCb = document.getElementById('group-' + groupId);
            if (groupCb) groupCb.checked = allChecked;
        }
        
        function selectAll(select) {
            document.querySelectorAll('input[name="device"]').forEach(cb => cb.checked = select);
            document.querySelectorAll('input[id^="group-"]').forEach(cb => cb.checked = select);
            updateCounts();
        }
        
        function updateCounts() {
            // Count unique selected devices (same device may appear in multiple groups)
            const selectedSet = new Set();
            document.querySelectorAll('input[name="device"]:checked').forEach(cb => {
                selectedSet.add(cb.value);
            });
            const selected = selectedSet.size;
            document.getElementById('selected-devices').textContent = selected;
            document.getElementById('action-selected-count').textContent = selected;
        }
        
        // Sync checkboxes for same device across groups
        function syncDeviceCheckboxes(hostname, checked) {
            document.querySelectorAll(`input[name="device"][value="${hostname}"]`).forEach(cb => {
                cb.checked = checked;
                const groupId = cb.dataset.group;
                if (groupId) updateGroupCheckbox(groupId);
            });
        }
        
        function getSelectedDevices() {
            // Return unique device names (same device may appear in multiple groups)
            const deviceSet = new Set();
            document.querySelectorAll('input[name="device"]:checked').forEach(cb => {
                deviceSet.add(cb.value);
            });
            return Array.from(deviceSet);
        }
        
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            overlay.classList.toggle('visible', show);
        }
        
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                'Last updated: ' + now.toLocaleTimeString();
        }
        
        function appendOutput(text, type = '') {
            const output = document.getElementById('output-area');
            // Clear placeholder if exists
            if (output.querySelector('.output-placeholder')) {
                output.innerHTML = '';
            }
            
            const span = document.createElement('span');
            if (type) span.className = type;
            span.textContent = text + '\n';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('output-area').innerHTML = '';
        }
        
        function formatOutput(text) {
            // Add color classes based on content
            return text
                .replace(/ok=/g, '<span class="success">ok=</span>')
                .replace(/changed=/g, '<span class="changed">changed=</span>')
                .replace(/failed=/g, '<span class="error">failed=</span>')
                .replace(/PLAY \[/g, '<span class="info">PLAY [</span>')
                .replace(/TASK \[/g, '<span class="info">TASK [</span>')
                .replace(/\+\+\+/g, '<span class="success">+++</span>')
                .replace(/---/g, '<span class="error">---</span>');
        }
        
        async function ansibleApiCall(action, hosts) {
            const params = new URLSearchParams({ action });
            if (hosts) params.append('host', hosts);
            const response = await fetch(`/ansible-api?${params}`);
            return await response.json();
        }
        
        async function runGenerate() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                alert('Please select at least one device');
                return;
            }
            
            const hosts = selected.join(',');
            showLoading(true, `Generating configs for ${selected.length} device(s)...`);
            clearOutput();
            appendOutput(`=== GENERATE: ${selected.length} device(s) ===`, 'info');
            appendOutput(`Devices: ${hosts}\n`);
            
            try {
                const result = await ansibleApiCall('generate', hosts);
                
                if (result.success) {
                    appendOutput('Generation completed successfully!', 'success');
                    appendOutput('\n' + (result.output || ''));
                } else {
                    appendOutput('Generation failed!', 'error');
                    appendOutput('\n' + (result.error || result.output || 'Unknown error'));
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
            }
            
            showLoading(false);
        }
        
        async function runDiff() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                alert('Please select at least one device');
                return;
            }
            
            const hosts = selected.join(',');
            showLoading(true, `Running diff for ${selected.length} device(s)...`);
            clearOutput();
            appendOutput(`=== DIFF: ${selected.length} device(s) ===`, 'info');
            appendOutput(`Devices: ${hosts}\n`);
            
            try {
                const result = await ansibleApiCall('diff', hosts);
                
                if (result.success) {
                    const output = result.output || '';
                    
                    // Check for changes
                    const hasChanges = output.includes('With changes:');
                    const changesMatch = output.match(/With changes:\s*(\d+)/);
                    const changesCount = changesMatch ? parseInt(changesMatch[1]) : 0;
                    
                    if (changesCount > 0) {
                        appendOutput(`Found changes on ${changesCount} device(s)`, 'warning');
                    } else {
                        appendOutput('All devices are synchronized!', 'success');
                    }
                    
                    appendOutput('\n' + output);
                } else {
                    appendOutput('Diff failed!', 'error');
                    appendOutput('\n' + (result.error || result.output || 'Unknown error'));
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
            }
            
            showLoading(false);
        }
        
        async function runDeploy() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                alert('Please select at least one device');
                return;
            }
            
            const hosts = selected.join(',');
            const confirmMsg = `Are you sure you want to deploy to ${selected.length} device(s)?\n\n` +
                `Devices:\n${selected.slice(0, 10).join('\n')}` +
                (selected.length > 10 ? `\n... and ${selected.length - 10} more` : '') +
                `\n\nThis will apply changes to live network devices!`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showLoading(true, `Deploying to ${selected.length} device(s)...`);
            clearOutput();
            appendOutput(`=== DEPLOY: ${selected.length} device(s) ===`, 'warning');
            appendOutput(`Devices: ${hosts}\n`);
            
            try {
                const result = await ansibleApiCall('deploy', hosts);
                
                if (result.success) {
                    appendOutput('Deployment completed!', 'success');
                    appendOutput('\n' + (result.output || ''));
                } else {
                    appendOutput('Deployment failed!', 'error');
                    appendOutput('\n' + (result.error || result.output || 'Unknown error'));
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
            }
            
            showLoading(false);
        }
    </script>
</body>
</html>
