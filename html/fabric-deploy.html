<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <title>..::LLDPQ::..</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="css/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-title svg {
            width: 28px;
            height: 28px;
            fill: #76b900;
        }
        
        .last-updated {
            font-size: 13px;
            color: #888;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Summary Cards */
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .summary-card { 
            background: #252526; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 3px solid #76b900;
        }
        
        .card-total { border-left-color: #76b900; }
        .card-info { border-left-color: #4fc3f7; }
        .card-warning { border-left-color: #ff9800; }
        .card-success { border-left-color: #4caf50; }
        
        .card-value { 
            font-size: 28px; 
            font-weight: bold; 
        }
        
        .card-total .card-value { color: #76b900; }
        .card-info .card-value { color: #4fc3f7; }
        .card-warning .card-value { color: #ffb74d; }
        .card-success .card-value { color: #81c784; }
        
        .card-label { 
            font-size: 12px; 
            color: #888; 
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Group Vars Warning Banner */
        .group-vars-banner {
            background: linear-gradient(90deg, #3d2d00, #2d2200);
            border: 1px solid #ff9800;
            border-radius: 6px;
            padding: 10px 20px;
            margin: 0 20px 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffb74d;
            font-size: 13px;
        }
        .group-vars-banner svg {
            color: #ff9800;
            flex-shrink: 0;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(0deg, #76b900 0%, #8bc34a 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(0deg, #8bc34a 0%, #9ccc65 100%);
        }
        
        .btn-secondary {
            background: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #555;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #4a4a4a;
            border-color: #76b900;
        }
        
        .btn-warning {
            background: linear-gradient(0deg, #e65100 0%, #ff9800 100%);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(0deg, #ff9800 0%, #ffb74d 100%);
        }
        
        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        /* Device Selection Panel */
        .device-panel {
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #2d2d2d;
            padding: 12px 15px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #76b900;
        }
        
        .select-actions {
            display: flex;
            gap: 8px;
        }
        
        .select-actions a {
            color: #4fc3f7;
            font-size: 12px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .select-actions a:hover {
            text-decoration: underline;
        }
        
        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .device-group {
            margin-bottom: 15px;
        }
        
        .group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #1e1e1e;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .group-header:hover {
            background: #2a2a2a;
        }
        
        .group-header input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #76b900;
        }
        
        .group-name {
            color: #76b900;
            font-size: 13px;
            font-weight: 600;
        }
        
        .group-count {
            color: #888;
            font-size: 11px;
            margin-left: auto;
        }
        
        .device-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 30px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s;
        }
        
        .device-item:hover {
            background: #2a2a2a;
        }
        
        .device-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #76b900;
        }
        
        .device-name {
            font-family: 'Consolas', 'Monaco', 'SF Mono', monospace;
            font-size: 13px;
            color: #d4d4d4;
            font-weight: 400;
        }
        
        .device-ip {
            font-family: 'Consolas', 'Monaco', 'SF Mono', monospace;
            font-size: 11px;
            color: #888;
            margin-left: auto;
        }
        
        /* Deploy Actions Panel */
        .deploy-panel {
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .deploy-actions {
            padding: 15px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .selected-count {
            margin-left: auto;
            font-size: 13px;
            color: #888;
        }
        
        .selected-count strong {
            color: #76b900;
        }
        
        /* Output Area */
        .output-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #1a1a1a;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .output-area .success { color: #4caf50; }
        .output-area .error { color: #f44336; }
        .output-area .warning { color: #ff9800; }
        .output-area .info { color: #4fc3f7; }
        .output-area .changed { color: #ffb74d; }
        
        .output-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            max-height: 100%;
            color: #666;
            overflow: hidden;
        }
        
        .output-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .output-placeholder h2 {
            font-size: 24px;
            font-style: italic;
            font-weight: bold;
            margin-bottom: 10px;
            color: #888;
        }
        
        .output-placeholder p {
            font-size: 14px;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }
        
        .loading-overlay.visible {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); box-shadow: 0 0 15px rgba(118, 185, 0, 0.6); }
        }
        
        .loading-text {
            margin-top: 15px;
            color: #888;
            font-size: 14px;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-synced {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }
        
        .status-pending {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }
        
        /* Modified Badge */
        .modified-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            background: rgba(255, 152, 0, 0.25);
            color: #ffb74d;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .device-item.modified {
            background: rgba(255, 152, 0, 0.08);
            border-left: 2px solid #ff9800;
            padding-left: 28px;
        }
        
        .device-item.modified:hover {
            background: rgba(255, 152, 0, 0.15);
        }
        
        /* Alert Modal */
        .alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .alert-modal.visible {
            display: flex;
        }

        .alert-modal-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .alert-modal-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .alert-modal-header.warning {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            color: #fff;
        }

        .alert-modal-header.error {
            background: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%);
            color: #fff;
        }

        .alert-modal-header.info {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: #fff;
        }

        .alert-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .alert-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            padding: 0;
            line-height: 1;
        }

        .alert-modal-body {
            padding: 20px;
            color: #ccc;
            line-height: 1.6;
        }

        .alert-modal-footer {
            padding: 15px 20px;
            background: #252526;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
        }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .confirm-modal.visible {
            display: flex;
        }

        .confirm-modal-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .confirm-modal-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            color: #fff;
        }

        .confirm-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .confirm-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            padding: 0;
            line-height: 1;
        }

        .confirm-modal-body {
            padding: 20px;
            color: #ccc;
            line-height: 1.6;
            white-space: pre-line;
        }

        .confirm-modal-footer {
            padding: 15px 20px;
            background: #252526;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
        }
        
        .btn-cancel {
            background: #404040;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .btn-cancel:hover {
            background: #505050;
        }
        
        .btn-confirm-danger {
            background: linear-gradient(180deg, #e53e3e 0%, #c53030 100%);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .btn-confirm-danger:hover {
            background: linear-gradient(180deg, #f56565 0%, #e53e3e 100%);
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="page-title">
            <svg viewBox="0 0 24 24">
                <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>
            Fabric Deploy
        </div>
        <div class="action-buttons">
            <span class="last-updated" id="last-updated"></span>
            <button class="btn btn-primary" onclick="scanFabric()" id="btn-scan">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                Fabric Scan
            </button>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-devices">-</div>
            <div class="card-label">Total Devices</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="selected-devices">0</div>
            <div class="card-label">Selected</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="pending-changes">-</div>
            <div class="card-label">Pending Changes</div>
        </div>
        <div class="summary-card card-success">
            <div class="card-value" id="synced-devices">-</div>
            <div class="card-label">Synchronized</div>
        </div>
    </div>
    
    <!-- Group Vars Warning Banner -->
    <div id="group-vars-banner" class="group-vars-banner" style="display: none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
        </svg>
        <span id="group-vars-message">Group variables changed</span>
        <span style="margin-left: auto; opacity: 0.8;">Run <strong>Fabric Scan</strong> for accurate detection</span>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Device Selection Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <span class="panel-title">Select Devices</span>
                <span class="selected-count" style="margin-left: 15px; font-size: 13px;">
                    <strong id="action-selected-count">0</strong> selected
                </span>
                <div class="select-actions">
                    <a onclick="selectAll(true)">All</a>
                    <a onclick="selectAll(false)">None</a>
                    <a onclick="selectModified()" style="color: #ffb74d;">Modified</a>
                </div>
            </div>
            <div class="device-list" id="device-list">
                <div class="output-placeholder">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1"/>
                    </svg>
                    <div>Loading devices...</div>
                </div>
            </div>
        </div>
        
        <!-- Deploy Actions Panel -->
        <div class="deploy-panel">
            <div class="deploy-actions">
                <button class="btn btn-primary" onclick="runGenerate()" id="btn-generate">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Generate
                </button>
                <button class="btn" onclick="runValidate()" id="btn-validate" style="background: #0097a7; border-color: #0097a7; color: #fff;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Validate
                </button>
                <button class="btn btn-secondary" onclick="runDiff()" id="btn-diff">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                    Diff
                </button>
                <button class="btn btn-warning" onclick="runDeploy()" id="btn-deploy">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    Deploy
                </button>
                <button class="btn btn-secondary" onclick="clearOutput(); resetOutputPlaceholder()" style="margin-left: auto;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                    Clear
                </button>
            </div>
            <div class="output-area" id="output-area">
                <div class="output-placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <h2>Fabric Deployment Center</h2>
                    <p>Click <strong>Fabric Scan</strong> to detect pending changes across all devices</p>
                    <p style="margin-top: 8px; font-size: 12px; color: #666;">Then select devices and run Generate, Diff, or Deploy</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-text" class="loading-text">Loading...</div>
    </div>
    
    <!-- Validation Modal -->
    <div id="validate-modal" class="validate-modal">
        <div class="validate-modal-content">
            <div class="validate-modal-header" id="validate-modal-header">
                <h3 id="validate-modal-title">Validation Results</h3>
                <button class="validate-modal-close" onclick="hideValidateModal()">&times;</button>
            </div>
            <div class="validate-modal-body" id="validate-modal-body"></div>
            <div class="validate-modal-footer" style="display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-secondary" onclick="hideValidateModal()">Close</button>
                <button class="btn btn-primary" onclick="copyValidateModalContent(this)" style="background: #76b900;">Copy</button>
            </div>
        </div>
    </div>
    
    <style>
        .validate-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .validate-modal.visible { display: flex; }
        .validate-modal-content {
            background: #252526;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #404040;
        }
        .validate-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
            border-radius: 8px 8px 0 0;
        }
        .validate-modal-header.success { background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%); }
        .validate-modal-header.error { background: linear-gradient(135deg, #5c1a1a 0%, #3d1111 100%); }
        .validate-modal-header.warning { background: linear-gradient(135deg, #5c4a1a 0%, #3d3111 100%); }
        .validate-modal-header h3 { margin: 0; color: #fff; font-size: 16px; }
        .validate-modal-close { background: none; border: none; color: #999; font-size: 24px; cursor: pointer; }
        .validate-modal-close:hover { color: #fff; }
        .validate-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .validate-modal-footer { padding: 15px 20px; border-top: 1px solid #404040; text-align: right; }
    </style>
    
    <script>
        let devices = {};
        let totalDeviceCount = 0;
        let modifiedDevices = new Set();
        
        // Cache configuration
        const CACHE_KEY = 'fabricDeploy_scanCache';
        const CACHE_STALE_THRESHOLD = 60 * 60 * 1000; // 1 hour in ms
        
        // Auto-scan configuration (git status check, not Fabric Scan)
        const AUTO_SCAN_INTERVAL = 1 * 60 * 1000;  // 1 minute - check git status periodically
        const AUTO_SCAN_MIN_AGE = 30 * 1000;       // 30 seconds - minimum time before auto-scan
        let autoScanTimer = null;
        let lastAutoScanTime = 0;
        
        // Load devices on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            initAutoScan();
        });
        
        // Initialize auto-scan system
        function initAutoScan() {
            // Always run a quick git scan on page load
            setTimeout(() => {
                if (document.visibilityState === 'visible') {
                    silentGitScan();
                }
            }, 500); // Quick delay for page to settle
            
            // Start periodic scan timer
            startAutoScanTimer();
            
            // Handle tab visibility changes
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    // Tab became visible - check if scan is needed
                    const timeSinceLastScan = Date.now() - lastAutoScanTime;
                    if (timeSinceLastScan > AUTO_SCAN_MIN_AGE) {
                        silentGitScan();
                    }
                }
            });
        }
        
        function startAutoScanTimer() {
            if (autoScanTimer) clearInterval(autoScanTimer);
            autoScanTimer = setInterval(() => {
                // Only scan if tab is visible
                if (document.visibilityState === 'visible') {
                    silentGitScan();
                }
            }, AUTO_SCAN_INTERVAL);
        }
        
        // Silent git scan (no loading indicator, just updates UI)
        async function silentGitScan() {
            lastAutoScanTime = Date.now();
            try {
                const response = await fetch('/ansible-api.sh?action=git-status');
                const data = await response.json();
                
                if (data.success && data.output) {
                    const output = data.output;
                    const newPendingDevices = new Set();
                    
                    // Parse git status output for inventory/ changes only
                    for (const line of output.split('\n')) {
                        const hostVarsMatch = line.match(/inventory\/host_vars\/([^\/]+)\.ya?ml/);
                        if (hostVarsMatch) {
                            newPendingDevices.add(hostVarsMatch[1]);
                        }
                    }
                    
                    // Check if changes detected (compare with current)
                    const previousCount = modifiedDevices.size;
                    const hasChanges = newPendingDevices.size !== previousCount || 
                        ![...newPendingDevices].every(d => modifiedDevices.has(d));
                    
                    // Set directly (no merge - always fresh from git status)
                    modifiedDevices = newPendingDevices;
                    
                    // Update UI if changes detected
                    if (hasChanges) {
                        renderDeviceList();
                        updateSummaryCards();
                        
                        // Flash the pending count to draw attention if new changes
                        if (newPendingDevices.size > previousCount) {
                            const pendingEl = document.getElementById('pending-changes');
                            if (pendingEl) {
                                pendingEl.style.animation = 'none';
                                pendingEl.offsetHeight; // Trigger reflow
                                pendingEl.style.animation = 'pulse 0.5s ease-in-out 2';
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('[silentGitScan] Error:', e.message);
            }
        }
        
        async function loadDevices() {
            try {
                const devicesResp = await fetch('/fabric-api.sh?action=list-devices');
                const devicesData = await devicesResp.json();
                
                if (devicesData.success && devicesData.devices) {
                    devices = devicesData.devices;
                }
                
                renderDeviceList();
                updateLastUpdated();
                
                // Run git status to detect uncommitted changes in Ansible source
                // This is fast (seconds) so no caching needed - always fresh data
                await quickGitScan();
            } catch (e) {
                document.getElementById('device-list').innerHTML = 
                    `<div class="output-placeholder" style="color: #f44336;">Error loading devices: ${e.message}</div>`;
            }
        }
        
        // Cache management functions
        function saveScanCache(pendingDevices) {
            const cache = {
                timestamp: Date.now(),
                pendingDevices: Array.from(pendingDevices),
                totalDevices: totalDeviceCount
            };
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) {
                console.warn('Failed to save scan cache:', e);
            }
        }
        
        function loadScanCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    return JSON.parse(cached);
                }
            } catch (e) {
                console.warn('Failed to load scan cache:', e);
            }
            return null;
        }
        
        // Load server-side cache from cron job
        async function loadServerCache() {
            try {
                const response = await fetch('/fabric-scan-cache.json?t=' + Date.now());
                if (response.ok) {
                    const text = await response.text();
                    if (text && text.trim()) {
                        return JSON.parse(text);
                    }
                }
            } catch (e) {
                // No server cache yet - that's OK
            }
            return null;
        }
        
        function showScanAge(timestamp) {
            const age = Date.now() - timestamp;
            const minutes = Math.floor(age / 60000);
            const hours = Math.floor(minutes / 60);
            
            let ageText;
            if (hours > 0) {
                ageText = `${hours}h ${minutes % 60}m ago`;
            } else if (minutes > 0) {
                ageText = `${minutes}m ago`;
            } else {
                ageText = 'just now';
            }
            
            document.getElementById('last-updated').textContent = `Last scan: ${ageText}`;
            document.getElementById('last-updated').title = new Date(timestamp).toLocaleString();
        }
        
        function showStaleWarning() {
            const pendingEl = document.getElementById('pending-changes');
            const syncedEl = document.getElementById('synced-devices');
            pendingEl.style.opacity = '0.6';
            syncedEl.style.opacity = '0.6';
            pendingEl.title = 'Data may be stale - click Fabric Scan to refresh';
            syncedEl.title = 'Data may be stale - click Fabric Scan to refresh';
        }
        
        function updateSummaryCards() {
            const pendingCount = modifiedDevices.size;
            const syncedCount = totalDeviceCount - pendingCount;
            
            document.getElementById('pending-changes').textContent = pendingCount;
            document.getElementById('synced-devices').textContent = syncedCount;
        }
        
        // Quick git-based scan (fast - milliseconds)
        // Only detects host_vars changes. For group_vars, shows warning but doesn't mark devices
        // (because group_vars changes require Fabric Scan to determine which devices are affected)
        async function quickGitScan() {
            try {
                console.log('[quickGitScan] Starting...');
                const response = await fetch('/ansible-api.sh?action=git-status');
                const data = await response.json();
                console.log('[quickGitScan] API response:', data.success ? 'success' : 'failed');
                
                if (data.success && data.output) {
                    const output = data.output;
                    console.log('[quickGitScan] Git output lines:', output.split('\n').length);
                    const gitPendingDevices = new Set();
                    const modifiedGroups = new Set();
                    
                    // Parse git status output for modified files in inventory/
                    const lines = output.split('\n');
                    
                    for (const line of lines) {
                        // Match host_vars file changes
                        const hostMatch = line.match(/inventory\/host_vars\/([^\/\s]+)\.ya?ml/);
                        if (hostMatch) {
                            const hostname = hostMatch[1];
                            if (hostname && hostname !== 'all') {
                                gitPendingDevices.add(hostname);
                            }
                        }
                        
                        // Match group_vars file changes
                        const groupMatch = line.match(/inventory\/group_vars\/([^\/\s]+)/);
                        if (groupMatch) {
                            modifiedGroups.add(groupMatch[1]);
                        }
                    }
                    
                    console.log('[quickGitScan] Detected host_vars devices:', Array.from(gitPendingDevices));
                    console.log('[quickGitScan] Detected group_vars:', Array.from(modifiedGroups));
                    
                    // Set modifiedDevices directly from git status (no caching, always fresh)
                    modifiedDevices = gitPendingDevices;
                    console.log('[quickGitScan] modifiedDevices:', modifiedDevices.size);
                    
                    // Show banner if group_vars changed
                    const banner = document.getElementById('group-vars-banner');
                    const bannerMsg = document.getElementById('group-vars-message');
                    
                    if (modifiedGroups.size > 0) {
                        const groupList = Array.from(modifiedGroups).join(', ');
                        console.log('Group vars changed:', groupList);
                        
                        // Show warning banner
                        if (banner) {
                            bannerMsg.textContent = `Group variables changed: ${groupList}`;
                            banner.style.display = 'flex';
                        }
                    } else {
                        // Hide banner if no group_vars changes
                        if (banner) {
                            banner.style.display = 'none';
                        }
                    }
                    
                    // Update UI
                    renderDeviceList();
                    updateSummaryCards();
                    
                    console.log('[quickGitScan] Complete:', gitPendingDevices.size, 'host_vars,', modifiedGroups.size, 'group_vars');
                }
            } catch (e) {
                console.error('[quickGitScan] FAILED:', e.message, e);
            }
        }
        
        function renderDeviceList() {
            const container = document.getElementById('device-list');
            let html = '';
            
            // Count unique devices (same device may be in multiple groups)
            const uniqueDevices = new Set();
            for (const [group, groupDevices] of Object.entries(devices)) {
                for (const device of groupDevices) {
                    uniqueDevices.add(device.hostname || device);
                }
            }
            totalDeviceCount = uniqueDevices.size;
            
            for (const [group, groupDevices] of Object.entries(devices)) {
                const groupId = group.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Count modified in this group
                const modifiedInGroup = groupDevices.filter(d => modifiedDevices.has(d.hostname || d)).length;
                const modifiedBadge = modifiedInGroup > 0 ? `<span class="modified-badge">${modifiedInGroup} modified</span>` : '';
                
                html += `
                    <div class="device-group">
                        <div class="group-header" onclick="toggleGroup('${groupId}')">
                            <input type="checkbox" id="group-${groupId}" onclick="event.stopPropagation(); toggleGroupDevices('${groupId}')" onchange="updateCounts()">
                            <span class="group-name">${group}</span>
                            ${modifiedBadge}
                            <span class="group-count">${groupDevices.length}</span>
                        </div>
                        <div id="devices-${groupId}">
                `;
                
                for (const device of groupDevices) {
                    const hostname = device.hostname || device;
                    const ip = device.ansible_host || device.ip || '';
                    const isModified = modifiedDevices.has(hostname);
                    const modifiedClass = isModified ? ' modified' : '';
                    const badge = isModified ? '<span class="modified-badge">modified</span>' : '';
                    
                    html += `
                        <label class="device-item${modifiedClass}">
                            <input type="checkbox" name="device" value="${hostname}" data-group="${groupId}" onchange="syncDeviceCheckboxes('${hostname}', this.checked); updateCounts()">
                            <span class="device-name">${hostname}${badge}</span>
                            <span class="device-ip">${ip}</span>
                        </label>
                    `;
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            document.getElementById('total-devices').textContent = totalDeviceCount;
            updateCounts();
        }
        
        function selectModified() {
            // First uncheck all
            document.querySelectorAll('input[name="device"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[id^="group-"]').forEach(cb => cb.checked = false);
            
            // Then check only modified devices
            modifiedDevices.forEach(hostname => {
                const cb = document.querySelector(`input[name="device"][value="${hostname}"]`);
                if (cb) {
                    cb.checked = true;
                    // Update group checkbox
                    const groupId = cb.dataset.group;
                    if (groupId) updateGroupCheckbox(groupId);
                }
            });
            
            updateCounts();
        }
        
        function toggleGroup(groupId) {
            const devicesDiv = document.getElementById('devices-' + groupId);
            devicesDiv.style.display = devicesDiv.style.display === 'none' ? 'block' : 'block';
        }
        
        function toggleGroupDevices(groupId) {
            const groupCb = document.getElementById('group-' + groupId);
            const deviceCbs = document.querySelectorAll(`input[name="device"][data-group="${groupId}"]`);
            deviceCbs.forEach(cb => cb.checked = groupCb.checked);
            updateCounts();
        }
        
        function updateGroupCheckbox(groupId) {
            const deviceCbs = document.querySelectorAll(`input[name="device"][data-group="${groupId}"]`);
            const allChecked = Array.from(deviceCbs).every(cb => cb.checked);
            const groupCb = document.getElementById('group-' + groupId);
            if (groupCb) groupCb.checked = allChecked;
        }
        
        function selectAll(select) {
            document.querySelectorAll('input[name="device"]').forEach(cb => cb.checked = select);
            document.querySelectorAll('input[id^="group-"]').forEach(cb => cb.checked = select);
            updateCounts();
        }
        
        function updateCounts() {
            // Count unique selected devices (same device may appear in multiple groups)
            const selectedSet = new Set();
            document.querySelectorAll('input[name="device"]:checked').forEach(cb => {
                selectedSet.add(cb.value);
            });
            const selected = selectedSet.size;
            document.getElementById('selected-devices').textContent = selected;
            document.getElementById('action-selected-count').textContent = selected;
        }
        
        // Sync checkboxes for same device across groups
        function syncDeviceCheckboxes(hostname, checked) {
            document.querySelectorAll(`input[name="device"][value="${hostname}"]`).forEach(cb => {
                cb.checked = checked;
                const groupId = cb.dataset.group;
                if (groupId) updateGroupCheckbox(groupId);
            });
        }
        
        function getSelectedDevices() {
            // Return unique device names (same device may appear in multiple groups)
            const deviceSet = new Set();
            document.querySelectorAll('input[name="device"]:checked').forEach(cb => {
                deviceSet.add(cb.value);
            });
            return Array.from(deviceSet);
        }
        
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            overlay.classList.toggle('visible', show);
        }
        
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                'Last updated: ' + now.toLocaleTimeString();
        }
        
        // Strip ANSI escape codes and convert to HTML with colors
        function parseAnsiOutput(text) {
            // Remove ANSI escape codes
            let cleaned = text.replace(/\x1b\[[0-9;]*m/g, '');
            // Also handle the escaped version [0;32m etc
            cleaned = cleaned.replace(/\[0;3[0-9]m/g, '');
            cleaned = cleaned.replace(/\[0m/g, '');
            cleaned = cleaned.replace(/\[1;3[0-9]m/g, '');
            cleaned = cleaned.replace(/\[0;1;3[0-9]m/g, '');
            return cleaned;
        }
        
        function appendOutput(text, type = '') {
            const output = document.getElementById('output-area');
            // Clear placeholder if exists
            if (output.querySelector('.output-placeholder')) {
                output.innerHTML = '';
                output.classList.add('has-content');
            }
            
            // Clean ANSI codes
            const cleanedText = parseAnsiOutput(text);
            
            const span = document.createElement('span');
            if (type) span.className = type;
            span.textContent = cleanedText + '\n';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }
        
        function appendFormattedOutput(text) {
            const output = document.getElementById('output-area');
            if (output.querySelector('.output-placeholder')) {
                output.innerHTML = '';
                output.classList.add('has-content');
            }
            
            // Clean ANSI codes first
            const cleaned = parseAnsiOutput(text);
            
            // Split by lines and colorize
            const lines = cleaned.split('\n');
            for (const line of lines) {
                const span = document.createElement('span');
                
                // Determine color based on content
                if (line.includes('ok=') && !line.includes('ok=0')) {
                    span.className = 'success';
                } else if (line.includes('changed=') && !line.includes('changed=0')) {
                    span.className = 'changed';
                } else if (line.includes('failed=') && !line.includes('failed=0')) {
                    span.className = 'error';
                } else if (line.includes('unreachable=') && !line.includes('unreachable=0')) {
                    span.className = 'error';
                } else if (line.includes('PLAY [') || line.includes('TASK [')) {
                    span.className = 'info';
                } else if (line.includes('CONFIG DIFF SUMMARY') || line.includes('TOTAL:')) {
                    span.className = 'info';
                } else if (line.includes('No changes') || line.includes('✓')) {
                    span.className = 'success';
                } else if (line.includes('With changes') || line.includes('✗')) {
                    span.className = 'warning';
                }
                
                span.textContent = line + '\n';
                output.appendChild(span);
            }
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('output-area').innerHTML = '';
        }
        
        function ansiToHtml(text) {
            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Wrap in span to handle orphan closing tags
            html = '<span>' + html + '</span>';
            
            // ANSI color map
            const colors = {
                '30': '#000', '31': '#e74c3c', '32': '#2ecc71', '33': '#f1c40f',
                '34': '#3498db', '35': '#9b59b6', '36': '#1abc9c', '37': '#ecf0f1',
                '90': '#7f8c8d', '91': '#ff6b6b', '92': '#4ec9b0', '93': '#ffd93d',
                '94': '#6997d5', '95': '#c586c0', '96': '#56d4bc', '97': '#fff'
            };
            
            // Replace ANSI codes with spans
            html = html.replace(/\u001b\[([0-9;]+)m/g, (match, codes) => {
                const codeList = codes.split(';');
                let style = '';
                let isReset = false;
                
                for (const code of codeList) {
                    if (code === '0' || code === '') {
                        isReset = true;
                        continue;
                    }
                    if (code === '1') style += 'font-weight:bold;';
                    else if (code === '4') style += 'text-decoration:underline;';
                    else if (colors[code]) style += `color:${colors[code]};`;
                    else {
                        const bg = parseInt(code);
                        if (bg >= 40 && bg <= 47) {
                            const fgCode = String(bg - 10);
                            if (colors[fgCode]) style += `background:${colors[fgCode]};`;
                        }
                    }
                }
                
                if (isReset && !style) return '</span>';
                if (style) return `</span><span style="${style}">`;
                return '';
            });
            
            return html;
        }
        
        function showDiffModal(output, changesCount, deviceList = []) {
            // Remove existing modal if any
            const existing = document.getElementById('diff-popup-modal');
            if (existing) existing.remove();
            
            const hasChanges = changesCount > 0;
            const statusColor = hasChanges ? '#ff9800' : '#76b900';
            const statusIcon = hasChanges ? '⚠' : '✓';
            const headerClass = hasChanges ? 'warning' : 'success';
            
            let html = '<div style="font-family: monospace; font-size: 13px;">';
            
            // Summary header
            html += `<div style="padding: 15px; background: ${hasChanges ? 'rgba(255,152,0,0.1)' : 'rgba(118,185,0,0.1)'}; border-radius: 8px; margin-bottom: 15px; border: 1px solid ${statusColor};">`;
            html += `<div style="font-size: 18px; color: ${statusColor}; margin-bottom: 10px;">${statusIcon} ${hasChanges ? 'Changes Detected' : 'All Devices Synchronized'}</div>`;
            html += `<div style="color: #ccc;">`;
            html += `<div>Devices Checked: <span style="color: #fff;">${deviceList.length}</span></div>`;
            if (hasChanges) {
                html += `<div>Devices with Changes: <span style="color: #ff9800; font-weight: bold;">${changesCount}</span></div>`;
            }
            html += '</div></div>';
            
            // Parse NVUE YAML diff content for each device
            // Format: ✗ hostname: N changes (+X -Y) followed by YAML diff
            if (hasChanges && output) {
                const lines = output.split('\n');
                let deviceDiffs = {};
                let currentDevice = '';
                let inDiffSection = false;
                let inDeviceDiff = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Start of SWITCHES WITH CHANGES section
                    if (line.includes('SWITCHES WITH CHANGES')) {
                        inDiffSection = true;
                        continue;
                    }
                    
                    // End markers
                    if (line.includes('PLAY RECAP') || line.includes('TASKS RECAP')) {
                        inDiffSection = false;
                        inDeviceDiff = false;
                        break;
                    }
                    
                    if (inDiffSection) {
                        // Device header: ✗ hostname: N changes (+X -Y)
                        const deviceMatch = line.match(/[✗✓]\s+(\S+):\s*(\d+)\s*changes?\s*\(([^)]+)\)/);
                        if (deviceMatch) {
                            currentDevice = deviceMatch[1];
                            const changeInfo = deviceMatch[3];
                            deviceDiffs[currentDevice] = {
                                header: `${currentDevice}: ${deviceMatch[2]} change(s) (${changeInfo})`,
                                lines: []
                            };
                            inDeviceDiff = true;
                            continue;
                        }
                        
                        // Collect diff lines for current device
                        if (inDeviceDiff && currentDevice) {
                            if (line.match(/^[✗✓]\s+\S+:/) || line.includes('════════')) {
                                inDeviceDiff = false;
                                continue;
                            }
                            if (line.trim()) {
                                deviceDiffs[currentDevice].lines.push(line);
                            }
                        }
                    }
                }
                
                // Render device diffs
                const deviceNames = Object.keys(deviceDiffs);
                deviceNames.forEach(device => {
                    const diff = deviceDiffs[device];
                    if (diff.lines.length > 0) {
                        html += `<div style="background: #2a2a2a; border-radius: 6px; padding: 12px; margin-bottom: 10px;">`;
                        html += `<div style="color: #f44336; margin-bottom: 8px; font-weight: bold;">✗ ${diff.header}</div>`;
                        html += '<div style="background: #1a1a1a; border-radius: 4px; padding: 8px; overflow-x: auto; font-family: monospace; font-size: 12px;">';
                        
                        diff.lines.forEach(line => {
                            let lineColor = '#ccc';
                            let bgColor = 'transparent';
                            const trimmed = line.trim();
                            
                            if (trimmed.startsWith('- set:') || trimmed.startsWith('- unset:')) {
                                lineColor = '#f44336';
                                bgColor = 'rgba(244,67,54,0.1)';
                            } else if (trimmed.startsWith('+ set:') || trimmed.startsWith('+ unset:')) {
                                lineColor = '#76b900';
                                bgColor = 'rgba(118,185,0,0.1)';
                            } else if (trimmed.includes(':') && !trimmed.endsWith(':')) {
                                lineColor = '#4fc3f7';
                            }
                            
                            // Strip ANSI color codes and escape HTML
                            const cleanLine = line.replace(/\x1b\[[0-9;]*m/g, '').replace(/\[0;?[0-9]*m/g, '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            html += `<div style="color: ${lineColor}; background: ${bgColor}; padding: 1px 5px; white-space: pre;">${cleanLine}</div>`;
                        });
                        
                        html += '</div></div>';
                    }
                });
            }
            
            html += '</div>';
            
            // Use the validate modal for consistent styling
            const modal = document.getElementById('validate-modal');
            const header = document.getElementById('validate-modal-header');
            document.getElementById('validate-modal-title').textContent = hasChanges ? 'Diff Results - Changes Detected' : 'Diff Results - Synchronized';
            document.getElementById('validate-modal-body').innerHTML = html;
            header.className = 'validate-modal-header ' + headerClass;
            modal.classList.add('visible');
        }
        
        function copyDiffContent(btn) {
            const pre = document.getElementById('diff-popup-content');
            if (pre) {
                const text = pre.textContent;
                
                // Create a temporary textarea for copying (works on HTTP too)
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '0';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    // Show feedback
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#4ec9b0';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#76b900';
                    }, 2000);
                } catch (err) {
                    console.error('Copy failed:', err);
                }
                
                document.body.removeChild(textarea);
            }
        }
        
        function extractDiffSummary(output) {
            // Extract the summary section from diff output
            const lines = output.split('\n');
            const summaryLines = [];
            let inSummary = false;
            let foundDevices = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Start capturing at CONFIG DIFF SUMMARY (also get the box border line before it)
                if (line.includes('CONFIG DIFF SUMMARY')) {
                    inSummary = true;
                    // Include the box border line before CONFIG DIFF SUMMARY if it exists
                    if (i > 0 && lines[i-1].includes('╔')) {
                        summaryLines.push(lines[i-1]);
                    }
                    summaryLines.push(line);
                    continue;
                }
                
                // Capture summary content
                if (inSummary) {
                    // End at PLAY RECAP
                    if (line.includes('PLAY RECAP') || line.includes('TASKS RECAP')) {
                        break;
                    }
                    summaryLines.push(line);
                    
                    // Track if we found device changes
                    if (line.includes('SWITCHES WITH CHANGES')) {
                        foundDevices = true;
                    }
                }
            }
            
            return summaryLines.join('\n');
        }
        
        function resetOutputPlaceholder() {
            const output = document.getElementById('output-area');
            output.classList.remove('has-content');
            output.innerHTML = `
                <div class="output-placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <h2>Fabric Deployment Center</h2>
                    <p>Click <strong>Fabric Scan</strong> to detect pending changes across all devices</p>
                    <p style="margin-top: 8px; font-size: 12px; color: #666;">Then select devices and run Generate, Diff, or Deploy</p>
                </div>
            `;
        }
        
        async function ansibleApiCall(action, hosts) {
            const params = new URLSearchParams({ action });
            if (hosts) params.append('host', hosts);
            const response = await fetch(`/ansible-api?${params}`);
            return await response.json();
        }
        
        async function runGenerate() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                showAlert('Please select at least one device', 'warning', 'No Selection');
                return;
            }
            
            const hosts = selected.join(',');
            showLoading(true, `Generating configs for ${selected.length} device(s)...`);
            clearOutput();
            appendOutput(`=== GENERATE: ${selected.length} device(s) ===`, 'info');
            appendOutput(`Devices: ${hosts}\n`);
            
            try {
                const result = await ansibleApiCall('generate', hosts);
                
                if (result.success) {
                    appendOutput('Generation completed successfully!', 'success');
                    appendFormattedOutput(result.output || '');
                } else {
                    appendOutput('Generation failed!', 'error');
                    appendFormattedOutput(result.error || result.output || 'Unknown error');
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
            }
            
            showLoading(false);
        }
        
        function showValidateModal(title, content, type = 'success') {
            const modal = document.getElementById('validate-modal');
            const header = document.getElementById('validate-modal-header');
            document.getElementById('validate-modal-title').textContent = title;
            document.getElementById('validate-modal-body').innerHTML = content;
            header.className = 'validate-modal-header ' + type;
            modal.classList.add('visible');
        }
        
        function hideValidateModal() {
            document.getElementById('validate-modal').classList.remove('visible');
        }
        
        function copyValidateModalContent(btn) {
            const body = document.getElementById('validate-modal-body');
            if (body) {
                const text = body.innerText;
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#4ec9b0';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#76b900';
                    }, 1500);
                } catch (e) {
                    console.error('Copy failed:', e);
                }
                document.body.removeChild(textarea);
            }
        }
        
        async function runValidate() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                showAlert('Please select at least one device', 'warning', 'No Selection');
                return;
            }
            
            const hosts = selected.join(',');
            showLoading(true, `Validating ${selected.length} device(s)...`);
            
            try {
                const response = await fetch(`/edit-config?action=validate&devices=${encodeURIComponent(hosts)}`);
                const data = await response.json();
                
                showLoading(false);
                
                if (!data.success) {
                    showValidateModal('Validation Error', `<div style="color: #f44336;">${data.error || 'Unknown error'}</div>`, 'error');
                    return;
                }
                
                const result = data.result;
                const summary = result.summary;
                let html = '<div style="font-family: monospace; font-size: 13px;">';
                
                // Summary
                const isValid = result.valid;
                const statusColor = isValid ? '#76b900' : '#f44336';
                const statusIcon = isValid ? '✓' : '✗';
                
                html += `<div style="padding: 15px; background: ${isValid ? 'rgba(118,185,0,0.1)' : 'rgba(244,67,54,0.1)'}; border-radius: 8px; margin-bottom: 15px; border: 1px solid ${statusColor};">`;
                html += `<div style="font-size: 18px; color: ${statusColor}; margin-bottom: 10px;">${statusIcon} ${isValid ? 'All Configurations Valid' : 'Validation Issues Found'}</div>`;
                html += `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; color: #ccc;">`;
                html += `<div>Files: <span style="color: #fff;">${summary.total_files}</span> (${summary.valid_files} valid, ${summary.invalid_files} invalid)</div>`;
                html += `<div>File Issues: <span style="color: #f44336;">${summary.total_errors} errors</span>, <span style="color: #ff9800;">${summary.total_warnings} warnings</span></div>`;
                if (result.topology) {
                    html += `<div>Topology: <span style="color: #f44336;">${summary.topology_errors} errors</span>, <span style="color: #ff9800;">${summary.topology_warnings} warnings</span></div>`;
                }
                html += '</div></div>';
                
                // File issues
                const filesWithIssues = result.files.filter(f => f.issues && f.issues.length > 0);
                if (filesWithIssues.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><div style="color: #76b900; font-weight: bold; margin-bottom: 10px; font-size: 14px;">File Validation Issues</div>';
                    
                    filesWithIssues.forEach(file => {
                        const filename = file.filename.split('/').pop();
                        html += `<div style="background: #2a2a2a; border-radius: 6px; padding: 12px; margin-bottom: 10px;">`;
                        html += `<div style="color: #4fc3f7; margin-bottom: 8px; font-weight: bold;">${filename}</div>`;
                        
                        file.issues.forEach(issue => {
                            const sevColor = issue.severity === 'ERROR' ? '#f44336' : issue.severity === 'WARNING' ? '#ff9800' : '#4fc3f7';
                            html += `<div style="margin-left: 10px; margin-bottom: 6px; border-left: 2px solid ${sevColor}; padding-left: 10px;">`;
                            html += `<span style="color: ${sevColor}; font-weight: bold;">[${issue.severity}]</span> `;
                            html += `<span style="color: #888;">${issue.path}:</span> `;
                            html += `<span style="color: #ddd;">${issue.message}</span>`;
                            if (issue.suggestion) {
                                html += `<div style="color: #999; margin-top: 3px; font-style: italic;">→ ${issue.suggestion}</div>`;
                            }
                            html += '</div>';
                        });
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                // Topology issues
                if (result.topology && result.topology.issues && result.topology.issues.length > 0) {
                    html += '<div><div style="color: #76b900; font-weight: bold; margin-bottom: 10px; font-size: 14px;">Topology Analysis Issues</div>';
                    
                    result.topology.issues.forEach(issue => {
                        const sevColor = issue.severity === 'ERROR' ? '#f44336' : issue.severity === 'WARNING' ? '#ff9800' : '#4fc3f7';
                        html += `<div style="background: #2a2a2a; border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid ${sevColor};">`;
                        html += `<div style="margin-bottom: 5px;"><span style="color: ${sevColor}; font-weight: bold;">[${issue.severity}]</span> <span style="color: #888;">${issue.category}</span></div>`;
                        html += `<div style="color: #ddd; margin-bottom: 5px;">${issue.message}</div>`;
                        if (issue.devices && issue.devices.length > 0) {
                            html += `<div style="color: #4fc3f7; font-size: 12px;">Devices: ${issue.devices.join(', ')}</div>`;
                        }
                        if (issue.suggestion) {
                            html += `<div style="color: #999; margin-top: 5px; font-style: italic;">→ ${issue.suggestion}</div>`;
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                
                showValidateModal(
                    isValid ? 'Validation Passed' : 'Validation Results',
                    html,
                    isValid ? 'success' : 'warning'
                );
                
            } catch (e) {
                showLoading(false);
                showValidateModal('Error', `<div style="color: #f44336;">Failed to run validation: ${e.message}</div>`, 'error');
            }
        }
        
        async function runDiff() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                showAlert('Please select at least one device', 'warning', 'No Selection');
                return;
            }
            
            const hosts = selected.join(',');
            showLoading(true, `Running diff for ${selected.length} device(s)...`);
            clearOutput();
            appendOutput(`=== DIFF: ${selected.length} device(s) ===`, 'info');
            appendOutput(`Devices: ${hosts}\n`);
            
            try {
                const result = await ansibleApiCall('diff', hosts);
                
                if (result.success) {
                    const output = result.output || '';
                    
                    // Check for changes
                    const hasChanges = output.includes('With changes:');
                    const changesMatch = output.match(/With changes:\s*(\d+)/);
                    const changesCount = changesMatch ? parseInt(changesMatch[1]) : 0;
                    
                    if (changesCount > 0) {
                        appendOutput(`Found changes on ${changesCount} device(s)`, 'warning');
                    } else {
                        appendOutput('All devices are synchronized!', 'success');
                    }
                    
                    appendFormattedOutput(output);
                    
                    // Show diff modal popup with nice formatting
                    showDiffModal(output, changesCount, selected);
                } else {
                    appendOutput('Diff failed!', 'error');
                    appendFormattedOutput(result.error || result.output || 'Unknown error');
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
            }
            
            showLoading(false);
        }
        
        async function scanFabric() {
            // Get all unique device hostnames
            const allDevices = new Set();
            for (const [group, groupDevices] of Object.entries(devices)) {
                for (const device of groupDevices) {
                    allDevices.add(device.hostname || device);
                }
            }
            
            if (allDevices.size === 0) {
                showAlert('No devices loaded. Please refresh first.', 'warning', 'No Devices');
                return;
            }
            
            const hosts = Array.from(allDevices).join(',');
            showLoading(true, `Scanning ${allDevices.size} devices for pending changes...`);
            clearOutput();
            appendOutput(`=== FABRIC SCAN: ${allDevices.size} device(s) ===`, 'info');
            appendOutput('Running diff against all devices to detect pending changes...\n');
            
            try {
                const result = await ansibleApiCall('diff', hosts);
                
                if (result.success) {
                    const output = result.output || '';
                    const cleanedOutput = parseAnsiOutput(output);
                    
                    // Parse "SWITCHES WITH CHANGES:" section
                    // Format: ✗ hostname: X changes (+Y -Z)
                    const pendingDevices = new Set();
                    const lines = cleanedOutput.split('\n');
                    
                    let inChangesSection = false;
                    for (const line of lines) {
                        // Detect start of changes section
                        if (line.includes('SWITCHES WITH CHANGES')) {
                            inChangesSection = true;
                            continue;
                        }
                        
                        // End of section (empty line or new section starts)
                        if (inChangesSection && (line.includes('PLAY RECAP') || line.includes('TASKS RECAP') || line.includes('PLAYBOOK RECAP'))) {
                            inChangesSection = false;
                        }
                        
                        // Parse device lines in changes section
                        // Match: "✗ HOSTNAME: N change(s)" or "HOSTNAME: N changes"
                        // Generic pattern: any alphanumeric hostname followed by ": N change"
                        if (inChangesSection) {
                            const match = line.match(/([A-Za-z0-9_-]+):\s*\d+\s+change/i);
                            if (match) {
                                const hostname = match[1];
                                // Skip common non-device names
                                if (hostname && hostname !== 'localhost' && !hostname.match(/^(ok|changed|unreachable|failed|skipped|rescued|ignored)$/i)) {
                                    pendingDevices.add(hostname);
                                    console.log('Found pending device:', hostname);
                                }
                            }
                        }
                    }
                    
                    console.log('Total pending devices found:', pendingDevices.size, Array.from(pendingDevices));
                    
                    // Update modifiedDevices with real diff results
                    modifiedDevices = pendingDevices;
                    
                    // Save to cache
                    saveScanCache(pendingDevices);
                    showScanAge(Date.now());
                    
                    // Remove stale styling
                    document.getElementById('pending-changes').style.opacity = '1';
                    document.getElementById('synced-devices').style.opacity = '1';
                    
                    // Re-render device list with new status
                    renderDeviceList();
                    updateSummaryCards();
                    
                    // Show summary
                    const pendingCount = pendingDevices.size;
                    const syncedCount = allDevices.size - pendingCount;
                    
                    appendOutput(`\n=== SCAN COMPLETE ===`, 'info');
                    if (pendingCount > 0) {
                        appendOutput(`Pending Changes: ${pendingCount} device(s)`, 'warning');
                        appendOutput(`Synchronized: ${syncedCount} device(s)`, 'success');
                        appendOutput(`\nDevices with pending changes:`, 'warning');
                        for (const d of pendingDevices) {
                            appendOutput(`  • ${d}`, 'warning');
                        }
                    } else {
                        appendOutput(`All ${allDevices.size} devices are synchronized!`, 'success');
                    }
                    
                    appendOutput('\n--- Full Diff Output ---\n');
                    appendFormattedOutput(output);
                    
                    // Show diff modal popup (same as runDiff)
                    const summary = extractDiffSummary(output);
                    if (summary) {
                        showDiffModal(summary, pendingCount);
                    } else {
                        const fallbackMsg = pendingCount > 0 
                            ? `${pendingCount} device(s) have configuration changes.\n\nCheck the output panel for details.`
                            : 'All devices are in sync with Ansible configurations.';
                        showDiffModal(fallbackMsg, pendingCount);
                    }
                } else {
                    appendOutput('Scan failed!', 'error');
                    appendFormattedOutput(result.error || result.output || 'Unknown error');
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
            }
            
            showLoading(false);
            updateLastUpdated();
        }
        
        async function runDeploy() {
            const selected = getSelectedDevices();
            if (selected.length === 0) {
                showAlert('Please select at least one device', 'warning', 'No Selection');
                return;
            }
            
            const hosts = selected.join(',');
            const confirmMsg = `Are you sure you want to deploy to ${selected.length} device(s)?\n\n` +
                `Devices:\n${selected.slice(0, 10).join('\n')}` +
                (selected.length > 10 ? `\n... and ${selected.length - 10} more` : '') +
                `\n\nThis will apply changes to live network devices!`;
            
            const confirmed = await confirmAsync(confirmMsg, 'Confirm Deploy');
            if (!confirmed) {
                return;
            }
            
            showLoading(true, `Deploying to ${selected.length} device(s)...`);
            clearOutput();
            appendOutput(`=== DEPLOY: ${selected.length} device(s) ===`, 'warning');
            appendOutput(`Devices: ${hosts}\n`);
            
            try {
                const result = await ansibleApiCall('deploy', hosts);
                
                if (result.success) {
                    appendOutput('Deployment completed!', 'success');
                    appendFormattedOutput(result.output || '');
                    
                    // Clear modified status for deployed devices
                    for (const hostname of selected) {
                        modifiedDevices.delete(hostname);
                    }
                    renderDeviceList();
                    updateSummaryCards();
                    showLoading(false);
                } else {
                    appendOutput('Deployment failed!', 'error');
                    appendFormattedOutput(result.error || result.output || 'Unknown error');
                    showLoading(false);
                }
            } catch (e) {
                appendOutput('Error: ' + e.message, 'error');
                showLoading(false);
            }
        }
        
        // Custom Alert Modal
        function showAlert(message, type = 'warning', title = 'Warning') {
            const modal = document.getElementById('alert-modal');
            const header = document.getElementById('alert-modal-header');
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            header.className = 'alert-modal-header ' + type;
            modal.classList.add('visible');
        }
        
        function hideAlertModal() {
            document.getElementById('alert-modal').classList.remove('visible');
        }
        
        // Custom Confirm Modal
        let confirmResolve = null;
        
        function confirmAsync(message, title = 'Confirm Action') {
            return new Promise((resolve) => {
                confirmResolve = resolve;
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-message').textContent = message;
                document.getElementById('confirm-modal').classList.add('visible');
            });
        }
        
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('visible');
            if (confirmResolve) {
                confirmResolve(false);
                confirmResolve = null;
            }
        }
        
        function executeConfirm() {
            document.getElementById('confirm-modal').classList.remove('visible');
            if (confirmResolve) {
                confirmResolve(true);
                confirmResolve = null;
            }
        }
    </script>
    
    <!-- Alert Modal -->
    <div id="alert-modal" class="alert-modal" onclick="if(event.target === this) hideAlertModal()">
        <div class="alert-modal-content">
            <div id="alert-modal-header" class="alert-modal-header warning">
                <h3 id="alert-modal-title">Warning</h3>
                <button class="alert-modal-close" onclick="hideAlertModal()">&times;</button>
            </div>
            <div class="alert-modal-body">
                <p id="alert-modal-message"></p>
            </div>
            <div class="alert-modal-footer">
                <button class="btn btn-primary" onclick="hideAlertModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="confirm-modal" onclick="if(event.target === this) closeConfirmModal()">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <h3 id="confirm-modal-title">Confirm Action</h3>
                <button class="confirm-modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="confirm-modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="confirm-modal-footer">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-danger" onclick="executeConfirm()">Deploy</button>
            </div>
        </div>
    </div>
</body>
</html>
