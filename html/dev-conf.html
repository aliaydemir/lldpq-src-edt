<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>..::LLDPQ::..</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <script src="/css/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Layout */
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Left Panel - Device List */
        .device-panel {
            width: 280px;
            background: #252526;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 15px;
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-header svg { width: 20px; height: 20px; }
        
        .search-box {
            padding: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #76b900;
        }
        
        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .device-group { margin-bottom: 5px; }
        
        .group-header {
            padding: 8px 15px;
            background: #2d2d2d;
            color: #999;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }
        
        .group-header:hover { background: #333; }
        .group-header .arrow { transition: transform 0.2s; }
        .group-header.collapsed .arrow { transform: rotate(-90deg); }
        .group-devices { display: block; }
        .group-devices.collapsed { display: none; }
        
        .device-item {
            padding: 10px 15px 10px 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .device-item:hover { background: #2a2d2e; }
        
        .device-item.selected {
            background: #37373d;
            border-left-color: #76b900;
        }
        
        .device-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #76b900;
        }
        
        .device-name {
            font-size: 13px;
            color: #d4d4d4;
        }
        
        .device-count {
            padding: 10px 15px;
            font-size: 12px;
            color: #888;
            border-top: 1px solid #404040;
            background: #2d2d2d;
        }
        
        /* Right Panel - Content */
        .content-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 15px 20px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title {
            font-size: 18px;
            font-weight: 600;
            color: #76b900;
        }
        
        .content-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn svg { width: 14px; height: 14px; }
        
        .btn-primary {
            background: #76b900;
            color: #000;
        }
        
        .btn-primary:hover {
            background: #8bd400;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #0097a7;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #00acc1;
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            color: #d4d4d4;
            border: 1px solid #555;
        }
        
        .btn-outline:hover {
            background: #3c3c3c;
            border-color: #76b900;
        }
        
        .format-selector {
            display: flex;
            gap: 5px;
            background: #1e1e1e;
            padding: 4px;
            border-radius: 6px;
        }
        
        .format-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: #888;
            transition: all 0.2s;
        }
        
        .format-btn.active {
            background: #76b900;
            color: #000;
            font-weight: 600;
        }
        
        .format-btn:hover:not(.active) {
            color: #d4d4d4;
        }
        
        /* Content Area - same as fabric-config */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .welcome-screen svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .welcome-screen h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #888;
        }
        
        .welcome-screen p {
            font-size: 14px;
        }
        
        /* Config Display */
        .config-display {
            background: #252526;
            border: 1px solid #404040;
            border-radius: 8px;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #333;
            border-bottom: 1px solid #404040;
            border-radius: 8px 8px 0 0;
        }
        
        .config-title {
            font-size: 14px;
            font-weight: 600;
            color: #76b900;
        }
        
        .download-single-btn {
            background: #76b900;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        
        .download-single-btn:hover {
            background: #8bd400;
            transform: scale(1.05);
        }
        
        .download-single-btn svg {
            width: 16px;
            height: 16px;
            fill: #000;
        }
        
        .config-info {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 15px;
        }
        
        .config-content {
            padding: 16px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Syntax highlighting */
        .config-line { display: block; margin: 1px 0; }
        .comment { color: #6a9955; font-style: italic; }
        .keyword { color: #569cd6; font-weight: bold; }
        .string { color: #ce9178; }
        .number { color: #d7ba7d; }
        .ip-number { color: #ffffff; }
        .variable { color: #9cdcfe; }
        .section { color: #dcdcaa; font-weight: bold; }
        .interface { color: #4ec9b0; }
        .yaml-key { color: #92c5f7; font-weight: bold; }
        .yaml-value { color: #ce9178; }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-overlay.visible { display: flex; }
        
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-text { color: #888; font-size: 14px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Device List -->
        <div class="device-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1"/>
                </svg>
                Device Configs
            </div>
            <div class="search-box">
                <input type="text" id="deviceSearch" placeholder="Search devices..." oninput="filterDevices()">
            </div>
            <div class="device-list" id="deviceList">
                <!-- Device list will be populated here -->
            </div>
            <div class="device-count" id="deviceCount">Loading devices...</div>
        </div>
        
        <!-- Right Panel - Content -->
        <div class="content-panel">
            <div class="content-header">
                <div>
                    <div class="content-title" id="contentTitle">Device Configurations</div>
                    <div class="content-subtitle" id="contentSubtitle">Select a device to view configuration</div>
                </div>
                <div class="action-buttons">
                    <div class="format-selector" id="formatSelector" style="display: none;">
                        <button class="format-btn active" data-format="txt" onclick="selectFormat('txt')">NV-SET</button>
                        <button class="format-btn" data-format="yaml" onclick="selectFormat('yaml')">YAML</button>
                    </div>
                    <button class="btn" onclick="runValidate()" id="btn-validate" style="background: #0097a7; color: #fff; display: none;">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Validate
                    </button>
                    <button class="btn btn-primary" onclick="downloadAllConfigs('txt')" id="download-nvset">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                        </svg>
                        Download All NV-SET
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAllConfigs('yaml')" id="download-yaml">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                        </svg>
                        Download All YAML
                    </button>
                </div>
            </div>
            
            <div class="content-area" id="contentArea">
                <div class="welcome-screen" id="welcomeScreen">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <h2>Device Configuration Viewer</h2>
                    <p>Select a device from the left panel to view its configuration</p>
                </div>
                
                <div class="config-display" id="configDisplay" style="display: none;">
                    <div class="config-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="config-title" id="configTitle">Configuration</div>
                            <button class="download-single-btn" onclick="downloadCurrentConfig()" title="Download this config">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                    <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="config-info">
                            <span id="configFormat">Format: NV-SET</span>
                            <span id="configSize">Size: 0 bytes</span>
                        </div>
                    </div>
                    <div class="config-content" id="configContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Validate Modal -->
    <div id="validateModal" class="validate-modal">
        <div class="validate-modal-content">
            <div class="validate-modal-header" id="validateModalHeader">
                <h3 id="validateModalTitle">Validation Results</h3>
                <button class="validate-modal-close" onclick="hideValidateModal()">&times;</button>
            </div>
            <div class="validate-modal-body" id="validateModalBody"></div>
            <div class="validate-modal-footer">
                <button class="btn btn-outline" onclick="hideValidateModal()">Close</button>
            </div>
        </div>
    </div>
    
    <style>
        .validate-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .validate-modal.visible { display: flex; }
        .validate-modal-content {
            background: #252526;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #404040;
        }
        .validate-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
            border-radius: 8px 8px 0 0;
        }
        .validate-modal-header.success { background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%); }
        .validate-modal-header.error { background: linear-gradient(135deg, #5c1a1a 0%, #3d1111 100%); }
        .validate-modal-header.warning { background: linear-gradient(135deg, #5c4a1a 0%, #3d3111 100%); }
        .validate-modal-header h3 { margin: 0; color: #fff; font-size: 16px; }
        .validate-modal-close { background: none; border: none; color: #999; font-size: 24px; cursor: pointer; }
        .validate-modal-close:hover { color: #fff; }
        .validate-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .validate-modal-footer { padding: 15px 20px; border-top: 1px solid #404040; text-align: right; }
    </style>
    
    <script>
        let files = [];
        let devices = [];
        let deviceGroups = {};
        let groupOrder = [];
        let selectedDevice = null;
        let selectedFormat = 'txt';
        let currentConfigContent = '';
        
        function showLoading(text = 'Loading...') {
            document.getElementById('loadingOverlay').classList.add('visible');
            document.getElementById('loadingText').textContent = text;
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('visible');
        }
        
        function listFiles() {
            fetch('/configs/')
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const htmlDoc = parser.parseFromString(data, 'text/html');
                    files = Array.from(htmlDoc.querySelectorAll('a'))
                        .map(a => a.getAttribute('href'))
                        .filter(file => file !== '../');
                    extractDevices();
                })
                .catch(error => {
                    console.error('Error fetching file list:', error);
                    document.getElementById('deviceCount').textContent = 'Error loading devices';
                });
        }
        
        function extractDevices() {
            const deviceSet = new Set();
            files.forEach(file => {
                const fileName = file.split('/').pop();
                const deviceName = fileName.split('.')[0];
                deviceSet.add(deviceName);
            });
            devices = Array.from(deviceSet).sort();
            
            // Get groups from fabric-api (same as fabric-config.html)
            fetchDeviceGroups();
        }
        
        async function fetchDeviceGroups() {
            try {
                const response = await fetch('/fabric-api.sh?action=list-devices');
                const data = await response.json();
                
                if (data.success && data.devices) {
                    // Use same groups as fabric-config.html - preserve API order
                    deviceGroups = {};
                    groupOrder = Object.keys(data.devices); // Preserve order from API
                    
                    for (const [group, groupDevices] of Object.entries(data.devices)) {
                        // Include all groups (even empty ones) like fabric-config
                        const hostnames = groupDevices.map(d => d.hostname);
                        const validHosts = hostnames.filter(h => devices.includes(h));
                        deviceGroups[group] = validHosts.sort();
                    }
                } else {
                    // Fallback to name-based grouping
                    groupDevicesByName();
                }
            } catch (e) {
                console.error('Failed to fetch device groups:', e);
                groupDevicesByName();
            }
            
            renderDeviceList();
        }
        
        function groupDevicesByName() {
            deviceGroups = {};
            groupOrder = [];
            devices.forEach(device => {
                // Extract group from device name (e.g., csw, ssw, lsw, osw)
                const match = device.match(/^([a-z]+)-/i);
                const group = match ? match[1].toLowerCase() : 'other';
                if (!deviceGroups[group]) {
                    deviceGroups[group] = [];
                    groupOrder.push(group);
                }
                deviceGroups[group].push(device);
            });
        }
        
        function renderDeviceList() {
            const container = document.getElementById('deviceList');
            container.innerHTML = '';
            
            // Use same order as fabric-config.html (from API)
            const groups = groupOrder.length > 0 ? groupOrder : Object.keys(deviceGroups).sort();
            
            groups.forEach(group => {
                if (!deviceGroups[group]) return;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'device-group';
                groupDiv.dataset.group = group;
                
                // Start collapsed like fabric-config.html
                const header = document.createElement('div');
                header.className = 'group-header collapsed';
                header.innerHTML = `
                    <span class="arrow">▼</span>
                    ${group} (${deviceGroups[group].length})
                `;
                header.onclick = () => toggleGroup(header);
                
                const devicesDiv = document.createElement('div');
                devicesDiv.className = 'group-devices collapsed';
                
                deviceGroups[group].forEach(device => {
                    const item = document.createElement('div');
                    item.className = 'device-item';
                    item.dataset.device = device;
                    item.innerHTML = `
                        <div class="device-icon"></div>
                        <span class="device-name">${device}</span>
                    `;
                    item.onclick = () => selectDevice(device);
                    devicesDiv.appendChild(item);
                });
                
                groupDiv.appendChild(header);
                groupDiv.appendChild(devicesDiv);
                container.appendChild(groupDiv);
            });
            
            document.getElementById('deviceCount').textContent = `${devices.length} devices`;
        }
        
        function toggleGroup(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        }
        
        function filterDevices() {
            const search = document.getElementById('deviceSearch').value.toLowerCase();
            document.querySelectorAll('.device-item').forEach(item => {
                const device = item.dataset.device.toLowerCase();
                item.style.display = device.includes(search) ? '' : 'none';
            });
            
            // Show/hide groups based on visible items
            document.querySelectorAll('.device-group').forEach(group => {
                const visibleItems = group.querySelectorAll('.device-item[style=""]').length + 
                                    group.querySelectorAll('.device-item:not([style])').length;
                group.style.display = visibleItems > 0 ? '' : 'none';
            });
        }
        
        function selectDevice(device) {
            selectedDevice = device;
            
            // Update selection UI
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.device === device);
            });
            
            // Update header
            document.getElementById('contentTitle').textContent = device;
            document.getElementById('contentSubtitle').textContent = 'Configuration file';
            document.getElementById('formatSelector').style.display = 'flex';
            document.getElementById('btn-validate').style.display = 'flex';
            
            // Load config
            loadConfig();
        }
        
        // Validate functions
        function showValidateModal(title, content, type = 'success') {
            const modal = document.getElementById('validateModal');
            const header = document.getElementById('validateModalHeader');
            document.getElementById('validateModalTitle').textContent = title;
            document.getElementById('validateModalBody').innerHTML = content;
            header.className = 'validate-modal-header ' + type;
            modal.classList.add('visible');
        }
        
        function hideValidateModal() {
            document.getElementById('validateModal').classList.remove('visible');
        }
        
        async function runValidate() {
            if (!selectedDevice) {
                alert('Please select a device first');
                return;
            }
            
            showLoading(`Validating ${selectedDevice}...`);
            
            try {
                const response = await fetch(`/edit-config?action=validate&devices=${encodeURIComponent(selectedDevice)}`);
                const data = await response.json();
                
                hideLoading();
                
                if (!data.success) {
                    showValidateModal('Validation Error', `<div style="color: #f44336;">${data.error || 'Unknown error'}</div>`, 'error');
                    return;
                }
                
                const result = data.result;
                const summary = result.summary;
                const isValid = result.valid;
                const statusColor = isValid ? '#76b900' : '#f44336';
                const statusIcon = isValid ? '✓' : '✗';
                
                let html = '<div style="font-family: monospace; font-size: 13px;">';
                
                // Summary
                html += `<div style="padding: 15px; background: ${isValid ? 'rgba(118,185,0,0.1)' : 'rgba(244,67,54,0.1)'}; border-radius: 8px; margin-bottom: 15px; border: 1px solid ${statusColor};">`;
                html += `<div style="font-size: 18px; color: ${statusColor}; margin-bottom: 10px;">${statusIcon} ${isValid ? 'Configuration Valid' : 'Validation Issues Found'}</div>`;
                html += `<div style="color: #ccc;">`;
                html += `<div>Device: <span style="color: #4fc3f7; font-weight: bold;">${selectedDevice}</span></div>`;
                html += `<div>Issues: <span style="color: #f44336;">${summary.total_errors} errors</span>, <span style="color: #ff9800;">${summary.total_warnings} warnings</span></div>`;
                html += '</div></div>';
                
                // File issues
                const filesWithIssues = result.files.filter(f => f.issues && f.issues.length > 0);
                if (filesWithIssues.length > 0) {
                    filesWithIssues.forEach(file => {
                        file.issues.forEach(issue => {
                            const sevColor = issue.severity === 'ERROR' ? '#f44336' : '#ff9800';
                            html += `<div style="margin-bottom: 8px; border-left: 2px solid ${sevColor}; padding-left: 10px;">`;
                            html += `<span style="color: ${sevColor}; font-weight: bold;">[${issue.severity}]</span> `;
                            html += `<span style="color: #888;">${issue.path}:</span> `;
                            html += `<span style="color: #ddd;">${issue.message}</span>`;
                            if (issue.suggestion) {
                                html += `<div style="color: #999; font-style: italic;">→ ${issue.suggestion}</div>`;
                            }
                            html += '</div>';
                        });
                    });
                }
                
                html += '</div>';
                
                showValidateModal(
                    isValid ? 'Validation Passed' : 'Validation Results',
                    html,
                    isValid ? 'success' : 'warning'
                );
                
            } catch (e) {
                hideLoading();
                showValidateModal('Error', `<div style="color: #f44336;">Failed to validate: ${e.message}</div>`, 'error');
            }
        }
        
        function selectFormat(format) {
            selectedFormat = format;
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.format === format);
            });
            loadConfig();
        }
        
        function loadConfig() {
            if (!selectedDevice) return;
            
            const fileName = `${selectedDevice}.${selectedFormat}`;
            
            if (!files.includes(fileName)) {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('configDisplay').style.display = 'block';
                document.getElementById('configContent').innerHTML = `<span style="color: #f44336;">Configuration file not found: ${fileName}</span>`;
                return;
            }
            
            showLoading(`Loading ${fileName}...`);
            
            fetch(`/configs/${fileName}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(data => {
                    hideLoading();
                    displayConfig(data, fileName);
                })
                .catch(error => {
                    hideLoading();
                    document.getElementById('configContent').innerHTML = `<span style="color: #f44336;">Error loading config: ${error.message}</span>`;
                });
        }
        
        function displayConfig(content, fileName) {
            document.getElementById('welcomeScreen').style.display = 'none';
            const configDisplay = document.getElementById('configDisplay');
            configDisplay.style.display = 'block';
            
            // Store for download
            currentConfigContent = content;
            
            document.getElementById('configTitle').textContent = fileName;
            document.getElementById('configFormat').textContent = `Format: ${selectedFormat === 'txt' ? 'NV-SET' : 'YAML'}`;
            document.getElementById('configSize').textContent = `Size: ${formatFileSize(content.length)}`;
            
            const container = document.getElementById('configContent');
            container.innerHTML = '';
            
            const lines = content.split('\n');
            lines.forEach(line => {
                const span = document.createElement('span');
                span.className = 'config-line';
                
                if (selectedFormat === 'yaml') {
                    span.innerHTML = highlightYaml(line);
                } else {
                    span.innerHTML = highlightNvSet(line);
                }
                
                container.appendChild(span);
            });
        }
        
        function highlightNvSet(line) {
            if (line.trim().startsWith('#')) {
                return `<span class="comment">${escapeHtml(line)}</span>`;
            }
            
            let result = escapeHtml(line);
            
            // Highlight nv set
            result = result.replace(/^(nv set)/g, '<span class="keyword">$1</span>');
            
            // Highlight interface names
            result = result.replace(/\b(swp\d+s?\d*|bond\d+|vlan\d+|lo|eth\d+)/g, '<span class="interface">$1</span>');
            
            // Highlight IP addresses
            result = result.replace(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(\/\d+)?)/g, '<span class="ip-number">$1</span>');
            
            return result || ' ';
        }
        
        function highlightYaml(line) {
            if (line.trim().startsWith('#')) {
                return `<span class="comment">${escapeHtml(line)}</span>`;
            }
            
            // Key-value pairs
            const match = line.match(/^(\s*)([^:]+):\s*(.*)$/);
            if (match) {
                const indent = match[1];
                const key = match[2];
                const value = match[3];
                
                let result = indent + `<span class="yaml-key">${escapeHtml(key)}</span>:`;
                if (value) {
                    result += ` <span class="yaml-value">${escapeHtml(value)}</span>`;
                }
                return result;
            }
            
            // List items
            if (line.trim().startsWith('-')) {
                return `<span class="yaml-value">${escapeHtml(line)}</span>`;
            }
            
            return escapeHtml(line) || ' ';
        }
        
        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        function downloadCurrentConfig() {
            if (!selectedDevice || !currentConfigContent) return;
            
            const fileName = `${selectedDevice}.${selectedFormat}`;
            const blob = new Blob([currentConfigContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function downloadAllConfigs(format) {
            const button = document.getElementById(format === 'txt' ? 'download-nvset' : 'download-yaml');
            const originalHtml = button.innerHTML;
            
            const formatFiles = files.filter(file => file.endsWith(`.${format}`));
            
            if (formatFiles.length === 0) {
                alert(`No ${format.toUpperCase()} files found.`);
                return;
            }
            
            button.disabled = true;
            button.innerHTML = `<div class="loading-spinner" style="width:14px;height:14px;border-width:2px;"></div> Creating ZIP...`;
            
            const zip = new JSZip();
            let completed = 0;
            
            formatFiles.forEach(filename => {
                fetch(`/configs/${filename}`)
                    .then(r => r.text())
                    .then(content => {
                        zip.file(filename, content);
                        completed++;
                        
                        if (completed === formatFiles.length) {
                            zip.generateAsync({type: 'blob'}).then(blob => {
                                const now = new Date();
                                const dateStr = now.toISOString().slice(0, 10);
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = `Configs_${format.toUpperCase()}_${dateStr}.zip`;
                                link.click();
                                
                                button.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg> Downloaded!`;
                                setTimeout(() => {
                                    button.disabled = false;
                                    button.innerHTML = originalHtml;
                                }, 2000);
                            });
                        }
                    })
                    .catch(() => {
                        completed++;
                    });
            });
        }
        
        // Initialize
        window.onload = listFiles;
    </script>
</body>
</html>
