<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>..::LLDPQ::..</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <script src="/css/auth.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/styles2.css">
    <link rel="stylesheet" type="text/css" href="/css/select2.min.css">
    <style>
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .summary-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .card-excellent { border-left-color: #4caf50; }
        .card-good { border-left-color: #8bc34a; }
        .card-warning { border-left-color: #ff9800; }
        .card-critical { border-left-color: #f44336; }
        .card-total { border-left-color: #2196f3; }
        .card-info { border-left-color: #2196f3; }
        .card-value { font-size: 24px; font-weight: bold; color: #333; }
        
        /* Colored card values */
        .card-excellent .card-value { color: #4caf50; }
        .card-good .card-value { color: #8bc34a; }
        .card-warning .card-value { color: #ff9800; }
        .card-critical .card-value { color: #f44336; }
        .card-total .card-value { color: #333; }
        .card-info .card-value { color: #2196f3; }
        .card-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .summary-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .summary-card.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-left-width: 6px;
        }
        
        .filter-info {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #e8f4fd;
            border-radius: 4px;
            color: #1976d2;
            display: none;
        }
        
        .status-success { color: #4caf50; font-weight: bold; }
        .status-fail { color: #f44336; font-weight: bold; }
        .status-warning { color: #ff9800; font-weight: bold; }
        .status-no-info { color: #f44336; font-weight: bold; }
        
        .port-status-up { color: #4caf50; font-weight: bold; }
        .port-status-down { color: #f44336; font-weight: bold; }
        
        .lldp-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .lldp-table th, .lldp-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .lldp-table th { background-color: #f2f2f2; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
            background: #ffeaea;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Sortable table styling */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }
        
        .sortable:hover {
            background-color: #f5f5f5;
        }
        
        .sort-arrow {
            font-size: 10px;
            color: #999;
            margin-left: 5px;
            opacity: 0.5;
        }
        
        .sortable.asc .sort-arrow::before {
            content: '‚ñ≤';
            color: #b57614;
            opacity: 1;
        }
        
        .sortable.desc .sort-arrow::before {
            content: '‚ñº';
            color: #b57614;
            opacity: 1;
        }
        
        .sortable.asc .sort-arrow,
        .sortable.desc .sort-arrow {
            opacity: 1;
        }
        
        /* Device Search Box - Match Run button height (padding 8px + font 14px + border) */
        .device-search-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .device-search-container .select2-container {
            min-width: 250px;
        }
        .device-search-container .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ccc;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
            color: #333;
            padding-left: 8px;
            font-size: 14px;
        }
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }
        .device-search-container .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #999;
        }
        .clear-search-btn {
            background: #ff5722;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: none;
            transition: all 0.3s ease;
        }
        .clear-search-btn:hover {
            background: #e64a19;
        }
        .highlight-row {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>
    <h1></h1>
    <h1><font color="#b57614">LLDP Network Topology Analysis</font></h1>
    <p><strong>Last Updated:</strong> <span id="last-updated"></span></p>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">LLDP Connection Summary</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <!-- Device Search Box -->
            <div class="device-search-container">
                <select id="deviceSearch" style="width: 250px;">
                    <option value="">Search Device...</option>
                </select>
                <button id="clearSearchBtn" class="clear-search-btn" onclick="clearDeviceSearch()">‚úï</button>
            </div>
            <button id="run-lldp" onclick="runLLDPCheck()" 
                    style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#1976d2'" 
                    onmouseout="this.style.background='#2196f3'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                </svg>
                <span id="run-lldp-text">Run LLDP Check</span>
            </button>
            <button id="edit-topology" onclick="openTopologyEditor()" 
                    style="background: #607d8b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#546e7a'" 
                    onmouseout="this.style.background='#607d8b'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                </svg>
                Edit Topology
            </button>
            <button id="download-csv" onclick="downloadCSV()" 
                    style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#45a049'" 
                    onmouseout="this.style.background='#4caf50'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Download CSV
            </button>
        </div>
    </div>
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-connections">0</div>
            <div class="card-label">Total Connections</div>
        </div>
        <div class="summary-card card-excellent">
            <div class="card-value" id="success-connections">0</div>
            <div class="card-label">Successful Links</div>
        </div>
        <div class="summary-card card-critical">
            <div class="card-value" id="failed-connections">0</div>
            <div class="card-label">Failed Links</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="warning-connections">0</div>
            <div class="card-label">Warning Links</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="no-info-connections">0</div>
            <div class="card-label">No Information</div>
        </div>
    </div>
    
    <h2>LLDP Connection Status</h2>
    <div id="filter-info" class="filter-info">
        <span id="filter-text"></span>
        <button onclick="clearFilter()" style="margin-left: 10px; padding: 2px 8px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer;">Show All</button>
    </div>
    <div id="loading" class="loading">
        <p>Loading LLDP topology data...</p>
    </div>
    <div id="error" class="error" style="display: none;">
        <p>Error loading LLDP data. Please check if the data file exists.</p>
    </div>
    <table class="lldp-table" id="lldp-table" style="display: none;">
        <thead>
        <tr>
            <th class="sortable" data-column="0" data-type="string">
                Local Device <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="1" data-type="port">
                Local Port <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="2" data-type="port-status">
                Port Status <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="3" data-type="string">
                Expected Neighbor <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="4" data-type="port">
                Expected Neighbor Port <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="5" data-type="string">
                Active Neighbor <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="6" data-type="port">
                Active Neighbor Port <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="7" data-type="lldp-status">
                Status <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
            <th class="sortable" data-column="8" data-type="string">
                Connection Health <span class="sort-arrow">‚ñ≤‚ñº</span>
            </th>
        </tr>
        </thead>
        <tbody id="lldp-data">
        </tbody>
    </table>

    <!-- jQuery and Select2 for device search -->
    <script src="/css/jquery-3.5.1.min.js"></script>
    <script src="/css/select2.min.js"></script>

    <script>
        let totalConnections = 0;
        let successConnections = 0;
        let failedConnections = 0;
        let warningConnections = 0;
        let noInfoConnections = 0;
        
        // Filter state
        let currentFilter = 'ALL';
        let allConnections = [];

        function updateSummaryCards() {
            document.getElementById('total-connections').textContent = totalConnections;
            document.getElementById('success-connections').textContent = successConnections;
            document.getElementById('failed-connections').textContent = failedConnections;
            document.getElementById('warning-connections').textContent = warningConnections;
            document.getElementById('no-info-connections').textContent = noInfoConnections;
        }
        
        function filterConnections(filterType) {
            if (allConnections.length === 0) return;
            
            currentFilter = filterType;
            
            // Clear device search when using card filters
            if (deviceSearchActive) {
                selectedDevice = '';
                deviceSearchActive = false;
                $('#deviceSearch').val('').trigger('change');
                document.getElementById('clearSearchBtn').style.display = 'none';
            }
            
            // Clear active state from all cards
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            let filteredConnections = allConnections;
            let filterText = '';
            
            if (filterType === 'SUCCESS') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'SUCCESS');
                filterText = `Showing ${filteredConnections.length} Successful Links`;
                document.getElementById('success-connections').parentElement.classList.add('active');
            } else if (filterType === 'FAILED') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'FAILED');
                filterText = `Showing ${filteredConnections.length} Failed Links`;
                document.getElementById('failed-connections').parentElement.classList.add('active');
            } else if (filterType === 'WARNING') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'WARNING');
                filterText = `Showing ${filteredConnections.length} Warning Links`;
                document.getElementById('warning-connections').parentElement.classList.add('active');
            } else if (filterType === 'NO_INFO') {
                filteredConnections = allConnections.filter(conn => determineLLDPStatus(conn).status === 'NO INFO');
                filterText = `Showing ${filteredConnections.length} No Information Links`;
                document.getElementById('no-info-connections').parentElement.classList.add('active');
            } else if (filterType === 'TOTAL') {
                filteredConnections = allConnections;
                filterText = `Showing All ${filteredConnections.length} Connections`;
                document.getElementById('total-connections').parentElement.classList.add('active');
            }
            
            // Show filter info for all filters except TOTAL
            if (filterType !== 'ALL' && filterType !== 'TOTAL') {
                document.getElementById('filter-info').style.display = 'block';
                document.getElementById('filter-text').textContent = filterText;
            } else {
                document.getElementById('filter-info').style.display = 'none';
            }
            
            renderConnectionsTable(filteredConnections);
        }
        
        function clearFilter() {
            currentFilter = 'ALL';
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('filter-info').style.display = 'none';
            
            // Also clear device search
            if (deviceSearchActive) {
                selectedDevice = '';
                deviceSearchActive = false;
                $('#deviceSearch').val('').trigger('change');
                document.getElementById('clearSearchBtn').style.display = 'none';
            }
            
            renderConnectionsTable(allConnections);
        }

        function determineLLDPStatus(connection) {
            const { lldpStatus, expectedDevice, expectedPort, actualDevice, actualPort, portStatus, localPort } = connection;
            
            // Check if local port is N/A - this is a critical error
            if (!localPort || localPort === 'N/A' || localPort === '') {
                return {
                    status: 'FAILED',
                    healthClass: 'lldp-critical',
                    statusClass: 'status-fail',
                    health: 'Local Port Not Defined'
                };
            }
            
            // Based on actual LLDP status from the data
            if (lldpStatus === 'Pass') {
                return {
                    status: 'SUCCESS',
                    healthClass: 'lldp-excellent',
                    statusClass: 'status-success',
                    health: 'LLDP Connection Verified'
                };
            } else if (lldpStatus === 'No-Info') {
                // Check if port is physically down
                if (portStatus === 'DOWN') {
                    return {
                        status: 'NO INFO',
                        healthClass: 'lldp-unknown',
                        statusClass: 'status-no-info',
                        health: 'Local Port is DOWN'
                    };
                } else {
                    return {
                        status: 'NO INFO',
                        healthClass: 'lldp-unknown',
                        statusClass: 'status-no-info',
                        health: 'No LLDP Response Received'
                    };
                }
            } else if (lldpStatus === 'Fail') {
                // Check if port is physically down first
                if (portStatus === 'DOWN') {
                    return {
                        status: 'FAILED',
                        healthClass: 'lldp-critical',
                        statusClass: 'status-fail',
                        health: 'Local Port is DOWN'
                    };
                }
                // Check if it's a port mismatch (same device, different port)
                else if (actualDevice && expectedDevice && actualDevice === expectedDevice && 
                    actualPort && expectedPort && actualPort !== expectedPort) {
                    return {
                        status: 'WARNING',
                        healthClass: 'lldp-warning',
                        statusClass: 'status-warning',
                        health: `Port Mismatch: Expected ${expectedPort}, Got ${actualPort}`
                    };
                }
                // Device mismatch (wrong device connected) - also WARNING now
                else if (actualDevice && expectedDevice && actualDevice !== expectedDevice) {
                    return {
                        status: 'WARNING',
                        healthClass: 'lldp-warning',
                        statusClass: 'status-warning',
                        health: `Wrong Device: Expected ${expectedDevice}, Got ${actualDevice}`
                    };
                }
                // Other fail cases (unexpected connection, etc.)
                else {
                    return {
                        status: 'WARNING',
                        healthClass: 'lldp-warning',
                        statusClass: 'status-warning',
                        health: 'Unexpected Connection'
                    };
                }
            } else {
                // Unknown status - treat as warning
                return {
                    status: 'WARNING',
                    healthClass: 'lldp-warning',
                    statusClass: 'status-warning',
                    health: `Unknown Status: ${lldpStatus}`
                };
            }
        }
        
        function renderConnectionsTable(connections) {
            const tbody = document.getElementById('lldp-data');
            tbody.innerHTML = '';
            
            connections.forEach(connection => {
                const status = determineLLDPStatus(connection);
                const row = tbody.insertRow();
                row.className = status.healthClass;
                
                row.insertCell(0).textContent = connection.localDevice;
                row.insertCell(1).textContent = connection.localPort;
                
                // Port Status cell (NEW)
                const portStatusCell = row.insertCell(2);
                const portStatus = connection.portStatus || 'N/A';
                let portStatusClass = '';
                if (portStatus === 'UP') {
                    portStatusClass = 'port-status-up';
                } else if (portStatus === 'DOWN') {
                    portStatusClass = 'port-status-down';
                } else {
                    portStatusClass = 'port-status-down';  // N/A or unknown = treat as down (red)
                }
                portStatusCell.innerHTML = `<span class="${portStatusClass}">${portStatus}</span>`;
                
                row.insertCell(3).textContent = connection.expectedDevice || 'N/A';
                row.insertCell(4).textContent = connection.expectedPort || 'N/A';
                row.insertCell(5).textContent = connection.actualDevice || 'N/A';
                row.insertCell(6).textContent = connection.actualPort || 'N/A';
                
                const statusCell = row.insertCell(7);
                statusCell.innerHTML = `<span class="${status.statusClass}">${status.status}</span>`;
                
                row.insertCell(8).textContent = status.health;
            });
        }

        function parseAndDisplayLLDPData(data) {
            const tbody = document.getElementById('lldp-data');
            tbody.innerHTML = '';
            
            const lines = data.split('\n');
            const connections = [];
            let currentDevice = '';
            
            console.log('Total lines to process:', lines.length);
            
            // Parse LLDP data based on actual format
            lines.forEach((line, index) => {
                line = line.trim();
                
                // Extract device name from header lines
                if (line.includes('===') && line.length > 20) {
                    const deviceMatch = line.match(/=+\s*(.+?)\s*=+/);
                    if (deviceMatch) {
                        currentDevice = deviceMatch[1].trim();
                        console.log('Found device:', currentDevice);
                    }
                    return;
                }
                
                // Skip header and separator lines
                if (!line || line.startsWith('Port') || line.startsWith('-') || 
                    line.startsWith('Created') || line.includes('===')) {
                    return;
                }
                
                // Parse port data lines
                const parts = line.split(/\s+/);
                if (parts.length >= 7 && currentDevice) {
                    const localPort = parts[0];
                    const status = parts[1];
                    const expectedDevice = parts[2];
                    const expectedPort = parts[3];
                    const actualDevice = parts[4] === 'None' ? null : parts[4];
                    const actualPort = parts[5] === 'None' ? null : parts[5];
                    const portStatus = parts[6] || 'N/A';
                    
                    connections.push({
                        localDevice: currentDevice,
                        localPort: localPort,
                        expectedDevice: expectedDevice,
                        expectedPort: expectedPort,
                        actualDevice: actualDevice,
                        actualPort: actualPort,
                        lldpStatus: status,
                        portStatus: portStatus,
                        originalLine: line
                    });
                } else if (parts.length >= 6) {
                    console.log('Skipping line (no current device):', line);
                } else if (currentDevice && parts.length > 0) {
                    console.log('Skipping line (not enough parts):', line, 'Parts:', parts.length);
                }
            });
            
            console.log('Total connections parsed:', connections.length);

            // Sort connections - problems first
            connections.sort((a, b) => {
                const statusA = determineLLDPStatus(a);
                const statusB = determineLLDPStatus(b);
                
                const priority = { 'FAILED': 0, 'NO INFO': 1, 'WARNING': 2, 'SUCCESS': 3 };
                return priority[statusA.status] - priority[statusB.status];
            });

            // Store all connections for filtering
            allConnections = connections;

            // Count by status
            totalConnections = 0;
            successConnections = 0;
            failedConnections = 0;
            warningConnections = 0;
            noInfoConnections = 0;
            
            connections.forEach(connection => {
                const status = determineLLDPStatus(connection);
                totalConnections++;
                if (status.status === 'SUCCESS') successConnections++;
                else if (status.status === 'FAILED') failedConnections++;
                else if (status.status === 'WARNING') warningConnections++;
                else if (status.status === 'NO INFO') noInfoConnections++;
            });

            updateSummaryCards();
            
            // Setup click events for summary cards
            setupSummaryCardEvents();
            
            // üöÄ Progressive loading: Show first 50 connections immediately
            const initialBatch = connections.slice(0, 50);
            renderConnectionsTable(initialBatch);
            
            // Show loading indicator for remaining data
            if (connections.length > 50) {
                const tbody = document.getElementById('lldp-data');
                const loadingRow = tbody.insertRow();
                loadingRow.innerHTML = '<td colspan="9" style="text-align: center; padding: 20px; color: #666; font-style: italic;">Loading remaining connections...</td>';
                
                // Load all connections after 20ms
                setTimeout(() => {
                    renderConnectionsTable(connections);
                }, 20);
            }
            
            // Initialize device search after data is loaded
            populateDeviceList();
            initDeviceSearch();
        }

        function showFallbackContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('lldp-table').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            
            // Reset summary cards to 0 when no data available
            totalConnections = 0;
            successConnections = 0;
            failedConnections = 0;
            warningConnections = 0;
            noInfoConnections = 0;
            updateSummaryCards();
            setLastUpdated();
        }
        
        function setLastUpdated(timestampFromFile) {
            let dateToUse;
            
            if (timestampFromFile) {
                // Parse "2025-08-05 04-22-30" format from lldp_results.ini
                const parts = timestampFromFile.trim().split(' ');
                if (parts.length === 2) {
                    const datePart = parts[0]; // "2025-08-05"
                    const timePart = parts[1].replace(/-/g, ':'); // "04-22-30" -> "04:22:30"
                    dateToUse = new Date(datePart + 'T' + timePart);
                } else {
                    // Fallback if format doesn't match
                    dateToUse = new Date();
                }
            } else {
                // Fallback to current time if no timestamp available
                dateToUse = new Date();
            }
            
                    const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
            const formattedDate = dateToUse.toLocaleString('en-US', options);
            document.getElementById('last-updated').textContent = formattedDate;
        }
        
        function setupSummaryCardEvents() {
            // Total connections card
            document.getElementById('total-connections').parentElement.addEventListener('click', function() {
                if (totalConnections > 0) filterConnections('TOTAL');
            });
            
            // Success connections card
            document.getElementById('success-connections').parentElement.addEventListener('click', function() {
                if (successConnections > 0) filterConnections('SUCCESS');
            });
            
            // Failed connections card
            document.getElementById('failed-connections').parentElement.addEventListener('click', function() {
                if (failedConnections > 0) filterConnections('FAILED');
            });
            
            // Warning connections card
            document.getElementById('warning-connections').parentElement.addEventListener('click', function() {
                if (warningConnections > 0) filterConnections('WARNING');
            });
            
            // No info connections card
            document.getElementById('no-info-connections').parentElement.addEventListener('click', function() {
                if (noInfoConnections > 0) filterConnections('NO_INFO');
            });
        }

        function loadLLDPData() {
            fetch('lldp_results.ini')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Data file not found. Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('lldp-table').style.display = 'table';
                    
                    // Extract timestamp from data (first line: "Created on YYYY-MM-DD HH-MM")
                    const firstLine = data.split('\n')[0];
                    if (firstLine.startsWith('Created on ')) {
                        const timestampStr = firstLine.replace('Created on ', '');
                        setLastUpdated(timestampStr);
                    } else {
                        setLastUpdated();
                    }
                    
                    parseAndDisplayLLDPData(data);
                })
                .catch(error => {
                    showFallbackContent();
                });
        }

        // Generic table sorting functionality
        let currentSort = { column: -1, direction: 'asc' };
        
        function initTableSorting() {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const column = parseInt(this.dataset.column);
                    const type = this.dataset.type;
                    
                    // Toggle sort direction
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.direction = 'asc';
                    }
                    currentSort.column = column;
                    
                    // Update header styling
                    headers.forEach(h => h.classList.remove('asc', 'desc'));
                    this.classList.add(currentSort.direction);
                    
                    // Sort table
                    sortLLDPTable(column, currentSort.direction, type);
                });
            });
        }
        
        function sortLLDPTable(columnIndex, direction, type) {
            const table = document.getElementById('lldp-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();
                
                // Extract actual text for status column (remove HTML)
                if (type === 'lldp-status') {
                    aVal = a.cells[columnIndex].querySelector('span')?.textContent || aVal;
                    bVal = b.cells[columnIndex].querySelector('span')?.textContent || bVal;
                }
                
                let result = 0;
                
                switch(type) {
                    case 'port':
                        result = comparePort(aVal, bVal);
                        break;
                    case 'lldp-status':
                        result = compareLLDPStatus(aVal, bVal);
                        break;
                    case 'port-status':
                        result = comparePortStatus(aVal, bVal);
                        break;
                    case 'string':
                    default:
                        result = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
                        break;
                }
                
                return direction === 'desc' ? -result : result;
            });
            
            // Clear tbody and add sorted rows back
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function comparePort(a, b) {
            if (a === 'N/A') return 1;
            if (b === 'N/A') return -1;
            
            // Handle port sorting (swp1, swp10, swp1s0, etc.)
            const extractPortNumber = (port) => {
                const match = port.match(/swp(\d+)(?:s(\d+))?/);
                if (match) {
                    const mainPort = parseInt(match[1]);
                    const subPort = match[2] ? parseInt(match[2]) : 0;
                    return mainPort * 1000 + subPort; // swp1 = 1000, swp1s0 = 1000, swp1s1 = 1001
                }
                return port.localeCompare(b, undefined, { numeric: true });
            };
            
            return extractPortNumber(a) - extractPortNumber(b);
        }
        
        function compareLLDPStatus(a, b) {
            const priority = {
                'FAILED': 0,
                'WARNING': 1,
                'NO INFO': 2,
                'SUCCESS': 3
            };
            
            return (priority[a] || 4) - (priority[b] || 4);
        }
        
        function comparePortStatus(a, b) {
            const priority = {
                'DOWN': 0,
                'UP': 1
            };
            
            // Treat N/A and unknown as DOWN for sorting
            return (priority[a] || 0) - (priority[b] || 0);
        }

        // Run LLDP Check Function
        function runLLDPCheck() {
            const button = document.getElementById('run-lldp');
            const buttonText = document.getElementById('run-lldp-text');
            const originalText = buttonText.textContent;
            
            // Disable button and show loading
            button.disabled = true;
            button.style.opacity = '0.7';
            button.style.cursor = 'not-allowed';
            buttonText.textContent = 'Running...';
            
            // Make request to trigger LLDP check via simple endpoint
            fetch('/trigger-lldp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ LLDP check response:', data);
                
                // Always show manual trigger instruction
                buttonText.textContent = '‚úì Triggered';
                button.style.background = '#4caf50';
                
                // Show instruction notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2196f3;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                    font-size: 14px;
                    max-width: 350px;
                    font-family: monospace;
                `;
                notification.innerHTML = `
                    <strong>‚úÖ LLDP Check Started</strong><br>
                    The topology analysis is running in the background.<br>
                    <small>Page will automatically refresh in 5 seconds to show the latest results.</small>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-refresh page after 7 seconds
                setTimeout(() => {
                    location.reload();
                }, 7000);
                
                // Auto-remove notification after 6 seconds (before refresh)
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 6000);
                
                // Reset button after 5 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.background = '#2196f3';
                    buttonText.textContent = originalText;
                }, 5000);
            })
            .catch(error => {
                console.error('‚ùå Error running LLDP check:', error);
                
                // Show error state
                buttonText.textContent = '‚úó Error';
                button.style.background = '#f44336';
                
                // Show error notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                    font-size: 14px;
                    max-width: 300px;
                `;
                notification.innerHTML = `
                    <strong>Error!</strong><br>
                    Could not start LLDP check. Please try again or contact administrator.
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.background = '#2196f3';
                    buttonText.textContent = originalText;
                }, 3000);
            });
        }

        // CSV Download Function
        function downloadCSV() {
            try {
                // Get current date for filename
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
                const timeStr = now.toTimeString().slice(0, 5).replace(':', '-'); // HH-MM
                const filename = `LLDP_Topology_Report_${dateStr}_${timeStr}.csv`;
                
                // Create CSV header
                const headers = [
                    'Local Device',
                    'Local Port',
                    'Port Status',
                    'Expected Neighbor',
                    'Expected Port',
                    'Active Neighbor',
                    'Active Port',
                    'Status',
                    'Connection Health'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                // Get table data (only visible rows)
                const table = document.getElementById('lldp-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                
                // Add summary stats as comments
                csvContent += `# LLDP Connection Summary Report\n`;
                csvContent += `# Generated: ${now.toLocaleString()}\n`;
                csvContent += `# Total Connections: ${document.getElementById('total-connections').textContent}\n`;
                csvContent += `# Successful Links: ${document.getElementById('success-connections').textContent}\n`;
                csvContent += `# Failed Links: ${document.getElementById('failed-connections').textContent}\n`;
                csvContent += `# Warning Links: ${document.getElementById('warning-connections').textContent}\n`;
                csvContent += `# No Information: ${document.getElementById('no-info-connections').textContent}\n`;
                csvContent += `#\n`;
                
                // Process each visible row
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 8) {
                            const rowData = [
                                cells[0].textContent.trim(), // Device
                                cells[1].textContent.trim(), // Local Port
                                cells[2].textContent.trim(), // Port Status
                                cells[3].textContent.trim(), // Expected Neighbor
                                cells[4].textContent.trim(), // Expected Port
                                cells[5].textContent.trim(), // Active Neighbor
                                cells[6].textContent.trim(), // Active Port
                                cells[7].textContent.trim(), // Status
                                cells[8].textContent.trim()  // Health
                            ];
                            
                            // Escape commas and quotes in data
                            const escapedData = rowData.map(field => {
                                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                                    return '"' + field.replace(/"/g, '""') + '"';
                                }
                                return field;
                            });
                            
                            csvContent += escapedData.join(',') + '\n';
                        }
                    }
                });
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`‚úÖ CSV downloaded: ${filename}`);
                
            } catch (error) {
                console.error('‚ùå Error generating CSV:', error);
                alert('Error generating CSV file. Please try again.');
            }
        }

        // ===== Device Search Functions =====
        let deviceSearchActive = false;
        let selectedDevice = '';
        
        function initDeviceSearch() {
            // Initialize Select2 with search capability
            $('#deviceSearch').select2({
                placeholder: 'Search Device...',
                allowClear: true,
                width: '250px',
                dropdownAutoWidth: true,
                matcher: function(params, data) {
                    // Custom matcher for case-insensitive search
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    if (typeof data.text === 'undefined') {
                        return null;
                    }
                    if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    return null;
                }
            });
            
            // Handle device selection
            $('#deviceSearch').on('select2:select', function(e) {
                const device = e.params.data.id;
                if (device) {
                    filterByDevice(device);
                }
            });
            
            // Handle clear selection
            $('#deviceSearch').on('select2:clear', function(e) {
                clearDeviceSearch();
            });
        }
        
        function populateDeviceList() {
            // Collect all unique device names from connections
            const deviceSet = new Set();
            
            allConnections.forEach(conn => {
                if (conn.localDevice) deviceSet.add(conn.localDevice);
                if (conn.expectedDevice && conn.expectedDevice !== 'N/A') deviceSet.add(conn.expectedDevice);
                if (conn.actualDevice && conn.actualDevice !== 'N/A') deviceSet.add(conn.actualDevice);
            });
            
            // Sort devices alphabetically
            const sortedDevices = Array.from(deviceSet).sort((a, b) => 
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );
            
            // Clear existing options and populate
            const select = document.getElementById('deviceSearch');
            select.innerHTML = '<option value="">üîç Search device...</option>';
            
            sortedDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device;
                option.textContent = device;
                select.appendChild(option);
            });
            
            // Reinitialize Select2 with new options
            $('#deviceSearch').trigger('change');
        }
        
        function filterByDevice(deviceName) {
            if (!deviceName || allConnections.length === 0) return;
            
            selectedDevice = deviceName;
            deviceSearchActive = true;
            
            // Clear card-based filter
            currentFilter = 'ALL';
            document.querySelectorAll('.summary-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Filter connections where device appears in any column
            const filteredConnections = allConnections.filter(conn => {
                return conn.localDevice === deviceName ||
                       conn.expectedDevice === deviceName ||
                       conn.actualDevice === deviceName;
            });
            
            // Show filter info
            document.getElementById('filter-info').style.display = 'block';
            document.getElementById('filter-text').textContent = 
                `Showing ${filteredConnections.length} connections for "${deviceName}"`;
            
            // Show clear button
            document.getElementById('clearSearchBtn').style.display = 'inline-block';
            
            // Render filtered table
            renderConnectionsTable(filteredConnections);
            
            console.log(`Device filter: ${deviceName}, found ${filteredConnections.length} connections`);
        }
        
        function clearDeviceSearch() {
            selectedDevice = '';
            deviceSearchActive = false;
            
            // Clear Select2 selection
            $('#deviceSearch').val('').trigger('change');
            
            // Hide clear button
            document.getElementById('clearSearchBtn').style.display = 'none';
            
            // Hide filter info
            document.getElementById('filter-info').style.display = 'none';
            
            // Render all connections
            renderConnectionsTable(allConnections);
        }

        // Load data when page loads
        window.addEventListener('load', function() {
            loadLLDPData();
            initTableSorting();
        });

        // ===== Topology Editor Functions =====
        function openTopologyEditor() {
            document.getElementById('topologyEditorModal').style.display = 'flex';
            document.getElementById('topologyEditorStatus').textContent = 'Loading...';
            
            fetch('/edit-topology')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('topologyEditor').value = data.content;
                        document.getElementById('topologyEditorStatus').textContent = '';
                    } else {
                        document.getElementById('topologyEditor').value = '# Error loading file: ' + data.error;
                        document.getElementById('topologyEditorStatus').textContent = 'Error: ' + data.error;
                    }
                })
                .catch(err => {
                    document.getElementById('topologyEditor').value = '# Error loading file';
                    document.getElementById('topologyEditorStatus').textContent = 'Error: ' + err.message;
                });
        }

        function closeTopologyEditor(event) {
            if (event.target === document.getElementById('topologyEditorModal')) {
                closeTopologyEditorModal();
            }
        }

        function closeTopologyEditorModal() {
            document.getElementById('topologyEditorModal').style.display = 'none';
        }

        function saveTopologyOnly() {
            const content = document.getElementById('topologyEditor').value;
            document.getElementById('topologyEditorStatus').textContent = 'Saving...';
            
            fetch('/edit-topology', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('topologyEditorStatus').textContent = 'Saved successfully!';
                    setTimeout(() => {
                        document.getElementById('topologyEditorStatus').textContent = '';
                    }, 3000);
                } else {
                    document.getElementById('topologyEditorStatus').textContent = 'Error: ' + data.error;
                }
            })
            .catch(err => {
                document.getElementById('topologyEditorStatus').textContent = 'Error: ' + err.message;
            });
        }

        function saveTopologyAndRun() {
            const content = document.getElementById('topologyEditor').value;
            document.getElementById('topologyEditorStatus').textContent = 'Saving...';
            
            fetch('/edit-topology', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('topologyEditorStatus').textContent = 'Saved! Running LLDP check...';
                    closeTopologyEditorModal();
                    runLLDPCheck();
                } else {
                    document.getElementById('topologyEditorStatus').textContent = 'Error: ' + data.error;
                }
            })
            .catch(err => {
                document.getElementById('topologyEditorStatus').textContent = 'Error: ' + err.message;
            });
        }
    </script>

    <!-- Topology Editor Modal -->
    <div id="topologyEditorModal" onclick="closeTopologyEditor(event)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
        <div onclick="event.stopPropagation()" style="background: #2d2d2d; border-radius: 8px; width: 80%; max-width: 900px; max-height: 90vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            <div style="padding: 15px 20px; background: #1a1a1a; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #76b900; font-size: 16px;">Edit Topology (topology.dot)</h3>
                <button onclick="closeTopologyEditorModal()" style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div style="padding: 0;">
                <div style="padding: 15px; background: #333; border-bottom: 1px solid #4a4a4a; font-size: 12px; color: #888;">
                    Format: <code style="color: #76b900;">"device1":"port1" -- "device2":"port2"</code>
                    &nbsp;|&nbsp; One link per line &nbsp;|&nbsp; Lines starting with # are comments
                </div>
                <textarea id="topologyEditor" style="width: 100%; height: 50vh; padding: 15px; border: none; background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; resize: vertical; box-sizing: border-box;" placeholder="Loading..."></textarea>
                <div style="padding: 15px; background: #333; border-top: 1px solid #4a4a4a; text-align: right; display: flex; justify-content: space-between; align-items: center;">
                    <span id="topologyEditorStatus" style="color: #888; font-size: 12px;"></span>
                    <div>
                        <button onclick="closeTopologyEditorModal()" style="background: #555; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                        <button onclick="saveTopologyOnly()" style="background: #607d8b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Save</button>
                        <button onclick="saveTopologyAndRun()" style="background: #76b900; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Save & Run LLDPq</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hide edit button for operators -->
    <script>
        (async function() {
            await LLDPqAuth.checkAuth();
            if (LLDPqAuth.isOperator()) {
                document.getElementById('edit-topology').style.display = 'none';
            }
        })();
    </script>
</body>
</html>