<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Configuration</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <script src="/css/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Layout */
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Left Panel - Device List */
        .device-panel {
            width: 280px;
            background: #252526;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 15px;
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-header svg {
            width: 20px;
            height: 20px;
        }
        
        .search-box {
            padding: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #76b900;
        }
        
        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .device-group {
            margin-bottom: 5px;
        }
        
        .group-header {
            padding: 8px 15px;
            background: #2d2d2d;
            color: #999;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }
        
        .group-header:hover {
            background: #333;
        }
        
        .group-header .arrow {
            transition: transform 0.2s;
        }
        
        .group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        
        .group-devices {
            display: block;
        }
        
        .group-devices.collapsed {
            display: none;
        }
        
        .device-item {
            padding: 10px 15px 10px 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .device-item:hover {
            background: #2a2d2e;
        }
        
        .device-item.selected {
            background: #37373d;
            border-left-color: #76b900;
        }
        
        .device-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #76b900;
        }
        
        .device-name {
            font-size: 13px;
            color: #d4d4d4;
        }
        
        .device-ip {
            font-size: 11px;
            color: #888;
            margin-left: auto;
        }
        
        /* Right Panel - Content */
        .content-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 15px 20px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .content-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        .content-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(0deg, #8bd400 0%, #6ba000 100%);
        }
        
        .btn-secondary {
            background: #404040;
            color: #d4d4d4;
        }
        
        .btn-secondary:hover {
            background: #505050;
        }
        
        .btn-warning {
            background: linear-gradient(0deg, #ff6b00 0%, #cc5500 100%);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(0deg, #ff8533 0%, #e66000 100%);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: #555;
            margin: 0 5px;
        }
        
        .btn-success {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(0deg, #8bd400 0%, #6ba000 100%);
        }
        
        .target-label {
            font-size: 13px;
            color: #888;
            margin-left: 5px;
            display: flex;
            align-items: center;
        }
        
        /* Host Multi-Select Dropdown */
        .host-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .host-dropdown-trigger {
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            min-width: 160px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        .host-dropdown-trigger:hover {
            border-color: #76b900;
        }
        
        .host-dropdown-trigger .arrow {
            font-size: 10px;
            color: #888;
        }
        
        .host-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 4px;
            min-width: 220px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .host-dropdown-menu.show {
            display: block;
        }
        
        .host-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            color: #d4d4d4;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }
        
        .host-dropdown-item:hover {
            background: #404040;
        }
        
        .host-dropdown-item.selected {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
        }
        
        .host-dropdown-group {
            padding: 6px 12px;
            color: #888;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            border-top: 1px solid #404040;
            background: #252526;
        }
        
        .host-dropdown-group:first-child {
            border-top: none;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-overlay.visible {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #404040;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #d4d4d4;
            font-size: 14px;
        }
        
        /* Output Modal */
        .output-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .output-modal.visible {
            display: flex;
        }
        
        .output-modal-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .output-modal-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #404040;
        }
        
        .output-modal-header.success {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: #000;
        }
        
        .output-modal-header.error {
            background: linear-gradient(0deg, #c53030 0%, #9b2c2c 100%);
            color: #fff;
        }
        
        .output-modal-header.warning {
            background: linear-gradient(0deg, #ff6b00 0%, #cc5500 100%);
            color: #fff;
        }
        
        .output-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .output-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            padding: 0;
            line-height: 1;
        }
        
        .output-modal-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #1e1e1e;
        }
        
        .output-modal-body pre {
            margin: 0;
            white-space: pre;
            font-family: 'DejaVu Sans Mono', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #d4d4d4;
        }
        
        .output-modal-footer {
            padding: 15px 20px;
            background: #252526;
            display: flex;
            justify-content: center;
            gap: 10px;
            border-top: 1px solid #404040;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .welcome-screen svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .welcome-screen h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #888;
        }
        
        .welcome-screen p {
            font-size: 14px;
        }
        
        /* Device Dashboard Sections */
        .dashboard-section {
            background: #2d2d2d;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 12px 16px;
            background: #333;
            font-weight: 600;
            font-size: 14px;
            color: #76b900;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .section-content {
            padding: 16px;
        }
        
        /* No padding for table containers */
        .section-content-table {
            padding: 0;
        }
        
        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: #252526;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #76b900;
        }
        
        .info-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: #252526;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #404040;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        
        .data-table tr:hover {
            background: #333;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .badge-green {
            background: rgba(118, 185, 0, 0.2);
            color: #76b900;
        }
        
        .badge-blue {
            background: rgba(0, 122, 204, 0.2);
            color: #4fc3f7;
        }
        
        .badge-orange {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }
        
        .badge-gray {
            background: rgba(128, 128, 128, 0.2);
            color: #999;
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #888;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #333;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Text */
        .status-text {
            font-size: 12px;
            color: #888;
            margin-left: 15px;
            display: flex;
            align-items: center;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Device List -->
        <div class="device-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1M9 5h1V3H9v2m0 8h1v-2H9v2m0 8h1v-2H9v2M5 3v2h2V3H5m0 8v2h2v-2H5m0 8v2h2v-2H5z"/>
                </svg>
                Fabric Config
            </div>
            
            <div class="search-box">
                <input type="text" id="device-search" placeholder="Search devices..." oninput="filterDevices(this.value)">
            </div>
            
            <div class="device-list" id="device-list">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading devices...
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Content -->
        <div class="content-panel">
            <div class="content-header">
                <div>
                    <div class="content-title" id="content-title">Fabric Configuration</div>
                    <div class="content-subtitle" id="content-subtitle">Select a device from the left panel</div>
                </div>
                <div class="action-buttons" id="action-buttons">
                    <button class="btn btn-secondary" onclick="refreshDevice()" id="btn-refresh" style="display: none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Refresh
                    </button>
                    <div class="toolbar-separator" id="separator-refresh" style="display: none;"></div>
                    <button class="btn btn-success" onclick="runGenerate()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Generate
                    </button>
                    <label class="target-label">Target:</label>
                    <div class="host-dropdown">
                        <div class="host-dropdown-trigger" onclick="toggleHostDropdown()">
                            <span id="host-dropdown-text">Select hosts...</span>
                            <span class="arrow">▼</span>
                        </div>
                        <div id="host-dropdown-menu" class="host-dropdown-menu"></div>
                    </div>
                    <button class="btn btn-secondary" onclick="runDiff()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        Diff
                    </button>
                    <button class="btn btn-warning" onclick="runDeploy()" id="btn-deploy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                        </svg>
                        Deploy
                    </button>
                    <span class="status-text" id="status-text">Ready</span>
                </div>
            </div>
            
            <div class="content-area" id="content-area">
                <div class="welcome-screen">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1M9 5h1V3H9v2m0 8h1v-2H9v2m0 8h1v-2H9v2M5 3v2h2V3H5m0 8v2h2v-2H5m0 8v2h2v-2H5z"/>
                    </svg>
                    <h2>Fabric Configuration Manager</h2>
                    <p>Select a device from the left panel to view and manage its configuration</p>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-text" class="loading-text">Loading...</div>
    </div>
    
    <!-- Output Modal -->
    <div id="output-modal" class="output-modal" onclick="if(event.target === this) hideOutputModal()">
        <div class="output-modal-content">
            <div id="output-modal-header" class="output-modal-header">
                <h3 id="output-modal-title">Output</h3>
                <button class="output-modal-close" onclick="hideOutputModal()">&times;</button>
            </div>
            <div class="output-modal-body">
                <pre id="output-modal-content"></pre>
            </div>
            <div class="output-modal-footer">
                <button class="btn btn-secondary" onclick="hideOutputModal()">Close</button>
                <button class="btn btn-primary" onclick="copyOutput()">Copy</button>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let devices = {};
        let selectedDevice = null;
        let ansibleDir = '';
        
        // Initialize
        async function init() {
            // Check auth
            const isAuth = await LLDPqAuth.check();
            if (!isAuth) return;
            
            // Only admin can access
            if (!LLDPqAuth.isAdmin()) {
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: #888;">Access denied. Admin only.</div>';
                return;
            }
            
            // Load devices
            await loadDevices();
        }
        
        // Load devices from API
        async function loadDevices() {
            try {
                const response = await fetch('/fabric-api.sh?action=list-devices');
                const data = await response.json();
                
                if (data.success) {
                    devices = data.devices;
                    ansibleDir = data.ansible_dir;
                    renderDeviceList();
                } else {
                    showError('Failed to load devices: ' + data.error);
                }
            } catch (err) {
                showError('Failed to load devices: ' + err.message);
            }
        }
        
        // Render device list
        function renderDeviceList() {
            const container = document.getElementById('device-list');
            
            if (Object.keys(devices).length === 0) {
                container.innerHTML = '<div class="loading">No devices found</div>';
                return;
            }
            
            let html = '';
            for (const [group, groupDevices] of Object.entries(devices)) {
                html += `
                    <div class="device-group" data-group="${group}">
                        <div class="group-header collapsed" onclick="toggleGroup(this)">
                            <span class="arrow">▼</span>
                            ${group} (${groupDevices.length})
                        </div>
                        <div class="group-devices collapsed">
                `;
                
                for (const device of groupDevices) {
                    html += `
                        <div class="device-item" data-hostname="${device.hostname}" onclick="selectDevice('${device.hostname}')">
                            <div class="device-icon"></div>
                            <span class="device-name">${device.hostname}</span>
                            <span class="device-ip">${device.ip || ''}</span>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            
            // Populate host dropdown
            populateHostDropdown();
        }
        
        // Multi-select host dropdown
        let selectedHosts = [];
        
        function toggleHostDropdown() {
            const menu = document.getElementById('host-dropdown-menu');
            menu.classList.toggle('show');
        }
        
        function toggleHostSelection(host) {
            // If "all" is selected, clear everything else and close menu
            if (host === 'all') {
                selectedHosts = ['all'];
                updateHostDropdownUI();
                document.getElementById('host-dropdown-menu').classList.remove('show');
                return;
            }
            
            // If selecting something other than "all", remove "all" if it was selected
            const allIndex = selectedHosts.indexOf('all');
            if (allIndex !== -1) {
                selectedHosts.splice(allIndex, 1);
            }
            
            const index = selectedHosts.indexOf(host);
            if (index === -1) {
                selectedHosts.push(host);
            } else {
                selectedHosts.splice(index, 1);
            }
            updateHostDropdownUI();
        }
        
        function updateHostDropdownUI() {
            const text = document.getElementById('host-dropdown-text');
            if (selectedHosts.length === 0) {
                text.textContent = 'Select hosts...';
            } else if (selectedHosts.length === 1 && selectedHosts[0] === 'all') {
                text.textContent = 'ALL HOSTS';
            } else if (selectedHosts.length === 1) {
                text.textContent = selectedHosts[0];
            } else {
                text.textContent = selectedHosts.length + ' hosts selected';
            }
            
            // Update item selection styling
            document.querySelectorAll('.host-dropdown-item').forEach(item => {
                if (selectedHosts.includes(item.dataset.value)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Populate host dropdown menu
        function populateHostDropdown() {
            const menu = document.getElementById('host-dropdown-menu');
            menu.innerHTML = '';
            
            // Add "ALL HOSTS" option
            const allItem = document.createElement('div');
            allItem.className = 'host-dropdown-item';
            allItem.dataset.value = 'all';
            allItem.textContent = '-- ALL HOSTS --';
            allItem.onclick = () => toggleHostSelection('all');
            menu.appendChild(allItem);
            
            // Add groups and hosts
            for (const [group, groupDevices] of Object.entries(devices)) {
                // Group header
                const groupLabel = document.createElement('div');
                groupLabel.className = 'host-dropdown-group';
                groupLabel.textContent = group + ' (' + groupDevices.length + ')';
                menu.appendChild(groupLabel);
                
                // Group item (select all in group)
                const groupItem = document.createElement('div');
                groupItem.className = 'host-dropdown-item';
                groupItem.dataset.value = group;
                groupItem.textContent = '▸ ' + group + ' (all)';
                groupItem.onclick = () => toggleHostSelection(group);
                menu.appendChild(groupItem);
                
                // Individual hosts
                for (const device of groupDevices) {
                    const item = document.createElement('div');
                    item.className = 'host-dropdown-item';
                    item.dataset.value = device.hostname;
                    item.textContent = '    ' + device.hostname;
                    item.onclick = () => toggleHostSelection(device.hostname);
                    menu.appendChild(item);
                }
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.host-dropdown')) {
                document.getElementById('host-dropdown-menu').classList.remove('show');
            }
        });
        
        // Toggle group collapse
        function toggleGroup(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        }
        
        // Filter devices
        function filterDevices(query) {
            const items = document.querySelectorAll('.device-item');
            const groups = document.querySelectorAll('.device-group');
            
            query = query.toLowerCase();
            
            groups.forEach(group => {
                let hasVisible = false;
                const groupItems = group.querySelectorAll('.device-item');
                
                groupItems.forEach(item => {
                    const hostname = item.dataset.hostname.toLowerCase();
                    const visible = hostname.includes(query);
                    item.style.display = visible ? '' : 'none';
                    if (visible) hasVisible = true;
                });
                
                group.style.display = hasVisible ? '' : 'none';
            });
        }
        
        // Select device
        async function selectDevice(hostname) {
            // Update selection UI
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.hostname === hostname);
            });
            
            selectedDevice = hostname;
            
            // Update host dropdown selection
            selectedHosts = [hostname];
            updateHostDropdownUI();
            
            // Show refresh button when device is selected
            document.getElementById('btn-refresh').style.display = 'flex';
            document.getElementById('separator-refresh').style.display = 'block';
            
            // Update header
            document.getElementById('content-title').textContent = hostname;
            document.getElementById('content-subtitle').textContent = 'Loading configuration...';
            
            // Show loading
            document.getElementById('content-area').innerHTML = '<div class="loading"><div class="spinner"></div>Loading device configuration...</div>';
            
            // Load device config
            try {
                const response = await fetch(`/fabric-api.sh?action=get-device&hostname=${encodeURIComponent(hostname)}`);
                const data = await response.json();
                
                if (data.success) {
                    renderDeviceDashboard(data);
                } else {
                    showError('Failed to load device: ' + data.error);
                }
            } catch (err) {
                showError('Failed to load device: ' + err.message);
            }
        }
        
        // Get BGP ASN from config (try top-level first, then from VRFs)
        function getBgpAsn(config) {
            // Check top-level bgp_asn
            if (config.bgp_asn) return config.bgp_asn;
            
            // Check VRFs for ASN
            if (config.vrfs) {
                for (const [vrfName, vrfConfig] of Object.entries(config.vrfs)) {
                    if (vrfConfig.bgp?.asn) {
                        // Return without Jinja template syntax
                        const asn = vrfConfig.bgp.asn;
                        if (typeof asn === 'string' && asn.includes('{{')) {
                            continue; // Skip Jinja variables
                        }
                        return asn;
                    }
                }
            }
            
            return 'N/A';
        }
        
        // Render device dashboard
        function renderDeviceDashboard(data) {
            const config = data.config;
            const deviceInfo = data.device_info;
            const portProfiles = data.port_profiles || {};
            const vlanToVrf = data.vlan_to_vrf || {};
            const vlanProfiles = data.vlan_profiles || {};
            
            document.getElementById('content-subtitle').textContent = deviceInfo.ip || '';
            
            // Check if config is empty (no host_vars file)
            const hasConfig = config && Object.keys(config).length > 0;
            
            if (!hasConfig) {
                document.getElementById('content-area').innerHTML = `
                    <div class="welcome-screen">
                        <svg viewBox="0 0 24 24" fill="#808080" style="opacity: 0.5;">
                            <path d="M20 5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H4V7h16v10z"/>
                        </svg>
                        <h2 style="color: #808080;">No Configuration</h2>
                        <p>This device (${selectedDevice}) does not have a host_vars configuration file.</p>
                        <p style="font-size: 12px; color: #666;">Group: ${deviceInfo.group || 'Unknown'} | IP: ${deviceInfo.ip || 'N/A'}</p>
                    </div>
                `;
                return;
            }
            
            // Helper function to resolve VLAN from port profile
            function getVlanFromProfile(profileName) {
                if (!profileName || !portProfiles[profileName]) return null;
                const profile = portProfiles[profileName];
                if (profile.access_vlan) return String(profile.access_vlan);
                if (profile.native_vlan) return String(profile.native_vlan);
                return null;
            }
            
            // Helper function to resolve VRF from VLAN ID
            function getVrfFromVlan(vlanId) {
                if (!vlanId) return null;
                return vlanToVrf[String(vlanId)] || null;
            }
            
            // Build interface to bond mapping
            const interfaceToBond = {};
            if (config.bonds) {
                for (const [bondName, bondConfig] of Object.entries(config.bonds)) {
                    if (bondConfig && bondConfig.bond_members) {
                        for (const member of bondConfig.bond_members) {
                            interfaceToBond[member] = {
                                bondName,
                                profile: bondConfig.sw_port_profile,
                                description: bondConfig.description
                            };
                        }
                    }
                }
            }
            
            // Check if device has a "default" VRF defined
            const hasDefaultVrf = config.vrfs && config.vrfs['default'];
            
            let html = '';
            
            // Overview Section
            html += `
                <div class="dashboard-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                        Overview
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Hostname</div>
                                <div class="info-value">${selectedDevice}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Management IP</div>
                                <div class="info-value">${config.mgmt_ip || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Loopback IP</div>
                                <div class="info-value">${config.lo_ip || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">BGP ASN</div>
                                <div class="info-value">${getBgpAsn(config)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">VTEP</div>
                                <div class="info-value">${config.vtep?.state ? '<span class="badge badge-green">Enabled</span>' : '<span class="badge badge-orange">Disabled</span>'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Group</div>
                                <div class="info-value">${deviceInfo.group || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // VRFs Section
            if (config.vrfs && Object.keys(config.vrfs).length > 0) {
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                            VRFs (${Object.keys(config.vrfs).length})
                        </div>
                        <div class="section-content-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>VRF Name</th>
                                        <th>L3VNI</th>
                                        <th>BGP Profile</th>
                                        <th>ASN</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const [vrfName, vrfConfig] of Object.entries(config.vrfs)) {
                    html += `
                        <tr>
                            <td><span class="badge badge-blue">${vrfName}</span></td>
                            <td>${vrfConfig.l3vni || '-'}</td>
                            <td>${vrfConfig.bgp?.bgp_profile || '-'}</td>
                            <td>${vrfConfig.bgp?.asn || '-'}</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div></div>';
            }
            
            // VLANs Section
            if (config.vlan_templates && config.vlan_templates.length > 0) {
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                            </svg>
                            VLAN Templates (${config.vlan_templates.length})
                        </div>
                        <div class="section-content">
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${config.vlan_templates.map(v => `<span class="badge badge-green">${v}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // SVI / Gateway IPs Section - show IP info for used VLANs
                const usedVlanProfiles = config.vlan_templates.filter(v => vlanProfiles[v]);
                if (usedVlanProfiles.length > 0) {
                    // Determine if this is an odd or even switch based on lo_ip or hostname
                    let isOddSwitch = false;
                    if (config.lo_ip) {
                        const lastOctet = config.lo_ip.split('.')[3]?.split('/')[0];
                        if (lastOctet) {
                            isOddSwitch = parseInt(lastOctet) % 2 === 1;
                        }
                    }
                    
                    html += `
                        <div class="dashboard-section">
                            <div class="section-header">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                </svg>
                                SVI / Gateway IPs (${usedVlanProfiles.length})
                            </div>
                            <div class="section-content-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>VLAN Template</th>
                                            <th>VLAN ID</th>
                                            <th>VRR VIP</th>
                                            <th>Switch IP</th>
                                            <th>VRF</th>
                                            <th>L2VNI</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const templateName of usedVlanProfiles) {
                        const vp = vlanProfiles[templateName];
                        const vrrVip = vp.vrr_vip || null;
                        let switchIp = null;
                        
                        if (vp.vrr_enabled) {
                            // VRR enabled - use even_ip or odd_ip based on switch
                            switchIp = isOddSwitch ? (vp.odd_ip || null) : (vp.even_ip || null);
                        } else {
                            // VRR disabled - use regular ip
                            switchIp = vp.ip || null;
                        }
                        
                        // Check if this is L2-only (no IP addresses at all)
                        const isL2Only = !vrrVip && !switchIp;
                        
                        // VRF display - show "-" for L2-only VLANs
                        const vrfDisplay = isL2Only ? '-' : (vp.vrf || 'default');
                        
                        html += `
                            <tr>
                                <td><span class="badge badge-green">${templateName}</span></td>
                                <td>${vp.vlan_id}</td>
                                <td>${vrrVip ? `<span class="badge badge-orange">${vrrVip}</span>` : '-'}</td>
                                <td>${isL2Only ? '<span class="badge badge-gray">L2 Only</span>' : (switchIp ? `<span class="badge badge-blue">${switchIp}</span>` : '-')}</td>
                                <td>${vrfDisplay !== '-' ? `<span class="badge badge-blue">${vrfDisplay}</span>` : '-'}</td>
                                <td>${vp.l2vni || '-'}</td>
                                <td>${vp.description || '-'}</td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div></div>';
                }
            }
            
            // DHCP Relay Section
            if (config.dhcp_relay && config.dhcp_relay.length > 0) {
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l7.59-7.59L21 8l-9 9z"/>
                            </svg>
                            DHCP Relay (${config.dhcp_relay.length})
                        </div>
                        <div class="section-content-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>VRF</th>
                                        <th>Interfaces</th>
                                        <th>Servers</th>
                                        <th>Upstream</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const relay of config.dhcp_relay) {
                    html += `
                        <tr>
                            <td><span class="badge badge-blue">${relay.vrf}</span></td>
                            <td>${relay.interfaces?.join(', ') || '-'}</td>
                            <td>${relay.servers?.join(', ') || '-'}</td>
                            <td>${relay.upstream?.join(', ') || '-'}</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div></div>';
            }
            
            // EVPN Multihoming Section
            if (config.evpn_mh) {
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17 16l-4-4V8.82C14.16 8.4 15 7.3 15 6c0-1.66-1.34-3-3-3S9 4.34 9 6c0 1.3.84 2.4 2 2.82V12l-4 4H3v5h5v-3.05l4-4.2 4 4.2V21h5v-5h-4z"/>
                            </svg>
                            EVPN Multihoming
                        </div>
                        <div class="section-content">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">System MAC</div>
                                    <div class="info-value">${config.evpn_mh.sysmac || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">DF Preference</div>
                                    <div class="info-value">${config.evpn_mh.df_preference || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Separate interfaces into breakouts and real interfaces
            if (config.interfaces && Object.keys(config.interfaces).length > 0) {
                const allInterfaces = Object.entries(config.interfaces);
                
                // Separate breakout parents from real interfaces
                const breakouts = [];
                const realInterfaces = [];
                
                for (const [ifName, ifConfig] of allInterfaces) {
                    const cfg = ifConfig || {};
                    const isSubInterface = /s\d+$/.test(ifName);
                    
                    if (cfg.breakout && !isSubInterface) {
                        // This is a breakout parent (physical port with breakout config)
                        breakouts.push([ifName, cfg]);
                    } else {
                        // This is a real interface (sub-interface or non-breakout)
                        realInterfaces.push([ifName, cfg]);
                    }
                }
                
                // Breakouts Section
                if (breakouts.length > 0) {
                    html += `
                        <div class="dashboard-section">
                            <div class="section-header">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"/>
                                </svg>
                                Port Breakouts (${breakouts.length})
                            </div>
                            <div class="section-content-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Physical Port</th>
                                            <th>Breakout</th>
                                            <th>Sub-Interfaces</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const [ifName, cfg] of breakouts) {
                        // Calculate sub-interfaces based on breakout type
                        const breakoutType = cfg.breakout || '-';
                        let subIfCount = 1;
                        const breakoutMatch = breakoutType.match(/^(\d+)x/);
                        if (breakoutMatch) {
                            subIfCount = parseInt(breakoutMatch[1]);
                        }
                        const subInterfaces = [];
                        for (let i = 0; i < subIfCount; i++) {
                            subInterfaces.push(ifName + 's' + i);
                        }
                        
                        html += `
                            <tr>
                                <td><strong>${ifName}</strong></td>
                                <td><span class="badge badge-orange">${breakoutType}</span></td>
                                <td>${subInterfaces.join(', ')}</td>
                                <td>${cfg.description || '-'}</td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div></div>';
                }
                
                // Interfaces Section (real interfaces only)
                if (realInterfaces.length > 0) {
                    html += `
                        <div class="dashboard-section">
                            <div class="section-header">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7.77 6.76L6.23 5.48.82 12l5.41 6.52 1.54-1.28L3.42 12l4.35-5.24zM7 13h2v-2H7v2zm10-2h-2v2h2v-2zm-6 2h2v-2h-2v2zm6.77-7.52l-1.54 1.28L20.58 12l-4.35 5.24 1.54 1.28L23.18 12l-5.41-6.52z"/>
                                </svg>
                                Interfaces (${realInterfaces.length})
                            </div>
                            <div class="section-content-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Interface</th>
                                            <th>Bond</th>
                                            <th>IP</th>
                                            <th>Profile</th>
                                            <th>VLAN</th>
                                            <th>VRF</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const [ifName, ifConfig] of realInterfaces) {
                        const cfg = ifConfig || {};
                        const bondInfo = interfaceToBond[ifName];
                        const profile = cfg.sw_port_profile || (bondInfo?.profile) || '';
                        
                        let vlan = getVlanFromProfile(profile);
                        if (!vlan && cfg.access_vlan) vlan = String(cfg.access_vlan);
                        if (!vlan && cfg.native_vlan) vlan = String(cfg.native_vlan);
                        
                        let vrf = getVrfFromVlan(vlan);
                        if (!vrf && cfg.vrf) vrf = cfg.vrf;
                        
                        const displayProfile = profile || '-';
                        const displayVrf = vrf || (hasDefaultVrf ? 'default' : null);
                        const ipAddr = cfg.ip || '-';
                        const description = cfg.description || (bondInfo?.description) || '-';
                        
                        html += `
                            <tr>
                                <td>${ifName}</td>
                                <td>${bondInfo ? `<span class="badge badge-orange">${bondInfo.bondName}</span>` : '-'}</td>
                                <td>${ipAddr !== '-' ? `<span class="badge badge-blue">${ipAddr}</span>` : '-'}</td>
                                <td>${displayProfile}</td>
                                <td>${vlan ? `<span class="badge badge-green">${vlan}</span>` : '-'}</td>
                                <td>${displayVrf ? `<span class="badge badge-blue">${displayVrf}</span>` : '-'}</td>
                                <td>${description}</td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div></div>';
                }
            }
            
            // Bonds Section (after interfaces)
            if (config.bonds && Object.keys(config.bonds).length > 0) {
                const bonds = Object.entries(config.bonds);
                
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 10l-2.5-1.5L15 12V4h5v8z"/>
                            </svg>
                            Bonds / LAG (${bonds.length})
                        </div>
                        <div class="section-content-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Bond</th>
                                        <th>Members</th>
                                        <th>Profile</th>
                                        <th>VLAN</th>
                                        <th>VRF</th>
                                        <th>ESI</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const [bondName, bondConfig] of bonds) {
                    const cfg = bondConfig || {};
                    const profile = cfg.sw_port_profile || '';
                    const vlan = getVlanFromProfile(profile);
                    const vrf = getVrfFromVlan(vlan);
                    const displayVrf = vrf || (vlan ? 'default' : null);
                    const members = cfg.bond_members?.join(', ') || '-';
                    const esi = cfg.evpn_mh_id ? `ES-${cfg.evpn_mh_id}` : '-';
                    
                    html += `
                        <tr>
                            <td><strong>${bondName}</strong></td>
                            <td>${members}</td>
                            <td>${profile || '-'}</td>
                            <td>${vlan ? `<span class="badge badge-green">${vlan}</span>` : '-'}</td>
                            <td>${displayVrf ? `<span class="badge badge-blue">${displayVrf}</span>` : '-'}</td>
                            <td>${esi !== '-' ? `<span class="badge badge-orange">${esi}</span>` : '-'}</td>
                            <td>${cfg.description || '-'}</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div></div>';
            }
            
            document.getElementById('content-area').innerHTML = html;
        }
        
        // Refresh device
        function refreshDevice() {
            if (selectedDevice) {
                selectDevice(selectedDevice);
            }
        }
        
        // Show error
        function showError(message) {
            document.getElementById('content-area').innerHTML = `
                <div class="welcome-screen">
                    <svg viewBox="0 0 24 24" fill="#ff6b6b" style="opacity: 1;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <h2 style="color: #ff6b6b;">Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // ========== ANSIBLE ACTIONS ==========
        
        // Show loading overlay
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            if (show) {
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }
        
        // Show output modal
        function showOutputModal(title, content, type = 'success') {
            const modal = document.getElementById('output-modal');
            const header = document.getElementById('output-modal-header');
            document.getElementById('output-modal-title').textContent = title;
            document.getElementById('output-modal-content').innerHTML = ansiToHtml(content);
            
            header.className = 'output-modal-header ' + type;
            modal.classList.add('visible');
        }
        
        // Hide output modal
        function hideOutputModal() {
            document.getElementById('output-modal').classList.remove('visible');
        }
        
        // Copy output content
        function copyOutput() {
            const content = document.getElementById('output-modal-content').textContent;
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = originalText, 1500);
        }
        
        // Convert ANSI codes to HTML
        function ansiToHtml(text) {
            if (!text) return '';
            
            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Wrap in span to handle orphan closing tags
            html = '<span>' + html + '</span>';
            
            // ANSI color map
            const colors = {
                '30': '#000', '31': '#e74c3c', '32': '#2ecc71', '33': '#f1c40f',
                '34': '#3498db', '35': '#9b59b6', '36': '#1abc9c', '37': '#ecf0f1',
                '90': '#7f8c8d', '91': '#ff6b6b', '92': '#4ec9b0', '93': '#ffd93d',
                '94': '#6997d5', '95': '#c586c0', '96': '#56d4bc', '97': '#fff'
            };
            
            // Replace ANSI codes with spans
            html = html.replace(/\u001b\[([0-9;]+)m/g, (match, codes) => {
                const codeList = codes.split(';');
                let style = '';
                let isReset = false;
                
                for (const code of codeList) {
                    if (code === '0' || code === '') {
                        isReset = true;
                        continue;
                    }
                    if (code === '1') style += 'font-weight:bold;';
                    else if (code === '4') style += 'text-decoration:underline;';
                    else if (colors[code]) style += `color:${colors[code]};`;
                    else {
                        const bg = parseInt(code);
                        if (bg >= 40 && bg <= 47) {
                            const fgCode = String(bg - 10);
                            if (colors[fgCode]) style += `background:${colors[fgCode]};`;
                        }
                    }
                }
                
                if (isReset && !style) return '</span>';
                if (style) return `</span><span style="${style}">`;
                return '';
            });
            
            return html;
        }
        
        // Ansible API call
        async function ansibleApiCall(action, params = {}) {
            const queryParams = new URLSearchParams({ action, ...params });
            const response = await fetch(`/ansible-api?${queryParams}`);
            return await response.json();
        }
        
        // Get target host(s) from dropdown
        function getTargetHost() {
            if (selectedHosts.length === 0) return '';
            if (selectedHosts.length === 1 && selectedHosts[0] === 'all') return '';
            return selectedHosts.join(',');
        }
        
        // Run Generate
        async function runGenerate() {
            const host = getTargetHost();
            const targetMsg = host ? `for ${host}` : 'for all hosts';
            
            showLoading(true, `Generating configs ${targetMsg}...`);
            setStatus('Generating...');
            
            try {
                const result = await ansibleApiCall('generate', { host: host || '' });
                
                if (result.success) {
                    showOutputModal(
                        `Generate Complete ${targetMsg}`,
                        result.output || 'Configs generated successfully',
                        'success'
                    );
                } else {
                    showOutputModal(
                        'Generate Failed',
                        result.error || result.output || 'Unknown error',
                        'error'
                    );
                }
            } catch (err) {
                showOutputModal('Error', 'Failed to run generate: ' + err.message, 'error');
            }
            
            showLoading(false);
            setStatus('Ready');
        }
        
        // Run Diff
        async function runDiff() {
            const host = getTargetHost();
            const targetMsg = host || 'all hosts';
            
            showLoading(true, `Running diff for ${targetMsg}...`);
            setStatus('Comparing...');
            
            try {
                const result = await ansibleApiCall('diff', { host });
                const output = result.output || result.error || '';
                
                if (result.success) {
                    // Check if there are changes
                    const hasChanges = output.includes('DIFF SUMMARY') && output.includes('With changes:');
                    const changesMatch = output.match(/With changes:\s*(\d+)/);
                    const changesCount = changesMatch ? parseInt(changesMatch[1]) : 0;
                    
                    // Show diff popup
                    showDiffSummaryModal(output, changesCount);
                } else {
                    showOutputModal('Diff Failed', output, 'error');
                }
            } catch (err) {
                showOutputModal('Error', 'Failed to run diff: ' + err.message, 'error');
            }
            
            showLoading(false);
            setStatus('Ready');
        }
        
        // Show Diff Summary Modal (special formatting)
        function showDiffSummaryModal(output, changesCount) {
            // Extract summary section
            const lines = output.split('\n');
            let summaryLines = [];
            let inSummary = false;
            
            for (const line of lines) {
                if (line.includes('PLAY RECAP')) break;
                if (line.includes('CONFIG DIFF SUMMARY') || line.includes('╔') || inSummary) {
                    inSummary = true;
                    summaryLines.push(line);
                }
            }
            
            const summaryContent = summaryLines.join('\n') || output;
            const hasChanges = changesCount > 0;
            const title = hasChanges 
                ? `⚠️ Configuration Changes Detected (${changesCount})`
                : '✅ All Switches Synchronized';
            
            showOutputModal(title, summaryContent, hasChanges ? 'warning' : 'success');
        }
        
        // Run Deploy
        async function runDeploy() {
            const host = getTargetHost();
            const targetMsg = host || 'ALL HOSTS';
            
            // Confirm deployment
            const confirmMsg = host 
                ? `Are you sure you want to deploy configuration to ${host}?\n\nThis will apply changes to the live network device.`
                : `Are you sure you want to deploy configuration to ALL HOSTS?\n\n⚠️ This will apply changes to ALL network devices!`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showLoading(true, `Deploying to ${targetMsg}...`);
            setStatus('Deploying...');
            
            try {
                const result = await ansibleApiCall('deploy', { host });
                
                if (result.success) {
                    showOutputModal(
                        `Deploy Complete - ${targetMsg}`,
                        result.output || 'Configuration deployed successfully',
                        'success'
                    );
                } else {
                    showOutputModal(
                        `Deploy Failed - ${targetMsg}`,
                        result.error || result.output || 'Unknown error',
                        'error'
                    );
                }
            } catch (err) {
                showOutputModal('Error', 'Failed to deploy: ' + err.message, 'error');
            }
            
            showLoading(false);
            setStatus('Ready');
        }
        
        function setStatus(text) {
            const statusEl = document.getElementById('status-text');
            if (statusEl) statusEl.textContent = text;
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
