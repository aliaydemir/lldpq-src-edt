<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>..::LLDPQ::..</title>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <script src="/css/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Layout */
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Left Panel - Device List */
        .device-panel {
            width: 250px;
            background: #252526;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 15px;
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-header svg {
            width: 20px;
            height: 20px;
        }
        
        .search-box {
            padding: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 13px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #76b900;
        }
        
        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .device-group {
            margin-bottom: 5px;
        }
        
        .group-header {
            padding: 8px 15px;
            background: #2d2d2d;
            color: #999;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }
        
        .group-header:hover {
            background: #333;
        }
        
        .group-header .arrow {
            transition: transform 0.2s;
        }
        
        .group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        
        .group-devices {
            display: block;
        }
        
        .group-devices.collapsed {
            display: none;
        }
        
        .device-item {
            padding: 10px 15px 10px 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .device-item:hover {
            background: #2a2d2e;
        }
        
        .device-item.selected {
            background: #37373d;
            border-left-color: #76b900;
        }
        
        .device-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #76b900;
        }
        
        .device-name {
            font-size: 13px;
            color: #d4d4d4;
        }
        
        .device-ip {
            font-size: 11px;
            color: #888;
            margin-left: auto;
        }
        
        /* Right Panel - Content */
        .content-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 15px 20px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .content-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        .content-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            outline: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(0deg, #8bd400 0%, #6ba000 100%);
        }
        
        .btn-secondary {
            background: #404040;
            color: #d4d4d4;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            outline: none;
        }
        
        .btn-secondary:hover {
            background: #505050;
        }
        
        .btn-danger {
            background: linear-gradient(0deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            outline: none;
        }
        
        .btn-danger:hover {
            background: linear-gradient(0deg, #e4606d 0%, #d63344 100%);
        }

        .btn-warning {
            background: linear-gradient(0deg, #ff6b00 0%, #cc5500 100%);
            color: white;
            border: none;
            outline: none;
        }
        
        .btn-warning:hover {
            background: linear-gradient(0deg, #ff8533 0%, #e66000 100%);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: #555;
            margin: 0 12px;
        }
        
        .btn-success {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: white;
            border: none;
            outline: none;
        }
        
        .btn-success:hover {
            background: linear-gradient(0deg, #8bd400 0%, #6ba000 100%);
        }
        
        .target-label {
            font-size: 13px;
            color: #888;
            margin-left: 5px;
            display: flex;
            align-items: center;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-overlay.visible {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #404040;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #d4d4d4;
            font-size: 14px;
        }
        
        /* Output Modal */
        .output-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .output-modal.visible {
            display: flex;
        }
        
        .output-modal-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .output-modal-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #404040;
        }
        
        .output-modal-header.success {
            background: linear-gradient(0deg, #76b900 0%, #5a8c00 100%);
            color: #000;
        }
        
        .output-modal-header.error {
            background: linear-gradient(0deg, #c53030 0%, #9b2c2c 100%);
            color: #fff;
        }
        
        .output-modal-header.warning {
            background: linear-gradient(0deg, #ff6b00 0%, #cc5500 100%);
            color: #fff;
        }
        
        .output-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .output-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: inherit;
            padding: 0;
            line-height: 1;
        }
        
        .output-modal-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #1e1e1e;
        }
        
        .output-modal-body pre {
            margin: 0;
            white-space: pre;
            font-family: 'DejaVu Sans Mono', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #d4d4d4;
        }
        
        .output-modal-footer {
            padding: 15px 20px;
            background: #252526;
            display: flex;
            justify-content: center;
            gap: 10px;
            border-top: 1px solid #404040;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .welcome-screen svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .welcome-screen h2 {
            font-size: 24px;
            font-style: italic;
            font-weight: bold;
            margin-bottom: 10px;
            color: #888;
        }
        
        .welcome-screen p {
            font-size: 14px;
        }
        
        /* Device Dashboard Sections */
        .dashboard-section {
            background: #2d2d2d;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 12px 16px;
            background: #333;
            font-weight: 600;
            font-size: 14px;
            color: #76b900;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .section-content {
            padding: 16px;
        }
        
        /* No padding for table containers */
        .section-content-table {
            padding: 0;
        }
        
        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: #252526;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #76b900;
        }
        
        .info-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: #252526;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #404040;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        
        .data-table tr:hover {
            background: #333;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .badge-green {
            background: rgba(118, 185, 0, 0.2);
            color: #76b900;
        }
        
        .badge-blue {
            background: rgba(0, 122, 204, 0.2);
            color: #4fc3f7;
        }

        .badge-purple {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
        }
        
        .badge-cyan {
            background: rgba(0, 188, 212, 0.2);
            color: #4dd0e1;
        }
        
        .badge-pink {
            background: rgba(233, 30, 99, 0.2);
            color: #f48fb1;
        }
        
        .badge-with-delete {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding-right: 6px;
        }
        
        .badge-delete {
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.6;
            transition: opacity 0.2s, color 0.2s;
            line-height: 1;
        }
        
        .badge-delete:hover {
            opacity: 1;
            color: #ff6b6b;
        }

        .badge-orange {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }
        
        .badge-red {
            background: rgba(244, 67, 54, 0.2);
            color: #ef5350;
        }
        
        .badge-gray {
            background: rgba(128, 128, 128, 0.2);
            color: #aaa;
        }
        
        .btn-assign {
            background: #2196f3 !important;
        }
        
        .btn-assign:hover {
            background: #1976d2 !important;
        }
        
        .btn-edit {
            background: #ff9800 !important;
        }
        
        .btn-edit:hover {
            background: #f57c00 !important;
        }
        
        .vlan-checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 6px;
            background: rgba(0,0,0,0.2);
        }
        
        .vlan-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #333;
        }
        
        .vlan-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .vlan-checkbox-item:hover {
            background: rgba(118, 185, 0, 0.1);
        }
        
        .vlan-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .vlan-checkbox-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .vlan-name {
            color: #76b900;
            font-weight: 500;
        }
        
        .vlan-info {
            color: #888;
            font-size: 12px;
        }
        
        .vlan-edit-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 6px;
            background: rgba(0,0,0,0.2);
        }
        
        .vlan-edit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #333;
        }
        
        .vlan-edit-item:last-child {
            border-bottom: none;
        }
        
        .vlan-edit-item:hover {
            background: rgba(118, 185, 0, 0.1);
        }
        
        .vlan-edit-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .vlan-edit-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon-edit {
            background: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
        }
        
        .btn-icon-edit:hover {
            background: #2196f3;
            color: white;
        }
        
        .btn-icon-delete {
            background: rgba(244, 67, 54, 0.2);
            color: #ef5350;
        }
        
        .btn-icon-delete:hover {
            background: #f44336;
            color: white;
        }
        
        .badge-gray {
            background: rgba(128, 128, 128, 0.2);
            color: #999;
        }
        
        /* Section header with add button */
        .section-header-with-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #333;
            font-weight: 600;
            color: #76b900;
        }
        
        .section-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-add-small {
            background: #76b900;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        
        .btn-add-small:hover {
            background: #8fcf00;
        }
        
        /* VLAN Form Modal */
        .vlan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .vlan-modal.visible {
            display: flex;
        }
        
        .vlan-modal-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .vlan-modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #76b900 0%, #5a8f00 100%);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }
        
        .vlan-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .vlan-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .vlan-modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #ccc;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            border-color: #76b900;
            outline: none;
        }
        
        .form-group-inline {
            display: flex;
            gap: 12px;
        }
        
        .form-group-inline .form-group {
            flex: 1;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #76b900;
        }
        
        .form-checkbox label {
            margin: 0;
            cursor: pointer;
        }
        
        .form-hint {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        
        .vlan-modal-footer {
            padding: 16px 20px;
            background: #252526;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
        }
        
        .btn-primary:disabled,
        .btn-secondary:disabled,
        .btn-danger:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .vrr-fields {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #252526;
            border-radius: 4px;
        }
        
        .vrr-fields.visible {
            display: block;
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #888;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #333;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Text */
        .status-text {
            font-size: 12px;
            color: #888;
            margin-left: 15px;
            display: flex;
            align-items: center;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Device List -->
        <div class="device-panel">
            <div class="panel-header">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1M9 5h1V3H9v2m0 8h1v-2H9v2m0 8h1v-2H9v2M5 3v2h2V3H5m0 8v2h2v-2H5m0 8v2h2v-2H5z"/>
                </svg>
                Fabric Config
            </div>
            
            <div class="search-box">
                <input type="text" id="device-search" placeholder="Search devices..." oninput="filterDevices(this.value)">
            </div>
            
            <div class="device-list" id="device-list">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading devices...
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Content -->
        <div class="content-panel">
            <div class="content-header">
                <div>
                    <div class="content-title" id="content-title">Fabric Configuration</div>
                    <div class="content-subtitle" id="content-subtitle">Select a device from the left panel</div>
                </div>
                <div class="action-buttons" id="action-buttons">
                    <button class="btn btn-secondary" onclick="refreshDevice()" id="btn-refresh" style="display: none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="btn btn-success" onclick="runGenerate()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Generate
                    </button>
                    <button class="btn btn-secondary" onclick="runDiff()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        Diff
                    </button>
                    <button class="btn btn-warning" onclick="runDeploy()" id="btn-deploy">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                        </svg>
                        Deploy
                    </button>
                    <span class="status-text" id="status-text">Ready</span>
                </div>
            </div>
            
            <div class="content-area" id="content-area">
                <div class="welcome-screen">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 1h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1m0 8h16a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1M9 5h1V3H9v2m0 8h1v-2H9v2m0 8h1v-2H9v2M5 3v2h2V3H5m0 8v2h2v-2H5m0 8v2h2v-2H5z"/>
                    </svg>
                    <h2>Fabric Configuration Manager</h2>
                    <p>Select a device from the left panel to view and manage its configuration</p>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-text" class="loading-text">Loading...</div>
    </div>
    
    <!-- Output Modal -->
    <div id="output-modal" class="output-modal" onclick="if(event.target === this) hideOutputModal()">
        <div class="output-modal-content">
            <div id="output-modal-header" class="output-modal-header">
                <h3 id="output-modal-title">Output</h3>
                <button class="output-modal-close" onclick="hideOutputModal()">&times;</button>
            </div>
            <div class="output-modal-body">
                <pre id="output-modal-content"></pre>
            </div>
            <div class="output-modal-footer">
                <button class="btn btn-secondary" onclick="hideOutputModal()">Close</button>
                <button class="btn btn-primary" onclick="copyOutput()">Copy</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="vlan-modal" onclick="if(event.target === this) closeConfirmModal()">
        <div class="vlan-modal-content" style="max-width: 450px;">
            <div class="vlan-modal-header" style="background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);">
                <h3 id="confirm-modal-title">Confirm</h3>
                <button class="vlan-modal-close" onclick="closeConfirmModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <p id="confirm-modal-message" style="color: #ccc; line-height: 1.6;"></p>
            </div>
            <div class="vlan-modal-footer">
                <button type="button" class="btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn-danger" onclick="executeConfirm()">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let devices = {};
        let selectedDevice = null;
        let currentDeviceConfig = null;  // Current device's config
        let currentVxlanIntMapping = {};  // VRF -> VXLAN interface VLAN mapping
        let ansibleDir = '';
        let vlanProfiles = {};  // Global VLAN profiles
        let portProfiles = {};  // Global SW Port profiles
        let leakedSubnets = {};  // Subnet -> {target_vrf, route_map}
        
        // Helper: Get VRF badge class
        // Dynamic VRF badge colors - uses hash for consistent colors
        function getVrfBadgeClass(vrfName) {
            if (!vrfName || vrfName === 'L2 Only' || vrfName === 'default') return 'badge-gray';
            
            // Infra VRFs get blue
            if (vrfName === 'oob' || vrfName.toLowerCase().includes('mgmt') || vrfName.toLowerCase().includes('management')) {
                return 'badge-blue';
            }
            
            // Hash the VRF name to get consistent color
            const colors = ['badge-green', 'badge-purple', 'badge-orange', 'badge-cyan', 'badge-pink'];
            let hash = 0;
            for (let i = 0; i < vrfName.length; i++) {
                hash = ((hash << 5) - hash) + vrfName.charCodeAt(i);
                hash = hash & hash;
            }
            return colors[Math.abs(hash) % colors.length];
        }
        
        // Helper: Convert IP to network address
        function ipToNetwork(ipWithMask) {
            if (!ipWithMask) return null;
            const parts = ipWithMask.split('/');
            if (parts.length !== 2) return null;
            const ip = parts[0];
            const mask = parseInt(parts[1]);
            const ipOctets = ip.split('.').map(Number);
            const maskBits = 32 - mask;
            const hostBits = Math.pow(2, maskBits) - 1;
            const ipInt = (ipOctets[0] << 24) + (ipOctets[1] << 16) + (ipOctets[2] << 8) + ipOctets[3];
            const networkInt = ipInt & ~hostBits;
            const networkOctets = [
                (networkInt >> 24) & 255,
                (networkInt >> 16) & 255,
                (networkInt >> 8) & 255,
                networkInt & 255
            ];
            return networkOctets.join('.') + '/' + mask;
        }
        
        // Initialize
        async function init() {
            // Check auth
            const isAuth = await LLDPqAuth.check();
            if (!isAuth) return;
            
            // Only admin can access
            if (!LLDPqAuth.isAdmin()) {
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: #888;">Access denied. Admin only.</div>';
                return;
            }
            
            // Load devices
            await loadDevices();
        }
        
        // Load devices from API
        async function loadDevices() {
            try {
                const response = await fetch('/fabric-api.sh?action=list-devices');
                const data = await response.json();
                
                if (data.success) {
                    devices = data.devices;
                    ansibleDir = data.ansible_dir;
                    renderDeviceList();
                } else {
                    showError('Failed to load devices: ' + data.error);
                }
            } catch (err) {
                showError('Failed to load devices: ' + err.message);
            }
        }
        
        // Render device list
        function renderDeviceList() {
            const container = document.getElementById('device-list');
            
            if (Object.keys(devices).length === 0) {
                container.innerHTML = '<div class="loading">No devices found</div>';
                return;
            }
            
            let html = '';
            for (const [group, groupDevices] of Object.entries(devices)) {
                html += `
                    <div class="device-group" data-group="${group}">
                        <div class="group-header collapsed" onclick="toggleGroup(this)">
                            <span class="arrow">▼</span>
                            ${group} (${groupDevices.length})
                        </div>
                        <div class="group-devices collapsed">
                `;
                
                for (const device of groupDevices) {
                    html += `
                        <div class="device-item" data-hostname="${device.hostname}" onclick="selectDevice('${device.hostname}')">
                            <div class="device-icon"></div>
                            <span class="device-name">${device.hostname}</span>
                            <span class="device-ip">${device.ip || ''}</span>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
        }
        
        // Toggle group collapse
        function toggleGroup(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        }
        
        // Filter devices
        function filterDevices(query) {
            const items = document.querySelectorAll('.device-item');
            const groups = document.querySelectorAll('.device-group');
            
            query = query.toLowerCase();
            
            groups.forEach(group => {
                let hasVisible = false;
                const groupItems = group.querySelectorAll('.device-item');
                
                groupItems.forEach(item => {
                    const hostname = item.dataset.hostname.toLowerCase();
                    const visible = hostname.includes(query);
                    item.style.display = visible ? '' : 'none';
                    if (visible) hasVisible = true;
                });
                
                group.style.display = hasVisible ? '' : 'none';
            });
        }
        
        // Select device
        async function selectDevice(hostname) {
            // Update selection UI
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.hostname === hostname);
            });
            
            selectedDevice = hostname;
            
            // Show refresh button when device is selected
            document.getElementById('btn-refresh').style.display = 'flex';
            
            // Update header
            document.getElementById('content-title').textContent = hostname;
            document.getElementById('content-subtitle').textContent = 'Loading configuration...';
            
            // Show loading
            document.getElementById('content-area').innerHTML = '<div class="loading"><div class="spinner"></div>Loading device configuration...</div>';
            
            // Load device config and leaked subnets in parallel
            try {
                const [deviceResponse, leakResponse] = await Promise.all([
                    fetch(`/fabric-api.sh?action=get-device&hostname=${encodeURIComponent(hostname)}`),
                    fetch('/fabric-api.sh?action=get-all-leaked-subnets')
                ]);
                
                const data = await deviceResponse.json();
                const leakData = await leakResponse.json();
                
                if (leakData.success) {
                    leakedSubnets = leakData.leaked_subnets || {};
                }
                
                if (data.success) {
                    currentDeviceConfig = data.config;  // Save for VRF creation
                    currentVxlanIntMapping = data.vxlan_int_mapping || {};  // Save for DHCP relay
                    renderDeviceDashboard(data);
                } else {
                    showError('Failed to load device: ' + data.error);
                }
            } catch (err) {
                showError('Failed to load device: ' + err.message);
            }
        }
        
        // Get BGP ASN from config (try top-level first, then from VRFs)
        function getBgpAsn(config) {
            // Check top-level bgp_asn
            if (config.bgp_asn) return config.bgp_asn;
            
            // Check VRFs for ASN
            if (config.vrfs) {
                for (const [vrfName, vrfConfig] of Object.entries(config.vrfs)) {
                    if (vrfConfig.bgp?.asn) {
                        // Return without Jinja template syntax
                        const asn = vrfConfig.bgp.asn;
                        if (typeof asn === 'string' && asn.includes('{{')) {
                            continue; // Skip Jinja variables
                        }
                        return asn;
                    }
                }
            }
            
            return 'N/A';
        }
        
        // Render device dashboard
        function renderDeviceDashboard(data) {
            const config = data.config;
            const deviceInfo = data.device_info;
            portProfiles = data.port_profiles || {};  // Update global
            const vlanToVrf = data.vlan_to_vrf || {};
            vlanProfiles = data.vlan_profiles || {};  // Update global
            const vxlanIntMapping = data.vxlan_int_mapping || {};  // VRF name -> VLAN ID mapping
            
            document.getElementById('content-subtitle').textContent = deviceInfo.ip || '';
            
            // Check if config is empty (no host_vars file)
            const hasConfig = config && Object.keys(config).length > 0;
            
            if (!hasConfig) {
                document.getElementById('content-area').innerHTML = `
                    <div class="welcome-screen">
                        <svg viewBox="0 0 24 24" fill="#808080" style="opacity: 0.5;">
                            <path d="M20 5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H4V7h16v10z"/>
                        </svg>
                        <h2 style="color: #808080;">No Configuration</h2>
                        <p>This device (${selectedDevice}) does not have a host_vars configuration file.</p>
                        <p style="font-size: 12px; color: #666;">Group: ${deviceInfo.group || 'Unknown'} | IP: ${deviceInfo.ip || 'N/A'}</p>
                    </div>
                `;
                return;
            }
            
            // Helper function to resolve VLAN from port profile
            function getVlanFromProfile(profileName) {
                if (!profileName || !portProfiles[profileName]) return null;
                const profile = portProfiles[profileName];
                if (profile.access_vlan) return String(profile.access_vlan);
                // Check both native_vlan and trunk_untagged for trunk profiles
                if (profile.native_vlan) return String(profile.native_vlan);
                if (profile.trunk_untagged) return String(profile.trunk_untagged);
                return null;
            }
            
            // Helper function to get detailed port profile info
            function getPortProfileInfo(profileName) {
                const result = { mode: 'access', vlans: '-', native: '-' };
                if (!profileName || !portProfiles[profileName]) return result;
                
                const profile = portProfiles[profileName];
                const mode = profile.sw_port_mode || 'access';
                result.mode = mode;
                
                if (mode === 'access') {
                    result.vlans = profile.access_vlan ? String(profile.access_vlan) : '-';
                    result.native = '-';
                } else {
                    // Trunk mode
                    if (profile.trunk_allowed_vlan_all) {
                        result.vlans = 'ALL';
                    } else if (profile.trunk_allowed_vlan_range) {
                        result.vlans = profile.trunk_allowed_vlan_range;
                    } else {
                        const vlans = profile.trunk_allowed_vlans || profile.trunk_allowed_vlan_list || [];
                        if (vlans.length > 0) {
                            result.vlans = vlans.length > 3 ? vlans.slice(0, 3).join(', ') + '...' : vlans.join(', ');
                        }
                    }
                    result.native = profile.native_vlan || profile.trunk_untagged || '-';
                }
                
                return result;
            }
            
            // Helper function to resolve VRF from VLAN ID
            function getVrfFromVlan(vlanId) {
                if (!vlanId) return null;
                return vlanToVrf[String(vlanId)] || null;
            }
            
            // Build interface to bond mapping
            const interfaceToBond = {};
            if (config.bonds) {
                for (const [bondName, bondConfig] of Object.entries(config.bonds)) {
                    if (bondConfig && bondConfig.bond_members) {
                        for (const member of bondConfig.bond_members) {
                            interfaceToBond[member] = {
                                bondName,
                                profile: bondConfig.sw_port_profile,
                                description: bondConfig.description
                            };
                        }
                    }
                }
            }
            
            // Check if device has a "default" VRF defined
            const hasDefaultVrf = config.vrfs && config.vrfs['default'];
            
            let html = '';
            
            // Overview Section
            html += `
                <div class="dashboard-section">
                    <div class="section-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                        Overview
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Hostname</div>
                                <div class="info-value">${selectedDevice}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Management IP</div>
                                <div class="info-value">${config.mgmt_ip || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Loopback IP</div>
                                <div class="info-value">${config.lo_ip || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">BGP ASN</div>
                                <div class="info-value">${getBgpAsn(config)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">VTEP</div>
                                <div class="info-value">${config.vtep?.state ? '<span class="badge badge-green">Enabled</span>' : '<span class="badge badge-gray">Disabled</span>'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Multihoming</div>
                                <div class="info-value">${config.evpn_mh ? '<span class="badge badge-green">Enabled</span>' : '<span class="badge badge-gray">Disabled</span>'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Group</div>
                                <div class="info-value">${deviceInfo.group || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // VRFs Section - always show with action buttons
            const vrfCount = config.vrfs ? Object.keys(config.vrfs).length : 0;
            html += `
                <div class="dashboard-section">
                    <div class="section-header-with-action">
                        <div class="section-header-left">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                            VRFs (${vrfCount})
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn-add-small btn-assign" onclick="openAssignVrfModal()">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18 16v-5c0-.55-.45-1-1-1H8.41l1.79 1.79c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L5.5 9.5c-.39-.39-.39-1.02 0-1.41L8.79 5.3c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41L8.41 8H17c1.65 0 3 1.35 3 3v5h-2z"/>
                                </svg>
                                Assign
                            </button>
                            <button class="btn-add-small" onclick="openVrfModal()">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                                Create
                            </button>
                            <button class="btn-add-small btn-edit" onclick="openEditVrfModal()">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                                Edit
                            </button>
                        </div>
                    </div>
            `;
            
            if (vrfCount > 0) {
                html += `
                    <div class="section-content-table">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>VRF Name</th>
                                    <th>VXLAN Interface</th>
                                    <th>L3VNI</th>
                                    <th>BGP Profile</th>
                                    <th>ASN</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                for (const [vrfName, vrfConfig] of Object.entries(config.vrfs)) {
                    // Build VXLAN interface name from multiple sources:
                    // 1. VRF config itself (dt-mvp style): vrfConfig.vxlan_int
                    // 2. vxlan_int_mapping from vlan_profiles.yaml (nscale/kddi style)
                    let vxlanInt = '-';
                    let vxlanVlanId = null;
                    
                    // Check VRF config first
                    if (vrfConfig.vxlan_int) {
                        vxlanVlanId = vrfConfig.vxlan_int;
                    }
                    // Fallback to vxlan_int_mapping from vlan_profiles.yaml
                    else if (vxlanIntMapping && vxlanIntMapping[vrfName]) {
                        vxlanVlanId = vxlanIntMapping[vrfName];
                    }
                    
                    if (vxlanVlanId) {
                        vxlanInt = `vlan${vxlanVlanId}_l3`;
                    }
                    
                    // Don't show X for default VRF
                    const showRemove = vrfName !== 'default';
                    
                    html += `
                        <tr>
                            <td>
                                <span class="badge ${getVrfBadgeClass(vrfName)} badge-with-delete">
                                    ${vrfName}
                                    ${showRemove ? `<span class="badge-delete" onclick="event.stopPropagation(); confirmUnassignVrf('${vrfName}')" title="Remove from this device">×</span>` : ''}
                                </span>
                            </td>
                            <td>${vxlanInt !== '-' ? `<span class="badge badge-gray">${vxlanInt}</span>` : '-'}</td>
                            <td>${vrfConfig.l3vni || '-'}</td>
                            <td>${vrfConfig.bgp?.bgp_profile || '-'}</td>
                            <td>${vrfConfig.bgp?.asn || '-'}</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div>';
            } else {
                html += `
                    <div class="section-content">
                        <div style="color: #888; padding: 10px 0;">No VRFs assigned to this device</div>
                    </div>
                `;
            }
            html += '</div>';
            
            // VLANs Section - always show with add button
            html += `
                <div class="dashboard-section">
                    <div class="section-header-with-action">
                        <div class="section-header-left">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                            </svg>
                            VLAN Profiles (${config.vlan_templates?.length || 0})
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn-add-small btn-assign" onclick="openAssignVlanModal()">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18 16v-5c0-.55-.45-1-1-1H8.41l1.79 1.79c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L5.5 9.5c-.39-.39-.39-1.02 0-1.41L8.79 5.3c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41L8.41 8H17c1.65 0 3 1.35 3 3v5h-2z"/>
                                </svg>
                                Assign
                            </button>
                            <button class="btn-add-small" onclick="openVlanModal()">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                                Create
                            </button>
                            <button class="btn-add-small btn-edit" onclick="openEditVlanModal()">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                                Edit
                            </button>
                        </div>
                    </div>`;
            
            if (config.vlan_templates && config.vlan_templates.length > 0) {
                html += `
                    <div class="section-content">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${config.vlan_templates.map(v => `
                                <span class="badge badge-green badge-with-delete">
                                    ${v}
                                    <span class="badge-delete" onclick="event.stopPropagation(); confirmUnassignVlan('${v}')" title="Remove from this device">×</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="section-content">
                        <div style="color: #888; padding: 10px 0;">No VLANs assigned to this device</div>
                    </div>
                `;
            }
            html += `</div>`; // Close dashboard-section
            
            // SVI / Gateway IPs Section - show IP info for used VLANs
            const usedVlanProfiles = (config.vlan_templates || []).filter(v => vlanProfiles[v]);
            if (usedVlanProfiles.length > 0) {
                    // Determine if this is an odd or even switch based on lo_ip or hostname
                    let isOddSwitch = false;
                    if (config.lo_ip) {
                        const lastOctet = config.lo_ip.split('.')[3]?.split('/')[0];
                        if (lastOctet) {
                            isOddSwitch = parseInt(lastOctet) % 2 === 1;
                        }
                    }
                    
                    html += `
                        <div class="dashboard-section">
                            <div class="section-header">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                </svg>
                                SVI / Gateway IPs (${usedVlanProfiles.length})
                            </div>
                            <div class="section-content-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>VLAN Profile</th>
                                            <th>ID</th>
                                            <th>VRR VIP</th>
                                            <th>IP</th>
                                            <th>VRF</th>
                                            <th>L2VNI</th>
                                            <th>Leak To</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const templateName of usedVlanProfiles) {
                        const vp = vlanProfiles[templateName];
                        const vrrVip = vp.vrr_vip || null;
                        let switchIp = null;
                        
                        if (vp.vrr_enabled) {
                            // VRR enabled - use even_ip or odd_ip based on switch
                            switchIp = isOddSwitch ? (vp.odd_ip || null) : (vp.even_ip || null);
                        } else {
                            // VRR disabled - use regular ip
                            switchIp = vp.ip || null;
                        }
                        
                        // Check if this is L2-only (no IP addresses at all)
                        const isL2Only = !vrrVip && !switchIp;
                        
                        // VRF display - show "L2 Only" badge for L2-only VLANs
                        const vrfDisplay = isL2Only ? 'L2 Only' : (vp.vrf || 'default');
                        const vrfBadgeClass = getVrfBadgeClass(vrfDisplay);
                        
                        // VLAN ID display - API now returns proper format (e.g., "50-255" for ranges)
                        const vlanIdDisplay = vp.vlan_id || '-';
                        const l2vniDisplay = vp.l2vni || '-';
                        let descDisplay = vp.description || '-';
                        
                        // For range profiles, show VLAN count if no description
                        if (vp.vlan_count && vp.vlan_count > 1 && descDisplay === '-') {
                            descDisplay = `${vp.vlan_count} VLANs`;
                        }
                        
                        // Check if subnet is leaked
                        const subnetForLeak = ipToNetwork(vrrVip || vp.ip);
                        let leakToDisplay = '-';
                        if (subnetForLeak && leakedSubnets[subnetForLeak]) {
                            const targetVrf = leakedSubnets[subnetForLeak].target_vrf;
                            leakToDisplay = `<span class="badge ${getVrfBadgeClass(targetVrf)}">${targetVrf}</span>`;
                        }
                        
                        html += `
                            <tr>
                                <td><span class="badge badge-green">${templateName}</span></td>
                                <td>${vlanIdDisplay}</td>
                                <td>${vrrVip ? `<span class="badge badge-orange">${vrrVip}</span>` : '-'}</td>
                                <td>${switchIp ? `<span class="badge badge-blue">${switchIp}</span>` : '-'}</td>
                                <td><span class="badge ${vrfBadgeClass}">${vrfDisplay}</span></td>
                                <td>${l2vniDisplay}</td>
                                <td>${leakToDisplay}</td>
                                <td>${descDisplay}</td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div></div>';
            }
            
            // DHCP Relay Section - show if device has at least 1 VLAN
            if (config.vlan_templates && config.vlan_templates.length > 0) {
                const dhcpRelays = config.dhcp_relay || [];
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l7.59-7.59L21 8l-9 9z"/>
                            </svg>
                            DHCP Relay (${dhcpRelays.length})
                            <div style="margin-left: auto; display: flex; gap: 8px;">
                                <button class="btn-add-small" onclick="openDhcpRelayModal()">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                    </svg>
                                    Create
                                </button>
                            </div>
                        </div>`;
                
                if (dhcpRelays.length > 0) {
                    html += `
                        <div class="section-content-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>VRF</th>
                                        <th>Interfaces</th>
                                        <th>Servers</th>
                                        <th>Upstream</th>
                                        <th style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (let idx = 0; idx < dhcpRelays.length; idx++) {
                        const relay = dhcpRelays[idx];
                        const vrfBadgeClass = getVrfBadgeClass(relay.vrf);
                        html += `
                            <tr>
                                <td><span class="badge ${vrfBadgeClass}">${relay.vrf}</span></td>
                                <td>${relay.interfaces?.join(', ') || '-'}</td>
                                <td>${relay.servers?.join(', ') || '-'}</td>
                                <td>${relay.upstream?.join(', ') || '-'}</td>
                                <td>
                                    <div style="display: flex; gap: 6px;">
                                        <button class="btn-icon btn-icon-edit" onclick="editDhcpRelay(${idx})" title="Edit">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon btn-icon-delete" onclick="confirmDeleteDhcpRelay(${idx})" title="Delete">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div>';
                } else {
                    html += `
                        <div class="section-content">
                            <div style="color: #888; padding: 10px 0;">No DHCP Relay configured. Click Create to add one.</div>
                        </div>
                    `;
                }
                html += '</div>';
            }
            
            // EVPN Multihoming Section - show if device has VTEP (EVPN capable)
            if (config.vtep) {
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17 16l-4-4V8.82C14.16 8.4 15 7.3 15 6c0-1.66-1.34-3-3-3S9 4.34 9 6c0 1.3.84 2.4 2 2.82V12l-4 4H3v5h5v-3.05l4-4.2 4 4.2V21h5v-5h-4z"/>
                            </svg>
                            EVPN Multihoming
                            <div style="margin-left: auto; display: flex; gap: 8px;">
                                ${config.evpn_mh ? `
                                    <button class="btn-add-small" onclick="openEvpnMhModal(true)" style="background: #4a4a4a;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                        </svg>
                                        Edit
                                    </button>
                                    <button class="btn-add-small" onclick="deleteEvpnMh()" style="background: #dc3545;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                        </svg>
                                        Delete
                                    </button>
                                ` : `
                                    <button class="btn-add-small" onclick="openEvpnMhModal()">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                        </svg>
                                        Create
                                    </button>
                                `}
                            </div>
                        </div>
                `;
                
                if (config.evpn_mh) {
                    html += `
                        <div class="section-content">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">System MAC</div>
                                    <div class="info-value">${config.evpn_mh.sysmac || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">DF Preference</div>
                                    <div class="info-value">${config.evpn_mh.df_preference || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="section-content">
                            <div style="color: #888; padding: 10px 0;">No EVPN Multihoming configured. Click Create to add one.</div>
                        </div>
                    `;
                }
                
                html += '</div>';
            }
            
            // Separate interfaces into breakouts and real interfaces
            if (config.interfaces && Object.keys(config.interfaces).length > 0) {
                const allInterfaces = Object.entries(config.interfaces);
                
                // Separate breakout parents from real interfaces
                const breakouts = [];
                const realInterfaces = [];

                for (const [ifName, ifConfig] of allInterfaces) {
                    const cfg = ifConfig || {};
                    const isSubInterface = /s\d+$/.test(ifName);

                    if (cfg.breakout && !isSubInterface) {
                        // This is a breakout parent (physical port with breakout config)
                        breakouts.push([ifName, cfg]);
                    } else {
                        // This is a real interface (sub-interface or non-breakout)
                        realInterfaces.push([ifName, cfg]);
                    }
                    
                    // Check for nested subinterfaces (e.g., swp1.1001)
                    if (cfg.subinterfaces && typeof cfg.subinterfaces === 'object') {
                        for (const [subId, subConfig] of Object.entries(cfg.subinterfaces)) {
                            const subIfName = `${ifName}.${subId}`;
                            // Add subinterface with merged config
                            realInterfaces.push([subIfName, {
                                ...subConfig,
                                _parentInterface: ifName,
                                _isVlanSubInterface: true
                            }]);
                        }
                    }
                }
                
                // Sort function for interface names (natural sort: swp1, swp1.1001, swp2, swp2s0, swp2s1, swp3, ...)
                const sortInterfaces = (a, b) => {
                    const nameA = a[0];
                    const nameB = b[0];
                    // Extract prefix, number, and optional sub-index (handles both swp2s0 and swp1.1001 formats)
                    const parseIf = (name) => {
                        // Try breakout format first (swp2s0)
                        let match = name.match(/^([a-zA-Z]+)(\d+)s(\d+)$/);
                        if (match) {
                            return { prefix: match[1], num: parseInt(match[2]), subType: 's', sub: parseInt(match[3]) };
                        }
                        // Try VLAN sub-interface format (swp1.1001)
                        match = name.match(/^([a-zA-Z]+)(\d+)\.(\d+)$/);
                        if (match) {
                            return { prefix: match[1], num: parseInt(match[2]), subType: '.', sub: parseInt(match[3]) };
                        }
                        // Regular interface (swp1)
                        match = name.match(/^([a-zA-Z]+)(\d+)$/);
                        if (match) {
                            return { prefix: match[1], num: parseInt(match[2]), subType: '', sub: -1 };
                        }
                        return { prefix: name, num: 0, subType: '', sub: -1 };
                    };
                    const pA = parseIf(nameA);
                    const pB = parseIf(nameB);
                    if (pA.prefix !== pB.prefix) return pA.prefix.localeCompare(pB.prefix);
                    if (pA.num !== pB.num) return pA.num - pB.num;
                    // Sub-interfaces come after parent: swp1 < swp1.1001 < swp1s0
                    if (pA.sub === -1 && pB.sub !== -1) return -1;
                    if (pA.sub !== -1 && pB.sub === -1) return 1;
                    // VLAN subs (.) before breakout subs (s)
                    if (pA.subType !== pB.subType) return pA.subType === '.' ? -1 : 1;
                    return pA.sub - pB.sub;
                };
                
                // Sort both arrays
                breakouts.sort(sortInterfaces);
                realInterfaces.sort(sortInterfaces);
                
                // Breakouts Section
                if (breakouts.length > 0) {
                    html += `
                        <div class="dashboard-section">
                            <div class="section-header">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"/>
                                </svg>
                                Port Breakouts (${breakouts.length})
                            </div>
                            <div class="section-content-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Physical Port</th>
                                            <th>Breakout</th>
                                            <th>Sub-Interfaces</th>
                                            <th>Description</th>
                                            <th style="width: 60px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const [ifName, cfg] of breakouts) {
                        const breakoutType = cfg.breakout || '-';
                        
                        // Find actual configured sub-interfaces for this port
                        const actualSubInterfaces = realInterfaces
                            .filter(([name, _]) => name.startsWith(ifName + 's'))
                            .map(([name, _]) => name);
                        
                        // If no actual sub-interfaces configured, show expected ones based on breakout
                        let subInterfaceText = '-';
                        if (actualSubInterfaces.length > 0) {
                            subInterfaceText = actualSubInterfaces.join(', ');
                        } else {
                            // Calculate expected sub-interfaces
                            const breakoutMatch = breakoutType.match(/^(\d+)x/);
                            if (breakoutMatch) {
                                const subIfCount = parseInt(breakoutMatch[1]);
                                const expected = [];
                                for (let i = 0; i < subIfCount; i++) {
                                    expected.push(ifName + 's' + i);
                                }
                                subInterfaceText = `<span style="color: #888;">${expected.join(', ')} (not configured)</span>`;
                            }
                        }

                        const escapedBreakoutIfName = ifName.replace(/'/g, "\\'");
                        const escapedBreakoutDesc = (cfg.description || '').replace(/'/g, "\\'");
                        const breakoutCfgJson = encodeURIComponent(JSON.stringify(cfg));
                        
                        html += `
                            <tr>
                                <td><strong>${ifName}</strong></td>
                                <td><span class="badge badge-orange">${breakoutType}</span></td>
                                <td>${subInterfaceText}</td>
                                <td>${cfg.description || '-'}</td>
                                <td>
                                    <button class="btn-icon btn-icon-edit" onclick="openBreakoutEditModal('${escapedBreakoutIfName}', '${breakoutType}', '${escapedBreakoutDesc}')" title="Edit Breakout">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div></div>';
                }
                
                // Interfaces Section (real interfaces only)
                if (realInterfaces.length > 0) {
                    html += `
                        <div class="dashboard-section">
                            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M7.77 6.76L6.23 5.48.82 12l5.41 6.52 1.54-1.28L3.42 12l4.35-5.24zM7 13h2v-2H7v2zm10-2h-2v2h2v-2zm-6 2h2v-2h-2v2zm6.77-7.52l-1.54 1.28L20.58 12l-4.35 5.24 1.54 1.28L23.18 12l-5.41-6.52z"/>
                                    </svg>
                                    Interfaces (${realInterfaces.length})
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-add-small" onclick="openCreateSubifModal()" title="Create Subinterface">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                        </svg>
                                        SubIF
                                    </button>
                                    <button class="btn-add-small" onclick="openCreateBondModal()" title="Create Bond">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                        </svg>
                                        Bond
                                    </button>
                                </div>
                            </div>
                            <div class="section-content-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Interface</th>
                                            <th>Bond</th>
                                            <th>IP</th>
                                            <th>Profile</th>
                                            <th>VLAN(s)</th>
                                            <th>Native</th>
                                            <th>VRF</th>
                                            <th>Description</th>
                                            <th style="width: 60px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const [ifName, ifConfig] of realInterfaces) {
                        const cfg = ifConfig || {};
                        const bondInfo = interfaceToBond[ifName];
                        const profile = cfg.sw_port_profile || (bondInfo?.profile) || '';
                        const profileInfo = getPortProfileInfo(profile);
                        
                        // Get VLAN - check direct vlan field first (for VLAN sub-interfaces), then profile
                        let vlan = cfg.vlan ? String(cfg.vlan) : null;
                        if (!vlan) vlan = getVlanFromProfile(profile);
                        if (!vlan && cfg.access_vlan) vlan = String(cfg.access_vlan);
                        if (!vlan && cfg.native_vlan) vlan = String(cfg.native_vlan);
                        
                        // Get VRF - check direct vrf field first, then derive from VLAN
                        let vrf = cfg.vrf || null;
                        if (!vrf) vrf = getVrfFromVlan(vlan);
                        
                        const displayProfile = profile || '-';
                        const displayVrf = vrf || (hasDefaultVrf ? 'default' : null);
                        const ipAddr = cfg.ip || '-';
                        const description = cfg.description || (bondInfo?.description) || '-';
                        
                        // Format VLAN(s) display based on profile mode
                        let vlanDisplay = '-';
                        if (profile && profileInfo.vlans !== '-') {
                            const isTrunk = profileInfo.mode === 'trunk';
                            const badgeColor = isTrunk ? (profileInfo.vlans === 'ALL' ? 'badge-cyan' : 'badge-purple') : 'badge-green';
                            vlanDisplay = `<span class="badge ${badgeColor}">${profileInfo.vlans}</span>`;
                        } else if (vlan) {
                            vlanDisplay = `<span class="badge badge-green">${vlan}</span>`;
                        }
                        
                        // Native VLAN display
                        const nativeDisplay = profileInfo.native !== '-' 
                            ? `<span class="badge badge-orange">${profileInfo.native}</span>` 
                            : '-';
                        
                        // Escape quotes for onclick
                        const escapedIfName = ifName.replace(/'/g, "\\'");
                        const escapedProfile = (profile || '').replace(/'/g, "\\'");
                        const escapedDesc = (cfg.description || '').replace(/'/g, "\\'");
                        const hasBond = bondInfo ? bondInfo.bondName : '';
                        const cfgJson = encodeURIComponent(JSON.stringify(cfg));
                        
                        html += `
                            <tr>
                                <td>${ifName}</td>
                                <td>${bondInfo ? `<span class="badge badge-orange">${bondInfo.bondName}</span>` : '-'}</td>
                                <td>${ipAddr !== '-' ? `<span class="badge badge-blue">${ipAddr}</span>` : '-'}</td>
                                <td>${displayProfile}</td>
                                <td>${vlanDisplay}</td>
                                <td>${nativeDisplay}</td>
                                <td>${displayVrf ? `<span class="badge badge-blue">${displayVrf}</span>` : '-'}</td>
                                <td>${description}</td>
                                <td>
                                    <button class="btn-icon btn-icon-edit" onclick="openInterfaceEditModal('${escapedIfName}', '${escapedProfile}', '${escapedDesc}', '${hasBond}', '${cfgJson}')" title="Edit Interface">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div></div>';
                }
            }
            
            // Bonds Section (after interfaces)
            if (config.bonds && Object.keys(config.bonds).length > 0) {
                const bonds = Object.entries(config.bonds);
                
                html += `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 10l-2.5-1.5L15 12V4h5v8z"/>
                            </svg>
                            Bonds / LAG (${bonds.length})
                        </div>
                        <div class="section-content-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Bond</th>
                                        <th>Members</th>
                                        <th>Profile</th>
                                        <th>VLAN(s)</th>
                                        <th>Native</th>
                                        <th>VRF</th>
                                        <th>ESI</th>
                                        <th>LACP Mode</th>
                                        <th>LACP Bypass</th>
                                        <th>Description</th>
                                        <th style="width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const [bondName, bondConfig] of bonds) {
                    const cfg = bondConfig || {};
                    const profile = cfg.sw_port_profile || '';
                    const profileInfo = getPortProfileInfo(profile);
                    const vlan = getVlanFromProfile(profile);
                    const vrf = getVrfFromVlan(vlan);
                    const displayVrf = vrf || (vlan ? 'default' : null);
                    const members = cfg.bond_members?.join(', ') || '-';
                    const esi = cfg.evpn_mh_id ? `ES-${cfg.evpn_mh_id}` : '-';
                    // bond_mode can be 'lacp', 'static', or 'active'/'passive' (which means lacp mode)
                    // If bond_mode is 'active' or 'passive', it's actually the LACP mode
                    const bondMode = cfg.bond_mode || '';
                    const isActive = bondMode === 'active';
                    const lacpMode = isActive ? 'ACTIVE' : 'PASSIVE';
                    const lacpBypass = cfg.lacp_bypass ? true : false;
                    
                    // Format VLAN(s) display based on mode
                    let vlanDisplay = '-';
                    if (profileInfo.vlans !== '-') {
                        const isTrunk = profileInfo.mode === 'trunk';
                        const badgeColor = isTrunk ? (profileInfo.vlans === 'ALL' ? 'badge-cyan' : 'badge-purple') : 'badge-green';
                        vlanDisplay = `<span class="badge ${badgeColor}">${profileInfo.vlans}</span>`;
                    }
                    
                    // Native VLAN display
                    const nativeDisplay = profileInfo.native !== '-' 
                        ? `<span class="badge badge-orange">${profileInfo.native}</span>` 
                        : '-';
                    
                    // Escape quotes for onclick
                    const escapedBondName = bondName.replace(/'/g, "\\'");
                    const escapedBondProfile = (profile || '').replace(/'/g, "\\'");
                    const escapedBondDesc = (cfg.description || '').replace(/'/g, "\\'");
                    const bondCfgJson = encodeURIComponent(JSON.stringify(cfg));
                    
                    html += `
                        <tr>
                            <td><strong>${bondName}</strong></td>
                            <td>${members}</td>
                            <td>${profile || '-'}</td>
                            <td>${vlanDisplay}</td>
                            <td>${nativeDisplay}</td>
                            <td>${displayVrf ? `<span class="badge badge-blue">${displayVrf}</span>` : '-'}</td>
                            <td>${esi !== '-' ? `<span class="badge badge-orange">${esi}</span>` : '-'}</td>
                            <td><span class="badge ${isActive ? 'badge-green' : 'badge-orange'}">${lacpMode}</span></td>
                            <td>${lacpBypass ? '<span class="badge badge-green">Yes</span>' : '<span class="badge badge-red">No</span>'}</td>
                            <td>${cfg.description || '-'}</td>
                            <td>
                                <button class="btn-icon btn-icon-edit" onclick="openBondEditModal('${escapedBondName}', '${escapedBondProfile}', '${escapedBondDesc}', '${bondCfgJson}')" title="Edit Bond">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div></div>';
            }
            
            document.getElementById('content-area').innerHTML = html;
        }
        
        // Refresh device
        function refreshDevice() {
            if (selectedDevice) {
                selectDevice(selectedDevice);
            }
        }
        
        // Show error
        function showError(message) {
            document.getElementById('content-area').innerHTML = `
                <div class="welcome-screen">
                    <svg viewBox="0 0 24 24" fill="#ff6b6b" style="opacity: 1;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <h2 style="color: #ff6b6b;">Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // ========== ANSIBLE ACTIONS ==========
        
        // Show loading overlay
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            if (show) {
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }
        
        // Show alert (wrapper for showOutputModal with simple messages)
        function showAlert(message, type = 'error') {
            const title = type === 'error' ? 'Error' : (type === 'warning' ? 'Warning' : 'Info');
            const color = type === 'error' ? '#ff6b6b' : (type === 'warning' ? '#ffc107' : '#76b900');
            showOutputModal(title, `<div style="color: ${color};">${message}</div>`, type, true);
        }
        
        // Custom confirm dialog
        let confirmCallback = null;
        function showConfirm(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').innerHTML = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.add('visible');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('visible');
            confirmCallback = null;
        }
        
        function executeConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }
        
        // Show output modal
        function showOutputModal(title, content, type = 'success', isHtml = false) {
            const modal = document.getElementById('output-modal');
            const header = document.getElementById('output-modal-header');
            document.getElementById('output-modal-title').textContent = title;
            // If content is already HTML, use it directly; otherwise convert ANSI codes
            document.getElementById('output-modal-content').innerHTML = isHtml ? content : ansiToHtml(content);

            header.className = 'output-modal-header ' + type;
            modal.classList.add('visible');
        }
        
        // Hide output modal
        function hideOutputModal() {
            document.getElementById('output-modal').classList.remove('visible');
        }
        
        // Copy output content
        function copyOutput() {
            const content = document.getElementById('output-modal-content').textContent;
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = originalText, 1500);
        }
        
        // Convert ANSI codes to HTML
        function ansiToHtml(text) {
            if (!text) return '';
            
            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Wrap in span to handle orphan closing tags
            html = '<span>' + html + '</span>';
            
            // ANSI color map
            const colors = {
                '30': '#000', '31': '#e74c3c', '32': '#2ecc71', '33': '#f1c40f',
                '34': '#3498db', '35': '#9b59b6', '36': '#1abc9c', '37': '#ecf0f1',
                '90': '#7f8c8d', '91': '#ff6b6b', '92': '#4ec9b0', '93': '#ffd93d',
                '94': '#6997d5', '95': '#c586c0', '96': '#56d4bc', '97': '#fff'
            };
            
            // Replace ANSI codes with spans
            html = html.replace(/\u001b\[([0-9;]+)m/g, (match, codes) => {
                const codeList = codes.split(';');
                let style = '';
                let isReset = false;
                
                for (const code of codeList) {
                    if (code === '0' || code === '') {
                        isReset = true;
                        continue;
                    }
                    if (code === '1') style += 'font-weight:bold;';
                    else if (code === '4') style += 'text-decoration:underline;';
                    else if (colors[code]) style += `color:${colors[code]};`;
                    else {
                        const bg = parseInt(code);
                        if (bg >= 40 && bg <= 47) {
                            const fgCode = String(bg - 10);
                            if (colors[fgCode]) style += `background:${colors[fgCode]};`;
                        }
                    }
                }
                
                if (isReset && !style) return '</span>';
                if (style) return `</span><span style="${style}">`;
                return '';
            });
            
            return html;
        }
        
        // Ansible API call
        async function ansibleApiCall(action, params = {}) {
            const queryParams = new URLSearchParams({ action, ...params });
            const response = await fetch(`/ansible-api?${queryParams}`);
            return await response.json();
        }
        
        // Get target host - returns currently selected device
        function getTargetHost() {
            return selectedDevice || '';
        }
        
        // Run Generate
        async function runGenerate() {
            const host = getTargetHost();
            if (!host) {
                showOutputModal('Error', 'Please select a device first', 'error');
                return;
            }
            
            showLoading(true, `Generating config for ${host}...`);
            setStatus('Generating...');
            
            try {
                const result = await ansibleApiCall('generate', { host });
                
                if (result.success) {
                    showOutputModal(
                        `Generate Complete for ${host}`,
                        result.output || 'Config generated successfully',
                        'success'
                    );
                } else {
                    showOutputModal(
                        'Generate Failed',
                        result.error || result.output || 'Unknown error',
                        'error'
                    );
                }
            } catch (err) {
                showOutputModal('Error', 'Failed to run generate: ' + err.message, 'error');
            }
            
            showLoading(false);
            setStatus('Ready');
        }
        
        // Run Diff
        async function runDiff() {
            const host = getTargetHost();
            if (!host) {
                showOutputModal('Error', 'Please select a device first', 'error');
                return;
            }
            
            showLoading(true, `Running diff for ${host}...`);
            setStatus('Comparing...');
            
            try {
                const result = await ansibleApiCall('diff', { host });
                const output = result.output || result.error || '';
                
                if (result.success) {
                    // Check if there are changes
                    const hasChanges = output.includes('DIFF SUMMARY') && output.includes('With changes:');
                    const changesMatch = output.match(/With changes:\s*(\d+)/);
                    const changesCount = changesMatch ? parseInt(changesMatch[1]) : 0;
                    
                    // Show diff popup
                    showDiffSummaryModal(output, changesCount, host);
                } else {
                    showOutputModal('Diff Failed', output, 'error');
                }
            } catch (err) {
                showOutputModal('Error', 'Failed to run diff: ' + err.message, 'error');
            }
            
            showLoading(false);
            setStatus('Ready');
        }
        
        // Show Diff Summary Modal (special formatting)
        function showDiffSummaryModal(output, changesCount, host = '') {
            // Extract summary section
            const lines = output.split('\n');
            let summaryLines = [];
            let inSummary = false;
            
            for (const line of lines) {
                if (line.includes('PLAY RECAP')) break;
                if (line.includes('CONFIG DIFF SUMMARY') || line.includes('╔') || inSummary) {
                    inSummary = true;
                    summaryLines.push(line);
                }
            }
            
            const summaryContent = summaryLines.join('\n') || output;
            const hasChanges = changesCount > 0;
            const hostInfo = host ? ` - ${host}` : '';
            const title = hasChanges 
                ? `⚠️ Changes Detected${hostInfo}`
                : `✅ Synchronized${hostInfo}`;
            
            showOutputModal(title, summaryContent, hasChanges ? 'warning' : 'success');
        }
        
        // Run Deploy
        function runDeploy() {
            const host = getTargetHost();
            if (!host) {
                showOutputModal('Error', 'Please select a device first', 'error');
                return;
            }
            
            // Confirm deployment with custom modal
            showConfirm(
                'Confirm Deploy',
                `Are you sure you want to deploy configuration to <strong>${host}</strong>?<br><br>This will apply changes to the live network device.`,
                () => executeDeployment(host)
            );
        }
        
        async function executeDeployment(host) {
            showLoading(true, `Deploying to ${host}...`);
            setStatus('Deploying...');
            
            try {
                const result = await ansibleApiCall('deploy', { host });
                
                if (result.success) {
                    showOutputModal(
                        `Deploy Complete - ${host}`,
                        result.output || 'Configuration deployed successfully',
                        'success'
                    );
                } else {
                    showOutputModal(
                        `Deploy Failed - ${host}`,
                        result.error || result.output || 'Unknown error',
                        'error'
                    );
                }
            } catch (err) {
                showOutputModal('Error', 'Failed to deploy: ' + err.message, 'error');
            }
            
            showLoading(false);
            setStatus('Ready');
        }
        
        function setStatus(text) {
            const statusEl = document.getElementById('status-text');
            if (statusEl) statusEl.textContent = text;
        }
        
        // ==================== VLAN Management ====================
        
        let availableVrfs = ['default'];
        
        async function loadVrfs() {
            try {
                const response = await fetch('/fabric-api.sh?action=get-vrfs');
                const data = await response.json();
                if (data.success) {
                    availableVrfs = data.vrfs || ['default'];
                }
            } catch (e) {
                console.error('Failed to load VRFs:', e);
            }
        }
        
        function openVlanModal() {
            loadVrfs().then(() => {
                // Populate VRF dropdown
                const vrfSelect = document.getElementById('vlan-vrf');
                vrfSelect.innerHTML = availableVrfs.map(v => 
                    `<option value="${v}">${v}</option>`
                ).join('');
                
                // Reset form
                document.getElementById('vlan-form').reset();
                document.getElementById('vlan-l2vni').value = '';
                document.getElementById('vlan-profile-name').value = '';
                
                // Reset Range mode
                document.getElementById('vlan-range-mode').checked = false;
                document.getElementById('single-vlan-fields').style.display = 'block';
                document.getElementById('range-vlan-fields').style.display = 'none';
                document.getElementById('svi-section').style.display = 'block';
                document.getElementById('range-preview').style.display = 'none';
                document.getElementById('l2vni-label-suffix').textContent = '';
                document.getElementById('l2vni-hint').textContent = 'Default: 100000 + VLAN ID';
                document.getElementById('btn-create-vlan').textContent = 'Create VLAN';
                
                // Reset SVI/VRR fields visibility
                document.getElementById('svi-fields').classList.remove('visible');
                document.getElementById('vrr-fields').classList.remove('visible');
                document.getElementById('single-ip-field').style.display = 'block';
                
                // Reset leaking fields
                document.getElementById('vlan-leaking-enabled').checked = false;
                document.getElementById('vlan-leaking-fields').classList.remove('visible');
                
                // Show modal
                document.getElementById('vlan-modal').classList.add('visible');
            });
        }
        
        function closeVlanModal() {
            document.getElementById('vlan-modal').classList.remove('visible');
        }
        
        function toggleRangeMode() {
            const isRange = document.getElementById('vlan-range-mode').checked;
            document.getElementById('single-vlan-fields').style.display = isRange ? 'none' : 'block';
            document.getElementById('range-vlan-fields').style.display = isRange ? 'block' : 'none';
            document.getElementById('svi-section').style.display = isRange ? 'none' : 'block';
            document.getElementById('l2vni-label-suffix').textContent = isRange ? '(Offset)' : '';
            document.getElementById('l2vni-hint').textContent = isRange ? 'L2VNI = offset + VLAN ID' : 'Default: 100000 + VLAN ID';
            document.getElementById('btn-create-vlan').textContent = isRange ? 'Create VLANs' : 'Create VLAN';
            document.getElementById('vlan-description').placeholder = isRange ? 'e.g., L2 VLANs' : 'e.g., Management Network';
        }
        
        function updateRangePreview() {
            const startId = parseInt(document.getElementById('vlan-start-id').value);
            const endId = parseInt(document.getElementById('vlan-end-id').value);
            const previewDiv = document.getElementById('range-preview');
            const previewContent = document.getElementById('range-preview-content');
            
            if (startId && endId && startId <= endId && startId >= 1 && endId <= 4094) {
                const count = endId - startId + 1;
                const offset = parseInt(document.getElementById('vlan-l2vni').value) || 100000;
                
                const profileNameInput = document.getElementById('vlan-range-profile-name');
                if (!profileNameInput.value) {
                    profileNameInput.placeholder = `VLAN_${startId}_${endId}_L2`;
                }
                
                previewContent.innerHTML = `VLANs: ${startId} - ${endId} (<strong>${count} VLANs</strong>) | L2VNIs: ${offset + startId} - ${offset + endId}`;
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }
        
        // Unassign VLAN from current device
        function confirmUnassignVlan(profileName) {
            if (!selectedDevice) {
                showAlert('No device selected');
                return;
            }
            
            const modal = document.getElementById('unassign-confirm-modal');
            document.getElementById('unassign-vlan-name').textContent = profileName;
            document.getElementById('unassign-device-name').textContent = selectedDevice;
            modal.dataset.profileName = profileName;
            modal.classList.add('visible');
        }
        
        function closeUnassignModal() {
            document.getElementById('unassign-confirm-modal').classList.remove('visible');
        }
        
        function confirmUnassign() {
            const modal = document.getElementById('unassign-confirm-modal');
            const profileName = modal.dataset.profileName;
            closeUnassignModal();
            unassignVlan(profileName);
        }
        
        async function unassignVlan(profileName) {
            try {
                const response = await fetch('/fabric-api.sh?action=unassign-vlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        vlan: profileName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showOutputModal('VLAN Removed',
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ "${profileName}" removed from ${selectedDevice}</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                    selectDevice(selectedDevice);
                } else {
                    showAlert('Error: ' + result.error);
                }
            } catch (e) {
                showAlert('Failed to unassign VLAN: ' + e.message);
            }
        }
        
        // Edit VLAN modal - for editing or deleting VLANs globally
        function openEditVlanModal() {
            const modal = document.getElementById('edit-vlan-modal');
            const listContainer = document.getElementById('edit-vlan-list');
            
            // Only show VLANs assigned to current device
            const deviceVlans = currentDeviceConfig?.vlan_templates || [];
            
            if (deviceVlans.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 20px;">
                        No VLANs assigned to this device.<br>
                        <span style="font-size: 12px;">Use "Assign" or "Create" to add VLANs.</span>
                    </div>
                `;
            } else {
                listContainer.innerHTML = `
                    <div style="margin-bottom: 10px; color: #ccc;">Select a VLAN to edit or delete:</div>
                    <div class="vlan-edit-list">
                        ${deviceVlans.map(v => {
                            const vp = vlanProfiles[v];
                            const vlanId = vp?.vlan_id || '-';
                            const desc = vp?.description || '';
                            return `
                                <div class="vlan-edit-item">
                                    <div class="vlan-edit-info">
                                        <span class="vlan-name">${v}</span>
                                        <span class="vlan-info">VLAN ${vlanId}${desc ? ' - ' + desc : ''}</span>
                                    </div>
                                    <div class="vlan-edit-actions">
                                        <button class="btn-icon btn-icon-edit" onclick="editVlan('${v}')" title="Edit">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                            </svg>
                                        </button>
                                        <button class="btn-icon btn-icon-delete" onclick="closeEditVlanModal(); confirmDeleteVlan('${v}')" title="Delete">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            modal.classList.add('visible');
        }
        
        function closeEditVlanModal() {
            document.getElementById('edit-vlan-modal').classList.remove('visible');
        }
        
        async function editVlan(profileName) {
            closeEditVlanModal();
            
            const vp = vlanProfiles[profileName];
            if (!vp) {
                showAlert('VLAN profile not found');
                return;
            }
            
            // Load VRFs first
            await loadVrfs();
            
            // Populate VRF dropdown
            const vrfSelect = document.getElementById('edit-vlan-vrf');
            vrfSelect.innerHTML = availableVrfs.map(v => 
                `<option value="${v}">${v}</option>`
            ).join('');
            
            // Open edit modal and populate fields
            const modal = document.getElementById('vlan-edit-form-modal');
            document.getElementById('edit-vlan-profile-name').value = profileName;
            document.getElementById('edit-vlan-original-name').value = profileName;
            document.getElementById('edit-vlan-id').value = vp.vlan_id || '';
            document.getElementById('edit-vlan-description').value = vp.description || '';
            document.getElementById('edit-vlan-l2vni').value = vp.l2vni || '';
            
            // SVI settings
            const hasSvi = vp.vrf || vp.vrr_vip || vp.even_ip || vp.odd_ip || vp.ip;
            document.getElementById('edit-vlan-svi-enabled').checked = hasSvi;
            
            if (hasSvi) {
                document.getElementById('edit-svi-fields').classList.add('visible');
                document.getElementById('edit-vlan-vrf').value = vp.vrf || 'default';
                
                const hasVrr = vp.vrr_vip || vp.even_ip || vp.odd_ip;
                document.getElementById('edit-vlan-vrr-enabled').checked = hasVrr;
                
                if (hasVrr) {
                    document.getElementById('edit-vrr-fields').classList.add('visible');
                    document.getElementById('edit-single-ip-field').style.display = 'none';
                    document.getElementById('edit-vlan-vrr-vip').value = vp.vrr_vip || '';
                    document.getElementById('edit-vlan-even-ip').value = vp.even_ip || '';
                    document.getElementById('edit-vlan-odd-ip').value = vp.odd_ip || '';
                    document.getElementById('edit-vlan-vrr-vmac').value = vp.vrr_vmac || '';
                } else {
                    document.getElementById('edit-vrr-fields').classList.remove('visible');
                    document.getElementById('edit-single-ip-field').style.display = 'block';
                    document.getElementById('edit-vlan-gateway-ip').value = vp.ip || '';
                    document.getElementById('edit-vlan-vrr-vmac').value = '';
                }
            } else {
                document.getElementById('edit-svi-fields').classList.remove('visible');
            }
            
            // Check if subnet is already leaked and pre-populate
            const subnetForLeak = ipToNetwork(vp.vrr_vip || vp.ip);
            if (subnetForLeak && leakedSubnets[subnetForLeak]) {
                const leakInfo = leakedSubnets[subnetForLeak];
                document.getElementById('edit-vlan-leaking-enabled').checked = true;
                document.getElementById('edit-vlan-leaking-fields').classList.add('visible');
                
                // Load targets and select the current one
                loadEditVlanLeakingTargets().then(() => {
                    const select = document.getElementById('edit-vlan-leak-target-vrf');
                    for (let opt of select.options) {
                        if (opt.value === leakInfo.target_vrf) {
                            opt.selected = true;
                            break;
                        }
                    }
                });
            } else {
                document.getElementById('edit-vlan-leaking-enabled').checked = false;
                document.getElementById('edit-vlan-leaking-fields').classList.remove('visible');
            }
            
            modal.classList.add('visible');
        }
        
        function closeEditFormModal() {
            document.getElementById('vlan-edit-form-modal').classList.remove('visible');
        }
        
        function toggleEditSviFields() {
            const sviFields = document.getElementById('edit-svi-fields');
            const sviEnabled = document.getElementById('edit-vlan-svi-enabled').checked;
            if (sviEnabled) {
                sviFields.classList.add('visible');
                toggleEditVrrFields();
            } else {
                sviFields.classList.remove('visible');
            }
        }
        
        function toggleEditVrrFields() {
            const vrrFields = document.getElementById('edit-vrr-fields');
            const singleIpField = document.getElementById('edit-single-ip-field');
            const vrrEnabled = document.getElementById('edit-vlan-vrr-enabled').checked;
            
            if (vrrEnabled) {
                vrrFields.classList.add('visible');
                singleIpField.style.display = 'none';
            } else {
                vrrFields.classList.remove('visible');
                singleIpField.style.display = 'block';
            }
        }
        
        function toggleEditVlanLeakingFields() {
            const leakingFields = document.getElementById('edit-vlan-leaking-fields');
            const leakingEnabled = document.getElementById('edit-vlan-leaking-enabled').checked;
            
            if (leakingEnabled) {
                leakingFields.classList.add('visible');
                loadEditVlanLeakingTargets();
            } else {
                leakingFields.classList.remove('visible');
            }
        }
        
        async function loadEditVlanLeakingTargets() {
            const select = document.getElementById('edit-vlan-leak-target-vrf');
            const selectedVrf = document.getElementById('edit-vlan-vrf').value;
            
            try {
                const response = await fetch('/fabric-api.sh?action=get-leaking-targets');
                const data = await response.json();
                
                if (data.success && data.leaking_map) {
                    const targets = data.leaking_map[selectedVrf] || [];
                    
                    select.innerHTML = '<option value="">Select VRF...</option>';
                    targets.forEach(t => {
                        select.innerHTML += `<option value="${t.target_vrf}" data-routemap="${t.route_map}">${t.target_vrf}</option>`;
                    });
                    
                    if (targets.length === 0) {
                        select.innerHTML = '<option value="">No leaking configured for this VRF</option>';
                    }
                }
            } catch (e) {
                select.innerHTML = '<option value="">Error loading VRFs</option>';
            }
        }
        
        async function saveVlanEdit() {
            const saveBtn = document.getElementById('btn-save-vlan-edit');
            const originalName = document.getElementById('edit-vlan-original-name').value;
            
            const sviEnabled = document.getElementById('edit-vlan-svi-enabled').checked;
            const vrrEnabled = sviEnabled && document.getElementById('edit-vlan-vrr-enabled').checked;
            
            const data = {
                original_name: originalName,
                profile_name: document.getElementById('edit-vlan-profile-name').value,
                vlan_id: parseInt(document.getElementById('edit-vlan-id').value),
                description: document.getElementById('edit-vlan-description').value,
                l2vni: parseInt(document.getElementById('edit-vlan-l2vni').value) || null,
                svi_enabled: sviEnabled,
                vrr_enabled: vrrEnabled
            };
            
            if (sviEnabled) {
                data.vrf = document.getElementById('edit-vlan-vrf').value;
                if (vrrEnabled) {
                    data.vrr_vip = document.getElementById('edit-vlan-vrr-vip').value;
                    data.even_ip = document.getElementById('edit-vlan-even-ip').value;
                    data.odd_ip = document.getElementById('edit-vlan-odd-ip').value;
                    const vrrVmac = document.getElementById('edit-vlan-vrr-vmac').value.trim();
                    if (vrrVmac) {
                        data.vrr_vmac = vrrVmac;
                    }
                } else {
                    data.gateway_ip = document.getElementById('edit-vlan-gateway-ip').value;
                }
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=update-vlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Handle leaking if enabled
                    let leakingMsg = '';
                    const leakingEnabled = document.getElementById('edit-vlan-leaking-enabled').checked;
                    const leakTargetSelect = document.getElementById('edit-vlan-leak-target-vrf');
                    const leakTargetVrf = leakTargetSelect.value;
                    const leakRouteMap = leakTargetSelect.selectedOptions[0]?.dataset?.routemap || '';
                    
                    if (leakingEnabled && leakTargetVrf && leakRouteMap && sviEnabled) {
                        let subnet = '';
                        if (vrrEnabled) {
                            subnet = document.getElementById('edit-vlan-vrr-vip').value.trim();
                        } else {
                            subnet = document.getElementById('edit-vlan-gateway-ip').value.trim();
                        }
                        
                        if (subnet) {
                            const networkAddr = ipToNetwork(subnet);
                            if (networkAddr) {
                                try {
                                    const leakResp = await fetch('/fabric-api.sh?action=add-subnet-leak', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ subnet: networkAddr, route_map: leakRouteMap })
                                    });
                                    const leakResult = await leakResp.json();
                                    if (leakResult.success && leakResult.count > 0) {
                                        leakingMsg = `<p><strong>Leaking:</strong> ${networkAddr} → ${leakTargetVrf} (${leakResult.count} device(s))</p>`;
                                    }
                                } catch (e) {
                                    console.error('Leaking error:', e);
                                }
                            }
                        }
                    }
                    
                    closeEditFormModal();
                    let msg = `<div style="color: #76b900; margin-bottom: 15px;">✓ VLAN "${data.profile_name}" updated successfully!</div>`;
                    if (leakingMsg) {
                        msg += `<div style="color: #ccc;">${leakingMsg}</div>`;
                    }
                    msg += `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`;
                    showOutputModal('VLAN Updated', msg, 'success', true);
                    if (selectedDevice) selectDevice(selectedDevice);
                } else {
                    showAlert('Error: ' + result.error);
                }
            } catch (e) {
                showAlert('Failed to update VLAN: ' + e.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }
        
        function confirmDeleteVlan(profileName) {
            const modal = document.getElementById('delete-confirm-modal');
            document.getElementById('delete-vlan-name').textContent = profileName;
            modal.dataset.profileName = profileName;
            
            // Find all devices using this VLAN
            const affectedDevices = [];
            for (const [deviceName, deviceData] of Object.entries(devices)) {
                if (deviceData.config && deviceData.config.vlan_templates) {
                    if (deviceData.config.vlan_templates.includes(profileName)) {
                        affectedDevices.push(deviceName);
                    }
                }
            }
            
            // Update affected devices list
            const affectedList = document.getElementById('affected-devices-list');
            if (affectedDevices.length > 0) {
                affectedList.innerHTML = `
                    <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 8px;">
                        ⚠️ This VLAN is used by ${affectedDevices.length} device(s):
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
                        ${affectedDevices.slice(0, 10).map(d => `<span class="badge badge-orange">${d}</span>`).join('')}
                        ${affectedDevices.length > 10 ? `<span class="badge badge-gray">+${affectedDevices.length - 10} more</span>` : ''}
                    </div>
                `;
            } else {
                affectedList.innerHTML = `<div style="color: #888;">No devices are currently using this VLAN.</div>`;
            }
            
            modal.classList.add('visible');
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.remove('visible');
        }
        
        function openAssignVlanModal() {
            if (!selectedDevice) {
                showAlert('Please select a device first');
                return;
            }
            
            const modal = document.getElementById('assign-vlan-modal');
            const listContainer = document.getElementById('assign-vlan-list');
            
            // Get current device's assigned VLANs
            const deviceData = devices[selectedDevice];
            const assignedVlans = deviceData?.config?.vlan_templates || [];
            
            // Get all available VLANs from vlan_profiles
            const allVlans = Object.keys(vlanProfiles);
            
            // Filter to show only unassigned VLANs
            const availableVlans = allVlans.filter(v => !assignedVlans.includes(v));
            
            if (availableVlans.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 20px;">
                        All VLANs are already assigned to this device.<br>
                        <span style="font-size: 12px;">Use "Create" to add a new VLAN.</span>
                    </div>
                `;
            } else {
                listContainer.innerHTML = `
                    <div style="margin-bottom: 10px; color: #ccc;">Select VLANs to assign to <strong style="color: #76b900;">${selectedDevice}</strong>:</div>
                    <div class="vlan-checkbox-list">
                        ${availableVlans.map(v => {
                            const vp = vlanProfiles[v];
                            const vlanId = vp?.vlan_id || '-';
                            const desc = vp?.description || '';
                            return `
                                <label class="vlan-checkbox-item">
                                    <input type="checkbox" name="assign-vlan" value="${v}">
                                    <span class="vlan-checkbox-label">
                                        <span class="vlan-name">${v}</span>
                                        <span class="vlan-info">VLAN ${vlanId}${desc ? ' - ' + desc : ''}</span>
                                    </span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            modal.classList.add('visible');
        }
        
        function closeAssignVlanModal() {
            document.getElementById('assign-vlan-modal').classList.remove('visible');
        }
        
        async function assignVlans() {
            const checkboxes = document.querySelectorAll('input[name="assign-vlan"]:checked');
            const vlansToAssign = Array.from(checkboxes).map(cb => cb.value);
            
            if (vlansToAssign.length === 0) {
                showAlert('Please select at least one VLAN to assign');
                return;
            }
            
            const assignBtn = document.getElementById('btn-assign-vlans');
            assignBtn.disabled = true;
            assignBtn.textContent = 'Assigning...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=assign-vlans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        vlans: vlansToAssign
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeAssignVlanModal();
                    showOutputModal('VLANs Assigned',
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ ${vlansToAssign.length} VLAN(s) assigned to ${selectedDevice}!</div>` +
                        `<div style="color: #ccc;">` +
                        `<p>Assigned: ${vlansToAssign.join(', ')}</p>` +
                        `<p style="margin-top: 15px; color: #888;">Run <strong>Deploy</strong> to apply changes.</p>` +
                        `</div>`,
                        'success', true);
                    
                    // Refresh device view
                    selectDevice(selectedDevice);
                } else {
                    showAlert('Error: ' + result.error);
                }
            } catch (e) {
                showAlert('Failed to assign VLANs: ' + e.message);
            } finally {
                assignBtn.disabled = false;
                assignBtn.textContent = 'Assign Selected';
            }
        }
        
        async function deleteVlan() {
            const modal = document.getElementById('delete-confirm-modal');
            const profileName = modal.dataset.profileName;
            const deleteBtn = document.getElementById('btn-confirm-delete');
            
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=delete-vlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile_name: profileName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeDeleteModal();
                    showOutputModal('VLAN Deleted', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ VLAN profile "${profileName}" deleted successfully!</div>` +
                        `<div style="color: #ccc;">` +
                        `<p>Removed from: vlan_profiles.yaml</p>` +
                        (result.port_profile_deleted ? `<p>Port profile also removed: ${result.port_profile}</p>` : '') +
                        `<p style="margin-top: 15px; color: #888;">Run <strong>Deploy</strong> to apply changes.</p>` +
                        `</div>`,
                        'success', true);
                    
                    // Refresh device view
                    if (selectedDevice) {
                        selectDevice(selectedDevice);
                    }
                } else {
                    showAlert('Error: ' + result.error);
                }
            } catch (e) {
                showAlert('Failed to delete VLAN: ' + e.message);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete';
            }
        }

        function updateL2VNI() {
            const vlanId = document.getElementById('vlan-id').value;
            if (vlanId && !isNaN(vlanId)) {
                document.getElementById('vlan-l2vni').value = 100000 + parseInt(vlanId);
                document.getElementById('vlan-profile-name').value = 'VLAN_' + vlanId;
            }
        }
        
        function toggleSviFields() {
            const sviFields = document.getElementById('svi-fields');
            const sviEnabled = document.getElementById('vlan-svi-enabled').checked;
            if (sviEnabled) {
                sviFields.classList.add('visible');
                // Show single IP by default, VRR fields hidden
                toggleVrrFields();
            } else {
                sviFields.classList.remove('visible');
            }
        }
        
        function toggleVrrFields() {
            const vrrFields = document.getElementById('vrr-fields');
            const singleIpField = document.getElementById('single-ip-field');
            const vrrEnabled = document.getElementById('vlan-vrr-enabled').checked;
            
            if (vrrEnabled) {
                vrrFields.classList.add('visible');
                singleIpField.style.display = 'none';
            } else {
                vrrFields.classList.remove('visible');
                singleIpField.style.display = 'block';
            }
        }
        
        let vlanLeakingMap = {};
        
        function toggleVlanLeakingFields() {
            const leakingFields = document.getElementById('vlan-leaking-fields');
            const leakingEnabled = document.getElementById('vlan-leaking-enabled').checked;
            
            if (leakingEnabled) {
                leakingFields.classList.add('visible');
                loadVlanLeakingTargets();
            } else {
                leakingFields.classList.remove('visible');
            }
        }
        
        async function loadVlanLeakingTargets() {
            const select = document.getElementById('vlan-leak-target-vrf');
            const selectedVrf = document.getElementById('vlan-vrf').value;
            
            try {
                const response = await fetch('/fabric-api.sh?action=get-leaking-targets');
                const data = await response.json();
                
                if (data.success && data.leaking_map) {
                    vlanLeakingMap = data.leaking_map;
                    const targets = vlanLeakingMap[selectedVrf] || [];
                    
                    select.innerHTML = '<option value="">Select VRF...</option>';
                    targets.forEach(t => {
                        select.innerHTML += `<option value="${t.target_vrf}" data-routemap="${t.route_map}">${t.target_vrf}</option>`;
                    });
                    
                    if (targets.length === 0) {
                        select.innerHTML = '<option value="">No leaking configured for this VRF</option>';
                    }
                }
            } catch (e) {
                select.innerHTML = '<option value="">Error loading VRFs</option>';
            }
        }
        
        function onVlanVrfChange() {
            if (document.getElementById('vlan-leaking-enabled').checked) {
                loadVlanLeakingTargets();
            }
        }
        
        async function createVlan() {
            const createBtn = document.getElementById('btn-create-vlan');
            const isRangeMode = document.getElementById('vlan-range-mode').checked;
            
            const description = document.getElementById('vlan-description').value.trim();
            if (!description) {
                showAlert('Description is required');
                return;
            }
            
            createBtn.disabled = true;
            
            if (isRangeMode) {
                // Range mode - create multiple VLANs
                const startId = parseInt(document.getElementById('vlan-start-id').value);
                const endId = parseInt(document.getElementById('vlan-end-id').value);
                
                if (!startId || !endId || startId < 1 || endId > 4094) {
                    showAlert('VLAN IDs must be between 1 and 4094');
                    createBtn.disabled = false;
                    return;
                }
                
                if (startId > endId) {
                    showAlert('Start VLAN ID must be less than or equal to End VLAN ID');
                    createBtn.disabled = false;
                    return;
                }
                
                const count = endId - startId + 1;
                if (count > 500) {
                    showAlert('Maximum 500 VLANs can be created at once');
                    createBtn.disabled = false;
                    return;
                }
                
                const profileName = document.getElementById('vlan-range-profile-name').value || `VLAN_${startId}_${endId}_L2`;
                const l2vniOffset = parseInt(document.getElementById('vlan-l2vni').value) || 100000;
                
                const data = {
                    start_id: startId,
                    end_id: endId,
                    profile_name: profileName,
                    description: description,
                    l2vni_offset: l2vniOffset
                };
                
                createBtn.textContent = `Creating ${count} VLANs...`;
                
                try {
                    const response = await fetch('/fabric-api.sh?action=bulk-create-vlans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Assign to current device
                        const createdVlans = result.created_vlans || [];
                        
                        let assignedCount = 0;
                        if (selectedDevice && createdVlans.length > 0) {
                            createBtn.textContent = 'Assigning to device...';
                            try {
                                const assignResp = await fetch('/fabric-api.sh?action=assign-vlans', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ device: selectedDevice, vlans: createdVlans })
                                });
                                const assignResult = await assignResp.json();
                                if (assignResult.success) assignedCount = 1;
                            } catch (e) {}
                        }
                        
                        closeVlanModal();
                        let msg = `<div style="color: #76b900; margin-bottom: 15px;">✓ ${count} VLANs created successfully!</div>` +
                            `<div style="color: #ccc;">` +
                            `<p><strong>Profile:</strong> ${profileName}</p>` +
                            `<p><strong>Range:</strong> ${startId} - ${endId}</p>`;
                        if (assignedCount > 0) {
                            msg += `<p><strong>Assigned to:</strong> ${selectedDevice}</p>`;
                        }
                        msg += `<p style="margin-top: 15px; color: #888;">Run <strong>Deploy</strong> to apply changes.</p>` +
                            `</div>`;
                        showOutputModal('VLANs Created', msg, 'success', true);
                        if (selectedDevice) {
                            selectDevice(selectedDevice);
                        }
                    } else {
                        showOutputModal('Creation Failed', 
                            `<div style="color: #ff6b6b; margin-bottom: 15px;">✗ Failed to create VLANs</div>` +
                            `<div style="color: #ccc;">${result.error || 'Unknown error'}</div>`,
                            'error', true);
                    }
                } catch (e) {
                    showOutputModal('Error', `<div style="color: #ff6b6b;">${e.message}</div>`, 'error', true);
                }
                
                createBtn.disabled = false;
                createBtn.textContent = 'Create VLANs';
                return;
            }
            
            // Single VLAN mode
            const vlanId = parseInt(document.getElementById('vlan-id').value);
            if (!vlanId || vlanId < 1 || vlanId > 4094) {
                showAlert('VLAN ID must be between 1 and 4094');
                createBtn.disabled = false;
                return;
            }
            
            // Build data
            const sviEnabled = document.getElementById('vlan-svi-enabled').checked;
            const vrrEnabled = sviEnabled && document.getElementById('vlan-vrr-enabled').checked;
            
            const data = {
                vlan_id: vlanId,
                profile_name: document.getElementById('vlan-profile-name').value || `VLAN_${vlanId}`,
                description: description,
                l2vni: parseInt(document.getElementById('vlan-l2vni').value) || (100000 + vlanId),
                stp_bpduguard: document.getElementById('vlan-stp-bpduguard').checked,
                svi_enabled: sviEnabled,
                vrr_enabled: vrrEnabled
            };
            
            // Only include VRF and IP info if SVI is enabled
            if (sviEnabled) {
                data.vrf = document.getElementById('vlan-vrf').value;
                
                if (vrrEnabled) {
                    // VRR mode: VIP + Even/Odd IPs
                    data.vrr_vip = document.getElementById('vlan-vrr-vip').value.trim();
                    data.even_ip = document.getElementById('vlan-even-ip').value.trim();
                    data.odd_ip = document.getElementById('vlan-odd-ip').value.trim();
                    const vrrVmac = document.getElementById('vlan-vrr-vmac').value.trim();
                    if (vrrVmac) {
                        data.vrr_vmac = vrrVmac;
                    }
                } else {
                    // Single gateway IP mode
                    data.gateway_ip = document.getElementById('vlan-gateway-ip').value.trim();
                }
            }
            
            createBtn.textContent = 'Creating...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=create-vlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Assign to current device
                    const profileName = data.profile_name;
                    
                    let assignedCount = 0;
                    if (selectedDevice) {
                        createBtn.textContent = 'Assigning to device...';
                        try {
                            const assignResp = await fetch('/fabric-api.sh?action=assign-vlans', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ device: selectedDevice, vlans: [profileName] })
                            });
                            const assignResult = await assignResp.json();
                            if (assignResult.success) assignedCount = 1;
                        } catch (e) {}
                    }
                    
                    // Handle leaking if enabled
                    let leakingMsg = '';
                    const leakingEnabled = document.getElementById('vlan-leaking-enabled').checked;
                    const leakTargetSelect = document.getElementById('vlan-leak-target-vrf');
                    const leakTargetVrf = leakTargetSelect.value;
                    const leakRouteMap = leakTargetSelect.selectedOptions[0]?.dataset?.routemap || '';
                    
                    if (leakingEnabled && leakTargetVrf && leakRouteMap && sviEnabled) {
                        let subnet = '';
                        if (vrrEnabled) {
                            subnet = document.getElementById('vlan-vrr-vip').value.trim();
                        } else {
                            subnet = document.getElementById('vlan-gateway-ip').value.trim();
                        }
                        
                        if (subnet) {
                            const networkAddr = ipToNetwork(subnet);
                            if (networkAddr) {
                                try {
                                    const leakResp = await fetch('/fabric-api.sh?action=add-subnet-leak', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ subnet: networkAddr, route_map: leakRouteMap })
                                    });
                                    const leakResult = await leakResp.json();
                                    if (leakResult.success && leakResult.count > 0) {
                                        leakingMsg = `<p><strong>Leaking:</strong> ${networkAddr} → ${leakTargetVrf} (${leakResult.count} device(s))</p>`;
                                    }
                                } catch (e) {
                                    console.error('Leaking error:', e);
                                }
                            }
                        }
                    }
                    
                    closeVlanModal();
                    let msg = '<div style="color: #76b900; margin-bottom: 15px;">✓ VLAN ' + vlanId + ' created successfully!</div>' +
                        '<div style="color: #ccc;">' +
                        '<p><strong>VLAN Profile:</strong> ' + result.vlan_profile + '</p>' +
                        '<p><strong>Port Profile:</strong> ' + result.port_profile + '</p>';
                    if (assignedCount > 0) {
                        msg += '<p><strong>Assigned to:</strong> ' + selectedDevice + '</p>';
                    }
                    if (leakingMsg) {
                        msg += leakingMsg;
                    }
                    msg += '<p style="margin-top: 15px; color: #888;">Run <strong>Deploy</strong> to apply changes to devices.</p>' +
                        '</div>';
                    showOutputModal('VLAN Created', msg, 'success', true);
                    
                    // Refresh current device if one is selected
                    if (selectedDevice) {
                        selectDevice(selectedDevice);
                    }
                } else {
                    showOutputModal('VLAN Creation Failed', 
                        `<div style="color: #ff6b6b; margin-bottom: 15px;">✗ Failed to create VLAN</div>` +
                        `<div style="color: #ccc;">${result.error || 'Unknown error'}</div>`,
                        'error', true);
                }
            } catch (e) {
                showOutputModal('Error', 
                    `<div style="color: #ff6b6b;">${e.message}</div>`,
                    'error', true);
            }

            createBtn.disabled = false;
            createBtn.textContent = 'Create VLAN';
        }
        
        // ==================== VRF MANAGEMENT ====================
        
        // Available VRFs (global)
        let availableVrfProfiles = {};
        
        // Open VRF Create Modal
        async function openVrfModal() {
            document.getElementById('vrf-form').reset();
            
            // Reset custom loopback checkbox and input
            document.getElementById('vrf-custom-loopback').checked = false;
            document.getElementById('vrf-loopback-container').style.display = 'none';
            document.getElementById('vrf-loopback-ip').value = '';
            
            // Reset leaking options
            document.getElementById('vrf-leaking-enabled').checked = false;
            document.getElementById('vrf-leaking-options').style.display = 'none';
            document.getElementById('vrf-profile-group').style.display = 'block';
            
            // Hide BGP ASN field since we'll use each device's own ASN
            document.getElementById('vrf-bgp-asn').parentElement.style.display = 'none';
            
            // Load BGP profiles dynamically
            const select = document.getElementById('vrf-bgp-profile');
            select.innerHTML = '<option value="">Loading...</option>';
            
            try {
                const response = await fetch('/fabric-api.sh?action=get-bgp-profiles');
                const data = await response.json();
                
                if (data.success && data.profiles.length > 0) {
                    select.innerHTML = data.profiles.map(p => 
                        `<option value="${p.name}" ${p.name === 'OVERLAY_LEAF' ? 'selected' : ''}>${p.name}</option>`
                    ).join('');
                } else {
                    select.innerHTML = '<option value="OVERLAY_LEAF">OVERLAY_LEAF</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="OVERLAY_LEAF">OVERLAY_LEAF</option>';
            }
            
            document.getElementById('vrf-modal').classList.add('visible');
        }
        
        function closeVrfModal() {
            document.getElementById('vrf-modal').classList.remove('visible');
        }
        
        // Toggle leaking options
        async function toggleLeakingOptions() {
            const checkbox = document.getElementById('vrf-leaking-enabled');
            const optionsDiv = document.getElementById('vrf-leaking-options');
            const profileGroup = document.getElementById('vrf-profile-group');
            const profileHint = document.getElementById('vrf-profile-hint');
            
            if (checkbox.checked) {
                optionsDiv.style.display = 'block';
                profileGroup.style.display = 'none'; // Hide manual profile selection
                
                // Load VRFs for leaking dropdown
                const leakFromSelect = document.getElementById('vrf-leak-from');
                leakFromSelect.innerHTML = '<option value="">Loading...</option>';
                
                try {
                    const response = await fetch('/fabric-api.sh?action=get-leaking-vrfs');
                    const data = await response.json();
                    
                    if (data.success && data.vrfs.length > 0) {
                        leakFromSelect.innerHTML = '<option value="">Select VRF...</option>' +
                            data.vrfs.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
                    } else {
                        leakFromSelect.innerHTML = '<option value="">No leaking-enabled VRFs found</option>';
                    }
                } catch (e) {
                    leakFromSelect.innerHTML = '<option value="">Error loading VRFs</option>';
                }
            } else {
                optionsDiv.style.display = 'none';
                profileGroup.style.display = 'block';
            }
        }
        
        function toggleCustomLoopback() {
            const checkbox = document.getElementById('vrf-custom-loopback');
            const container = document.getElementById('vrf-loopback-container');
            const input = document.getElementById('vrf-loopback-ip');
            
            if (checkbox.checked) {
                container.style.display = 'block';
                input.focus();
            } else {
                container.style.display = 'none';
                input.value = '';
            }
        }
        
        // Create VRF
        async function createVrf() {
            const createBtn = document.getElementById('btn-create-vrf');
            const vrfName = document.getElementById('vrf-name').value.trim();
            const l3vni = parseInt(document.getElementById('vrf-l3vni').value);
            const leakingEnabled = document.getElementById('vrf-leaking-enabled').checked;
            const leakFromVrf = document.getElementById('vrf-leak-from').value;
            const customLoopback = document.getElementById('vrf-custom-loopback').checked;
            const loopbackIp = document.getElementById('vrf-loopback-ip').value.trim();
            
            if (!selectedDevice) {
                showAlert('Please select a device first');
                return;
            }
            
            if (!vrfName) {
                showAlert('VRF name is required');
                return;
            }
            
            if (!l3vni) {
                showAlert('L3VNI is required');
                return;
            }
            
            if (leakingEnabled && !leakFromVrf) {
                showAlert('Please select a VRF to leak from');
                return;
            }
            
            if (customLoopback && !loopbackIp) {
                showAlert('Please enter a loopback IP address with mask (e.g., 10.128.131.6/32)');
                return;
            }
            
            if (customLoopback && loopbackIp && !loopbackIp.includes('/')) {
                showAlert('Please include mask in loopback IP (e.g., 10.128.131.6/32)');
                return;
            }
            
            const data = {
                devices: [selectedDevice],
                vrf_name: vrfName,
                l3vni: l3vni,
                vxlan_int: parseInt(document.getElementById('vrf-vxlan-int').value) || null,
                bgp_profile: leakingEnabled ? null : (document.getElementById('vrf-bgp-profile').value.trim() || null),
                leaking_enabled: leakingEnabled,
                leak_from_vrf: leakingEnabled ? leakFromVrf : null
            };
            
            if (customLoopback && loopbackIp) {
                data.loopback_ip = loopbackIp;
            }
            
            createBtn.disabled = true;
            createBtn.textContent = `Creating on ${selectedDevice}...`;
            
            try {
                const response = await fetch('/fabric-api.sh?action=create-vrf-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeVrfModal();
                    
                    let message = `<div style="color: #76b900; margin-bottom: 15px;">✓ VRF "${vrfName}" created on ${selectedDevice}</div>`;
                    
                    if (result.leaking_configured) {
                        message += `<div style="color: #4fc3f7; margin-bottom: 10px;">✓ Route leaking configured:</div>`;
                        message += `<div style="color: #888; margin-left: 15px; margin-bottom: 5px;">• New VRF uses profile: <strong>${result.tenant_profile}</strong></div>`;
                        message += `<div style="color: #888; margin-left: 15px; margin-bottom: 10px;">• Updated <strong>${result.shared_profile}</strong> to import from ${vrfName}</div>`;
                    } else if (result.warning) {
                        message += `<div style="color: #ff9800; margin-bottom: 10px;">⚠ ${result.warning}</div>`;
                    }
                    
                    message += `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`;
                    
                    // Refresh current device if selected
                    if (selectedDevice) {
                        await selectDevice(selectedDevice);
                    }
                    showOutputModal('VRF Created', message, 'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
            
            createBtn.disabled = false;
            createBtn.textContent = 'Create VRF';
        }
        
        // Open Assign VRF Modal
        async function openAssignVrfModal() {
            if (!selectedDevice) {
                showAlert('Please select a device first');
                return;
            }
            
            const modal = document.getElementById('assign-vrf-modal');
            const listDiv = document.getElementById('assign-vrf-list');
            
            listDiv.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">Loading VRFs...</div>';
            modal.classList.add('visible');
            
            try {
                // Get available VRFs from existing devices
                const response = await fetch('/fabric-api.sh?action=get-available-vrfs');
                const data = await response.json();
                
                if (!data.success) {
                    listDiv.innerHTML = '<div style="color: #ff6b6b;">Failed to load VRFs</div>';
                    return;
                }
                
                const allVrfs = data.vrfs || [];
                const deviceConfig = await fetch(`/fabric-api.sh?action=get-device&device=${selectedDevice}`).then(r => r.json());
                const currentVrfs = deviceConfig.success && deviceConfig.config.vrfs ? Object.keys(deviceConfig.config.vrfs) : [];
                
                // Filter out already assigned VRFs
                const availableVrfs = allVrfs.filter(v => !currentVrfs.includes(v.name));
                
                if (availableVrfs.length === 0) {
                    listDiv.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">All VRFs are already assigned to this device, or no VRF templates exist.</div>';
                    return;
                }
                
                listDiv.innerHTML = `
                    <div class="vlan-checkbox-list">
                        ${availableVrfs.map(v => `
                            <label class="vlan-checkbox-item">
                                <input type="checkbox" value="${v.name}" data-l3vni="${v.l3vni || ''}" data-vxlan-int="${v.vxlan_int || ''}">
                                <span class="vlan-name">${v.name}</span>
                                <span class="vlan-info">${v.l3vni ? 'L3VNI: ' + v.l3vni : ''}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                listDiv.innerHTML = `<div style="color: #ff6b6b;">Error: ${e.message}</div>`;
            }
        }
        
        function closeAssignVrfModal() {
            document.getElementById('assign-vrf-modal').classList.remove('visible');
        }
        
        async function assignVrfs() {
            const checkboxes = document.querySelectorAll('#assign-vrf-list input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showAlert('Please select at least one VRF');
                return;
            }
            
            const vrfs = Array.from(checkboxes).map(cb => ({
                name: cb.value,
                l3vni: cb.dataset.l3vni || null,
                vxlan_int: cb.dataset.vxlanInt || null
            }));
            
            const assignBtn = document.getElementById('btn-assign-vrfs');
            assignBtn.disabled = true;
            assignBtn.textContent = 'Assigning...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=assign-vrfs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        vrfs: vrfs.map(v => v.name)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeAssignVrfModal();
                    // Refresh first, then show modal
                    await selectDevice(selectedDevice);
                    showOutputModal('VRFs Assigned', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ ${vrfs.length} VRF(s) assigned to ${selectedDevice}</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
            
            assignBtn.disabled = false;
            assignBtn.textContent = 'Assign Selected';
        }
        
        // Unassign VRF from device
        let unassigningVrfName = '';
        
        function confirmUnassignVrf(vrfName) {
            if (!selectedDevice) {
                showAlert('No device selected');
                return;
            }
            
            unassigningVrfName = vrfName;
            document.getElementById('unassign-vrf-name').textContent = vrfName;
            document.getElementById('unassign-vrf-device-name').textContent = selectedDevice;
            document.getElementById('unassign-vrf-confirm-modal').classList.add('visible');
        }
        
        function closeUnassignVrfModal() {
            document.getElementById('unassign-vrf-confirm-modal').classList.remove('visible');
            unassigningVrfName = '';
        }
        
        async function confirmUnassignVrfAction() {
            if (!unassigningVrfName) return;
            
            closeUnassignVrfModal();
            
            try {
                const response = await fetch('/fabric-api.sh?action=unassign-vrf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        vrf: unassigningVrfName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Refresh first, then show modal
                    await selectDevice(selectedDevice);
                    
                    let message = `<div style="color: #76b900; margin-bottom: 15px;">✓ "${unassigningVrfName}" removed from ${selectedDevice}</div>`;
                    if (result.leaking_removed) {
                        message += `<div style="color: #4fc3f7; margin-bottom: 10px;">✓ Leaking references also removed from BGP profiles</div>`;
                    }
                    message += `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`;
                    
                    showOutputModal('VRF Removed', message, 'success', true);
                } else {
                    showAlert('Error: ' + result.error);
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
        }
        
        // Edit VRF Modal (list device's VRFs only, exclude default)
        async function openEditVrfModal() {
            const modal = document.getElementById('edit-vrf-modal');
            const listDiv = document.getElementById('edit-vrf-list');
            
            if (!currentDeviceConfig || !currentDeviceConfig.vrfs) {
                listDiv.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">No VRFs configured on this device.</div>';
                modal.classList.add('visible');
                return;
            }
            
            // Get device's VRFs, excluding 'default'
            const deviceVrfs = Object.entries(currentDeviceConfig.vrfs)
                .filter(([name, _]) => name !== 'default')
                .map(([name, config]) => ({
                    name: name,
                    l3vni: config.vxlan_int || config.l3vni || '-'
                }));
            
            if (deviceVrfs.length === 0) {
                listDiv.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">No tenant VRFs configured on this device.</div>';
                modal.classList.add('visible');
                return;
            }
            
            modal.classList.add('visible');
            
            listDiv.innerHTML = `
                <div class="vlan-edit-list">
                    ${deviceVrfs.map(v => `
                        <div class="vlan-edit-item">
                            <div class="vlan-edit-info">
                                <span class="vlan-name">${v.name}</span>
                                <span class="vlan-info">L3VNI: ${v.l3vni}</span>
                            </div>
                            <div class="vlan-edit-actions">
                                <button class="btn-icon btn-icon-delete" onclick="closeEditVrfModal(); confirmUnassignVrf('${v.name}')" title="Remove from device">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function closeEditVrfModal() {
            document.getElementById('edit-vrf-modal').classList.remove('visible');
        }
        
        // Delete VRF globally (from all devices)
        let deletingVrfName = '';
        
        async function confirmDeleteVrf(vrfName) {
            if (vrfName === 'default') {
                showOutputModal('Error', '<div style="color: #f44336;">Cannot delete the default VRF</div>', 'error', true);
                return;
            }
            
            deletingVrfName = vrfName;
            document.getElementById('delete-vrf-name').textContent = vrfName;
            
            // Fetch affected devices
            let devicesHtml = '<div style="color: #888; font-size: 13px;">Loading...</div>';
            document.getElementById('delete-vrf-devices').innerHTML = devicesHtml;
            document.getElementById('delete-vrf-confirm-modal').classList.add('visible');
            
            try {
                const reportResp = await fetch('/fabric-api.sh?action=get-vrf-report');
                const reportData = await reportResp.json();
                if (reportData.success && reportData.vrfs) {
                    const vrfInfo = reportData.vrfs[vrfName];
                    if (vrfInfo && vrfInfo.devices && vrfInfo.devices.length > 0) {
                        devicesHtml = `<div style="color: #888; font-size: 13px; margin-bottom: 8px;">Affected devices (${vrfInfo.devices.length}):</div>`;
                        devicesHtml += `<div style="background: #1a1a1a; padding: 10px; border-radius: 4px; font-size: 12px; color: #4fc3f7;">`;
                        devicesHtml += vrfInfo.devices.join(', ');
                        devicesHtml += `</div>`;
                    } else {
                        devicesHtml = '<div style="color: #888; font-size: 13px;">No devices are currently using this VRF.</div>';
                    }
                }
            } catch (e) {
                devicesHtml = '<div style="color: #888; font-size: 13px;">Could not fetch device list.</div>';
            }
            
            document.getElementById('delete-vrf-devices').innerHTML = devicesHtml;
        }
        
        function closeDeleteVrfModal() {
            document.getElementById('delete-vrf-confirm-modal').classList.remove('visible');
            deletingVrfName = '';
        }
        
        async function executeDeleteVrf() {
            if (!deletingVrfName) return;
            
            const vrfName = deletingVrfName;
            closeDeleteVrfModal();
            
            try {
                const response = await fetch('/fabric-api.sh?action=delete-vrf-global', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vrf_name: vrfName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const devices = result.devices_updated || [];
                    let message = `<div style="color: #76b900; margin-bottom: 15px;">✓ VRF "${vrfName}" deleted</div>`;
                    if (devices.length > 0) {
                        message += `<div style="color: #888; margin-bottom: 5px;">Removed from ${devices.length} device(s):</div>`;
                        message += `<div style="color: #aaa; margin-bottom: 10px; padding-left: 10px; font-size: 12px;">${devices.join(', ')}</div>`;
                    } else {
                        message += `<div style="color: #888; margin-bottom: 10px;">No devices were using this VRF</div>`;
                    }
                    if (result.leaking_removed) {
                        message += `<div style="color: #4fc3f7; margin-bottom: 10px;">✓ Leaking references also removed</div>`;
                    }
                    message += `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`;
                    
                    showOutputModal('VRF Deleted', message, 'success', true);
                    
                    // Refresh current device if selected
                    if (selectedDevice) {
                        await selectDevice(selectedDevice);
                    }
                } else {
                    showOutputModal('Error', `<div style="color: #f44336;">${result.error || 'Unknown error'}</div>`, 'error', true);
                }
            } catch (e) {
                showOutputModal('Error', `<div style="color: #f44336;">${e.message}</div>`, 'error', true);
            }
        }
        
        // ==================== CREATE BOND ====================
        
        function openCreateBondModal() {
            const modal = document.getElementById('create-bond-modal');
            
            // Populate port profile dropdown
            populateVlanProfilesDropdown('bond-profile', '');
            
            // Clear form
            document.getElementById('bond-name').value = '';
            document.getElementById('bond-mh-id').value = '';
            document.getElementById('bond-mode').value = 'lacp';
            document.getElementById('bond-lacp-bypass').checked = false;
            document.getElementById('bond-description').value = '';
            
            modal.classList.add('visible');
        }
        
        function closeCreateBondModal() {
            document.getElementById('create-bond-modal').classList.remove('visible');
        }
        
        async function saveCreateBond() {
            const bondName = document.getElementById('bond-name').value.trim();
            const profile = document.getElementById('bond-profile').value;
            const mhId = document.getElementById('bond-mh-id').value;
            const bondMode = document.getElementById('bond-mode').value;
            const lacpBypass = document.getElementById('bond-lacp-bypass').checked;
            const description = document.getElementById('bond-description').value.trim();
            
            if (!bondName) {
                showAlert('Please enter a bond name');
                return;
            }
            
            const saveBtn = document.getElementById('btn-create-bond');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Creating...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=create-bond', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        bond_name: bondName,
                        profile: profile,
                        evpn_mh_id: mhId,
                        bond_mode: bondMode,
                        lacp_bypass: lacpBypass,
                        description: description
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeCreateBondModal();
                    await selectDevice(selectedDevice);
                    showOutputModal('Bond Created', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ Bond ${bondName} created successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes. Then assign interfaces as bond members.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Failed to create bond'));
                }
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Create Bond';
            }
        }
        
        // ==================== CREATE SUBINTERFACE ====================
        
        function openCreateSubifModal() {
            const modal = document.getElementById('create-subif-modal');
            
            // Populate parent interface dropdown with physical ports (not breakout sub-ports)
            const parentSelect = document.getElementById('subif-parent');
            parentSelect.innerHTML = '<option value="">Select parent interface...</option>';
            
            if (currentDeviceConfig && currentDeviceConfig.interfaces) {
                // Get physical ports (swp1, swp2, etc. - not swp1s0)
                const physicalPorts = Object.keys(currentDeviceConfig.interfaces)
                    .filter(name => /^swp\d+$/.test(name))
                    .sort((a, b) => {
                        const numA = parseInt(a.replace('swp', ''));
                        const numB = parseInt(b.replace('swp', ''));
                        return numA - numB;
                    });
                
                for (const port of physicalPorts) {
                    parentSelect.innerHTML += `<option value="${port}">${port}</option>`;
                }
            }
            
            // Populate VRF dropdown
            populateVrfDropdown('subif-vrf', '');
            
            // Clear form
            document.getElementById('subif-id').value = '';
            document.getElementById('subif-vlan').value = '';
            document.getElementById('subif-ip').value = '';
            document.getElementById('subif-description').value = '';
            
            modal.classList.add('visible');
        }
        
        function closeCreateSubifModal() {
            document.getElementById('create-subif-modal').classList.remove('visible');
        }
        
        async function saveCreateSubif() {
            const parentIf = document.getElementById('subif-parent').value;
            const subifId = document.getElementById('subif-id').value;
            const vlanId = document.getElementById('subif-vlan').value;
            const ip = document.getElementById('subif-ip').value.trim();
            const vrf = document.getElementById('subif-vrf').value;
            const description = document.getElementById('subif-description').value.trim();
            
            if (!parentIf || !subifId || !vlanId) {
                showAlert('Please fill in Parent Interface, Subinterface ID, and VLAN ID');
                return;
            }
            
            const saveBtn = document.getElementById('btn-create-subif');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Creating...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=update-interface', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        interface_name: `${parentIf}.${subifId}`,
                        interface_type: 'subif',
                        vlan_id: vlanId,
                        ip: ip,
                        vrf: vrf,
                        description: description
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeCreateSubifModal();
                    await selectDevice(selectedDevice);
                    showOutputModal('Subinterface Created', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ Subinterface ${parentIf}.${subifId} created successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'Create Subinterface';
        }
        
        // ==================== INTERFACE / BOND EDIT ====================
        
        function showInterfaceFields(mode, showModeSelector = true) {
            // mode: 'l2', 'l3', 'subif', 'bond', 'breakout', 'bond-member'
            const groups = {
                'interface-edit-mode-group': showModeSelector ? ['l2', 'l3', 'subif', 'bond-member'] : [],
                'interface-edit-bond-select-group': ['bond-member'],
                'interface-edit-breakout-group': ['breakout'],
                'interface-edit-profile-group': ['l2', 'bond'],
                'interface-edit-ip-group': ['l3', 'subif'],
                'interface-edit-vrf-group': ['l3', 'subif'],
                'interface-edit-vlan-id-group': ['subif'],
                'interface-edit-members-group': ['bond'],
                'interface-edit-mh-id-group': ['bond'],
                'interface-edit-bond-options-group': ['bond']
            };
            
            for (const [id, modes] of Object.entries(groups)) {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = modes.includes(mode) ? 'block' : 'none';
                }
            }
        }
        
        function onInterfaceModeChange() {
            const mode = document.getElementById('interface-edit-mode').value;
            document.getElementById('interface-edit-type').value = mode;
            showInterfaceFields(mode, true);
            
            // Populate appropriate dropdowns
            if (mode === 'l2') {
                populateVlanProfilesDropdown('interface-edit-profile', '');
            } else if (mode === 'l3' || mode === 'subif') {
                populateVrfDropdown('interface-edit-vrf', '');
            } else if (mode === 'bond-member') {
                populateBondDropdown('interface-edit-bond-select', currentInterfaceBond);
            }
        }
        
        function populateVrfDropdown(selectId, currentValue) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">default</option>';
            
            if (currentDeviceConfig && currentDeviceConfig.vrfs) {
                for (const vrfName of Object.keys(currentDeviceConfig.vrfs)) {
                    if (vrfName !== 'default') {
                        const selected = vrfName === currentValue ? 'selected' : '';
                        select.innerHTML += `<option value="${vrfName}" ${selected}>${vrfName}</option>`;
                    }
                }
            }
        }
        
        let currentInterfaceBond = '';  // Track current bond for comparison
        
        function openInterfaceEditModal(ifName, currentProfile, currentDesc, bondName, ifConfig) {
            const modal = document.getElementById('interface-edit-modal');
            const config = ifConfig ? JSON.parse(decodeURIComponent(ifConfig)) : {};
            
            // Reset subif option visibility (might have been hidden from previous edit)
            const modeSelect = document.getElementById('interface-edit-mode');
            const subifOption = modeSelect.querySelector('option[value="subif"]');
            if (subifOption) subifOption.style.display = '';
            
            // Store current bond for later comparison
            currentInterfaceBond = bondName || '';
            
            // Check if this is an existing subinterface (name contains dot like swp1s0.1002)
            const isExistingSubif = config._isVlanSubInterface || ifName.includes('.');
            
            // Determine interface mode based on current config
            let mode = 'l2';
            
            if (isExistingSubif) {
                mode = 'subif';
            } else if (bondName) {
                mode = 'bond-member';
            } else if (config.ip) {
                mode = 'l3';
            } else if (config.subinterfaces) {
                mode = 'l3';
            }
            
            // Set hidden values
            document.getElementById('interface-edit-name').value = ifName;
            document.getElementById('interface-edit-type').value = mode;
            document.getElementById('interface-edit-display-name').value = ifName;
            document.getElementById('interface-edit-modal-title').textContent = 'Edit Interface';
            
            // Configure mode selector based on interface type
            if (isExistingSubif) {
                // For existing subinterfaces: hide mode selector, show only subif fields
                showInterfaceFields(mode, false);  // false = don't show mode selector
            } else {
                // For physical interfaces: hide "Subinterface" option from dropdown
                if (subifOption) subifOption.style.display = 'none';
                modeSelect.value = mode;
                showInterfaceFields(mode, true);
            }
            
            // Populate fields based on mode
            if (mode === 'l2') {
                populateVlanProfilesDropdown('interface-edit-profile', currentProfile);
            } else if (mode === 'l3') {
                document.getElementById('interface-edit-ip').value = config.ip || '';
                populateVrfDropdown('interface-edit-vrf', config.vrf || '');
            } else if (mode === 'subif') {
                document.getElementById('interface-edit-vlan-id').value = config.vlan || '';
                document.getElementById('interface-edit-ip').value = config.ip || '';
                populateVrfDropdown('interface-edit-vrf', config.vrf || '');
            } else if (mode === 'bond-member') {
                populateBondDropdown('interface-edit-bond-select', bondName);
            }
            
            document.getElementById('interface-edit-description').value = currentDesc || '';
            
            // Show delete button only for subinterfaces
            document.getElementById('btn-delete-interface').style.display = isExistingSubif ? 'block' : 'none';
            
            modal.classList.add('visible');
        }
        
        function populateBondDropdown(selectId, currentBond) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select a bond...</option>';
            
            // Get bonds from current device config
            if (currentDeviceConfig && currentDeviceConfig.bonds) {
                for (const bondName of Object.keys(currentDeviceConfig.bonds)) {
                    const selected = bondName === currentBond ? 'selected' : '';
                    select.innerHTML += `<option value="${bondName}" ${selected}>${bondName}</option>`;
                }
            }
        }
        
        function openBondEditModal(bondName, currentProfile, currentDesc, bondConfig) {
            const modal = document.getElementById('interface-edit-modal');
            const config = bondConfig ? JSON.parse(decodeURIComponent(bondConfig)) : {};
            
            // Set hidden values
            document.getElementById('interface-edit-name').value = bondName;
            document.getElementById('interface-edit-type').value = 'bond';
            document.getElementById('interface-edit-display-name').value = bondName;
            document.getElementById('interface-edit-modal-title').textContent = 'Edit Bond';
            
            // Show bond fields (no mode selector for bonds)
            showInterfaceFields('bond', false);
            
            // Populate fields
            populateVlanProfilesDropdown('interface-edit-profile', currentProfile);
            document.getElementById('interface-edit-members').value = config.bond_members?.join(', ') || '';
            document.getElementById('interface-edit-mh-id').value = config.evpn_mh_id || '';
            document.getElementById('interface-edit-bond-mode').checked = config.bond_mode === 'active';
            document.getElementById('interface-edit-lacp-bypass').checked = config.lacp_bypass === true;
            document.getElementById('interface-edit-description').value = currentDesc || '';
            
            // Show delete button for bonds
            document.getElementById('btn-delete-interface').style.display = 'block';
            
            modal.classList.add('visible');
        }
        
        function populateVlanProfilesDropdown(selectId, currentValue) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">No Profile (clear)</option>';
            
            // Use SW Port Profiles (not VLAN profiles) for interface configuration
            if (Object.keys(portProfiles).length > 0) {
                // Sort profiles: Access first, then Trunk
                const sortedProfiles = Object.keys(portProfiles).sort((a, b) => {
                    const modeA = portProfiles[a].sw_port_mode || 'access';
                    const modeB = portProfiles[b].sw_port_mode || 'access';
                    if (modeA !== modeB) return modeA === 'access' ? -1 : 1;
                    return a.localeCompare(b);
                });
                
                for (const profileName of sortedProfiles) {
                    const profile = portProfiles[profileName];
                    const mode = profile.sw_port_mode || 'access';
                    const modeLabel = mode === 'trunk' ? '[T]' : '[A]';
                    const selected = profileName === currentValue ? 'selected' : '';
                    select.innerHTML += `<option value="${profileName}" ${selected}>${modeLabel} ${profileName}</option>`;
                }
            }
        }
        
        function openBreakoutEditModal(ifName, currentBreakout, currentDesc) {
            const modal = document.getElementById('interface-edit-modal');
            
            // Set hidden values
            document.getElementById('interface-edit-name').value = ifName;
            document.getElementById('interface-edit-type').value = 'breakout';
            document.getElementById('interface-edit-display-name').value = ifName + ' (Physical Port)';
            document.getElementById('interface-edit-modal-title').textContent = 'Edit Physical Port';
            
            // Show breakout field
            showInterfaceFields('breakout', false);
            
            // Set current breakout value
            const breakoutSelect = document.getElementById('interface-edit-breakout');
            breakoutSelect.value = currentBreakout || '';
            
            document.getElementById('interface-edit-description').value = currentDesc || '';
            
            modal.classList.add('visible');
        }
        
        function closeInterfaceEditModal() {
            document.getElementById('interface-edit-modal').classList.remove('visible');
        }
        
        function confirmDeleteInterface() {
            const ifName = document.getElementById('interface-edit-name').value;
            const ifType = document.getElementById('interface-edit-type').value;
            const typeLabel = ifType === 'bond' ? 'Bond' : 'Subinterface';
            
            // Close the edit modal first
            closeInterfaceEditModal();
            
            showConfirm(
                `Delete ${typeLabel}`,
                `Are you sure you want to delete <strong>${ifName}</strong>?<br><br>This action cannot be undone.`,
                () => executeDeleteInterface(ifName, ifType)
            );
        }
        
        async function executeDeleteInterface(ifName, ifType) {
            try {
                const action = ifType === 'bond' ? 'delete-bond' : 'delete-subinterface';
                const response = await fetch(`/fabric-api.sh?action=${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        name: ifName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeInterfaceEditModal();
                    await selectDevice(selectedDevice);
                    const typeLabel = ifType === 'bond' ? 'Bond' : 'Subinterface';
                    showOutputModal(`${typeLabel} Deleted`, 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ ${ifName} deleted successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
        }
        
        async function saveInterfaceEdit() {
            const ifName = document.getElementById('interface-edit-name').value;
            const ifType = document.getElementById('interface-edit-type').value;
            const description = document.getElementById('interface-edit-description').value.trim();
            
            // Build data based on mode
            const data = {
                device: selectedDevice,
                interface_name: ifName,
                interface_type: ifType,
                description: description
            };
            
            if (ifType === 'breakout') {
                data.breakout = document.getElementById('interface-edit-breakout').value;
            } else if (ifType === 'l2') {
                data.profile = document.getElementById('interface-edit-profile').value;
                data.previous_bond = currentInterfaceBond;  // To remove from old bond if was member
            } else if (ifType === 'l3') {
                data.ip = document.getElementById('interface-edit-ip').value.trim();
                data.vrf = document.getElementById('interface-edit-vrf').value;
                data.previous_bond = currentInterfaceBond;
            } else if (ifType === 'subif') {
                data.vlan_id = document.getElementById('interface-edit-vlan-id').value;
                data.ip = document.getElementById('interface-edit-ip').value.trim();
                data.vrf = document.getElementById('interface-edit-vrf').value;
                data.previous_bond = currentInterfaceBond;
            } else if (ifType === 'bond-member') {
                data.target_bond = document.getElementById('interface-edit-bond-select').value;
                data.previous_bond = currentInterfaceBond;
            } else if (ifType === 'bond') {
                data.profile = document.getElementById('interface-edit-profile').value;
                data.bond_members = document.getElementById('interface-edit-members').value.split(',').map(s => s.trim()).filter(Boolean);
                data.evpn_mh_id = document.getElementById('interface-edit-mh-id').value;
                data.bond_mode = document.getElementById('interface-edit-bond-mode').checked ? 'active' : '';
                data.lacp_bypass = document.getElementById('interface-edit-lacp-bypass').checked;
            }
            
            const saveBtn = document.getElementById('btn-save-interface-edit');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/fabric-api.sh?action=update-interface', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeInterfaceEditModal();
                    await selectDevice(selectedDevice);
                    showOutputModal('Interface Updated', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ ${ifType === 'bond' ? 'Bond' : 'Interface'} ${ifName} updated successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
        }
        
        // ==================== DHCP RELAY ====================
        let editingDhcpRelayIdx = null;
        
        async function openDhcpRelayModal(editIdx = null) {
            if (!selectedDevice) {
                showAlert('Please select a device first');
                return;
            }
            
            editingDhcpRelayIdx = editIdx;
            const modal = document.getElementById('dhcp-relay-modal');
            const form = document.getElementById('dhcp-relay-form');
            form.reset();
            
            // Set modal title
            document.getElementById('dhcp-relay-modal-title').textContent = editIdx !== null ? 'Edit DHCP Relay' : 'Create DHCP Relay';
            document.getElementById('btn-save-dhcp-relay').textContent = editIdx !== null ? 'Save Changes' : 'Create';
            
            // Load VRFs dropdown
            const vrfSelect = document.getElementById('dhcp-relay-vrf');
            vrfSelect.innerHTML = '<option value="">Loading...</option>';
            
            // Load L3 interfaces dropdown
            const interfaceSelect = document.getElementById('dhcp-relay-interface');
            interfaceSelect.innerHTML = '<option value="">Loading...</option>';
            
            try {
                // Get current device config for VRFs and interfaces
                const config = currentDeviceConfig;
                
                // Populate VRFs (exclude 'default' - DHCP relay is for tenant VRFs)
                const vrfs = config.vrfs ? Object.keys(config.vrfs).filter(v => v !== 'default') : [];
                if (vrfs.length === 0) {
                    vrfSelect.innerHTML = '<option value="">No tenant VRFs available</option>';
                } else {
                    vrfSelect.innerHTML = vrfs.map(v => `<option value="${v}">${v}</option>`).join('');
                }
                
                // Populate L3 interfaces (vlanXX interfaces from vlan_templates)
                const vlanInterfaces = [];
                if (config.vlan_templates && vlanProfiles) {
                    for (const templateName of config.vlan_templates) {
                        const vp = vlanProfiles[templateName];
                        if (vp && vp.vlan_id) {
                            // For range profiles, add all VLANs
                            if (vp.vlans && typeof vp.vlans === 'object') {
                                for (const vid of Object.keys(vp.vlans)) {
                                    vlanInterfaces.push(`vlan${vid}`);
                                }
                            } else {
                                vlanInterfaces.push(`vlan${vp.vlan_id}`);
                            }
                        }
                    }
                }
                
                // Sort numerically
                vlanInterfaces.sort((a, b) => {
                    const numA = parseInt(a.replace('vlan', ''));
                    const numB = parseInt(b.replace('vlan', ''));
                    return numA - numB;
                });
                
                interfaceSelect.innerHTML = vlanInterfaces.map(v => `<option value="${v}">${v}</option>`).join('');
                
                // Reset giaddr toggle and field
                const giaddrToggle = document.getElementById('dhcp-relay-giaddr-toggle');
                const giaddrContainer = document.getElementById('dhcp-relay-giaddr-container');
                const giaddrInput = document.getElementById('dhcp-relay-giaddr');
                
                // If editing, populate form with existing values
                if (editIdx !== null && config.dhcp_relay && config.dhcp_relay[editIdx]) {
                    const relay = config.dhcp_relay[editIdx];
                    vrfSelect.value = relay.vrf || '';
                    
                    // Select multiple interfaces
                    if (relay.interfaces && relay.interfaces.length > 0) {
                        for (const opt of interfaceSelect.options) {
                            opt.selected = relay.interfaces.includes(opt.value);
                        }
                    }
                    document.getElementById('dhcp-relay-servers').value = relay.servers?.join(', ') || '';
                    
                    // Set giaddr if exists
                    if (relay.giaddr) {
                        giaddrToggle.checked = true;
                        giaddrContainer.style.display = 'block';
                        giaddrInput.value = relay.giaddr;
                    } else {
                        giaddrToggle.checked = false;
                        giaddrContainer.style.display = 'none';
                        giaddrInput.value = '';
                    }
                    
                    // Upstream is auto-calculated from VRF
                    updateDhcpUpstream();
                } else {
                    // Clear giaddr for new relay
                    giaddrToggle.checked = false;
                    giaddrContainer.style.display = 'none';
                    giaddrInput.value = '';
                }
                
            } catch (e) {
                console.error('Error loading DHCP relay data:', e);
            }
            
            modal.classList.add('visible');
            updateDhcpUpstream();
        }
        
        function closeDhcpRelayModal() {
            document.getElementById('dhcp-relay-modal').classList.remove('visible');
            editingDhcpRelayIdx = null;
        }
        
        function toggleGiaddrField() {
            const checkbox = document.getElementById('dhcp-relay-giaddr-toggle');
            const container = document.getElementById('dhcp-relay-giaddr-container');
            const input = document.getElementById('dhcp-relay-giaddr');
            
            if (checkbox.checked) {
                container.style.display = 'block';
                input.focus();
            } else {
                container.style.display = 'none';
                input.value = '';
            }
        }
        
        function updateDhcpUpstream() {
            const vrfSelect = document.getElementById('dhcp-relay-vrf');
            const upstreamField = document.getElementById('dhcp-relay-upstream');
            const interfaceSelect = document.getElementById('dhcp-relay-interface');
            const selectedVrf = vrfSelect.value;
            
            if (!selectedVrf || !currentDeviceConfig) {
                upstreamField.value = '';
                interfaceSelect.innerHTML = '<option value="">Select VRF first...</option>';
                return;
            }
            
            // Get vxlan_int from VRF config
            const vrfConfig = currentDeviceConfig.vrfs?.[selectedVrf];
            if (vrfConfig && vrfConfig.vxlan_int) {
                upstreamField.value = `vlan${vrfConfig.vxlan_int}_l3`;
            } else {
                // Try to get from currentVxlanIntMapping (loaded from vlan_profiles.yaml)
                if (currentVxlanIntMapping[selectedVrf]) {
                    upstreamField.value = `vlan${currentVxlanIntMapping[selectedVrf]}_l3`;
                } else {
                    upstreamField.value = '';
                }
            }
            
            // Filter interfaces by VRF - get SVIs (vlanXX) that belong to this VRF
            const vrfInterfaces = [];
            
            // Get vlan_templates for this device
            const config = currentDeviceConfig;
            if (config.vlan_templates && vlanProfiles) {
                for (const templateName of config.vlan_templates) {
                    const vp = vlanProfiles[templateName];
                    if (vp && vp.vlan_id) {
                        // Check if this VLAN profile belongs to the selected VRF
                        const vrfName = vp.vrf || 'default';
                        if (vrfName === selectedVrf) {
                            // For range profiles, add all VLANs
                            if (vp.vlans && typeof vp.vlans === 'object') {
                                for (const vid of Object.keys(vp.vlans)) {
                                    vrfInterfaces.push(`vlan${vid}`);
                                }
                            } else {
                                vrfInterfaces.push(`vlan${vp.vlan_id}`);
                            }
                        }
                    }
                }
            }
            
            // Sort numerically
            vrfInterfaces.sort((a, b) => {
                const numA = parseInt(a.replace('vlan', ''));
                const numB = parseInt(b.replace('vlan', ''));
                return numA - numB;
            });
            
            if (vrfInterfaces.length > 0) {
                interfaceSelect.innerHTML = vrfInterfaces.map(v => `<option value="${v}">${v}</option>`).join('');
            } else {
                interfaceSelect.innerHTML = '<option value="">No interfaces in this VRF</option>';
            }
        }
        
        async function saveDhcpRelay() {
            const vrf = document.getElementById('dhcp-relay-vrf').value;
            const interfaceSelect = document.getElementById('dhcp-relay-interface');
            const selectedInterfaces = Array.from(interfaceSelect.selectedOptions).map(opt => opt.value);
            const serversStr = document.getElementById('dhcp-relay-servers').value.trim();
            const upstream = document.getElementById('dhcp-relay-upstream').value.trim();
            const giaddr = document.getElementById('dhcp-relay-giaddr').value.trim();
            
            if (!vrf) {
                showAlert('Please select a VRF');
                return;
            }
            if (selectedInterfaces.length === 0) {
                showAlert('Please select at least one interface');
                return;
            }
            if (!serversStr) {
                showAlert('Please enter at least one DHCP server');
                return;
            }
            
            // Parse servers (comma or space separated)
            const servers = serversStr.split(/[,\s]+/).map(s => s.trim()).filter(s => s);
            
            const saveBtn = document.getElementById('btn-save-dhcp-relay');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                // Build request body
                const requestBody = {
                    device: selectedDevice,
                    index: editingDhcpRelayIdx,
                    vrf: vrf,
                    interfaces: selectedInterfaces,
                    servers: servers,
                    upstream: upstream ? [upstream] : []
                };
                
                // Only include giaddr if provided
                if (giaddr) {
                    requestBody.giaddr = giaddr;
                }
                
                const response = await fetch('/fabric-api.sh?action=save-dhcp-relay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeDhcpRelayModal();
                    await selectDevice(selectedDevice);
                    showOutputModal('DHCP Relay Saved', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ DHCP Relay ${editingDhcpRelayIdx !== null ? 'updated' : 'created'} successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = editingDhcpRelayIdx !== null ? 'Save Changes' : 'Create';
        }
        
        function editDhcpRelay(idx) {
            openDhcpRelayModal(idx);
        }
        
        let deletingDhcpRelayIdx = null;
        
        function confirmDeleteDhcpRelay(idx) {
            if (!currentDeviceConfig || !currentDeviceConfig.dhcp_relay || !currentDeviceConfig.dhcp_relay[idx]) {
                return;
            }
            
            deletingDhcpRelayIdx = idx;
            const relay = currentDeviceConfig.dhcp_relay[idx];
            document.getElementById('delete-dhcp-relay-vrf').textContent = relay.vrf;
            document.getElementById('delete-dhcp-relay-interface').textContent = relay.interfaces?.join(', ') || '-';
            document.getElementById('delete-dhcp-relay-modal').classList.add('visible');
        }
        
        function closeDeleteDhcpRelayModal() {
            document.getElementById('delete-dhcp-relay-modal').classList.remove('visible');
            deletingDhcpRelayIdx = null;
        }
        
        async function executeDeleteDhcpRelay() {
            if (deletingDhcpRelayIdx === null) return;
            
            const idx = deletingDhcpRelayIdx;
            closeDeleteDhcpRelayModal();
            
            try {
                const response = await fetch('/fabric-api.sh?action=delete-dhcp-relay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        index: idx
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await selectDevice(selectedDevice);
                    showOutputModal('DHCP Relay Deleted', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ DHCP Relay deleted successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
        }
        
        // ========== EVPN Multihoming Functions ==========
        let editingEvpnMh = false;
        
        function openEvpnMhModal(isEdit = false) {
            if (!selectedDevice) {
                showAlert('Please select a device first');
                return;
            }
            
            editingEvpnMh = isEdit;
            const modal = document.getElementById('evpn-mh-modal');
            const form = document.getElementById('evpn-mh-form');
            form.reset();
            
            document.getElementById('evpn-mh-modal-title').textContent = isEdit ? 'Edit EVPN Multihoming' : 'Configure EVPN Multihoming';
            document.getElementById('btn-save-evpn-mh').textContent = isEdit ? 'Save Changes' : 'Create';
            
            // If editing, populate with existing values
            if (isEdit && currentDeviceConfig && currentDeviceConfig.evpn_mh) {
                document.getElementById('evpn-mh-sysmac').value = currentDeviceConfig.evpn_mh.sysmac || '';
                document.getElementById('evpn-mh-df-preference').value = currentDeviceConfig.evpn_mh.df_preference || '50000';
            } else {
                // Default template
                document.getElementById('evpn-mh-sysmac').value = '44:38:39:ff:XX:XX';
            }
            
            modal.classList.add('visible');
        }
        
        function closeEvpnMhModal() {
            document.getElementById('evpn-mh-modal').classList.remove('visible');
            editingEvpnMh = false;
        }
        
        async function saveEvpnMh(event) {
            event.preventDefault();
            
            const sysmac = document.getElementById('evpn-mh-sysmac').value.trim();
            const dfPreference = parseInt(document.getElementById('evpn-mh-df-preference').value);
            
            if (!sysmac) {
                showAlert('System MAC is required');
                return;
            }
            
            closeEvpnMhModal();
            
            try {
                const response = await fetch('/fabric-api.sh?action=save-evpn-mh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device: selectedDevice,
                        evpn_mh: {
                            sysmac: sysmac,
                            df_preference: dfPreference
                        }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    refreshDevice();
                    showOutputModal('EVPN Multihoming Saved', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ EVPN Multihoming configured successfully</div>` +
                        `<div style="color: #888;">System MAC: <strong>${sysmac}</strong></div>` +
                        `<div style="color: #888;">DF Preference: <strong>${dfPreference}</strong></div>` +
                        `<div style="color: #ffb74d; margin-top: 15px; padding: 12px 12px 12px 12px; background: rgba(255, 183, 77, 0.1); border-left: 3px solid #ffb74d; border-radius: 4px; text-align: left;">
<strong>⚠️ Important:</strong> Please create bond interfaces with <code>evpn_mh_id</code> to complete the configuration.<br>
Without bonds, the EVPN Multihoming configuration will be incomplete.
                        </div>` +
                        `<div style="color: #888; margin-top: 10px;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
        }
        
        function deleteEvpnMh() {
            document.getElementById('delete-evpn-mh-modal').classList.add('visible');
        }
        
        function closeDeleteEvpnMhModal() {
            document.getElementById('delete-evpn-mh-modal').classList.remove('visible');
        }
        
        async function executeDeleteEvpnMh() {
            closeDeleteEvpnMhModal();
            
            try {
                const response = await fetch('/fabric-api.sh?action=delete-evpn-mh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: selectedDevice })
                });
                
                const result = await response.json();
                if (result.success) {
                    refreshDevice();
                    showOutputModal('EVPN Multihoming Deleted', 
                        `<div style="color: #76b900; margin-bottom: 15px;">✓ EVPN Multihoming deleted successfully</div>` +
                        `<div style="color: #888;">Run <strong>Deploy</strong> to apply changes.</div>`,
                        'success', true);
                } else {
                    showAlert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                showAlert('Error: ' + e.message);
            }
        }
        
        // Initialize on load
        init();
    </script>
    
    <!-- VLAN Creation Modal -->
    <div id="vlan-modal" class="vlan-modal">
        <div class="vlan-modal-content">
            <div class="vlan-modal-header">
                <h3>Create New VLAN</h3>
                <button class="vlan-modal-close" onclick="closeVlanModal()">&times;</button>
            </div>
            <div class="vlan-modal-body">
                <form id="vlan-form" onsubmit="event.preventDefault(); createVlan();">
                    <!-- Range Mode Toggle -->
                    <div class="form-group" style="margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #404040;">
                        <div class="form-checkbox">
                            <input type="checkbox" id="vlan-range-mode" onchange="toggleRangeMode()">
                            <label for="vlan-range-mode">Create VLAN Range (multiple VLANs)</label>
                        </div>
                    </div>
                    
                    <!-- Single VLAN Fields -->
                    <div id="single-vlan-fields">
                        <div class="form-group-inline">
                            <div class="form-group">
                                <label>VLAN ID *</label>
                                <input type="number" id="vlan-id" min="1" max="4094" 
                                       oninput="updateL2VNI()" placeholder="e.g., 100">
                            </div>
                            <div class="form-group">
                                <label>Profile Name</label>
                                <input type="text" id="vlan-profile-name" placeholder="VLAN_100">
                                <div class="form-hint">Auto-generated from VLAN ID</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Range VLAN Fields -->
                    <div id="range-vlan-fields" style="display: none;">
                        <div class="form-group-inline">
                            <div class="form-group">
                                <label>Start VLAN ID *</label>
                                <input type="number" id="vlan-start-id" min="1" max="4094" placeholder="e.g., 50" oninput="updateRangePreview()">
                            </div>
                            <div class="form-group">
                                <label>End VLAN ID *</label>
                                <input type="number" id="vlan-end-id" min="1" max="4094" placeholder="e.g., 100" oninput="updateRangePreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Profile Name</label>
                            <input type="text" id="vlan-range-profile-name" placeholder="Auto: VLAN_{start}_{end}_L2">
                        </div>
                        <div id="range-preview" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; display: none;">
                            <div id="range-preview-content" style="font-family: monospace; font-size: 12px; color: #76b900;"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" id="vlan-description" 
                               placeholder="e.g., Management Network">
                    </div>
                    
                    <div class="form-group">
                        <label>L2VNI <span id="l2vni-label-suffix"></span></label>
                        <input type="number" id="vlan-l2vni" placeholder="Auto: 100000 + VLAN ID">
                        <div class="form-hint" id="l2vni-hint">Default: 100000 + VLAN ID</div>
                    </div>
                    
                    <!-- SVI section (only for single VLAN) -->
                    <div id="svi-section">
                        <div class="form-group">
                            <div class="form-checkbox">
                                <input type="checkbox" id="vlan-svi-enabled" onchange="toggleSviFields()">
                                <label for="vlan-svi-enabled">Enable SVI / L3 Configuration</label>
                            </div>
                        </div>
                        
                        <div id="svi-fields" class="vrr-fields">
                        <div class="form-group">
                            <label>VRF</label>
                            <select id="vlan-vrf" onchange="onVlanVrfChange()">
                                <option value="default">default</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-checkbox">
                                <input type="checkbox" id="vlan-vrr-enabled" onchange="toggleVrrFields()">
                                <label for="vlan-vrr-enabled">Enable VRR (Virtual Router Redundancy)</label>
                            </div>
                        </div>
                        
                        <!-- Single IP (when VRR disabled) -->
                        <div id="single-ip-field" class="form-group">
                            <label>Gateway IP</label>
                            <input type="text" id="vlan-gateway-ip" placeholder="e.g., 10.10.100.1/24">
                        </div>
                        
                        <!-- VRR IPs (when VRR enabled) -->
                        <div id="vrr-fields" class="vrr-fields">
                            <div class="form-group">
                                <label>VRR Virtual IP (VIP)</label>
                                <input type="text" id="vlan-vrr-vip" placeholder="e.g., 10.10.100.1/24">
                            </div>
                            <div class="form-group-inline">
                                <div class="form-group">
                                    <label>Even Switch IP</label>
                                    <input type="text" id="vlan-even-ip" placeholder="e.g., 10.10.100.2/24">
                                </div>
                                <div class="form-group">
                                    <label>Odd Switch IP</label>
                                    <input type="text" id="vlan-odd-ip" placeholder="e.g., 10.10.100.3/24">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label>VRR Virtual MAC <span style="color: #888; font-weight: normal;">(optional)</span></label>
                                <input type="text" id="vlan-vrr-vmac" placeholder="44:38:39:ff:XX:XX" style="font-family: monospace;">
                                <div class="form-hint">Custom virtual MAC for VRR (leave empty for auto)</div>
                            </div>
                        </div>
                        
                        <!-- Leaking Section -->
                        <div class="form-group" style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #404040;">
                            <div class="form-checkbox">
                                <input type="checkbox" id="vlan-leaking-enabled" onchange="toggleVlanLeakingFields()">
                                <label for="vlan-leaking-enabled">Enable Leaking</label>
                            </div>
                        </div>
                        
                        <div id="vlan-leaking-fields" class="vrr-fields">
                            <div class="form-group">
                                <label>Leak To VRF</label>
                                <select id="vlan-leak-target-vrf">
                                    <option value="">Select VRF...</option>
                                </select>
                                <div class="form-hint">Subnet will be leaked to the selected VRF</div>
                            </div>
                        </div>
                    </div>
                    </div><!-- end svi-section -->
                    
                    <div class="form-group">
                        <div class="form-checkbox">
                            <input type="checkbox" id="vlan-stp-bpduguard" checked>
                            <label for="vlan-stp-bpduguard">Enable STP BPDU Guard (for access ports)</label>
                        </div>
                    </div>
                    
                </form>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeVlanModal()">Cancel</button>
                <button class="btn-primary" id="btn-create-vlan" onclick="createVlan()">Create VLAN</button>
            </div>
        </div>
    </div>
    
    <!-- Unassign Confirmation Modal -->
    <div class="vlan-modal" id="unassign-confirm-modal">
        <div class="vlan-modal-content" style="max-width: 400px;">
            <div class="vlan-modal-header">
                <h3>Remove VLAN from Device</h3>
                <button class="vlan-modal-close" onclick="closeUnassignModal()">×</button>
            </div>
            <div class="vlan-modal-body" style="text-align: center; padding: 25px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#ff9800" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Remove VLAN from this device?</p>
                <p style="color: #76b900; font-weight: bold; font-size: 18px; margin-bottom: 5px;" id="unassign-vlan-name"></p>
                <p style="color: #888; font-size: 14px;">from <span id="unassign-device-name" style="color: #64b5f6;"></span></p>
                <p style="color: #666; font-size: 12px; margin-top: 15px;">This will only remove the VLAN from this device.<br>The VLAN profile will not be deleted globally.</p>
            </div>
            <div class="vlan-modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn-secondary" onclick="closeUnassignModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmUnassign()">Remove</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="vlan-modal" id="delete-confirm-modal">
        <div class="vlan-modal-content" style="max-width: 400px;">
            <div class="vlan-modal-header">
                <h3>Delete VLAN</h3>
                <button class="vlan-modal-close" onclick="closeDeleteModal()">×</button>
            </div>
            <div class="vlan-modal-body" style="text-align: center; padding: 25px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#ff6b6b" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Are you sure you want to delete VLAN profile:</p>
                <p style="color: #76b900; font-weight: bold; font-size: 18px; margin-bottom: 15px;" id="delete-vlan-name"></p>
                <div id="affected-devices-list" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;"></div>
                <p style="color: #888; font-size: 12px;">This will also remove the associated port profile from sw_port_profiles.yaml</p>
            </div>
            <div class="vlan-modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-danger" id="btn-confirm-delete" onclick="deleteVlan()">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Assign VLAN Modal -->
    <div class="vlan-modal" id="assign-vlan-modal">
        <div class="vlan-modal-content" style="max-width: 450px;">
            <div class="vlan-modal-header">
                <h3>Assign VLANs to Device</h3>
                <button class="vlan-modal-close" onclick="closeAssignVlanModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <div id="assign-vlan-list"></div>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeAssignVlanModal()">Cancel</button>
                <button class="btn-primary" id="btn-assign-vlans" onclick="assignVlans()">Assign Selected</button>
            </div>
        </div>
    </div>
    
    <!-- Edit VLAN Modal (list) -->
    <div class="vlan-modal" id="edit-vlan-modal">
        <div class="vlan-modal-content" style="max-width: 500px;">
            <div class="vlan-modal-header">
                <h3>Edit / Delete VLANs</h3>
                <button class="vlan-modal-close" onclick="closeEditVlanModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <div id="edit-vlan-list"></div>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeEditVlanModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Edit VLAN Form Modal -->
    <div class="vlan-modal" id="vlan-edit-form-modal">
        <div class="vlan-modal-content">
            <div class="vlan-modal-header">
                <h3>Edit VLAN</h3>
                <button class="vlan-modal-close" onclick="closeEditFormModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <form id="edit-vlan-form" onsubmit="event.preventDefault(); saveVlanEdit();">
                    <input type="hidden" id="edit-vlan-original-name">
                    
                    <div class="form-group-inline">
                        <div class="form-group">
                            <label>VLAN ID *</label>
                            <input type="number" id="edit-vlan-id" min="1" max="4094" required readonly style="background: #333; cursor: not-allowed;">
                            <div class="form-hint">VLAN ID cannot be changed</div>
                        </div>
                        <div class="form-group">
                            <label>Profile Name</label>
                            <input type="text" id="edit-vlan-profile-name" placeholder="e.g., MGMT_100">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" id="edit-vlan-description" required>
                    </div>
                    
                    <div class="form-group">
                        <label>L2VNI</label>
                        <input type="number" id="edit-vlan-l2vni">
                    </div>
                    
                    <div class="form-group">
                        <div class="form-checkbox">
                            <input type="checkbox" id="edit-vlan-svi-enabled" onchange="toggleEditSviFields()">
                            <label for="edit-vlan-svi-enabled">Enable SVI / L3 Configuration</label>
                        </div>
                    </div>
                    
                    <div id="edit-svi-fields" class="vrr-fields">
                        <div class="form-group">
                            <label>VRF</label>
                            <select id="edit-vlan-vrf">
                                <option value="default">default</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-checkbox">
                                <input type="checkbox" id="edit-vlan-vrr-enabled" onchange="toggleEditVrrFields()">
                                <label for="edit-vlan-vrr-enabled">Enable VRR</label>
                            </div>
                        </div>
                        
                        <div id="edit-single-ip-field" class="form-group">
                            <label>Gateway IP</label>
                            <input type="text" id="edit-vlan-gateway-ip" placeholder="e.g., 10.10.100.1/24">
                        </div>
                        
                        <div id="edit-vrr-fields" class="vrr-fields">
                            <div class="form-group">
                                <label>VRR Virtual IP (VIP)</label>
                                <input type="text" id="edit-vlan-vrr-vip" placeholder="e.g., 10.10.100.1/24">
                            </div>
                            <div class="form-group-inline">
                                <div class="form-group">
                                    <label>Even Switch IP</label>
                                    <input type="text" id="edit-vlan-even-ip" placeholder="e.g., 10.10.100.2/24">
                                </div>
                                <div class="form-group">
                                    <label>Odd Switch IP</label>
                                    <input type="text" id="edit-vlan-odd-ip" placeholder="e.g., 10.10.100.3/24">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label>VRR Virtual MAC <span style="color: #888; font-weight: normal;">(optional)</span></label>
                                <input type="text" id="edit-vlan-vrr-vmac" placeholder="44:38:39:ff:XX:XX" style="font-family: monospace;">
                                <div class="form-hint">Custom virtual MAC for VRR (leave empty for auto)</div>
                            </div>
                        </div>
                        
                        <!-- Leaking Section for Edit -->
                        <div class="form-group" style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #404040;">
                            <div class="form-checkbox">
                                <input type="checkbox" id="edit-vlan-leaking-enabled" onchange="toggleEditVlanLeakingFields()">
                                <label for="edit-vlan-leaking-enabled">Add Subnet to Leaking</label>
                            </div>
                        </div>
                        
                        <div id="edit-vlan-leaking-fields" class="vrr-fields">
                            <div class="form-group">
                                <label>Leak To VRF</label>
                                <select id="edit-vlan-leak-target-vrf">
                                    <option value="">Select VRF...</option>
                                </select>
                                <div class="form-hint">Subnet will be leaked to the selected VRF</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeEditFormModal()">Cancel</button>
                <button class="btn-primary" id="btn-save-vlan-edit" onclick="saveVlanEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- VRF Create Modal -->
    <div class="vlan-modal" id="vrf-modal">
        <div class="vlan-modal-content">
            <div class="vlan-modal-header">
                <h3>Create New VRF</h3>
                <button class="vlan-modal-close" onclick="closeVrfModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <form id="vrf-form" onsubmit="event.preventDefault(); createVrf();">
                    <div class="form-group">
                        <label>VRF Name *</label>
                        <input type="text" id="vrf-name" required placeholder="e.g., tenant1">
                    </div>
                    
                    <div class="form-group">
                        <label>L3VNI *</label>
                        <input type="number" id="vrf-l3vni" required placeholder="e.g., 2001001">
                    </div>
                    
                    <div class="form-group">
                        <label>VXLAN Interface VLAN</label>
                        <input type="number" id="vrf-vxlan-int" placeholder="e.g., 4063">
                        <div class="form-hint">VLAN ID for L3VNI interface (e.g., vlan4063_l3)</div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="vrf-custom-loopback" onchange="toggleCustomLoopback()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span>Use different loopback IP</span>
                        </label>
                        <div id="vrf-loopback-container" style="display: none; margin-top: 10px;">
                            <input type="text" id="vrf-loopback-ip" placeholder="e.g., 192.168.100.101/32" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <div class="form-hint">Loopback IP with mask for this VRF (default uses device's lo_ip)</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>BGP ASN</label>
                        <input type="number" id="vrf-bgp-asn" placeholder="e.g., 4286611970">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="vrf-leaking-enabled" onchange="toggleLeakingOptions()" style="width: 16px; height: 16px;">
                            Enable Route Leaking
                        </label>
                    </div>
                    
                    <div id="vrf-leaking-options" style="display: none; padding: 12px; background: #252526; border-radius: 6px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Leak FROM VRF</label>
                            <select id="vrf-leak-from" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                                <option value="">Select VRF...</option>
                            </select>
                            <div class="form-hint">Routes will be exchanged between new VRF and selected VRF</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="vrf-profile-group">
                        <label>BGP Profile</label>
                        <select id="vrf-bgp-profile" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">Loading...</option>
                        </select>
                        <div class="form-hint" id="vrf-profile-hint">Overlay BGP profiles (VxLAN_UNDERLAY* excluded)</div>
                    </div>
                    
                </form>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeVrfModal()">Cancel</button>
                <button class="btn-primary" id="btn-create-vrf" onclick="createVrf()">Create VRF</button>
            </div>
        </div>
    </div>
    
    <!-- VRF Assign Modal -->
    <div class="vlan-modal" id="assign-vrf-modal">
        <div class="vlan-modal-content" style="max-width: 450px;">
            <div class="vlan-modal-header">
                <h3>Assign VRFs to Device</h3>
                <button class="vlan-modal-close" onclick="closeAssignVrfModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <div id="assign-vrf-list"></div>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeAssignVrfModal()">Cancel</button>
                <button class="btn-primary" id="btn-assign-vrfs" onclick="assignVrfs()">Assign Selected</button>
            </div>
        </div>
    </div>
    
    <!-- VRF Unassign Confirmation Modal -->
    <div class="vlan-modal" id="unassign-vrf-confirm-modal">
        <div class="vlan-modal-content" style="max-width: 400px;">
            <div class="vlan-modal-header">
                <h3>Remove VRF from Device</h3>
                <button class="vlan-modal-close" onclick="closeUnassignVrfModal()">×</button>
            </div>
            <div class="vlan-modal-body" style="text-align: center; padding: 25px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#ff9800" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Remove VRF from this device?</p>
                <p style="color: #76b900; font-weight: bold; font-size: 16px;" id="unassign-vrf-name"></p>
                <p style="color: #888; font-size: 12px; margin-top: 10px;">Device: <span id="unassign-vrf-device-name" style="color: #4fc3f7;"></span></p>
                <p style="color: #ff9800; font-size: 12px; margin-top: 15px;">Warning: This may affect routing for VLANs using this VRF</p>
            </div>
            <div class="vlan-modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn-secondary" onclick="closeUnassignVrfModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmUnassignVrfAction()">Remove</button>
            </div>
        </div>
    </div>
    
    <!-- VRF Delete Global Confirmation Modal -->
    <div class="vlan-modal" id="delete-vrf-confirm-modal">
        <div class="vlan-modal-content" style="max-width: 450px;">
            <div class="vlan-modal-header">
                <h3>Delete VRF</h3>
                <button class="vlan-modal-close" onclick="closeDeleteVrfModal()">×</button>
            </div>
            <div class="vlan-modal-body" style="text-align: center; padding: 25px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#f44336" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Are you sure you want to delete this VRF?</p>
                <p style="color: #76b900; font-weight: bold; font-size: 18px;" id="delete-vrf-name"></p>
                <div id="delete-vrf-devices" style="margin-top: 15px; text-align: left; max-height: 150px; overflow-y: auto;"></div>
                <p style="color: #f44336; font-size: 12px; margin-top: 15px;">⚠ This will remove the VRF from ALL listed devices</p>
            </div>
            <div class="vlan-modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn-secondary" onclick="closeDeleteVrfModal()">Cancel</button>
                <button class="btn-danger" id="btn-confirm-delete-vrf" onclick="executeDeleteVrf()">Delete VRF</button>
            </div>
        </div>
    </div>
    
    <!-- VRF Edit List Modal -->
    <div class="vlan-modal" id="edit-vrf-modal">
        <div class="vlan-modal-content" style="max-width: 500px;">
            <div class="vlan-modal-header">
                <h3>Device VRFs</h3>
                <button class="vlan-modal-close" onclick="closeEditVrfModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <div id="edit-vrf-list"></div>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeEditVrfModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Create Bond Modal -->
    <div class="vlan-modal" id="create-bond-modal">
        <div class="vlan-modal-content" style="max-width: 500px;">
            <div class="vlan-modal-header">
                <h3>Create Bond</h3>
                <button class="vlan-modal-close" onclick="closeCreateBondModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <form id="create-bond-form" onsubmit="event.preventDefault(); saveCreateBond();">
                    <div class="form-group">
                        <label>Bond Name *</label>
                        <input type="text" id="bond-name" placeholder="e.g., bond_dgx01" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">Name for the bond interface</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Port Profile</label>
                        <select id="bond-profile" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">None (L3)</option>
                        </select>
                        <div class="form-hint">VLAN profile for this bond</div>
                    </div>
                    
                    <div class="form-group">
                        <label>EVPN MH ID</label>
                        <input type="number" id="bond-mh-id" min="1" placeholder="e.g., 1" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">EVPN Multihoming ID for ESI</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Bond Mode</label>
                        <select id="bond-mode" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="lacp">LACP (802.3ad)</option>
                            <option value="static">Static</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="bond-lacp-bypass" style="width: 18px; height: 18px;">
                            LACP Bypass
                        </label>
                        <div class="form-hint">Allow traffic when LACP is not established</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="bond-description" placeholder="e.g., DGX Server Connection" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                    </div>
                </form>
            </div>
            <div class="vlan-modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCreateBondModal()">Cancel</button>
                <button type="submit" class="btn-primary" id="btn-create-bond" onclick="saveCreateBond()">Create Bond</button>
            </div>
        </div>
    </div>
    
    <!-- Create Subinterface Modal -->
    <div class="vlan-modal" id="create-subif-modal">
        <div class="vlan-modal-content" style="max-width: 500px;">
            <div class="vlan-modal-header">
                <h3>Create Subinterface</h3>
                <button class="vlan-modal-close" onclick="closeCreateSubifModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <form id="create-subif-form" onsubmit="event.preventDefault(); saveCreateSubif();">
                    <div class="form-group">
                        <label>Parent Interface *</label>
                        <select id="subif-parent" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">Select parent interface...</option>
                        </select>
                        <div class="form-hint">Physical port that will have the subinterface</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Subinterface ID *</label>
                        <input type="number" id="subif-id" min="1" max="4094" placeholder="e.g., 1001" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">Subinterface identifier (usually same as VLAN ID)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>VLAN ID *</label>
                        <input type="number" id="subif-vlan" min="1" max="4094" placeholder="e.g., 1001" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">802.1Q VLAN tag for this subinterface</div>
                    </div>
                    
                    <div class="form-group">
                        <label>IP Address</label>
                        <input type="text" id="subif-ip" placeholder="e.g., 10.0.0.1/24" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                    </div>
                    
                    <div class="form-group">
                        <label>VRF</label>
                        <select id="subif-vrf" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">default</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="subif-description" placeholder="e.g., External BGP to Provider" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                    </div>
                </form>
            </div>
            <div class="vlan-modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCreateSubifModal()">Cancel</button>
                <button type="submit" class="btn-primary" id="btn-create-subif" onclick="saveCreateSubif()">Create Subinterface</button>
            </div>
        </div>
    </div>
    
    <!-- Interface/Bond Edit Modal -->
    <div class="vlan-modal" id="interface-edit-modal">
        <div class="vlan-modal-content" style="max-width: 550px;">
            <div class="vlan-modal-header">
                <h3 id="interface-edit-modal-title">Edit Interface</h3>
                <button class="vlan-modal-close" onclick="closeInterfaceEditModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <form id="interface-edit-form" onsubmit="event.preventDefault(); saveInterfaceEdit();">
                    <input type="hidden" id="interface-edit-name">
                    <input type="hidden" id="interface-edit-type">
                    
                    <div class="form-group">
                        <label>Interface</label>
                        <input type="text" id="interface-edit-display-name" readonly style="width: 100%; padding: 10px 12px; background: #333; border: 1px solid #404040; border-radius: 4px; color: #76b900; font-size: 14px; cursor: not-allowed;">
                    </div>
                    
                    <!-- Port Mode Selector -->
                    <div class="form-group" id="interface-edit-mode-group">
                        <label>Port Mode</label>
                        <select id="interface-edit-mode" onchange="onInterfaceModeChange()" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="l2">L2 - Access/Trunk Port</option>
                            <option value="l3">L3 - Routed Interface</option>
                            <option value="subif">Subinterface (VLAN Tagged)</option>
                            <option value="bond-member">Bond Member</option>
                        </select>
                        <div class="form-hint">Select the port operation mode</div>
                    </div>
                    
                    <!-- Bond Selector (for bond-member mode) -->
                    <div class="form-group" id="interface-edit-bond-select-group" style="display: none;">
                        <label>Assign to Bond</label>
                        <select id="interface-edit-bond-select" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">Select a bond...</option>
                        </select>
                        <div class="form-hint">Select which bond this interface should be a member of</div>
                    </div>
                    
                    <!-- Breakout Config (for physical ports) -->
                    <div class="form-group" id="interface-edit-breakout-group" style="display: none;">
                        <label>Breakout Mode</label>
                        <select id="interface-edit-breakout" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">No Breakout (single port)</option>
                            <option value="2x">2x (2 sub-ports)</option>
                            <option value="4x">4x (4 sub-ports)</option>
                            <option value="4x25G">4x25G</option>
                            <option value="4x10G">4x10G</option>
                            <option value="2x50G">2x50G</option>
                            <option value="2x100G">2x100G</option>
                            <option value="4x100G">4x100G</option>
                        </select>
                        <div class="form-hint">Split physical port into multiple sub-interfaces</div>
                    </div>
                    
                    <!-- L2 Mode: VLAN Profile -->
                    <div class="form-group" id="interface-edit-profile-group">
                        <label>VLAN Profile</label>
                        <select id="interface-edit-profile" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">No Profile (clear)</option>
                        </select>
                        <div class="form-hint">Select a VLAN profile for this port</div>
                    </div>
                    
                    <!-- L3 Mode: IP Address -->
                    <div class="form-group" id="interface-edit-ip-group" style="display: none;">
                        <label>IP Address</label>
                        <input type="text" id="interface-edit-ip" placeholder="e.g., 10.0.0.1/24" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                    </div>
                    
                    <!-- L3 Mode: VRF -->
                    <div class="form-group" id="interface-edit-vrf-group" style="display: none;">
                        <label>VRF</label>
                        <select id="interface-edit-vrf" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">default</option>
                        </select>
                    </div>
                    
                    <!-- Subinterface: VLAN ID -->
                    <div class="form-group" id="interface-edit-vlan-id-group" style="display: none;">
                        <label>VLAN ID</label>
                        <input type="number" id="interface-edit-vlan-id" min="1" max="4094" placeholder="e.g., 1001" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                    </div>
                    
                    <!-- Bond: Members -->
                    <div class="form-group" id="interface-edit-members-group" style="display: none;">
                        <label>Bond Members</label>
                        <input type="text" id="interface-edit-members" placeholder="e.g., swp1s0, swp1s1" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">Comma-separated list of member interfaces</div>
                    </div>
                    
                    <!-- Bond: EVPN MH ID -->
                    <div class="form-group" id="interface-edit-mh-id-group" style="display: none;">
                        <label>EVPN Multihoming ID (ESI)</label>
                        <input type="number" id="interface-edit-mh-id" min="1" max="65535" placeholder="e.g., 1" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">Leave empty if not using EVPN Multihoming</div>
                    </div>
                    
                    <!-- Bond: Checkboxes -->
                    <div class="form-group" id="interface-edit-bond-options-group" style="display: none;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="interface-edit-bond-mode" style="width: 18px; height: 18px;">
                                <span>bond_mode: active</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="interface-edit-lacp-bypass" style="width: 18px; height: 18px;">
                                <span>lacp_bypass: true</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Common: Description -->
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="interface-edit-description" placeholder="e.g., server-01, dgx-3nb-02-04" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                    </div>
                </form>
            </div>
            <div class="vlan-modal-footer" style="display: flex; justify-content: space-between;">
                <button type="button" class="btn-danger" id="btn-delete-interface" onclick="confirmDeleteInterface()" style="display: none;">Delete</button>
                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button type="button" class="btn-secondary" onclick="closeInterfaceEditModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="btn-save-interface-edit" onclick="saveInterfaceEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- DHCP Relay Create/Edit Modal -->
    <div class="vlan-modal" id="dhcp-relay-modal">
        <div class="vlan-modal-content" style="max-width: 500px;">
            <div class="vlan-modal-header">
                <h3 id="dhcp-relay-modal-title">Create DHCP Relay</h3>
                <button class="vlan-modal-close" onclick="closeDhcpRelayModal()">×</button>
            </div>
            <div class="vlan-modal-body">
                <form id="dhcp-relay-form" onsubmit="event.preventDefault(); saveDhcpRelay();">
                    <div class="form-group">
                        <label>VRF *</label>
                        <select id="dhcp-relay-vrf" onchange="updateDhcpUpstream()" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="">Select VRF...</option>
                        </select>
                        <div class="form-hint">VRF for the DHCP relay</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Interfaces *</label>
                        <select id="dhcp-relay-interface" multiple style="width: 100%; min-height: 120px; padding: 8px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        </select>
                        <div class="form-hint">Hold Ctrl/Cmd to select multiple interfaces</div>
                    </div>
                    
                    <div class="form-group">
                        <label>DHCP Servers *</label>
                        <input type="text" id="dhcp-relay-servers" placeholder="192.168.75.11, 192.168.75.12" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">One or more DHCP server IPs (comma or space separated)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Upstream Interface</label>
                        <input type="text" id="dhcp-relay-upstream" readonly style="width: 100%; padding: 10px 12px; background: #333; border: 1px solid #404040; border-radius: 4px; color: #76b900; font-size: 14px; cursor: not-allowed;">
                        <div class="form-hint">Auto-filled from VRF's VXLAN interface</div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="dhcp-relay-giaddr-toggle" onchange="toggleGiaddrField()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span>Set Gateway Interface (giaddr)</span>
                        </label>
                        <div id="dhcp-relay-giaddr-container" style="display: none; margin-top: 10px;">
                            <input type="text" id="dhcp-relay-giaddr" placeholder="lo, vlan100, or VRF name" style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <div class="form-hint">Source interface for DHCP relay (lo, vlan, or VRF)</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="vlan-modal-footer">
                <button class="btn-secondary" onclick="closeDhcpRelayModal()">Cancel</button>
                <button class="btn-primary" id="btn-save-dhcp-relay" onclick="saveDhcpRelay()">Create</button>
            </div>
        </div>
    </div>
    
    <!-- DHCP Relay Delete Confirmation Modal -->
    <div class="vlan-modal" id="delete-dhcp-relay-modal">
        <div class="vlan-modal-content" style="max-width: 400px;">
            <div class="vlan-modal-header">
                <h3>Delete DHCP Relay</h3>
                <button class="vlan-modal-close" onclick="closeDeleteDhcpRelayModal()">×</button>
            </div>
            <div class="vlan-modal-body" style="text-align: center; padding: 25px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#f44336" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Delete this DHCP Relay?</p>
                <p style="color: #76b900; font-weight: bold; font-size: 16px;" id="delete-dhcp-relay-vrf"></p>
                <p style="color: #888; font-size: 13px; margin-top: 5px;">Interface: <span id="delete-dhcp-relay-interface" style="color: #4fc3f7;"></span></p>
            </div>
            <div class="vlan-modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn-secondary" onclick="closeDeleteDhcpRelayModal()">Cancel</button>
                <button class="btn-danger" onclick="executeDeleteDhcpRelay()">Delete</button>
            </div>
        </div>
    </div>

    <!-- EVPN Multihoming Modal -->
    <div class="vlan-modal" id="evpn-mh-modal">
        <div class="vlan-modal-content" style="max-width: 450px;">
            <div class="vlan-modal-header">
                <h3 id="evpn-mh-modal-title">Configure EVPN Multihoming</h3>
                <button class="vlan-modal-close" onclick="closeEvpnMhModal()">×</button>
            </div>
            <form id="evpn-mh-form" onsubmit="saveEvpnMh(event)">
                <div class="vlan-modal-body">
                    <div class="form-group">
                        <label>System MAC</label>
                        <input type="text" id="evpn-mh-sysmac" placeholder="44:38:39:ff:XX:XX" pattern="^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$" required style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                        <div class="form-hint">Format: 44:38:39:ff:XX:XX (unique per MLAG pair)</div>
                    </div>
                    <div class="form-group">
                        <label>DF Preference</label>
                        <select id="evpn-mh-df-preference" required style="width: 100%; padding: 10px 12px; background: #1e1e1e; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 14px;">
                            <option value="50000">50000 (Primary)</option>
                            <option value="40000">40000 (Secondary)</option>
                        </select>
                        <div class="form-hint">Higher value = preferred DF (Designated Forwarder)</div>
                    </div>
                </div>
                <div class="vlan-modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEvpnMhModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="btn-save-evpn-mh">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete EVPN MH Confirmation Modal -->
    <div class="vlan-modal" id="delete-evpn-mh-modal">
        <div class="vlan-modal-content" style="max-width: 400px;">
            <div class="vlan-modal-header">
                <h3>Delete EVPN Multihoming</h3>
                <button class="vlan-modal-close" onclick="closeDeleteEvpnMhModal()">×</button>
            </div>
            <div class="vlan-modal-body" style="text-align: center; padding: 25px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#f44336" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Delete EVPN Multihoming configuration?</p>
                <p style="color: #888; font-size: 13px;">This will remove System MAC and DF Preference settings.</p>
            </div>
            <div class="vlan-modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn-secondary" onclick="closeDeleteEvpnMhModal()">Cancel</button>
                <button class="btn-danger" onclick="executeDeleteEvpnMh()">Delete</button>
            </div>
        </div>
    </div>
</body>
</html>
