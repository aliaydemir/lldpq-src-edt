<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="/png/favicon.ico">
    <title>..::LLDPQ::..</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="css/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #76b900;
        }
        
        .last-updated {
            font-size: 13px;
            color: #888;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Summary Cards Grid */
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .summary-card { 
            background: #252526; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 3px solid #76b900;
            transition: all 0.2s ease;
        }
        
        .card-total { border-left-color: #76b900; }
        .card-info { border-left-color: #4fc3f7; }
        .card-warning { border-left-color: #ff9800; }
        .card-purple { border-left-color: #9c27b0; }
        
        .card-value { 
            font-size: 28px; 
            font-weight: bold; 
            color: #fff; 
        }
        
        .card-total .card-value { color: #76b900; }
        .card-info .card-value { color: #4fc3f7; }
        .card-warning .card-value { color: #ffb74d; }
        .card-purple .card-value { color: #ce93d8; }
        
        .card-label { 
            font-size: 12px; 
            color: #888; 
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Dashboard Section */
        .dashboard-section {
            background: #2d2d2d;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 12px 16px;
            background: #333;
            font-weight: 600;
            font-size: 14px;
            color: #76b900;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #404040;
        }
        
        .section-content {
            padding: 0;
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px 14px;
            background: #252526;
            color: #888;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #404040;
        }
        
        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        
        .data-table tr:hover {
            background: #333;
        }
        
        .data-table tr.expandable {
            cursor: pointer;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .badge-green { background: rgba(118, 185, 0, 0.2); color: #76b900; }
        .badge-blue { background: rgba(33, 150, 243, 0.2); color: #64b5f6; }
        .badge-purple { background: rgba(156, 39, 176, 0.2); color: #ce93d8; }
        .badge-orange { background: rgba(255, 152, 0, 0.2); color: #ffb74d; }
        .badge-gray { background: rgba(158, 158, 158, 0.2); color: #9e9e9e; }
        
        /* Action buttons in table */
        .row-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon-edit {
            background: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
        }
        
        .btn-icon-edit:hover {
            background: #2196f3;
            color: white;
        }
        
        .btn-icon-delete {
            background: rgba(244, 67, 54, 0.2);
            color: #ef5350;
        }
        
        .btn-icon-delete:hover {
            background: #f44336;
            color: white;
        }
        
        /* Expand icon */
        .expand-icon {
            display: inline-block;
            width: 20px;
            color: #666;
            transition: transform 0.2s;
        }
        
        .expand-icon.rotated {
            transform: rotate(90deg);
        }
        
        /* Device list row */
        .device-list-row {
            display: none;
            background: #252526;
        }
        
        .device-list-row.visible {
            display: table-row;
        }
        
        .device-list-row td {
            padding: 15px 14px 15px 50px;
        }
        
        .device-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .device-chip {
            background: #333;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #76b900;
        }
        
        /* VRF Name */
        .vrf-name {
            color: #ce93d8;
            font-weight: 500;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #76b900;
            color: white;
        }
        
        .btn-primary:hover {
            background: #8ed100;
        }
        
        .btn-secondary {
            background: #444;
            color: #ccc;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: #76b900;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.visible {
            display: flex;
        }
        
        .modal-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            background: #333;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: #76b900;
            font-size: 16px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #fff;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: #252526;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 12px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #76b900;
        }
        
        .form-hint {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }
        
        /* No data message */
        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <div class="page-title">VRF Report</div>
            <div class="last-updated" id="last-updated">Loading...</div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="loadData()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card card-total">
            <div class="card-value" id="total-vrfs">-</div>
            <div class="card-label">Total VRFs</div>
        </div>
        <div class="summary-card card-info">
            <div class="card-value" id="total-devices">-</div>
            <div class="card-label">Devices with VRFs</div>
        </div>
        <div class="summary-card card-warning">
            <div class="card-value" id="unused-vrfs">-</div>
            <div class="card-label">Unused VRFs</div>
        </div>
        <div class="summary-card card-purple">
            <div class="card-value" id="tenant-vrfs">-</div>
            <div class="card-label">Tenant VRFs</div>
        </div>
    </div>
    
    <!-- VRF Table Section -->
    <div class="dashboard-section">
        <div class="section-header">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
            VRF Profiles
        </div>
        <div class="section-content" id="content-area">
            <div class="loading">
                <div class="spinner"></div>
                Loading VRF data...
            </div>
        </div>
    </div>
    
    <!-- Create VRF Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create VRF</h3>
                <button class="modal-close" onclick="closeCreateModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #888; margin-bottom: 15px;">
                    VRFs are created per-device. To create a new VRF, go to 
                    <a href="fabric-config.html" style="color: #76b900;">Fabric Config</a>, 
                    select a device, and use the Create button in the VRFs section.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCreateModal()">Close</button>
                <a href="fabric-config.html" class="btn btn-primary">Go to Fabric Config</a>
            </div>
        </div>
    </div>
    
    <!-- Delete VRF Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 style="color: #ff6b6b;">Delete VRF</h3>
                <button class="modal-close" onclick="closeDeleteModal()">×</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#ff6b6b" style="margin-bottom: 15px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p style="color: #ccc; margin-bottom: 10px;">Are you sure you want to delete VRF:</p>
                <p style="color: #ce93d8; font-weight: bold; font-size: 18px; margin-bottom: 15px;" id="delete-vrf-name"></p>
                <div id="affected-devices-list" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;"></div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn" id="btn-confirm-delete" onclick="confirmDelete()" style="background: #dc3545; color: white;">Delete</button>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let vrfData = {};
        let totalDeviceCount = 0;
        
        // Initialize
        async function init() {
            const isAuth = await LLDPqAuth.check();
            if (!isAuth) return;
            
            if (!LLDPqAuth.isAdmin()) {
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: #888;">Access denied. Admin only.</div>';
                return;
            }
            await loadData();
        }
        
        // Load all data
        async function loadData() {
            document.getElementById('content-area').innerHTML = '<div class="loading"><div class="spinner"></div>Loading VRF data...</div>';
            
            try {
                const response = await fetch('/fabric-api.sh?action=get-vrf-report');
                const data = await response.json();
                
                if (data.success) {
                    vrfData = data.vrfs || {};
                    totalDeviceCount = data.device_count || 0;
                    
                    document.getElementById('last-updated').textContent = 'Last Updated: ' + new Date().toLocaleString();
                    updateSummary();
                    renderTable();
                } else {
                    document.getElementById('content-area').innerHTML = '<div class="no-data">Failed to load data: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (e) {
                document.getElementById('content-area').innerHTML = '<div class="no-data">Failed to load data: ' + e.message + '</div>';
            }
        }
        
        // Update summary cards
        function updateSummary() {
            const vrfNames = Object.keys(vrfData);
            const totalVrfs = vrfNames.length;
            const unusedVrfs = vrfNames.filter(v => !vrfData[v].devices || vrfData[v].devices.length === 0).length;
            const excludedVrfs = ['default', 'oob', 'shared-hss'];
            const tenantVrfs = vrfNames.filter(v => !excludedVrfs.includes(v)).length;
            
            document.getElementById('total-vrfs').textContent = totalVrfs;
            document.getElementById('total-devices').textContent = totalDeviceCount;
            document.getElementById('unused-vrfs').textContent = unusedVrfs;
            document.getElementById('tenant-vrfs').textContent = tenantVrfs;
        }
        
        // Render table
        function renderTable() {
            const vrfNames = Object.keys(vrfData);
            
            if (vrfNames.length === 0) {
                document.getElementById('content-area').innerHTML = '<div class="no-data">No VRF profiles found.</div>';
                return;
            }
            
            // Sort by name
            vrfNames.sort();
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>VRF Name</th>
                            <th>L3VNI</th>
                            <th>VXLAN Int</th>
                            <th>Devices</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const vrfName of vrfNames) {
                const vrf = vrfData[vrfName];
                const devices = vrf.devices || [];
                const deviceCount = devices.length;
                
                const vxlanInt = vrf.vxlan_int ? `vlan${vrf.vxlan_int}_l3` : '-';
                
                html += `
                    <tr class="expandable" onclick="toggleDeviceList('${vrfName}')">
                        <td><span class="expand-icon" id="icon-${vrfName}">›</span></td>
                        <td><span class="vrf-name">${vrfName}</span></td>
                        <td>${vrf.l3vni || '-'}</td>
                        <td>${vxlanInt !== '-' ? `<span class="badge badge-purple">${vxlanInt}</span>` : '-'}</td>
                        <td>
                            <span class="badge ${deviceCount > 0 ? 'badge-green' : 'badge-gray'}">
                                ${deviceCount} device${deviceCount !== 1 ? 's' : ''}
                            </span>
                        </td>
                        <td>
                            <div class="row-actions">
                                <button class="btn-icon btn-icon-delete" onclick="event.stopPropagation(); confirmDeleteVrf('${vrfName}')" title="Delete" ${vrfName === 'default' ? 'disabled style="opacity:0.3;cursor:not-allowed;"' : ''}>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr class="device-list-row" id="devices-${vrfName}">
                        <td colspan="6">
                            ${devices.length > 0 ? `
                                <div class="device-chips">
                                    ${devices.map(d => `<span class="device-chip">${d}</span>`).join('')}
                                </div>
                            ` : '<span style="color: #888;">No devices assigned</span>'}
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            document.getElementById('content-area').innerHTML = html;
        }
        
        // Toggle device list
        function toggleDeviceList(vrfName) {
            const row = document.getElementById('devices-' + vrfName);
            const icon = document.getElementById('icon-' + vrfName);
            
            if (row.classList.contains('visible')) {
                row.classList.remove('visible');
                icon.classList.remove('rotated');
            } else {
                row.classList.add('visible');
                icon.classList.add('rotated');
            }
        }
        
        // Modal functions
        function openCreateModal() {
            document.getElementById('create-modal').classList.add('visible');
        }
        
        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('visible');
        }
        
        // Delete VRF
        let deletingVrfName = '';
        
        function confirmDeleteVrf(vrfName) {
            if (vrfName === 'default') {
                alert('Cannot delete the default VRF');
                return;
            }
            
            deletingVrfName = vrfName;
            document.getElementById('delete-vrf-name').textContent = vrfName;
            
            const devices = vrfData[vrfName]?.devices || [];
            const affectedDiv = document.getElementById('affected-devices-list');
            if (devices.length > 0) {
                affectedDiv.innerHTML = `
                    <p style="color: #ff6b6b; margin-bottom: 8px;">Warning: This VRF is used by ${devices.length} device(s):</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
                        ${devices.map(d => `<span style="background: #444; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${d}</span>`).join('')}
                    </div>
                `;
            } else {
                affectedDiv.innerHTML = '<p style="color: #888;">This VRF is not used by any devices.</p>';
            }
            
            document.getElementById('delete-modal').classList.add('visible');
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('visible');
            deletingVrfName = '';
        }
        
        async function confirmDelete() {
            if (!deletingVrfName) return;
            
            // VRF deletion is complex - it needs to be removed from all devices
            // For now, show a message
            alert('VRF deletion requires removing from all devices.\n\nPlease use Fabric Config to remove VRF from individual devices, or edit host_vars files directly.');
            closeDeleteModal();
        }
        
        // Init on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
